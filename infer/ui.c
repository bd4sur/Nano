#include <stdio.h>
#include <time.h>

#include "graphics.h"
#include "keyboard_hal.h"
#include "ui.h"

#include "platform.h"

#ifdef BADAPPLE_ENABLED
    #include "badapple.h"
#endif

#define IME_HANZI_NUM 7081

// 查询方式：给定按键序列对应的整数，例如“33”，从KEYS_LIST中查出全部出现位置的index，在UTF32_LIST中对应index位置的数值，即为候选字的utf32

static uint32_t KEYS_LIST[IME_HANZI_NUM] = {
33,34,94,28,744,53,5426,736,924,968,96,82,943,9434,934,944,524,32,324,94,43,94664,74264,636,326,7484,7486,486,43,486,33,34,93,94,744,326,248,37,926,98,548,942,33,334,53,64,6426,74364,94,484,5824,62,634,468,6364,384,9426,943,948,9486,744,74,54,786,78,4264,9464,486,542,744,9664,32,8426,78,726,986,3264,24364,943,386,74,368,38,726,9426,586,37,98,8664,62,63,926,5464,32,3264,74,98,426,526,983,546,94664,54264,424,4826,336,24,946,7426,6426,968,3464,5426,9426,74,944,948,634,66,4664,2664,9664,944,744,28,236,3664,9426,946,524,943,54,24264,94264,6464,9264,94,94,983,94364,94264,744,22,326,94264,54264,646,82,54,936,3364,924,34,9264,426,936,824,868,7464,94,54,82,484,2464,5426,7468,74,4826,24664,94664,9464,4664,9464,7826,636,526,3426,7436,3664,968,43,94264,944,98,9426,93,234,94364,634,98,37,54,78,9426,54,26,486,54,436,984,748,944,634,7426,84,7436,744,946,482,6464,983,43,43,542,744,7464,7484,24264,486,934,946,38,2426,54,74364,626,324,968,68,926,62,546,248,2426,7426,8664,6464,83,434,54,748,7486,24,424,546,2426,9826,74,94,43,9468,482,568,736,9436,224,54,5426,4826,7426,74,33,543,943,7436,93,24,2464,74,32,9826,924,586,243,8464,34,84,926,74,4364,24,7468,224,986,37,54,9826,226,944,224,9664,334,5426,38,234,934,94264,5464,326,744,744,98,8426,2426,94,54,743,736,68,48264,4826,58,543,24364,486,226,543,84,783,944,426,626,54264,98,944,78,24264,74,3426,5664,2426,8664,5426,74,53,34,746,7464,38,948,7464,744,548,3264,3364,94,748,744,73,7424,9464,9264,24826,94826,22,38,926,5464,7464,583,9426,426,5426,384,74264,9264,68,78,5426,98,32,743,7826,53,548,743,54,4826,54,424,9426,94,48,746,94,94264,482,74,926,546,54,38,324,58,543,986,5426,583,94264,9826,334,9826,7468,326,744,94664,243,58,468,534,24364,94826,4664,7426,744,744,548,634,424,2426,9426,744,5426,748,948,546,43,54,426,986,936,28,824,7264,54264,43,744,944,484,52,743,54,244,786,9464,94364,4664,7436,234,926,9264,5824,54,28,546,9468,9664,2464,482,2436,24364,586,24,326,783,63,64,226,543,436,54,74264,2436,486,9464,5464,948,784,742,38,286,2436,9486,48264,7468,48,58,7436,48264,626,7664,2426,326,7426,5426,3426,8426,244,54,48,7826,986,926,946,98,54,94364,926,983,68,98,3264,2364,9364,74,94,784,5464,744,74264,3826,624,9464,248,7464,248,94,7468,3264,226,9426,7464,944,98,983,58264,58,48264,7426,54,548,53,983,94264,9426,74,943,8826,948,936,94,98,98,94364,542,543,426,54,226,7436,744,944,4664,2,3,9426,88,9464,52,586,54,9464,9364,88,54,944,944,93,98,543,986,548,426,6426,54,7664,9426,944,92,884,58,543,586,226,54,9426,34,53,934,94664,9826,5664,744,526,968,748,948,548,6664,7426,94,76,934,94,334,826,946,242,942,94826,944,62,9426,744,74,948264,583,32,34,424,64,926,548,94,26,548,226,4664,74,26,242,434,88,326,58,868,94,9826,74364,9464,98,74824,58,926,324,484,94,98,24826,54,74,48,934,784,58,2426,984,22,786,2486,94264,7364,668,94,24364,62,744,54,944,5464,426,436,54264,3264,38,93,5426,934,78,748264,7426,5426,9426,968,934,546,54,98,7434,7484,5464,33,34,424,43,934,22,4664,368,54264,94264,5826,543,3364,468,9426,926,58,242,2424,24,53,94,724,546,5426,94,54,98,4664,5826,78,72,626,9426,226,3826,38,946,926,9826,48,968,94264,224,948,64264,68,824,468,482,98,5464,64,542,934,744,74264,4264,948264,526,78,948,94364,74364,5464,94264,54,93,94,946,78,74,34,744,884,5426,9426,73,8426,944,4824,5264,62,744,5464,944,9464,4826,626,6426,583,74,326,368,74,5464,926,743,5426,944,548,58,58,786,94664,22,526,486,548,9264,98,6264,484,286,748,9484,546,26,98,78,744,38,24664,9664,224,744,74364,943,983,326,826,224,534,38,62,634,9826,784,248264,48,94,38,23,224,7664,98,826,38,64,326,748,748,24664,36,43,986,3,98,8464,54264,48,9426,26,24,748,943,4826,66,626,226,48,744,5464,726,726,9264,54,7426,4824,37,9436,3364,98,5664,8264,8264,9426,948,943,9464,724,5426,6464,74364,5426,843,5426,583,48,286,368,38,484,94,5364,66,36,38,9264,6364,548,9436,42,26,624,38,248,734,8664,7468,536,98,9426,568,48,7486,946,98,968,48,74,5464,542,326,62,5426,543,94664,234,9464,786,24826,98,326,54,54,7436,5426,2364,9468,5426,583,94264,742,886,3364,2436,9264,5264,94,2426,668,926,943,48,48,9426,38,226,9426,942,94264,5426,94,74,58,93,744,54264,386,58,3464,94,934,7484,986,968,543,52,742,54,94,482,98,646,98,626,58,568,2,3826,88,4824,92,5426,2264,9264,92,934,936,7464,2264,7664,4826,468,5264,98,586,9264,94,94,546,426,648,7436,9426,98,94664,5824,326,9464,486,28,26,944,736,5826,24,926,946,74,48,98,38,74,94364,3426,93,48,924,4264,5664,9464,7664,9264,424,948264,326,886,543,424,43,98,746,8464,24,7484,7426,9426,68,74264,726,58,526,934,9426,78,24,983,336,94,586,7464,7264,48,643,54264,9826,7464,3826,24826,2426,826,43,24364,6364,484,68,586,926,986,948,7364,3426,542,968,98,64,826,43,94664,226,53,534,93,3426,934,326,783,586,926,43,5464,624,786,28,98,586,98,7426,23,98,948,426,24,543,24,92,3,26,24,98,743,3664,9264,926,4826,5426,48,24364,74364,58,226,224,9426,748,2426,768,426,93,9424,948,38,7426,5426,486,92,634,586,3264,48,5464,5664,6664,24364,726,726,58,3426,9426,54,3,66,9426,9426,58,248264,54,5426,948,94,7426,546,426,74,54,38,9264,58,236,3464,968,8426,74,5464,946,24,468,5426,226,986,74,944,948,968,94264,748,934,984,4264,94,5664,786,743,943,3364,9436,84,686,326,724,73,634,98,326,926,926,8464,748,92,5426,76,6426,24264,58,94,748,24264,3364,746,74264,38,736,9464,66,9664,76,58,93,26,9664,543,24264,9826,534,9826,586,226,248264,9482,334,2464,9436,8664,3364,926,5826,72,386,38,926,7426,78,34,5664,38,98,94,58,486,942,82,32,242,826,224,226,824,826,248,88,624,426,226,7468,4826,68,9426,436,234,6364,9826,4826,3664,7264,74824,7826,96,9664,986,948,946,24664,48,542,4664,93,226,7426,6426,724,224,934,98,62,936,934,54264,736,7426,9426,543,7426,48,934,94,484,9826,2486,7426,4364,64,22,944,9426,78,326,726,54,234,58,94,826,924,534,968,58264,426,324,336,868,54264,94,5264,6364,26,226,748,98,5464,74,7426,548,68,586,986,542,486,7364,944,943,74664,94,24,326,934,7426,9436,28,542,326,926,54,9424,74264,5464,468,724,244,7436,6426,94664,482,24,94,746,74,58,7826,2436,326,68,9486,78,726,8464,9436,748,626,48264,224,986,43,484,244,926,94264,24,23,9424,22,4664,94664,28,24264,286,24364,2468,53,626,934,526,586,234,4364,94,78,7426,98,52,526,926,943,784,2468,78,948,24,9264,3264,7468,7464,92,926,626,92,624,246,66,244,66,9464,748,74,724,742,486,868,94,4824,38,224,524,743,948,98,6364,9426,2484,5464,468,7664,58,38,424,58,426,78,734,4826,243,5464,586,62,248,3464,524,9826,426,9264,4664,43,583,5264,94264,94,5464,944,326,942,38,336,484,926,58,54264,968,2484,624,546,9426,634,543,52,7426,2264,924,76,986,226,948264,484,94264,986,54,54,4826,43,4826,8426,54,624,32,68,94,326,24,326,9826,2436,7436,3664,7464,234,24664,983,94264,234,2468,748,9426,2426,626,926,38,58,824,3264,9424,38,7826,74,68,26,484,948,5426,5464,2426,324,7486,526,58,7264,744,8264,6464,968,7426,243,9426,926,24,5426,24,3264,326,486,786,38,24,9364,62,486,9464,926,2436,426,626,43,6426,926,324,94664,244,746,94264,54,68,28,543,43,54264,94364,426,9436,7364,646,54,98,226,24,786,748,884,23,4664,926,948,486,66,94,24264,74264,5426,743,68,2464,98,24,38,32,384,4364,38,7426,5426,3664,486,726,78,934,54,924,542,326,983,78,88,983,5826,7826,726,78,66,784,942,48,546,5464,3364,546,934,5426,984,74364,64,926,3364,34,336,7426,5426,986,826,426,568,983,4826,926,726,768,92,942,426,7426,726,7364,98,98,98,3364,744,734,726,584,48264,48,74,934,38,8464,4826,54,72,843,64,634,736,484,94,924,9264,226,74,8464,2436,62,946,546,5426,54264,5426,74,7426,24364,486,64,94264,983,94264,5426,38,786,98,9426,78,734,72,98,98,7426,2264,948,626,94,98,94826,336,484,48,482,38,5426,9424,748,946,8464,98,768,34,64,78,948264,286,943,5464,326,74,746,48,58264,74,8364,242,24,248,3364,5464,386,7468,543,826,9436,9826,226,226,54,78,98,5426,66,768,886,26,9468,9436,98,7426,2664,7826,886,9486,9664,226,78,584,526,5426,524,94,53,944,7436,94,484,948,38,948,926,284,74824,746,8664,2264,334,93,484,98,626,54,542,943,744,284,526,9664,43,74,9468,583,486,52,624,626,968,986,74,626,424,9486,334,546,743,34,826,926,34,7482,72,543,224,224,26,7826,54,4664,386,74,94,626,98,386,2664,944,748,543,224,468,94,88,4664,284,986,543,343,5426,9424,5426,6464,5426,7426,942,76,5264,74364,986,334,3364,968,92,826,26,9436,54,626,746,942,486,934,9364,926,946,96,986,348,5426,94,386,484,54,5426,543,968,58,748,926,22,484,748,743,68,5464,98,94,4826,943,98,24,5664,26,28,43,6664,74,2468,324,624,543,9426,586,943,26,5426,744,7426,244,94,943,68,543,7464,726,436,926,2464,7464,343,7426,586,38,244,54,2426,2664,3364,426,24,74,5464,54,78,926,526,626,946,38,482,9826,244,98,542,94,9426,983,636,94,54,98,94264,4264,32,943,484,9426,94,43,368,542,54264,4264,4364,426,4664,568,3264,9664,946,2468,748,686,62,8264,58,986,7426,546,726,24,743,94664,2364,8364,7426,98,548,7264,748,6826,26,4364,586,4664,54,8426,5426,48264,226,8264,9464,94264,38,948,234,6426,943,2424,73,482,626,7426,624,526,926,82,84,784,743,6264,7664,7826,926,92,2426,7426,9826,942,98,783,9826,9264,94,58,426,484,886,946,98,94264,943,9264,9264,548,244,726,2,43,74,744,336,9424,24664,948,3426,62,24264,426,5426,3426,744,74664,5426,264,9426,7464,96,98,626,5664,986,726,946,94,468,926,94,74364,48,54,9826,9664,9664,386,3464,736,926,6426,94,734,5464,48,58,582,74,284,9486,22,248,98,54,74,936,568,886,94,6264,726,336,983,368,94,74,66,426,744,94,78,743,948,34,2426,7426,78,26,7468,243,543,24364,634,92,5426,94264,5464,94,744,2468,2486,7464,94,94664,7264,746,58,284,7664,634,24,24,3,7426,5426,2464,2264,38,436,3364,986,54,28,7364,244,8426,226,484,8264,648,543,9464,5426,546,58,54264,226,5426,54264,9464,26,746,944,24,326,336,944,586,2426,526,76,78,583,648,53,58,548,2426,2436,244,53,9426,3264,426,746,2426,78,78,94,6426,54264,582,926,93,4264,94,726,26,94364,3426,98,92,24826,3364,926,78,742,94,94264,88,98,96,98,943,7482,944,5426,3264,74,93,426,28,968,9468,226,926,5426,4826,92,746,9484,26,226,94364,74264,5264,826,43,9426,736,748,24,926,7364,784,54,5426,948,38,268,4264,78,484,94,6426,38,468,6426,726,468,986,24,926,7664,942,942,886,54264,468,26,9826,326,943,98,9464,5464,7426,334,24,2426,2424,7426,9426,526,824,74,484,58,3,6,53,7426,7426,6464,9464,5464,948,926,74,2426,784,6426,4264,24,248,568,584,74,2426,9426,94664,9426,2426,38,9468,324,98,68,58,734,634,7364,24264,324,24826,58,3264,486,66,934,426,2264,7264,9468,748264,54,9264,94,2464,526,43,986,4664,9826,9424,4364,464,7664,826,2426,9826,9464,742,5826,4664,8264,98,94664,5826,946,234,926,826,4364,34,336,934,948264,58,942,3464,5464,24,726,2264,48264,7264,98,334,6426,94,94,748264,5364,48264,924,92,98,58,73,936,336,2468,948,2426,536,5826,248264,244,526,5426,66,9464,74,7486,64,68,524,3664,468,726,24,242,68,2424,9486,284,72,98,3364,368,8426,26,7426,783,4826,744,6264,226,4824,586,986,24,54,526,8664,7364,7486,7486,486,343,843,48,742,4664,534,584,284,4664,54264,9436,626,5426,343,546,5426,74,7664,226,74,744,92,26,583,746,634,926,468,24364,3364,58264,78,98,98,944,24,74,94664,926,944,74,4824,9264,2264,92,24,5826,948,94,226,74,926,48264,726,53,78,43,586,626,943,5426,9464,24264,3,58,586,5426,748,7426,3426,726,94264,4826,924,94264,94,94,78,486,66,926,24264,74264,38,742,94264,424,9826,54,8364,7464,2264,88,786,36,64,58,9468,94826,9826,24,54,784,98,268,3464,94,926,546,386,54,6264,58,2486,546,48264,3364,26,6264,54,9426,2486,546,743,468,24364,9486,248,76,78,9264,9426,2826,4664,748,2426,546,37,98,426,242,742,8264,94264,6426,9426,926,526,5826,744,742,786,326,924,24,648,78,426,74,94,686,7826,482,586,7426,94,3426,826,48264,7426,4364,826,64,3,2426,5426,2464,38,58,926,82,886,9424,246,74,9482,9426,58,586,584,942,9464,748,9426,926,826,74,48264,64,54,543,942,7426,76,38,826,38,548,968,324,92,38,326,94364,24,38,584,826,9436,742,942,24,634,94,736,2464,943,43,6464,7436,58264,64,88,5664,74264,7664,3464,94364,54,9464,5364,48,92,94,744,74264,768,9464,43,94364,74,7426,384,5426,98,7264,74,424,53,9426,926,98,94826,98,944,74824,5826,8264,626,84,74,246,7664,4664,744,94,386,26,24,24,84,683,948264,2264,7426,784,2426,9426,484,748,64,484,426,526,52,38,38,326,92,8664,7426,54264,934,9826,326,526,78,34,2426,484,4826,52,748,9426,26,3664,3,7426,944,94264,946,26,484,24,236,926,983,58264,368,48,326,948,943,926,66,748,226,54264,92,546,9468,948,286,9464,926,584,4364,9664,926,986,58,2486,2426,5826,326,368,9426,748,94,334,643,643,9426,7426,9426,484,7426,743,543,542,943,926,9426,426,986,343,826,94,2426,634,84,926,98,54,94,226,326,74,948,586,7364,4824,986,96,94264,2264,2486,586,5664,586,948,9486,8664,38,2436,9426,946,3426,726,326,98,386,226,52,5426,64,2484,9484,886,636,48,248,5426,8264,926,24264,634,7664,326,826,9826,2468,82,9664,3264,52,324,9426,244,744,643,946,5426,93,542,64,9464,3,568,6,826,542,248264,948264,4826,5426,734,26,426,92,7436,526,68,482,944,82,54,482,58,58,22,586,626,548,53,3,9264,768,54,246,946,58,983,746,7464,526,22,326,9486,426,74,236,38,26,434,9486,94264,26,7426,58,484,34,82,52,743,42,748,74,7424,484,5426,543,583,943,336,98,54,9436,54264,22,3,5464,424,94,748,54,94,926,2468,7426,66,7426,934,98,742,58,24,64,786,926,9426,94364,944,368,334,543,94,9826,74,28,226,6364,24,7364,9464,78,84,66,784,54,74,9364,9464,542,8464,986,224,668,3826,7486,9436,944,68,484,942,7364,926,546,543,5464,9264,26,43,6426,386,248,926,52,643,326,742,943,3364,426,936,244,7426,583,9426,946,326,826,5464,586,68,7826,748,986,9664,53,234,66,74,9826,343,324,94,6426,3426,54,926,546,242,7426,9426,584,94364,926,226,78,9826,943,543,24,726,7264,5426,583,2426,968,426,942,7426,948,942,7426,968,942,2484,743,7426,748,543,943,4264,5426,5464,7426,6464,568,74,4824,543,526,48264,926,7436,64,6426,5664,4826,2264,42,983,54,934,326,96,5426,5426,826,94,7426,9264,98,526,648,526,8464,748,934,7468,7464,9426,74,9484,3826,68,2364,626,34,9424,3364,226,743,4826,744,98,54264,944,7664,94664,66,63,942,74,43,586,5426,926,768,28,926,526,948,5426,94,548,986,7426,646,54,786,5464,5264,926,983,742,7426,84,2486,784,74,5264,244,94264,5426,5464,7426,6426,64264,9464,28,568,3426,98,54,786,58,24364,748,94,2664,486,26,3,486,96,98,58,926,98,484,58,484,926,98,586,8664,74,54,74824,884,94,9826,746,426,98,2426,343,5464,53,336,4364,482,486,2264,944,726,2436,92,54,7426,546,93,98,68,9486,926,34,62,63,234,48264,926,586,38,5426,3464,6426,668,484,643,2364,826,22,72,9264,426,9264,934,98,98,54,5264,426,58,74364,783,32,526,986,646,9468,948,26,3364,48,78,52,94,426,54664,54,2468,744,384,43,24,5264,34,6426,784,626,526,7464,73,94,26,586,6426,9468,68,54,74,336,546,986,343,5464,5426,5464,5826,5364,246,768,726,746,9426,724,26,944,74,548,98,48,626,6364,2486,946,64,248264,536,94,826,2426,568,38,943,5426,582,484,38,944,944,626,5426,54,72,686,94,5826,2464,426,234,94,742,9426,9364,546,48264,948,98,484,54664,74364,24824,334,64,43,56,586,7436,34,94,94,9264,73,94,482,92,968,98,646,4264,5264,526,9264,244,96,548,78,23,9436,58,74,9468,2436,98,826,784,626,426,934,34,9424,26,3,4826,5826,8664,88,9664,7264,986,5426,54664,94,4664,94364,9436,226,54264,286,98,9426,54264,886,98,7426,6,96,968,548,826,38,93,3664,7426,584,74,546,986,5426,926,5664,9826,54,9426,58,824,486,5426,942,94,5426,9426,68,94264,2426,7426,9464,426,94,244,926,54,54,748,54,98,96,264,526,8264,7426,34,78,6464,26,942,9464,48,426,7426,2426,38,78,986,226,93,94824,968,43,7468,83,884,482,244,4826,94264,22,886,9464,584,9426,943,5426,526,9484,548,4826,624,7664,586,326,936,78,94,7464,82,743,93,942,92,94,524,8264,24264,74,74826,546,78,5426,9468,7426,54,37,58,78,94,226,6426,646,324,37,2426,64,484,42,74,48,68,2826,7436,943,9426,48,48,72,484,54,746,2436,58,74364,426,934,96,226,726,22,38,243,634,26,244,9826,48,9436,968,736,646,783,34,3426,78,824,54264,72,326,826,386,586,243,943,226,468,9436,62,7426,926,48,944,986,98,583,744,92,94,58,5426,94,2436,2426,54,744,62,9426,54,543,98,9436,78,9664,886,884,22,7364,8664,948264,324,386,92,78,768,98,826,54,24,2484,24,74,9426,726,7426,5426,8364,7426,926,742,24,2426,926,7826,724,726,94264,484,2426,94826,936,2364,58,986,26,648,3426,386,886,74,48264,586,98,58,98,284,886,24264,734,2484,28,234,524,98,48,726,264,76,543,93,484,744,3426,4264,5364,74,98,78,7664,42,242,546,426,3,38,3,8664,2826,926,6426,246,2426,4264,5464,986,586,2468,386,58,5826,7826,38,484,3264,4826,424,542,64,58,94,2426,9426,584,84,236,24,7826,64,586,58,934,62,66,7264,6264,6364,946,424,5426,3,526,2486,7426,884,28,546,526,5426,386,7364,934,548,5426,74,224,5664,248,2264,7264,543,936,486,734,226,98,22,58,74826,526,9426,26,743,24826,546,926,5826,9426,334,926,946,986,74,8264,9464,58,7664,63,244,58,234,26,78,48264,3426,98,9484,248,24,58,748,78,284,9464,542,7664,948,9264,786,7424,634,5826,9826,246,24264,4664,7426,926,74264,48,48,2426,548,94,9486,7426,6426,944,4664,736,68,748,944,584,4826,5364,7664,43,43,66,424,434,24,74664,3,2426,243,548,7426,983,94664,26,9826,744,7426,98,944,3364,9426,2426,6364,58,7426,8826,9264,5824,746,944,726,6664,248,286,54,986,74,94,78,334,568,5464,24264,2426,784,54,386,826,5426,8426,7426,4826,22,72,26,226,9664,5464,2436,386,7426,426,98,9826,54,54,7426,9482,96,94826,826,84,98,9426,78,286,9426,9464,9264,43,43,5826,54,4826,93,768,94664,24364,2468,236,826,944,744,94364,7486,28,986,926,82,68,98,58,546,92,7426,78,98,942,244,524,5464,66,94,748,686,5426,986,98,524,326,38,546,942,24,74264,426,986,626,6426,7426,7426,986,4826,886,668,24264,7426,426,54,643,526,226,226,334,84,98,4364,534,28,946,43,38,526,743,724,926,9464,786,94364,54,226,78,48,48,234,26,5464,534,98,886,484,92,5426,243,48,784,78,926,8664,6264,586,548,5464,2364,6364,74,48,726,58,5426,943,54,7464,3426,944,66,88,926,98,53,54,98,7464,926,9486,74264,98,926,968,9468,534,8426,98,3364,248,92,942,54,34,54264,3264,584,64,626,36,94,948,548,58264,73,934,936,742,54264,548,9436,744,48,482,24364,93,926,646,248,546,54,82,484,9426,9364,74264,58264,5426,43,43,74,76,234,648,386,2664,5426,7426,946,3264,58,548,536,9486,5426,743,54,94264,6426,943,542,7826,942,94,926,48,2664,482,58,386,286,9436,748,8464,3426,34,54,386,634,948,23,3426,5426,7364,386,58,548,5426,543,58,784,76,784,9464,7426,784,736,54,7426,78,7664,946,948,74264,94264,426,54,926,26,742,48,5826,3,942,926,38,7664,436,93,783,9826,48,926,784,986,64,26,8664,748,726,946,2468,43,5426,94,74,58,94,726,7436,54,9826,74,54,4826,9826,74,242,942,98,942,42,5426,5426,5426,43,5464,43,94,5826,426,94,98,236,742,8826,548,7826,7464,9426,6426,54,726,568,54,38,6464,9664,7486,586,7426,2364,586,37,24364,2426,7426,944,9464,9464,9464,24,34,5426,786,9436,786,426,426,626,9264,43,526,58264,74824,5264,24664,626,926,534,48,38,8426,586,54,9664,4826,94264,74,9426,62,7426,7426,786,8426,946,968,94,748,546,243,5464,9468,24264,94,54,94,324,2486,426,334,7426,74264,786,986,38,43,6664,6664,98,8426,634,5426,5426,2486,48264,946,542,9664,784,726,783,946,2664,54,334,7436,226,2,742,626,9826,626,5464,546,4264,54,24,3364,8426,94,926,934,5464,526,94,74,944,6426,82,94664,74,7426,534,94,426,64,826,53,524,98,5426,9426,94,9264,94,96,26,468,5426,98,526,934,736,6464,58,926,926,58,326,948,542,2468,936,543,94,626,78,4364,226,7664,78,484,286,3,9486,244,82,43,74,426,3264,9484,426,826,826,484,626,526,2468,484,926,986,94,586,524,548,426,986,9264,7264,24664,934,58,2486,946,8664,3664,546,4664,6426,583,524,94,92,5664,9264,942,9664,7436,946,24,3264,6426,96,48264,53,7436,32,244,7364,78,88,748,94,926,74,84,24826,38,5426,748,3,8264,74,743,54,746,93,368,4824,668,38,76,226,58,34,54,93,326,24,426,484,9426,98,583,74,583,926,73,686,9664,226,24,78,226,486,3464,4264,9826,4826,926,943,66,3264,78,786,326,94,726,926,58,7364,5426,3426,986,646,98,32,2264,78,54,2264,38,634,368,98,2426,6426,94264,74,54,24,8264,54,54,926,52,58,5264,7436,968,944,583,826,26,2424,9826,768,586,934,38,886,94,986,7426,9364,646,64,74,94,968,934,948,58264,92,7826,94,726,74264,636,543,2484,34,9264,948264,986,9426,948,2826,626,626,43,9436,32,548,786,32,748,38,868,244,22,9464,546,2426,926,248,9264,26,944,32,426,748264,746,634,744,668,986,246,98,542,82,32,5426,944,6264,4664,748,74664,226,668,7426,5426,48,28,543,62,924,3426,8426,5464,6364,634,24364,88,3664,8664,6426,24,32,4664,426,43,42,486,6464,38,53,78,98,583,326,944,2664,548,226,634,484,886,934,244,74,78,78,5264,5426,84,9486,8426,9426,7426,3426,386,38,94,943,968,343,66,626,546,5426,548,683,926,7426,248264,3,926,468,43,968,94264,3426,94,424,536,946,226,726,784,58,334,22,9486,2436,768,626,743,94,94,744,48,543,74664,986,58,43,78,74,7364,468,94,9826,334,54,48,3426,568,58,942,484,584,526,6426,53,8426,62,634,8464,8426,542,748,2436,54,48264,94826,7436,9426,5664,4664,4364,7426,8664,6264,58,934,9464,943,586,28,54,54,7826,5264,546,2486,74,568,2426,9486,242,58,386,526,526,58,583,643,68,54,543,54,78,426,3464,84,7426,244,486,724,926,624,7264,93,986,48264,48264,3,934,66,926,542,624,786,94,986,9436,58,72,426,743,534,48,6464,6426,426,482,7464,58,76,948,968,98,244,5426,8426,94,548,84,926,54,426,7464,244,934,98,38,584,78,986,942,534,334,5364,948,486,54,583,742,946,5826,24,482,9426,94,5264,686,7436,43,38,484,92,486,2364,9436,9826,484,943,6464,542,7264,64,9486,9426,943,246,368,74,646,426,926,926,7464,983,943,944,58,224,234,543,946,886,5664,426,54264,98,9664,93,7426,234,586,926,943,4664,2426,948,9426,824,78,944,94,54264,543,744,78,7826,546,3,942,526,43,742,94,643,8264,94,484,22,934,936,7664,7426,926,886,6264,3426,74826,9664,7426,94,948,94,2424,48,734,5824,242,236,636,6464,9436,934,244,983,2426,2426,736,248,9426,336,3426,8426,2426,96,643,32,78,38,34,7426,3664,386,342,9426,9826,68,9436,548,32,546,9826,74,4664,546,94,5426,5426,76,5826,2264,94,482,526,5426,386,583,5426,526,98,6364,98,53,94,246,2464,9426,2426,9664,94,9436,9364,74,54,2364,93,736,98,526,8426,74,93,768,98,484,4826,943,743,968,646,38,9664,4826,736,5426,38,74,584,968,74,9464,9264,584,746,426,943,226,74264,886,9486,983,24826,5464,934,94,9826,734,926,54,944,98,248,9426,486,3,38,3264,248,3664,98,743,9426,643,48264,9464,9664,4826,242,74264,94,868,942,243,934,768,244,986,334,38,2436,58,242,54,5264,768,34,243,584,5426,24,98,936,96,726,9426,542,786,5426,6426,98,2426,38,7426,74,336,54,32,948,9826,986,7426,2826,98,943,94364,84,934,8426,5426,746,7426,7264,53,38,926,9464,2426,944,32,54,6464,9426,624,824,7426,6464,524,24264,94264,724,34,284,426,74,54,2464,9664,484,6364,5426,8426,78,98,426,54,54,9486,226,968,5426,568,94,9486,926,9426,926,548,58,64,9426,74364,326,98,943,7664,48,548,9464,5426,746,768,2486,7426,484,324,284,43,58,548,9486,484,66,284,326,743,64,94264,58,74,586,58,468,78,24,94,98,5426,64,9826,5464,5426,9264,546,726,226,6426,58,48264,7426,386,58,3264,944,6426,926,78,3364,26,468,783,484,246,74,543,28,7664,64,968,542,426,636,546,386,5264,583,886,24,22,48,58,98,94,886,626,646,6426,426,246,93,74,3364,726,484,24264,568,542,324,384,2484,2436,34,78,943,334,426,786,4264,236,743,583,948,3426,9826,7426,2664,74,78,768,94,784,74,74664,826,926,5464,3264,326,92,98,8664,926,72,546,7264,626,58,4264,484,784,244,94,53,8464,3464,2426,286,436,234,64,24,246,7664,48,526,26,5426,74,768,9426,24,968,7426,524,9464,826,38,7264,74,54,58,92,9664,54,968,926,38,736,6426,7486,334,38,542,38,68,582,944,943,948,746,386,48,542,98,94,934,924,8664,486,98,334,98,68,24824,68,5264,426,53,94,24364,5426,524,926,78,824,48,58,736,54,26,9468,9826,526,53,74826,2436,58,948,334,5464,54264,944,242,426,43,66,9826,58,24364,3264,546,7464,326,743,48,54,968,2426,94264,3264,48,94,54,94,98,786,58,926,9426,548,28,424,98,93,3664,74,326,843,634,6264,24264,948,58,34,74,584,324,9436,78,7464,98,64,636,5826,3426,28,94,886,9484,26,3,38,948,74364,6426,942,9464,8264,84,24664,24,286,98,54,54,48,486,946,248,98,24826,94,38,6426,5664,74264,92,2426,7426,92,43,4826,726,4364,326,3,48,94,886,93,926,8664,624,38,542,68,2426,968,944,543,8826,643,643,4364,2426,2426,5426,468,7826,58,98,2426,948,386,886,54,426,83,8264,83,826,783,58,624,524,946,543,98,8264,98,24,7426,4826,74264,42,426,226,726,58,74,626,948,78,284,48,242,568,5426,2426,943,543,986,626,486,7364,7426,7436,26,826,943,726,5664,48,748,7426,52,98,4364,943,78,248,26,534,926,244,746,82,8364,486,28,5264,52,68,824,24364,43,586,468,242,7426,242,948,53,48,38,546,94,94,426,626,482,326,74,3826,583,326,74264,986,946,2436,582,94364,98,986,94,74,426,926,926,7826,734,326,26,94,7426,9486,968,624,484,486,9264,948,3364,2826,468,74,468,484,26,943,74,468,74264,58264,5426,24,3264,643,626,98,944,5426,74264,94664,524,468,48,248,5464,3364,94,526,64,43,224,583,5426,534,743,534,74264,7426,986,926,24,226,5426,58,6426,9464,926,748,426,5426,586,536,584,24664,74,78,5824,236,94,74664,94,94,62,9364,76,934,8264,586,546,944,94,74264,3,5824,33,942,534,54,74,226,944,5464,7468,24826,6264,3264,7826,486,52,748,2,484,546,94,7426,743,96,243,226,6464,926,246,6464,78,7486,5426,746,24,78,72,9364,94264,948,98,48,586,98,54,94,94,54,426,242,5264,24,626,94264,22,746,948264,4264,94664,74364,2664,7364,72,986,32,38,94,968,9468,4826,334,5464,48,934,2426,934,9484,9664,74,58264,38,92,668,7264,9426,7264,74,626,748,548,74,37,768,726,224,38,286,93,68,482,686,28,734,948,7426,926,54,486,946,5426,48264,8826,944,53,548,586,926,74664,6426,926,986,568,2364,3826,5426,94826,5464,426,886,534,9426,726,7464,94,843,3464,54,482,926,92,38,74,5464,424,748,326,54,824,524,7426,486,54664,944,32,74,748,7664,786,3664,943,64,53,48,234,326,3464,8464,824,98,643,6364,24264,54,3664,744,943,942,38,548,5426,22,94,5664,926,7264,343,98,54,4664,8264,7426,7436,94,984,74,543,236,9426,226,2426,234,43,58,7464,2,726,7826,5664,5464,94,543,54,534,543,944,66,48,643,486,98,744,48,2468,326,9264,968,7482,884,286,94,58,58,468,58,58,2426,326,32,74,3,53,2424,8426,98,58,743,5464,98,84,934,3426,22,94364,43,948,94,62,22,986,64,24,38,98,74664,284,9664,64,9826,334,7426,98,2426,64,626,244,926,526,944,7436,58264,486,568,6464,2664,68,54,24826,248,64,226,26,8264,286,648,7364,5664,748264,48264,7464,54,26,94,586,943,926,9426,326,584,983,4826,54,64,6426,748,584,8426,3,38,3464,968,744,534,48,94,74,946,7264,3364,746,38,3426,24,94,5826,643,5426,524,9264,94264,37,9464,983,2426,58,28,634,736,584,54,7426,54,986,486,948,94,74,52,686,948,244,34,324,26,746,826,936,6364,942,248,26,7436,583,7426,9436,746,98,3664,84,5426,5664,43,934,934,54,242,726,26,386,54264,64,926,768,468,58,3664,43,748,7426,5826,626,26,484,986,942,5824,3,24364,53,38,626,34,48,9426,486,6426,426,92,584,54,646,726,743,634,48,9468,234,6426,72,7426,486,484,7426,74,748,748,948,786,5664,4826,234,548,2264,242,942,248,5464,748,68,48,36,9484,4364,343,386,526,24364,8426,98,26,244,486,74,744,2464,26,48,98,74,94,244,524,542,543,94664,7664,34,54,64,8464,98,968,9664,48,9464,94664,26,68,926,82,468,542,76,948,9826,58264,943,53,2484,24,48264,583,5426,66,5826,7426,94,468,6364,586,7826,3464,58,24264,26,9364,54,74,568,24,43,34,626,24664,94,944,986,424,968,78,9464,944,94,6426,986,944,7826,334,38,54,9464,58264,583,5426,68,748,38,8464,546,742,942,5464,726,4664,336,246,28,786,74264,926,94,4664,38,9264,224,7426,243,934,784,486,38,64,648,6364,78,58,66,3,53,24,98,643,543,944,336,468,944,7826,586,948,284,48,8664,768,94,934,824,324,948,583,2426,24,7486,9426,38,9468,94,6426,586,5426,986,543,98,92,9468,468,4664,643,543,943,2426,5824,26,3426,3364,944,93,24264,38,24,3364,7426,6426,786,748,26,568,524,54,24,74,84,9464,484,24,582,94,886,7426,92,983,53,3,38,74,968,98,224,5824,484,246,9468,9468,744,3,543,968,96,626,968,526,78,824,48,98,24,94,84,94,7464,7426,668,7436,9436,68,968,54,986,626,94,5426,484,74,48,926,76,9426,7426,742,568,734,626,82,586,326,482,9826,7464,726,5826,286,58,244,93,94,786,54,5464,986,244,2364,24364,2426,9426,3426,926,886,9426,84,426,426,7426,424,94264,94,42,24,984,74,586,32,486,546,9426,9826,5426,626,9464,74264,78,334,9464,9826,334,886,5426,736,7436,3364,7424,943,24,468,943,62,4826,526,926,343,326,54,743,343,74,944,586,74,6426,286,98,7426,926,626,5426,74264,736,92,34,5426,748,64,526,26,7426,3364,734,54,93,943,426,486,546,784,74,924,744,9424,334,326,583,24364,58264,26,9264,626,946,54,2424,286,2486,486,6426,744,926,426,78,226,78,9436,98,22,9664,826,24824,986,983,943,3464,2426,6264,94,94,98,526,542,5426,9364,68,54,546,24,724,8426,26,584,583,426,7426,9426,7426,94,726,886,824,94,2826,886,5426,542,24364,926,24364,24,58,436,6364,724,768,88,94,9426,8464,826,4364,5664,4264,542,384,524,9826,24,62,946,484,82,786,983,74,48,8264,9426,82,586,5824,9826,42,78,5426,3426,926,626,526,74,726,9664,426,2264,486,886,9826,343,37,68,24,54,526,426,54,944,942,546,286,3464,5426,98,78,486,24,586,98,326,7486,482,94,48264,586,986,643,73,626,3264,7664,7426,26,583,726,5464,78,2426,426,626,668,74,3426,74,926,486,92,94,726,48264,9826,586,5426,586,94264,7426,4826,743,48264,748,9426,626,26,548,6364,72,584,92,54,743,746,52,74,24,94,7664,584,94,53,2468,326,786,24364,9264,7426,2426,8426,426,5426,54264,74264,268,24264,8264,53,2426,343,62,624,426,78,94,2826,5426,54,54264,38,48264,583,37,742,78,9464,53,234,68,386,384,946,768,646,526,486,54,76,74,386,626,2426,343,54264,9826,74,9826,2426,748,66,24264,4826,926,386,58,78,626,7264,548,9436,242,586,3364,94264,748,646,936,48,326,6464,48,946,54,542,5364,244,74,98,64,54264,28,5464,5264,2826,748,968,226,5264,98,436,824,72,4664,48,968,36,88,37,744,8464,626,3464,486,424,6264,64,568,6364,568,226,8264,8426,9826,54,42,94,942,8664,42,5426,7464,486,98,5426,7426,53,543,724,26,336,336,94,58,946,94264,624,93,934,92,586,94,38,7464,66,78,24826,24824,534,22,948,58,38,92,54264,24664,7426,2426,948,98,4264,58,7464,3426,24,546,7426,5826,9826,24,9826,2426,48,78,524,54,8264,3664,5426,942,242,7426,336,78,743,3826,9426,546,26,468,53,746,268,368,524,646,242,726,5426,58,634,348,52,2426,9486,744,424,368,942,94264,83,934,7426,54264,48,7826,526,43,4264,5464,2426,5426,748,54264,426,24824,9468,8264
};

static uint32_t UTF32_LIST[IME_HANZI_NUM] = {
30340,30340,19968,19981,26159,20102,20102,20154,22312,26377,25105,20182,36825,36825,20026,20043,26469,22823,22823,20197,20010,20013,19978,20204,21040,35828,35828,22269,21644,21644,22320,22320,20063,23376,26102,36947,20986,32780,35201,20110,23601,19979,24471,24471,21487,20320,24180,29983,33258,20250,20250,37027,37027,21518,33021,23545,30528,30528,30528,30528,20107,20854,37324,25152,21435,34892,34892,36807,23478,21313,29992,21457,22825,22914,28982,20316,26041,25104,32773,22810,26085,37117,37117,19977,23567,20891,20108,26080,21516,20040,20040,20040,32463,27861,24403,36215,19982,22909,30475,23398,36827,31181,23558,36824,36824,20998,27492,24515,21069,38754,21448,23450,35265,35265,21482,21482,20027,27809,27809,20844,20174,20174,30693,20351,37096,26412,21160,29616,22240,24320,20123,29702,38271,38271,26126,26679,24847,24050,26376,27491,24819,23454,25226,20294,30456,20004,27665,22905,21147,25991,31561,22806,31532,29579,39640,38382,22826,22836,24773,35199,26426,23427,22238,24182,38388,25163,22235,20851,37325,37325,24212,24037,24615,20840,38376,32769,28857,36523,19996,30001,20309,21521,33267,29289,25112,19994,34987,25919,20869,20116,20799,21450,20837,20808,24049,23433,25110,21033,24456,26368,20070,21046,32654,23665,20307,20160,20160,26032,35805,21517,26352,21512,21512,21152,19990,24179,27700,24120,26524,20301,20449,24230,20135,31435,22768,21335,20195,36208,22899,35328,39532,37329,22788,20415,20415,36890,21629,29305,32473,32473,25968,25968,27425,28023,20170,34920,21407,26031,20041,21508,24030,21270,21475,20219,30495,25165,20960,25945,23448,23569,21496,24503,35299,35299,31070,21017,24517,20853,27668,25171,21592,20877,35770,21035,21548,25552,25552,19975,27515,26356,27604,21463,30334,20570,23572,21363,20803,25253,30452,30333,24635,38750,24314,22827,21271,26410,24352,20196,21453,22763,24072,35768,26465,21464,31995,35745,19988,35748,30446,20809,31649,36335,25509,22478,27963,20445,32467,39064,21364,25351,24863,38590,37327,21153,27835,21462,22330,24605,30005,31354,36793,32479,20214,26399,20811,24093,20146,20146,22797,20303,35831,24066,20845,25918,39118,36164,27714,21490,33394,33394,24418,26395,20256,20256,20843,24220,30524,39046,28165,20915,31505,21578,21483,38431,24378,24448,21306,21306,20132,27494,36798,31038,26435,31185,20061,35774,26446,35266,35760,25913,23637,23383,25925,21697,35758,35937,33457,19971,23436,26519,22522,26381,24102,25454,30028,20113,35273,35273,20687,38498,39134,36828,25910,30707,30707,20247,36710,36710,20505,31867,31243,36716,20849,21315,24335,22833,27969,27599,35813,26397,26397,22987,36830,26415,26415,36817,26684,27982,24178,36816,24590,27493,21488,35753,27743,27827,35782,35782,35268,25289,20999,26497,25345,33509,33521,20105,21151,28145,22791,36896,38451,24555,38598,24067,23613,21608,23447,30149,21326,31216,31216,32599,29233,23548,30830,21602,21602,21150,33410,26681,20987,21830,38472,28779,20852,20140,27880,34429,26432,29238,23384,33251,20934,24191,39318,20046,20855,29978,40644,28385,23481,21333,21333,21333,32852,35843,35843,21507,21507,21476,31639,22352,26089,24341,39035,31163,35777,32422,32422,27597,32452,25151,26366,26366,20284,26131,38543,31934,35270,23578,26029,20035,24433,38500,38738,21021,24687,23432,20826,21322,21439,36731,36136,35821,36234,20917,20030,30343,38065,21382,30041,20048,20048,31456,29031,22120,20889,22242,35832,38395,20134,36275,20313,25972,20215,20215,21495,32423,21442,21442,31034,25903,32418,38463,38463,28040,22270,26143,33853,33853,31036,33829,22686,22303,38469,33268,24535,22812,38656,30342,24038,31350,27721,24565,26082,36865,26174,32622,20122,25512,23621,21015,21531,21253,25216,32447,24351,23458,22996,32456,36873,40857,21183,32771,21491,23646,23646,37202,20892,29255,24076,30772,35859,21916,36153,35848,38899,26597,26597,19987,27490,21527,25214,39135,39135,35013,32477,31572,25932,23475,23494,30740,21016,20381,25353,20037,23453,25915,20225,26696,23519,40657,31361,20498,23616,25237,34915,24895,30465,30465,27442,29575,29575,20005,24453,24402,21307,29577,33337,22855,22855,25252,21355,23681,24459,26631,32618,21543,32676,26149,21709,20173,26576,32454,25215,25343,26045,24613,32844,21478,25954,36319,35762,38450,29420,36131,36739,23041,33487,21452,21892,26657,26657,21451,22260,20165,32426,26063,35841,35841,24778,24213,24213,23401,38761,32500,24052,20379,26007,38477,38477,21367,22992,23553,26500,31449,39564,33510,24046,24046,24046,21051,30410,27966,32039,26009,24322,20363,31062,23467,20081,32032,24597,30007,25928,33324,27573,31119,38134,26202,23459,25143,28216,39321,37319,20462,23064,26408,24577,22815,21010,32493,22659,31859,20551,24494,35797,20260,21018,29366,20848,35785,21161,24449,32988,31455,39033,32487,29239,30097,21360,36895,40784,20302,23460,36864,33080,38480,28909,30000,20540,24576,37070,32435,27663,26223,25191,22411,27426,27611,20813,30053,25209,29359,21542,21542,28789,33647,23556,30417,32455,38470,38470,21477,23385,20804,32610,21171,33719,26087,32593,39044,24537,36149,38169,26641,36861,20020,20271,32946,26222,35799,21103,20805,27704,36130,36866,22307,34880,34880,24377,24377,25308,38647,22919,21738,21738,28304,36930,21019,32993,20064,36127,31574,36133,23435,24481,35752,23500,23612,33539,29699,31179,20914,24681,21733,23547,24694,24694,20572,33391,32929,38505,27874,21050,36848,35874,29615,33707,33041,33609,24573,20365,38745,25955,21028,20859,31215,36963,24618,32819,38215,30331,36935,24656,21776,22530,35791,33879,33879,24184,25490,31616,23425,21319,26816,38081,35282,35282,39038,26449,35835,35835,25381,30691,20919,27169,20315,20315,26472,26790,25937,38453,21704,26263,20080,30563,26970,37197,30171,25480,32943,38632,21344,27004,21628,39034,38452,21566,22863,22266,30382,35686,30002,25285,22920,22362,38454,24544,32972,22995,32034,31359,21556,20961,21513,28608,23457,21073,23618,27954,33050,33050,20065,27801,25176,22857,27785,20129,24247,23452,36229,35851,28436,21327,28246,22993,36213,20184,29677,25307,22799,25484,20943,20234,22971,40065,37326,37322,20142,39039,24405,19969,31227,21361,31246,24231,20248,28872,21345,21345,20029,36951,30011,23627,24744,40060,24930,38706,38706,21834,31471,24466,22351,26434,28176,34255,34255,21387,36156,28201,21375,24110,26494,25442,20399,25239,21320,37089,27915,24109,33402,31105,36214,29275,30003,20185,35823,38047,22359,39277,36814,36135,34917,21338,26234,20161,27454,27605,24310,38544,31169,35895,35895,38468,39569,37073,27583,21494,34382,36733,33322,25511,21009,33635,22830,27010,24196,23707,33073,20171,30422,30422,24207,31206,24237,35789,30561,21484,21484,24594,26538,36305,34385,38752,21619,29486,26354,31508,38634,20221,20202,22256,24198,26049,20114,28781,26753,22253,35780,30701,24029,32534,25506,27468,20056,33945,39740,27431,27931,28895,23562,20241,26379,20856,26550,29369,24464,31192,36867,26680,38596,29256,21202,21202,27901,25481,39759,20992,32570,22343,25671,21917,25964,21334,25439,21330,21330,25324,22495,36801,27979,34394,36880,27627,36991,20511,36766,29273,39069,23736,36176,20104,33293,27934,25196,28286,39302,33328,40723,30427,30427,24040,26495,26448,40092,36755,36941,32905,21547,25321,25321,31168,27602,31687,20860,23130,21568,22969,20262,35775,39592,38517,24324,24324,35802,28846,30424,26053,24215,38144,30142,20420,26411,36132,23389,21741,24202,21519,20581,26417,25103,31080,26187,38889,23682,36857,20239,24536,21095,22868,39030,27833,36339,24323,30555,36763,24444,21402,32451,26292,35757,19997,32440,29664,23588,19976,26463,21807,22068,28207,21560,23380,24369,25240,25240,28783,38663,26367,35834,32763,22622,22622,26757,33310,20025,36190,36973,24311,29087,38597,30103,23110,24217,21378,24211,34989,21460,23581,20964,20405,36175,25242,24525,37266,40664,25317,36843,32511,39029,22885,21191,34903,26124,32536,32047,29572,36718,25265,31383,25235,24223,20912,25391,31461,20016,29609,23485,33832,22842,26460,28937,28508,36259,25269,38534,31526,20044,24441,20465,20249,28856,22612,32602,33590,22374,24425,26361,27888,21497,30784,36884,22902,23506,27531,23551,24739,22900,26195,24680,24754,29467,22278,32531,20908,20007,24069,36719,25569,32437,24033,31569,39278,23815,36158,36158,27946,32822,25805,28903,22937,36187,25670,23561,23431,40635,31283,24799,31918,26862,32461,38519,26480,20559,23396,36829,24713,27585,25588,32431,24039,27178,36855,29240,26088,38386,20439,30058,30058,23395,36125,32858,20159,22871,28798,27882,24551,29378,21898,25140,32439,36879,33931,26512,28010,30431,34180,34180,27530,38459,31454,26071,38378,26611,22982,25193,20801,39550,28151,20711,26893,21746,31351,20057,22467,26086,20255,26725,29645,20419,22025,28902,29141,31085,31085,22681,24452,36141,25293,23610,20280,40479,20210,25346,24065,27927,36139,21551,36317,21149,36784,30423,21162,26700,20166,26579,21381,38024,30095,36152,33618,35009,36805,38401,24800,36831,27839,20139,38381,20391,20391,25300,36129,20982,25429,21809,25514,19998,25277,35838,38393,23614,32476,32476,26479,34913,32764,27741,31245,24840,34013,34013,39068,37034,29790,19985,23487,23487,22721,32650,33459,21806,20542,21681,21681,20882,29926,40614,23486,39764,36196,25705,30828,32626,23546,29260,24688,39746,20599,32043,28142,24343,33756,33713,28041,39547,29425,23391,26157,21561,38236,29399,34701,25298,28193,39608,24807,29976,32899,22521,20896,24443,20117,20426,39554,35302,35746,36182,24616,25630,20208,24685,38548,29237,26391,35814,35793,20928,26525,32321,20384,28014,22859,27719,26242,21525,22870,24189,22402,32784,27941,23466,30473,25106,21862,31614,37030,23472,39047,35759,20276,22766,28784,24080,26152,21385,31821,36143,36154,24815,25361,40481,22856,20240,20598,24796,32966,38491,28129,26059,27784,27784,25026,20973,36744,34411,23731,38556,20493,20167,20167,33831,36777,26364,22934,36171,21346,25260,20223,20538,36212,27849,27773,24149,25773,24674,31481,22904,38646,28526,21574,26388,21002,31108,26705,23608,27748,40483,24188,24708,25764,26025,28814,40763,31661,24904,33633,27867,37101,32553,25206,33406,36192,29595,26127,26144,33136,26216,35946,35980,36203,25551,23721,34955,33016,27744,21220,31077,38582,31302,31895,35010,33655,20937,30151,27735,36126,24429,25935,23492,31199,29190,21696,28070,33298,33151,20876,36720,25513,31069,31096,25720,24518,20607,25250,24604,25668,29287,19993,32490,36924,20613,20047,22534,24218,36741,30631,23574,33891,24785,25200,36235,38886,40654,21705,20339,36820,38405,23624,21520,34203,22280,22280,25195,39537,22696,30862,21523,20272,21170,21170,20911,38182,24944,32937,37257,21097,36870,30416,37011,36882,31881,29301,36797,36981,38518,32752,23495,24742,21796,36965,33368,33368,25166,25166,20094,20094,21467,30896,27745,20237,21465,23792,39280,20329,32469,28291,24908,31946,21305,20266,33145,25402,24187,36753,25746,36148,27877,23186,22764,24935,20180,20180,33900,32990,20062,20141,23576,30721,27427,37051,24651,36742,28966,21987,20052,21576,38669,25311,31665,36291,20183,33714,35206,38145,32701,21688,38138,38506,29228,25098,21247,39128,20179,35803,28459,22839,24735,25776,24868,36745,28369,28369,24133,24265,23429,19992,23493,33351,35861,26580,36842,24357,25169,25758,23544,32961,33606,34507,24051,39057,21804,30719,22865,33150,25554,30861,20648,38155,40836,30462,20861,27905,26691,26389,34945,39184,24808,32489,20754,39296,35855,30952,25628,25302,21187,33311,35786,35947,39575,32874,37240,23663,23663,32508,22561,22561,20111,29282,37492,20975,26132,39063,27542,24910,22805,30328,26609,29995,34966,23476,34928,34928,29748,38108,33485,33778,28082,26690,24858,30683,21169,22841,27463,25342,32736,22570,36394,21106,30130,23449,25504,28378,33098,22475,22475,37193,20304,27450,21359,20133,25417,22915,35880,34503,29380,36138,21388,33922,32781,24085,25130,34081,26575,26575,21048,21737,40511,25958,28330,28330,34542,35029,26421,21254,31209,24246,29454,29468,27807,37009,28034,24344,23828,36874,21163,36300,33616,23528,36341,20957,27973,27973,36758,22369,29436,29298,24490,32933,36898,35825,25276,22363,29627,20390,24524,24700,38054,38686,27985,30031,32705,27575,27575,21351,35810,20002,38190,20857,36530,36330,39269,37066,25581,37038,23653,26530,24422,38712,24724,34560,31363,24917,20940,25100,25233,26707,26800,38654,33218,25314,21340,21340,33883,27987,31040,24833,36151,33033,25463,23244,38420,38795,25320,33392,39542,28418,40831,26885,26012,22675,23626,29942,29123,29408,21676,23631,23631,29241,38485,26118,21648,39536,23490,36776,19995,30127,31295,36767,36767,23725,21058,36785,36992,35272,24125,23609,33104,23521,24748,25941,35465,23233,31232,21066,21066,38391,29081,31890,26044,35140,38050,25645,27993,24509,20806,38177,25096,35910,20457,20457,32434,32789,28009,23439,25187,22952,28044,21535,31609,40736,23068,23068,36538,40575,21195,25159,26020,25243,30887,22974,29066,23849,30140,25970,28180,32416,24222,24661,26262,28595,24658,36923,24339,25380,28155,28860,26179,25644,20504,30408,28248,32922,29482,21329,33495,27844,26612,29791,29916,33538,35878,36808,28866,24367,36367,26799,38160,36198,33579,35772,25331,32768,34905,31109,31109,38075,23777,37057,38425,20900,22916,24473,34383,32791,36712,21534,28139,34398,26454,25658,33039,27754,33285,26021,23234,21621,21621,25114,35877,21545,25995,23456,32670,21514,22043,32928,32925,36735,38613,28287,29756,23047,26114,24358,39031,27779,33286,29483,31548,26197,28504,23035,35811,21246,30871,23039,32499,29392,32908,28170,38605,24248,21544,40718,21943,23002,21193,27589,36180,38742,38599,23649,36328,27875,20652,21331,25830,30044,30044,31293,31293,32441,28431,22949,22986,22218,39286,33452,31348,25238,23016,25259,28448,26097,20181,28363,20083,33292,32483,28404,25153,25153,28006,20474,30246,25199,31469,24809,26522,20011,20698,28072,26230,20846,35475,37228,21767,26228,30123,32959,32982,25810,25304,31929,25102,29028,34109,24330,39295,27424,32842,31104,33329,32932,30165,32541,38901,20864,24598,40527,30196,22635,40077,32472,31958,25197,21155,36194,32564,24062,37239,35845,25198,36145,30086,40560,27850,32856,33437,30913,35806,28954,20356,33740,32544,25318,26420,26420,21413,32445,26607,28809,28316,25220,36225,32827,28212,34900,26723,32597,25340,38829,23094,33970,20506,31186,21280,22840,21693,21693,23703,36920,20254,20658,25379,39072,23507,25366,20018,34562,39037,28192,21861,29306,32724,23648,24043,31389,20800,36740,21047,22336,27516,25377,32902,35858,20989,31807,24736,26172,39281,33395,39556,28748,23043,23517,22368,21093,21093,30529,33108,24266,28059,40548,32617,30406,22234,31072,34893,25172,38539,29827,24088,28891,36172,20945,20872,33769,40863,23219,30496,20440,38057,32501,34957,33503,26092,30284,30284,32824,29421,35784,38464,23004,24460,39539,36713,34115,36974,33988,27185,29618,34923,21290,25384,24034,25286,32420,32420,30733,32974,21422,26588,26588,21734,21734,22771,22771,25797,38125,23156,38083,22065,31967,26827,24426,23615,23615,26477,33576,21416,21481,24871,39282,36140,32918,34935,39076,39076,20463,39588,36910,36926,26286,24208,35060,23194,25447,30021,40667,21912,30697,22346,26829,25273,32963,26438,33152,33152,30385,29245,33673,27687,35850,26564,26639,30418,23381,36524,33489,25688,21756,21756,35829,28393,38046,29503,29481,20667,21365,25329,22616,27595,20898,32482,34218,30865,25405,35885,20136,22564,22367,21890,22918,26543,30504,30447,39048,23138,30460,26834,24822,22199,24841,32954,26825,31143,38553,38684,22353,29004,23830,23830,28020,35044,24825,21563,27675,33261,33261,21557,24691,25424,38383,32709,25042,33014,33180,24826,31048,33308,34588,21215,24936,20923,21897,27873,37145,21449,20137,38039,25826,33030,27922,21947,30634,31398,29980,24091,38592,38592,26874,30690,33725,26001,25296,27994,27994,30702,23020,28389,31570,34028,30805,30636,38149,21472,24086,22774,32433,34216,22418,39745,25703,34425,34425,26517,33541,20461,34678,40607,21098,20932,39042,35961,20447,36893,35766,24245,25496,31165,26151,38414,29492,28548,28548,21281,22609,21505,21505,33026,20282,20282,21256,38593,28382,28422,20054,26106,20621,40493,24380,20518,38136,33181,39041,27495,23591,35854,25856,26869,31903,21182,20177,30610,35856,25947,39062,20513,40517,25784,23803,38142,25101,27465,22880,39578,21410,23462,26685,24055,28322,25087,35889,35065,38476,23451,35059,35059,32538,29022,32960,39559,29831,33034,34276,33805,27036,20820,35033,21999,21999,39540,21650,36186,36186,25949,21400,30591,31161,36751,38025,21672,28976,31563,36929,29585,33426,33446,28147,28024,24653,35773,33046,30450,31287,35449,34850,28107,24623,21564,25745,37196,30679,27900,33889,26505,27838,31388,21700,31446,38416,29747,36144,23167,30347,21049,21049,28108,36134,31896,31896,28153,21208,30519,29422,33678,33678,31095,27498,21769,35884,36527,25022,26646,26646,25386,29356,21038,35064,37045,22075,38035,25674,34647,20392,26775,25487,22958,23077,21119,21119,31177,22581,33738,29814,25299,25299,31364,25996,33086,29226,29226,25134,38055,39304,26247,26447,28113,21880,20024,28845,23617,20976,38753,34249,34249,30606,34388,39748,25282,33796,31491,30244,20305,24608,40486,30585,36137,24596,38604,26023,31397,28525,22323,21414,21414,27609,29611,39551,20995,39292,21368,25601,20901,32453,26694,20522,31171,38471,32652,23913,21486,38126,22931,39053,24867,36764,30776,25558,24643,26188,21078,33722,35088,33976,21128,21736,20817,32516,21596,22756,25749,21683,21683,32673,26191,35820,30742,24676,25527,25684,40510,26848,21891,28053,35692,28392,28342,24041,34432,26224,22549,33334,24199,29943,21884,34384,26729,32465,29642,32485,22066,22066,29808,26803,21311,35763,28085,31726,21888,22930,25975,32829,21713,26742,26786,32475,32428,22435,34281,22350,31267,31515,26177,36159,28949,21895,26257,25472,33162,26635,21380,35892,32930,24432,32996,25615,26214,21710,31528,38053,38053,26103,20828,21653,24070,26666,23633,36481,35871,36174,24813,20725,28079,33641,36724,36724,25387,37026,31605,22862,32831,20323,20991,20991,30860,32496,32496,23071,36424,38497,33146,37041,22874,21857,25423,28037,30651,20521,37232,35809,31373,22882,35800,25375,25375,31377,30415,35824,21248,35853,28120,34433,27764,39749,36386,34299,23089,26647,24609,28799,31291,35755,26429,22372,26842,27088,34164,21727,39287,27815,37255,34746,22404,39558,29038,25305,26704,33433,34924,27836,39336,30008,30036,27146,20398,36466,34453,36771,25605,35269,26894,26894,39548,23273,24359,35098,30699,36255,35875,25950,38665,33993,28601,28601,21927,32504,27067,21647,32442,34593,27526,23477,21273,21273,23421,33643,29409,20918,36838,35868,33125,37122,38475,22114,28372,31292,24162,24162,32592,32478,27803,29100,33167,21703,32958,23013,23013,21350,31258,22604,27762,21719,27822,36162,22365,25414,25376,21646,30933,36943,36163,22013,26792,24428,33455,20387,35857,33529,33529,25438,21485,25443,27978,31957,36804,23697,36752,38797,22079,28796,29835,25942,20431,36989,24666,37048,40142,21654,20285,20285,35032,21860,26194,38394,25315,21983,21983,25032,24575,26093,35749,36168,27974,36299,24853,26060,19984,39056,23408,23241,34693,23113,30068,21024,23518,38902,28205,29788,30722,32533,27852,27852,38384,28790,38660,24501,24501,36887,27832,21671,35028,30505,20731,31751,35090,33804,29863,33192,33721,37221,36420,27819,33661,20127,20127,24974,33639,39050,38662,38504,36393,29279,38203,28865,26015,27713,30566,26198,26413,31735,33109,40158,35819,33777,30162,40140,33011,32517,38094,40668,26531,21068,34065,24764,27965,27899,20979,30355,38639,21489,33203,35776,28251,34885,21480,21480,33550,27814,29281,38446,32446,31066,27891,24682,24726,25721,23696,40499,36845,27513,22869,20885,22443,29432,20547,35167,35815,32728,32903,36917,25327,22122,28437,40843,36757,39049,39049,20478,20873,21971,22204,22204,28818,25912,31487,34430,38085,36142,26629,26629,37049,21283,38180,25735,33640,34092,20565,20565,32568,27975,40120,20325,25319,25602,22070,24458,27916,23706,36891,29157,28183,28346,28346,32999,35938,38225,23596,31908,26840,24013,24814,20525,24278,34527,27264,23388,23884,33255,27603,28572,38062,25597,27712,20495,24119,32502,22378,39553,32494,32512,32526,24361,36454,39654,32735,32735,20472,30242,30629,30186,21980,23679,26891,24092,32466,27769,40637,40637,20045,31041,31166,24275,20717,30338,21471,21754,22829,28900,34523,34121,25401,27060,39535,23789,38389,30079,29712,20278,24951,27280,38772,26441,26441,24789,36749,30562,29734,28821,20360,39144,29006,27902,27189,30596,37247,34631,37259,21949,30315,20446,32641,26797,28510,36894,37195,29626,33905,29459,20985,25212,28065,28065,32110,31391,28577,27428,31229,38816,40638,26332,26212,33821,20319,32521,32521,29993,39059,27778,32386,27777,37085,32997,38230,29266,32491,33499,27774,22466,35905,35905,35876,31063,22525,29723,33469,20442,38808,30684,25494,29020,21589,29730,20456,32532,21584,21584,24811,24140,32948,39567,28174,31546,38189,32554,32554,35826,32834,32503,27631,25170,25170,40495,25788,28800,34074,34074,26791,25119,29701,24717,38398,29989,40522,38400,32518,33600,38397,31909,21957,21877,31782,26011,28335,22403,24413,23604,36837,22334,30597,36732,24636,40509,38552,20130,27664,28218,39635,34067,38417,27682,31313,36155,40687,32438,36743,32964,27792,31520,23822,31914,38678,33464,30879,20834,26898,36851,40515,26865,39699,25545,25306,25306,22179,24472,34948,25370,32774,29705,38533,27818,35881,26406,25139,33589,33147,30126,22438,27268,30899,34633,23044,38428,34809,29711,22446,35801,22047,35311,36286,24148,25441,36173,21866,25062,21670,25371,28851,37219,29384,24675,38121,31659,21985,20955,31783,31482,27014,22317,31384,31513,25571,26000,20274,21679,21679,21679,23158,23265,32462,26771,38789,28073,32714,35074,34972,37321,36802,24751,25179,25179,20355,32596,39276,21815,30827,34837,21397,31087,27695,29738,32419,23480,22687,38892,34122,32772,25421,33806,28068,30758,25034,23784,28003,34866,28540,20984,26837,25880,24455,30977,28847,20694,40858,24103,24103,31922,37233,24534,33278,26632,26728,21822,33436,32745,21908,21908,23461,25578,30251,23386,26355,21658,36193,30420,27863,29822,29071,20389,20389,32843,28210,31729,27617,21348,27760,34926,26604,36944,32690,23525,38026,25287,38262,21310,21310,33210,26122,21553,28861,22852,32633,20238,22661,34015,24254,28197,32942,25335,33179,32558,22016,28654,20318,27688,38392,37090,25160,22741,39584,39584,33071,33071,37213,29923,25341,25341,38080,22737,29417,24530,24530,29502,21988,27961,28467,30116,26925,29787,22804,32509,25722,27099,27099,38181,27983,39711,27670,20935,38179,24161,34442,23418,29312,25806,36427,24913,21643,21643,21643,29060,26999,28907,24581,19989,25332,30967,22275,28071,32920,22545,30710,36841,30655,30655,28100,27133,34949,32535,23729,39285,35863,30511,26727,22030,40141,31503,27572,31713,21627,35882,28487,29786,33899,29750,34137,40100,23252,35852,39545,26207,36195,33479,26017,25203,25203,31494,39544,25507,23504,28196,24347,29232,27837,29956,29495,24641,24641,27063,35867,20993,22484,33492,36361,36276,28952,28952,36401,26916,36761,36761,38649,22434,31289,34434,33421,23267,34676,23769,27529,20430,23835,25325,34521,35864,33002,28293,23305,21972,24321,29313,22124,34758,21742,20552,20552,22040,33275,35109,37013,35114,35114,38774,30768,20718,20718,36840,21636,23045,35281,25822,39533,30192,26280,30201,28810,35048,35048,33335,30928,21242,30897,28373,23254,31786,38670,22003,35844,22576,35808,33134,34784,27233,24407,25600,39316,32010,36856,22108,37218,25303,25303,31775,39534,39534,31525,30970,25249,22366,39045,31162,24756,33216,23270,36756,25462,36875,38049,24698,35840,24794,39663,30414,29632,31224,26196,34516,23630,20291,21549,21549,26462,38064,22809,24578,22134,23700,36161,28640,35769,34993,21571,24696,25874,25874,25288,27553,31550,26464,33003,31584,31584,36364,38045,38109,37550,29435,29261,22955,32938,28067,28297,26551,31964,40595,33008,34814,26541,33909,21076,36146,36146,38120,35879,39585,25523,34183,23351,23351,20051,27667,27667,24571,38041,31382,35860,23146,26943,29053,34581,36441,24298,28518,28518,24816,28921,20558,30106,25769,30732,30572,21657,36487,30917,30917,26688,30239,34402,32986,32458,35817,33453,38191,26643,28889,23853,35865,33540,38031,21533,32424,28051,36877,32495,28270,28270,34224,27607,20645,28699,28388,29076,35767,31518,38827,23387,23387,28325,28255,28096,32895,36184,27249,21269,38044,25234,34914,33795,40550,37071,33592,28186,20335,21990,31579,37238,23782,25534,28626,23100,35301,25422,32510,36292,40536,40536,24527,40480,32716,28095,38052,25467,31378,28888,38887,40485,28465,28825,21294,28075,26974,20887,32421,32421,34022,21992,21992,34108,31353,34558,38130,28552,26601,33564,38074,36405,33018,35862,24337,36343,24548,34584,26539,23092,21342,34835,36738,35822,25247,27523,31607,34942,38495,21441,20396,21005,25619,31637,37095,29749,29113,34876,21536,38210,33729,26166,36779,31319,37300,33333,26137,39290,24684,40660,22850,32793,32793,38069,22024,36362,34505,24561,22697,25772,26482,33785,28843,36347,21501,24980,25373,25373,31686,34962,21059,35781,28046,29854,25774,30813,33830,24665,38422,38422,26686,39675,20492,37050,21974,38202,39563,31264,33519,39253,38601,35925,35812,21550,29469,27197,21510,27795,34261,28132,27257,35280,21277,35887,33593,22954,21522,30235,28062,38449,27521,32546,26329,20649,37237,37075,39036,36169,26805,34873,32537,38113,36344,35294,37039,32429,25035,24319,38067,35869,27739,23536,27216,30520,29462,21165,22158,25150,36433,37226,33502,31961,35837,23625,25410,32697,25794,22496,27462,26359,29322,20332,33508,28227,38409,32552,31499,31581,39589,28689,28689,40516,40516,28953,23210,20742,35796,28294,35930,21321,27964,37294,24971,34506,31071,35873,30746,24420,34770,29736,29080,32718,29997,27308,38713,33735,24214,28844,30350,20149,24760,32580,20939,34541,33545,33660,20822,39739,29634,30072,40521,20050,30358,21828,21595,28189,32327,32327,32327,32907,30522,34047,36460,38148,36711,36711,34849,31860,31921,35872,25542,38675,29761,21780,31531,38114,38893,30518,21868,38385,27766,33884,32560,38223,26722,26623,21617,21617,31204,33099,26483,24845,38607,22935,28435,29549,21913,28102,29934,22674,31568,32557,39612,28088,38466,38466,38466,22942,35056,28121,23780,23780,30270,33323,21632,33276,21827,26027,36324,40605,20432,39591,37000,29166,33626,30154,28195,36836,40542,38178,29742,35798,36382,27788,30923,30137,22654,23159,35970,26851,35400,21702,34946,23723,24699,28359,29134,22539,25479,28172,21417,28063,26708,26708,28617,37169,36995,22052,35754,38567,32427,38643,24838,34134,24730,22820,30633,38197,24224,30590,21677,30073,36315,39618,31629,28390,33852,29781,29906,33105,31462,20120,36188,38421,23195,27586,39751,33454,27988,26165,32753,25413,40653,25620,37995,20454,35779,39279,36750,27117,30141,20314,31937,31937,30178,26244,30294,33620,22300,22300,31098,21939,21939,24209,21623,21623,36423,29536,32742,33743,25004,38402,26342,38220,32660,22777,21206,28052,25488,28237,20710,33948,30956,36759,36759,21799,21263,39621,33669,33531,33559,34553,27082,31459,39560,27893,38589,29669,27225,25530,25530,33463,33637,33637,33828,26279,35787,27539,20556,36728,23057,38224,38224,28118,24591,25663,26003,35827,34752,38058,24545,29107,33412,30922,27986,23413,24541,38610,27813,22725,30437,30260,22017,26297,38048,21117,32549,21766,33300,27684,34484,37295,34412,28908,40150,21604,24090,33484,36160,31496,28173,29619,40529,39074,29394,29922,34103,36897,27698,34656,39052,21725,33043,26161,30027,23883,33575,33217,36372,38541,38156,36303,39683,29159,21638,30264,26133,22257,30782,25161,35804,40488,21956,21956,26164,29002,29785,25294,25294,32609,34268,30133,28925,36834,29463,29243,29032,30153,40859,36426,36426,36157,27796,25374,30405,40594,39582,34174,35794,27204,21674,27950,36722,38112,23524,25132,38115,38115,28478,31869,24132,20147,35807,38159,23162,29330,35839,22922,29406,39607,24779,35866,27224,37112,38152,32987,38624,35886,30571,24328,39314,26333,21757,38442,28126,27955,34794,21405,22121,35846,21883,38396,21981,28103,28698,23445,24820,39060,22349,35203,30789,34980,21792,24774,26231,29744,24642,38226,34526,25577,26066,25000,37306,30113,24439,24999,36918,33682,21852,34451,23762,23762,39313,32945,34256,29527,30302,28371,20258,29649,24792,29390,39252,33688,33688,25457,35014,40071,34583,33009,31392,34563,38801,39761,25256,22103,38029,34223,31906,31368,34162,36886,33307,37340,28267,28267,40535,24081,30875,25352,20458,33465,20164,34474,36381,20372,39333,21493,25292,29401,33659,39562,21863,21846,23318,28947,30344,34360,30402,20500,34548,27227,34578,21903,21903,24703,33862,34006,24875,29042,34838,30855,32923,32474,33694,33694,27053,39309,21274,21274,38588,29140,24331,34978,34468,20520,28558,38831,29623,38460,30399,37576,21714,27996,26384,30240,34444,25290,28028,32566,20451,23157,30910,23938,37043,38657,38701,32688,30778,26987,29740,21652,40557,38406,23072,29270,31049,25225,32486,31800,35962,27781,36418,39649,29477,40075,40501,38411,26331,34798,32559,23735,23443,33450,28101,40669,26693,20267,35795,21634,32507,33222,32555,32497,38036,25326,27084,30757,22872,22872,27957,26051,39312,36479,38170,26052,30105,31668,38780,21886,21965,31567,20421,34472,39600,34473,31889,27001,38771,36500,24493,26485,31207,22007,21675,31530,28134,23360,29277,39297,31598,34513,32792,32548,40556,31539,21970,21970,22849,21358,39317,34467,34479,34537,22338,37738,27733,23534,40490,26209,23125,25466,23869,38079,38079,32838,25077,26979,35022,33759,20375,20375,28238,27606,30249,38387,28751,34532,34532,35816,30609,38208,22391,31756,29030,25899,27694,30164,33473,38404,33320,28228,21684,20311,28828,21735,32628,33670,21961,34690,25730,24716,38255,31900,36323,33348,30857,28822,36282,35126,35126,35833,21899,34321,26976,34943,24508,28792,30111,30111,27207,24582,38415,38415,24384,30413,25549,27167,24005,39284,37282,40840,40840,21032,21032,35847,36911,33107,39747,20524,35894,34222,21622,27481,27481,28458,33296,31068,32687,37019,24864,29840,21996,28049,23218,24614,36869,36726,38089,32737,36902,32607,24806,20603,20603,40672,20608,20608,28061,25781,21969,31381,34930,38209,34579,27524,23724,33789,37108,20073,29852,39067,21698,39301,33551,27859,36179,30623,30643,26345,28425,23059,24763,21232,38403,38042,31492,35274,33603,31968,31932,40842,33040,33444,28598,28655,22163,27016,36346,37290,27012,35070,36470,21995,29935,23879,33445,23692,38418,21989,33114,35068,36314,22656,33636,20467,22925,38718,31344,31534,24701,28514,36945,38199,38551,38214,39181,34999,40720,39143,30231,27538,40489,36760,39122,40766,24812,20769,29043,21659,40655,27073,32973,23049,40072,31544,31672,21347,26665,40497,31509,31524,21000,38157,20508,37154,27918,33983,40070,23224,22313,22313,33748,21919,28641,32985,34481,32696,28125,38143,20367,38413,28583,29647,35039,21905,23402,39616,21072,31601,23991,27028,31983,28182,33336,28074,28805,23090,22821,36461,27035,40715,23428,40551,26269,34952,28354,24365,26873,26873,34638,25672,30168,39543,25279,28938,36189,33005,34619,21014,34544,34544,27896,21591,21591,34471,22239,27825,31423,32543,26238,23786,24949,24123,38201,38836,20526,33784,28203,27742,39307,25284,34259,32957,35790,26633,32755,39753,35750,34417,34512,34615,36495,40132,27048,30640,38217,40104,23673,21870,25642,34763,34426,25420,29614,21006,23847,33515,33728,39272,37017,21500,38377,20433,37167,21587,37054,33505,34431,34500,21624,33967,38200,30042,25194,29999,32540,24079,36357,36357,39647,23114,31252,25616,31498,20606,30872,38423,28538,30826,34843,22433,23702,40700,39606,23319,24683,22427,22002,33483,29783,27812,30043,40552,32823,25044,28457,40729,29657,38021,32513,38128,38256,31893,37124,26758,32725,26726,32625,28610,21722,30669,32547,38096,28015,34427,31485,34636,34191,27103,27103,35271,35271,29996,24639,32983,29969,22383,37094,22051,22094,28243,22953,35888,33094,28128,28904,39125,34568,21053,33809,32556,36170,30115,27887,27679,30152,29566,20190,34826,35747,33914,39319,26586,25001,32578,39757,26252,39078,26577,26964,29864,27183,36302,27998,27198,26941,33491,28064,38576,33841,26054,34623,22716,32989,40518,28353,38184,39300,23104,21264,20988,27159,33000,30066,30066,38704,33260,32915,30798,22665,40563,27086,27527,26070,38061,32581,36457,23916,39306,35115,24061,33470,33470,25275,25516,33580,33448,38390,38819,35830,30250,30589,38028,21964,39275,38412,40844,33226,34476,38078,33642,35591,32520,33140,34649,33705,33705,34547,37210,33456,22962,24229,25893,23755,33439,25786,30449,36205,29424,22159,33353,31079,38243,33449,22999,34691,39617,33423,33100,38473,39129,37061,35105,31901,28319,39752,33407,38043,38802,27870,31809,39727,33431,40131,23075,30209,33527,29971,34510,25682,33219,21286,38192,40553,40838,34343,38408,26096,25122,40785,32939,38051,22271,30545,31699,22123,33537,21411,32481,28977,32506,33339,25929,23704,23882,30472,40841,34071,23896,29733,40555,23348,35042,21539,28338,33724,32951,33631,20643,21840,34428,39123,29590,35836,24203,31203,27057,25909,31655,32315,37155,21950,33793,25419,25419,31537,21261,34204,39273,28944,20348,40587,32565,32666,29325,28874,22116,40837,40837,30471,33524,24488,25652,21057,33154,40066,40503,23081,23081,21164,33873,39293,23230,28820,28820,20647,32524,30883,21343,27029,22055,33720,33901,31705,28950,22535,30457,38162,25733,20039,24846,28766,30653,35765,38633,28000,40717,38804,40702,40702,34241,33169,26928,33803,37190,36434,38579,38410,25248,27971,32464,30867,38514,27015,32669,31067,29548,34586,31174,34001,22831,22831,21389,35890,26492,25474,33451,33441,26526,38198,30319,22014,30361,34148,27740,36331,37103,37118,27872,30720,32411,36819,22281,22005,24186,21317,23961,31155,34762,37301,27782,27908,34443,37079,37079,30604,30010,30010,35057,40574,33390,34003,30568,40538,39628,32924,35778,25121,31636,28244,20115,38204,36345,30353,39546,35120,30544,33556,40727,36185,32810,21661,23264,40492,34460,31933,26638,34480,33280,20971,39274,28156,38084,30761,30761,34545,21586,21586,25358,25709,26584,34496,21994,36280,22031,22031,33848,23748,23860,23860,37230,23838,40540,38671,33419,35764,36409,38037,20233,34461,27690,40839,30624,40554,28625,37694,34502,21588,29920,40835,34941,34414,37834,32457,40482,35124,23714,28078,30876,38606,33331,27047,38739,38739,39576,34921,35977,35977,35977,30307,31405,38107,38107,27135,40677,30024,38194,40533,36318,20369,33476,32515,26507,27122,30489,32545,32900,23899,32679,33507,23870,30187,36211,37293,27686,37207,26115,27681,32166,27546,39214,33683,22228,27653,28855,35099,35276,30174,24870,29977,30759,32539,26544,35278,26062,25041,38185,30300,27522,29088,30755,32530,40524,39066,40681,27929,28177,28177,30806,39271,39271,32519,33282,21537,38153,31411,23052,36349,24601,34303,37150,32460,31404,36932,31352,39633,33148,26634,25109,29706,26451,26451,27689,35004,40143,30129,29673,30718,22441,27753,39661,26302,38757,24697,20189,33816,32600,25115,23397,28975,21606,30179,20925,30083,20060,20060,34309,30765,29048,20716,40078,24731,27032,30208,31366,40584,22244,22244,40107,33761,24925,29805,24529,24528,24747,29722,21154,38196,22432,23377,39579,34739,37036,30016,38433,36909,23281,26094,26199,33370,39315,27017,34445,36199,27104,22149,29824,33776,23033,31576,25963,38259,39601,39601,38891,32550,32498,34779,24832,32962,37846,21845,36994,26721,23814,26767,40133,22028,33001,32417,40096,24296,29865,26990,36968,32786,35891,34733,27278,36287,35466,32850,36468,33704,26095,32806,28849,34511,22314,31657,31943,25661,32561,26440,40506,32514,35315,36311,36980,27728,38129,34486,40151,30729,20747,33425,26932,38154,25528,38166,31400,31400,40832,33007,23781,29096,29096,23411,22331,27092,35916,21084,26378,38187,34345,40513,35390,30807,31360,40063,26608,31755,26881,34520,33486,27811,29224,36952,22318,38834,32523,22387,30932,22994,32529,35137,21712,23011,22947,33770,34326,23745,36821,24408,33733,28829,33422,38158,31709,28864,24629,29940,38251,32703,23810,37274,38124,25520,34152,35043,38253,20312,23256,29109,33418,29551,26141,38207,39574,34044,34044,23346,23221,38379,36881,34181,22073,38175,35017,36332,33375,40502,34231,21721,38171,34597,37518,21695,21775,32941,32638,38027,38890,37283,27898,34106,26702,27449,32671,33482,33037,38173,21668,22046,23632,24192,23394,26547,32956,33359,27674,30829,38059,30030,39320,30764,27000,38165,40081,21370,33284,24906,24906,32927,30743,35091,34719,36273,35955,26592,40498,25632,33405,23000,23250,35174,33897,34169,29520,21691,33281,23733,25694,22948,20342,27447,33342,25486,32448,30900,21879,33798,34546,34769,38063,22105,25094,25094,33327,30490,29825,22061,26487,26112,30749,34670,28911,35788,35788,25532,31706,29517,40561,29484,35082,28493,38585,38235,30054,36150,40699,30737,32808,29924,26549,39073,22140,38105,28557,36955,39568,40504,35026,33627,31255,21579,23919,33332,39549,40505,25638,24450,24084,32741,21089,21089,29316,38252,38698,35045,29367,24406,32119,38174,37775,29662,28919,31559,26474,32616,21777,23901,29967,28997,40091,21869,26818,30712,24249,32551,31868,23046,20444,33765,33820,37194,30112,39557,25334,25334,32450,27791,37187,22419,23005,33807,40514,34233,23811,38032,40103,25155,36310,24603,39040,27845,33752,27051,40491,34567,31074,21499,23854,37950,32835,38116,38116,36294,22276,31742,33384,33750,27547,30800,34731,34731,26585,37083,39581,23589,23708,34612,30779,21761,36868,22558,25540,28327,33645,38231,28536,30775,35292,35292,32796,39715,22348,33718,23409,23409,30874,21759,23654,27696,21526,27886,39079,20517,22265,20350,30117,26533,22482,22482,37231,23275,37220,38221,38186,34606,33997,28409,30259,38034,23586,23586,21808,29050,36425,30157,38164,26636,26552,26552,21043,39130,30136,30136,26503,34485,34485,20394,33493,26444,36228,36228,23143,38238,32488,30207,36398,40069,38066,32750,28532,38023,38222,33757,22489,34364,30777,33583,20213,33557,28140,20588,27752,26982,38212,40157,32896,24283,29450,22241,20666,28383,30184,24089,35842,37021,24124,34684,37225,39586,34884,40578,33313,36464,33416,36277,36277,27160,30180,24568,30844,27895,27895,21667,27296,23924,33760,24722,40114,25783,23844,23844,31658,32873,27894,38206,21590,29461,21941,36946,23743,20347,38151,24158,20163,38508,28859,37241,35290,27562,30738,22553,25633,22100,38163,28367,38747,31718,31902,33044,21673,40547,24469,27889,23260,27953,28386,40864,33176,32468,29951,38213,33615,24733,24733,24749,33978,40095,21593,27237,21139,38516,37003,38168,36485,22395,22395,22509,25816,25599,38188,29882,33355,39303,25015,38073,30695,22104,31645,28337,28337,38434,23741,40520,36284,22405,30796,27943,40084,21811,27722,33490,39580,32525,29343,24617,23846,25482,23715,36413,33012,39730,36167,25518,39627,30791,36387,28905,26590,26590,20393,36717,38102,39055,26740,34728,38237,30204,40519,34632,30468,37084,26720,31697,34570,29641,30233,37060,40539,29474,22959,40526,34091,20200,33630,29682,29682,33211,35988,31959,24047,33585,29426,31644,25808,35097,39311,20263,26946,26946,34573,31923,27571,33500,36721,25665,39571,26689,36416,30744,38426,26536,39659,33460,31028,36383,28343,32432,36147,37044,38082,22251,29152,20821,30502,31722,24574,30146,36244,24554,24554,30535,33480,24130,26755,38056,33696,21889,38068,33607,34749,29364,24580,36730,36962,31692,29640,25908,28340,27883,22329,27021,30132,26864,33325,31681,22129,33137,35978,29431,33314,38193,39610,21200,22261,37275,21878,36723,20261,26697,38147,33632,33632,34107,33628,33160,26594,29286,38131,23915,36399,25753,38484,37177,34000,30271,36396,30802,33553,24589,36725,31564,24619,24619,38146,28486,32425,38242,40098,33004,25669,34569,28867,36166,27459,30751,21037,34490,35335,29602,29602,34079,25394,38250,40761,23651,35751,31059,24457,20336,27533,22396,38536,26520,25524,26911,40117,29379,34594,36476,22406,30268,33133,31262,35166,20251,38218,25449,24558,26876,22560,26624,39688,40583,39673,27635,21823,30780,31941,22520,33907,39552,39552,35973,26743,24557,21618,22913,31046,30881,30881,31213,40118,33638,33581,37063,21896,24579,30554,31808,20317,40649,39070,30102,32449,32527,29423,34735,22379,30748,22516,25590,24476,40632,28638,30964,31602,33074,30531,31211,38133,30232,21056,36729,30565,30565,37261,29838,21055,21716,20361,35275,26589,20191,22445,40149,28312,23641,32459,37099,33692,30224,25453,27981,27981,38228,37198,21825,33715,33706,36496,40748,33716,30592,40112,23611,20723,37040,29295,27947,24243,30717,33617,33617,31632,30109,21726,26937,26937,38076,34659,31717,40159,33542,22319,30839,33588,38093,37264,21795,30372,21715,25190,30183,33932,38664,29489,28463,28463,27672,38119,20743,40109,33068,23048,30700,22528,35913,31654,27176,31660,20616,40110,29377,33548,22092,22092,40138,35893,38461,38461,31656,29177,38161,37015,25792,33020,36165,24155,31114,38022,31578,34142,28556,25411,29648,22490,36762,31557,25550,33977,38086,25828,34595,40674,24753,25732,34696,40113,22376,28491,33882,33882,23965,37246,36510,31189,35279,34212,26473,32563,26674,33048,32779,36463,40097,25586,25586,33432,40697,24707,22500,40523,30388,31944,22479,22479,34683,26973,25111,36715,20324,30898,22093,27821,38092,38247,24274,36417,25125,37253,40679,36846,28707,38150,36746,27305,30509,32174,30014,40101,30261,30193,24521,35286,37234,22844,29522,36747,23404,21554,21724,30245,30245,34685,22191,22493,38088,37245,27860,40628,34732,28349,33985,37265,33543,33113,38241,22060,22060,28729,38167,29582,40148,25902,33315,40671,34643,26675,24669,35883,33994,24679,40162,21833,29815,22139,34601,27287,33929,21122,30131,34552,34552,38030,33912,29389,26561,40080,20193,27709,27709,25378,38227,26621,31948,22605,29428,31759,21711,29965,21708,30605,37236,36241,29443,33910,38077,32480,30275,39043,38103,24989,22450,27260,38091,29368,29434,40156,28347,21794,21717,34609,25149,28303,20924,38090,34819,37072,30498,23573,34060,25099,38123,38123,27862,28452,26724,35195,40153,28553,33953,30937,37217,22636,22436,38098,20203,33656,40090,38097,37200,21937,36734,25592,24273,33054,30100,26967,22316,27661,34622,31949,30386,29310,30213,33972,26653,30292,40135,37260,34120,38503,38127,22452,37025,34686,26912,32881,29213,24417,33096,30962,32700,39032,34661,34661,25815,40119,27732,29671,38060,30166,40759,27637,34789,38239,33078,26535,29473,40094,21121,28470,28384,26692,33127,27673,39071,23705,26709,30626,31586,21945,25568,29441,29470,34707,30220,26578,33544,33544,29416,34672,40123,27856,24113,24113,26731,22485,39541,32562,32790,40102,22150,22237,35911,22439,33120,24797,24797,20162,30885,29918,21787,21787,22377,38248,34032,27718,27645,21086,31976,33396,30272,23379,20340,21820,35307,34021,39570,37046,22390,38246,38246,27911,34699,33504,32802,21136,34016,38071,34590,30981,22657,33927,40125,27930,36508,20211,22456,20865,27641,35992,40115,40105,40144,27826,27655,27654,33129,30921,39695,27976,27307,30256,21802,33881,29360,29599,29599,20913,36181,32845,40116,38111,30124,30229,22596,30517,23674,40751,22381,30995,38072,26563,33943,38249,34660,34660,40682,31234,34019,33563,37214,33038,34171,33228,38101,33981,22541,40085,22488,33691,38232,32821,32800,33010,28461,33042,32807,31006,30477,30285,34711,25517,31650,34170,38122,32788,21747,33596,23580,40099,22282,25865,29427,25627,39583,38070,40082,33934,22511,40738,28725,37199,26896,33562,20169,33644,38104,27817,23688,38233,38257,31235,33496,32817,38135,24027,25611,27281,31012,30211,31238,40134,33149,32809,33594,34741,24586,30128,30182,31611,38245,35622,38110,31621,30645,23693,26698,30905,28375,30147,39121,29311,38244,38140,22364,32805,22412,34105,30148,29497,28530,40124,39077,27669,31766,25612,33190,25566,30218,40147,27008,26993,34104,33928,40152,38258,40139,36410,29323,29496,38117,20327,39587,31130,40122,25124,31740,40772,34771,38141,36558,29327,22682,36727,36737,38137,22629,32471,24362,30253,29294,40765,33587,25750,33194,33646,38132
};


// 符号列表
static wchar_t ime_symbols[55] = L"，。、？！：；“”‘’（）《》…—～·【】 !\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~";
// 按键对应的字母列表
static wchar_t ime_alphabet[10][32] = {L"0", L" 1.,:?!-/+_=&\"*", L"abcABC2", L"defDEF3", L"ghiGHI4", L"jklJKL5", L"mnoMNO6", L"pqrsPRQS7", L"tuvTUV8", L"wxyzWXYZ9"};

// 带四舍五入的整数除法，仅接受正数
static inline uint32_t div_round(uint32_t a, uint32_t b) {
    return (a + b / 2) / b;
}

void get_candidate_hanzi_list(Widget_Input_State *input_state) {
    unsigned int candidate_index[500];
    int candidate_count = 0;
    for(int i = 0; i < IME_HANZI_NUM; i++) {
        if(KEYS_LIST[i] == input_state->pinyin_keys) {
            candidate_index[candidate_count++] = i;
        }
    }

    memset(input_state->candidates, 0, sizeof(input_state->candidates));

    if(candidate_count == 0) {
        input_state->candidate_num = 0;
    }
    else {
        for(int i = 0; i < candidate_count; i++) {
            input_state->candidates[i] = UTF32_LIST[candidate_index[i]];
        }
        input_state->candidate_num = candidate_count;
    }
}


void candidate_paging(Widget_Input_State *input_state) {
    input_state->candidate_page_num = input_state->candidate_num / MAX_CANDIDATE_NUM_PER_PAGE + ((input_state->candidate_num % MAX_CANDIDATE_NUM_PER_PAGE) ? 1 : 0);
    memset(input_state->candidate_pages, 0, sizeof(input_state->candidate_pages));
    uint32_t pos = 0;
    for (uint32_t i = 0; i < input_state->candidate_page_num; i++) {
        for (uint32_t j = 0; j < MAX_CANDIDATE_NUM_PER_PAGE; j++) {
            input_state->candidate_pages[i][j] = (pos < input_state->candidate_num) ? input_state->candidates[pos] : 0; // 选字时，选到0就意味着越界了
            pos++;
        }
    }
}

// 在文本框的光标位置之后插入一个字符
void insert_char(Widget_Input_State *input_state, wchar_t new_char) {
    if (input_state->textarea.length + 1 > INPUT_BUFFER_LENGTH) {
        return;
    }

    input_state->textarea.text[input_state->textarea.length + 1] = L'\0';

    for (uint32_t i = input_state->textarea.length; i >= input_state->cursor_pos + 2; i--) {
        input_state->textarea.text[i] = input_state->textarea.text[i-1];
    }
    input_state->textarea.text[input_state->cursor_pos + 1] = new_char;

    input_state->cursor_pos++;
    input_state->textarea.length++;
}

// 删除光标位置的字符（即光标竖线左边的一个字符）
void delete_char(Widget_Input_State *input_state) {
    if (input_state->textarea.length <= 0 || input_state->cursor_pos < 0) {
        return;
    }

    for (uint32_t i = input_state->cursor_pos; i < input_state->textarea.length; i++) {
        input_state->textarea.text[i] = input_state->textarea.text[i+1];
    }
    input_state->textarea.text[input_state->textarea.length - 1] = L'\0';

    input_state->cursor_pos--;
    input_state->textarea.length--;
}



// 排版-折行（高代价）：计算全部文本的length(char_count)、line_num(break_count)、break_pos
void typeset_line_breaks(Widget_Textarea_State *textarea_state) {
    int32_t break_count = 0;
    int32_t line_x_pos = 0;
    int32_t char_count = 0;
    for (char_count = 0; char_count < wcslen(textarea_state->text); char_count++) {
        wchar_t ch = textarea_state->text[char_count];
        int32_t char_width = (ch < 127) ? ((ch == '\n') ? 0 : FONT_WIDTH_HALF) : FONT_WIDTH_FULL;
        if (char_count == 0 || line_x_pos + char_width >= textarea_state->width) {
            textarea_state->break_pos[break_count] = char_count;
            break_count++;
            line_x_pos = 0;
        }
        else if (ch == '\n') {
            textarea_state->break_pos[break_count] = char_count + 1;
            break_count++;
            line_x_pos = 0;
        }
        line_x_pos += char_width;
    }
    textarea_state->line_num = (break_count <= 0) ? 1 : break_count;
    textarea_state->length = char_count;
}


// 排版-视口（低代价）：给定起始行号和视口宽高，计算视口内文本的index和最大能容纳的行数
void typeset_view_range(Widget_Textarea_State *textarea_state) {
    int32_t view_height = textarea_state->height;
    //   NOTE 考虑到行间距为1，且末行以下无间距，因此分子加1以去除末行无间距的影响。
    //        例如，高度为64的屏幕，实际可容纳(64+1)/(12+1)=5行。
    int32_t max_view_lines = (view_height + 1) / (FONT_HEIGHT + 1);
    int32_t _line_num = textarea_state->line_num;

    textarea_state->view_lines = max_view_lines;

    int32_t start_line = textarea_state->current_line;

    // 对start_line的检查和标准化
    if (start_line < 0) {
        // start_line小于0，解释为将文字末行卷动到视图的某一行。例如：-1代表将文字末行卷动到视图的倒数1行、-max_view_lines代表将文字末行卷动到视图的第1行。
        //   若start_line小于-max_view_lines，则等效于-max_view_lines，保证文字内容不会卷到视图以外。
        if (-start_line <= max_view_lines) {
            if (_line_num >= max_view_lines) {
                start_line = _line_num - 1 - start_line - max_view_lines;
            }
            else {
                start_line = 0;
            }
        }
        else {
            start_line = _line_num - 1;
        }
    }
    else if (start_line >= _line_num) {
        // start_line超过了末行，则对文本行数取模后滚动
        start_line = start_line % _line_num;
    }

    // 情况1：start_line介于首行（0）和（使得末行进入可见区域以下1行的位置），即视图内不包含末行
    if (start_line < _line_num - max_view_lines) {
        textarea_state->view_start_pos = textarea_state->break_pos[start_line];
        textarea_state->view_end_pos = textarea_state->break_pos[start_line + max_view_lines] - 1;
    }
    // 情况2：start_line等于或超过了（使得末行恰好位于可见区域底行的位置），但尚未超出末行，也就是末行位于视图内
    //        若文本行数不大于视图行数，则一定满足此条件。
    else if (start_line >= _line_num - max_view_lines && start_line < _line_num) {
        textarea_state->view_start_pos = textarea_state->break_pos[start_line];
        textarea_state->view_end_pos = textarea_state->length - 1;
    }
}


void render_text(Widget_Textarea_State *textarea_state) {
    int x_pos = textarea_state->x;
    int y_pos = textarea_state->y;

    for (int i = textarea_state->view_start_pos; i <= textarea_state->view_end_pos; i++) {
        uint32_t current_char = textarea_state->text[i];
        if (!current_char) break;
        uint8_t font_width = FONT_WIDTH_FULL;
        uint8_t font_height = FONT_HEIGHT;
        if (current_char == '\n') {
            x_pos = textarea_state->x;
            if(i > 0) y_pos += (font_height + 1);
            continue;
        }
        uint8_t *glyph = get_glyph(current_char, &font_width, &font_height);
        if (!glyph) {
            // printf("出现了字库之外的字符[%d]\n", current_char);
            glyph = get_glyph(12307, &font_width, &font_height); // 用字脚符号“〓”代替，参考https://ja.wikipedia.org/wiki/下駄記号
        }
        if (x_pos + font_width >= textarea_state->x + textarea_state->width) {
            y_pos += (font_height + 1);
            x_pos = textarea_state->x;
        }
        fb_draw_char(x_pos, y_pos, glyph, font_width, font_height, 1);
        x_pos += font_width;
    }
}

// 绘制滚动条
//   line_num - 文本总行数
//   current_line - 当前在屏幕顶端的是哪一行
//   view_lines - 屏幕最多容纳几行
void render_scroll_bar(int32_t current_line, int32_t line_num, int32_t view_lines, int32_t x, int32_t y, int32_t width, int32_t height) {

    // 对current_line的检查和标准化
    if (current_line < 0) {
        // current_line小于0，解释为将文字末行卷动到视图的某一行。例如：-1代表将文字末行卷动到视图的倒数1行、-max_view_lines代表将文字末行卷动到视图的第1行。
        //   若current_line小于-max_view_lines，则等效于-max_view_lines，保证文字内容不会卷到视图以外。
        if (-current_line <= view_lines) {
            if (line_num >= view_lines) {
                current_line = line_num - 1 - current_line - view_lines;
            }
            else {
                current_line = 0;
            }
        }
        else {
            current_line = line_num - 1;
        }
    }
    else if (current_line >= line_num) {
        // current_line超过了末行，则对文本行数取模后滚动
        current_line = (line_num <= 0) ? 0 : current_line % line_num;
    }

    for (int n = y; n < y + height; n++) {
        fb_plot(x + width - 1, n, !(n % 3));
    }

    line_num = (line_num <= 0) ? 1 : line_num;

    // 如果总行数装不满视图，则滚动条长度等于视图高度height
    int32_t bar_height = (line_num < view_lines) ? (height) : div_round((view_lines * height), line_num);
    bar_height = (bar_height < 3) ? 3 : bar_height; // 滚动条高度不小于3px

    // 滚动条顶部y坐标
    int32_t y_0 = y + div_round(current_line * height, line_num);
    y_0 = (y_0 >= y + height - 3 - 1) ? (y + height - 3 - 1) : y_0; // 滚动条顶部限位（不低于底部上方3px）

    fb_draw_line(x + width - 1, (uint8_t)y_0, x + width - 1, (uint8_t)(y_0 + bar_height), 1);
    fb_draw_line(x + width - 2, (uint8_t)y_0, x + width - 2, (uint8_t)(y_0 + bar_height), 1);
}






// 绘制点阵的版权信息
//   点阵数据通过bd4sur.com/html/am32.html取得
void draw_copyright_notice(uint32_t x_offset, uint32_t y_offset) {
    uint32_t callsign[5]  = {3876120944, 2493057352, 3836266864, 2495359312, 3876177480}; // BD4SUR, width=29
    uint32_t year_2025[5] = {1662631936, 2493841408, 613010944, 1150296064, 4080910336};  // 2025-, width=23
    uint32_t year_2026[5] = {1662566400, 2493841408, 613007360, 1150361600, 4080844800};  // 2026, width=19
    uint32_t copy_mark[7] = {2013265920, 2214592512, 3019898880, 2751463424, 3019898880, 2214592512, 2013265920}; // (c), width=6

    uint32_t x = x_offset;

    for (uint32_t i = 0; i < 7; i++) {
        for (uint32_t j = 0; j < 32; j++) {
            fb_plot((uint8_t)(x + j), (uint8_t)(y_offset + i), (copy_mark[i] >> (32 - 1 - j)) & 0x1);
        }
    }
    x += (6 + 4);
    for (uint32_t i = 0; i < 5; i++) {
        for (uint32_t j = 0; j < 32; j++) {
            fb_plot((uint8_t)(x + j), (uint8_t)(y_offset + 1 + i), (year_2025[i] >> (32 - 1 - j)) & 0x1);
        }
    }
    x += (23 + 1);
    for (uint32_t i = 0; i < 5; i++) {
        for (uint32_t j = 0; j < 32; j++) {
            fb_plot((uint8_t)(x + j), (uint8_t)(y_offset + 1 + i), (year_2026[i] >> (32 - 1 - j)) & 0x1);
        }
    }
    x += (19 + 4);
    for (uint32_t i = 0; i < 5; i++) {
        for (uint32_t j = 0; j < 32; j++) {
            fb_plot((uint8_t)(x + j), (uint8_t)(y_offset + 1 + i), (callsign[i] >> (32 - 1 - j)) & 0x1);
        }
    }

}


void show_splash_screen(Key_Event *key_event, Global_State *global_state) {
    fb_soft_clear();

    for (int i = 1; i <= 14; i++) {
        fb_draw_line(1, i, 127, i, 1);
    }

#if CONFIG_IDF_TARGET_ESP32S3
    fb_draw_textline(L"Project Nano", 28, 2, 0);
    fb_draw_textline(L"电子鹦鹉@ESP32S3", 16, 20, 1);
    draw_copyright_notice(20, 53);
#else
    time_t rawtime;
    struct tm *timeinfo;
    char datetime_string_buffer[80];
    wchar_t datetime_wcs_buffer[80];

    time(&rawtime); // 获取当前时间戳
    timeinfo = localtime(&rawtime); // 转换为本地时间
    strftime(datetime_string_buffer, sizeof(datetime_string_buffer), "%Y-%m-%d %H:%M:%S", timeinfo); // 格式化输出
    _mbstowcs(datetime_wcs_buffer, datetime_string_buffer, 80);

    fb_draw_textline(L"Project Nano", 28, 2, 0);
    fb_draw_textline(L"电 子 鹦 鹉", 31, 20, 1);
    fb_draw_textline(datetime_wcs_buffer, 8, 35, 1);
    draw_copyright_notice(20, 53);
#endif

    fb_draw_line(0, 0, 127, 0, 1);
    fb_draw_line(0, 15, 127, 15, 1);
    fb_draw_line(0, 0, 0, 63, 1);
    fb_draw_line(127, 0, 127, 63, 1);
    fb_draw_line(0, 63, 127, 63, 1);

#ifdef ASR_ENABLED
    // 检查ASR服务状态，如果ASR服务未启动，则在屏幕左上角画一个闪烁的点，表示ASR服务启动中
    if (global_state->is_asr_server_up < 1) {
        uint8_t v = (uint8_t)((global_state->timer >> 2) & 0x1);
        fb_draw_line(4, 6, 7, 6, v);
        fb_draw_line(4, 7, 7, 7, v);
        fb_draw_line(4, 8, 7, 8, v);
        fb_draw_line(4, 9, 7, 9, v);
    }
#endif

#ifdef UPS_ENABLED
    // 绘制电池电量
    fb_draw_line(112, 4, 125, 4, 0);
    fb_draw_line(125, 4, 125, 11, 0);
    fb_draw_line(112, 11, 125, 11, 0);
    fb_draw_line(112, 4, 112, 11, 0);
    fb_draw_line(111, 6, 111, 9, 0);

    int32_t soc_bar_length = (int32_t)(10.0f * ((float)global_state->ups_soc / 100.0f));
    soc_bar_length = (soc_bar_length > 9) ? 9 : soc_bar_length;
    fb_draw_line(123 - soc_bar_length, 6, 123, 6, 0);
    fb_draw_line(123 - soc_bar_length, 7, 123, 7, 0);
    fb_draw_line(123 - soc_bar_length, 8, 123, 8, 0);
    fb_draw_line(123 - soc_bar_length, 9, 123, 9, 0);
#endif

    gfx_refresh();
}


void play_bad_apple(Key_Event *key_event, Global_State *global_state) {
#ifdef BADAPPLE_ENABLED
    if (global_state->timestamp - global_state->ba_begin_timestamp >= 100 * global_state->ba_frame_count) {
        fb_soft_clear();
        for (uint32_t row = 0; row < 64; row++) {
            uint32_t page_0 = bad_apple_10fps_64x64[global_state->ba_frame_count * 128 + row * 2];
            uint32_t page_1 = bad_apple_10fps_64x64[global_state->ba_frame_count * 128 + row * 2 + 1];
            for (uint32_t col = 0; col < 32; col++) {
                fb_plot(col + 32, row, (page_0 >> (32 - 1 - col)) & 0x1);
            }
            for (uint32_t col = 32; col < 64; col++) {
                fb_plot(col + 32, row, (page_1 >> (32 - 1 - (col-32))) & 0x1);
            }
        }
        gfx_refresh();
        global_state->ba_frame_count++;

        if (global_state->ba_frame_count > 2193) {
            global_state->ba_frame_count = 0;
            global_state->ba_begin_timestamp = global_state->timestamp;
        }
    }
#endif
}







void init_textarea(Key_Event *key_event, Global_State *global_state, Widget_Textarea_State *textarea_state,
    uint32_t max_len) {
    textarea_state->state = 0;
    textarea_state->x = 0;
    textarea_state->y = 0;
    textarea_state->width = 128;
    textarea_state->height = 64;
    textarea_state->length = 0;
    textarea_state->line_num = 0;
    textarea_state->view_lines = 0;
    textarea_state->view_start_pos = 0;
    textarea_state->view_end_pos = 0;
    textarea_state->current_line = 0;
    textarea_state->is_show_scroll_bar = 1;
    textarea_state->is_modified = 1;
    textarea_state->text = (wchar_t*)calloc(max_len, sizeof(wchar_t));
    textarea_state->break_pos = (int32_t*)calloc(max_len, sizeof(int32_t));
}

void set_textarea(Key_Event *key_event, Global_State *global_state, Widget_Textarea_State *textarea_state,
    wchar_t *text, int32_t current_line, int32_t is_show_scroll_bar) {
    textarea_state->is_modified = 1;
    textarea_state->current_line = current_line;
    textarea_state->is_show_scroll_bar = is_show_scroll_bar;
    wcscpy(textarea_state->text, text);
}

void draw_textarea(Key_Event *key_event, Global_State *global_state, Widget_Textarea_State *textarea_state) {
    if (textarea_state->is_modified) {
        typeset_line_breaks(textarea_state);
    }
    typeset_view_range(textarea_state);

    if (global_state->is_full_refresh) {
        fb_soft_clear();
    }

    render_text(textarea_state);

    if (textarea_state->is_show_scroll_bar) {
        render_scroll_bar(
            textarea_state->current_line, textarea_state->line_num, textarea_state->view_lines,
            textarea_state->x, textarea_state->y, textarea_state->width, textarea_state->height);
    }

    if (global_state->is_full_refresh) {
        gfx_refresh();
    }
}

// 通用的文本框卷行事件处理
int32_t textarea_event_handler(
    Key_Event *ke, Global_State *gs, Widget_Textarea_State *ts,
    int32_t prev_focus_state, int32_t current_focus_state
) {
    // 短按A键：回到上一个焦点
    if (ke->key_edge == -1 && ke->key_code == KEYCODE_NUM_A) {
        return prev_focus_state;
    }

    // 长+短按*键：推理结果向上翻一行。如果翻到顶，则回到最后一行。
    else if ((ke->key_edge == -1 || ke->key_edge == -2) && ke->key_code == KEYCODE_NUM_STAR) {
        if (ts->current_line <= 0) { // 卷到顶
            ts->current_line = ts->line_num - 5;
        }
        else {
            ts->current_line--;
        }

        ts->is_modified = 0;
        draw_textarea(ke, gs, ts);
        ts->is_modified = 1;

        return current_focus_state;
    }

    // 长+短按#键：推理结果向下翻一行。如果翻到底，则回到第一行。
    else if ((ke->key_edge == -1 || ke->key_edge == -2) && ke->key_code == KEYCODE_NUM_HASH) {
        if (ts->current_line >= (ts->line_num - 5)) { // 卷到底
            ts->current_line = 0;
        }
        else {
            ts->current_line++;
        }

        ts->is_modified = 0;
        draw_textarea(ke, gs, ts);
        ts->is_modified = 1;

        return current_focus_state;
    }

    return current_focus_state;
}







void init_input(Key_Event *key_event, Global_State *global_state, Widget_Input_State *input_state) {
    Widget_Textarea_State *ta = &(input_state->textarea);

    init_textarea(key_event, global_state, ta, INPUT_BUFFER_LENGTH);

    ta->state = 0;
    ta->x = 0;
    ta->y = 13;
    ta->width = 128;
    ta->height = 51; // NOTE 详见结构体定义处的说明
    ta->length = 0;
    ta->is_show_scroll_bar = 1;

    input_state->cursor_pos = -1;
    input_state->ime_mode_flag = IME_MODE_HANZI;
    input_state->pinyin_keys = 0;
    input_state->candidate_num = 0;
    input_state->candidate_page_num = 0;
    input_state->current_page = 0;
    input_state->alphabet_click_timestamp = 0;
    input_state->alphabet_is_counting_down = 0;
    input_state->alphabet_current_key = 255;
    input_state->alphabet_index = 0;

    // 初始化各个数组
    memset(input_state->candidates, 0, sizeof(input_state->candidates));
    memset(input_state->candidate_pages, 0, sizeof(input_state->candidate_pages));

    render_input_buffer(key_event, global_state, input_state);
}

void refresh_input(Key_Event *key_event, Global_State *global_state, Widget_Input_State *input_state) {
    input_state->cursor_pos = input_state->textarea.length - 1;
    render_input_buffer(key_event, global_state, input_state);
}

int32_t input_event_handler(
    Key_Event *key_event, Global_State *global_state, Widget_Input_State *input_state,
    int32_t prev_focus_state, int32_t current_focus_state, int32_t next_focus_state
) {

    int32_t state = input_state->state;

    // 定时器触发：字母输入的倒计时进度条
    if (input_state->ime_mode_flag == IME_MODE_ALPHABET && input_state->alphabet_is_counting_down == 1) {
        uint64_t ctimestamp = global_state->timestamp;
        // 倒计时进行中，绘制进度条
        if (ctimestamp - input_state->alphabet_click_timestamp <= ALPHABET_COUNTDOWN_MS) {
            uint8_t x_pos = (uint8_t)((ALPHABET_COUNTDOWN_MS - ctimestamp + input_state->alphabet_click_timestamp) * 128 / ALPHABET_COUNTDOWN_MS);
            fb_draw_line(0, 63, x_pos, 63, 1);
            fb_draw_line(x_pos + 1, 63, 127, 63, 0);
            gfx_refresh();
            input_state->state = 0;
        }
        // 倒计时结束，提交当前选中的字母，清除进度条
        else {
            input_state->alphabet_is_counting_down = 0;

            // 清除进度条
            fb_draw_line(0, 63, 127, 63, 0);
            gfx_refresh();

            // 将当前选中的字母加入输入缓冲区
            uint32_t ch = ime_alphabet[(int)(input_state->alphabet_current_key)][input_state->alphabet_index];
            if (ch) {
                insert_char(input_state, ch);
            }
            else {
                printf("选定了列表之外的字母，忽略。\n");
            }

            render_input_buffer(key_event, global_state, input_state);

            input_state->alphabet_current_key = 255;
            input_state->alphabet_index = 0;
            input_state->state = 0;
        }
    }

    if (state == 0) {

        // 长按0：输入符号
        if (key_event->key_edge == -2 && key_event->key_code == 0) {
            memset(input_state->candidates, 0, sizeof(input_state->candidates));

            input_state->candidate_num = 54;
            for (int i = 0; i < input_state->candidate_num; i++) {
                input_state->candidates[i] = (uint32_t)ime_symbols[i];
            }

            candidate_paging(input_state);

            render_symbol_input(input_state);

            input_state->current_page = 0;
            input_state->state = 3;
        }

        // 短按0：数字输入模式下是直接输入0，其余模式无动作
        else if (key_event->key_edge == -1 && key_event->key_code == 0) {
            if (input_state->ime_mode_flag == IME_MODE_NUMBER) {
                // input_state->text[(input_state->length)++] = L'0';
                // input_state->cursor_pos++;
                insert_char(input_state, L'0');
                render_input_buffer(key_event, global_state, input_state);
                input_state->state = 0;
            }
        }

        // 短按1-9：输入拼音/字母/数字，根据输入模式标志，转向不同的状态
        else if (key_event->key_edge == -1 && (key_event->key_code >= 1 && key_event->key_code <= 9)) {
            if (input_state->ime_mode_flag == IME_MODE_HANZI) {
                if (key_event->key_code >= 2 && key_event->key_code <= 9) { // 仅响应按键2-9；1无动作
                    input_state->state = 1;
                    input_event_handler(
                        key_event, global_state, input_state,
                        prev_focus_state, current_focus_state, next_focus_state);
                }
            }
            else if (input_state->ime_mode_flag == IME_MODE_NUMBER) {
                // input_state->text[(input_state->length)++] = L'0' + key_event->key_code;
                // input_state->cursor_pos++;
                insert_char(input_state, (wchar_t)(L'0' + key_event->key_code));
                render_input_buffer(key_event, global_state, input_state);
                input_state->state = 0;
            }
            else if (input_state->ime_mode_flag == IME_MODE_ALPHABET) {
                // 如果按键按下时，不是字母切换状态，则开始循环切换，并开始倒计时。
                if (input_state->alphabet_is_counting_down == 0) {
                    input_state->alphabet_is_counting_down = 1;
                    input_state->alphabet_click_timestamp = global_state->timestamp;
                    input_state->alphabet_current_key = key_event->key_code;
                    input_state->alphabet_index = 0;
                }
                // 如果按键按下时，倒计时尚未结束，则切换到下一个字母。
                else {
                    input_state->alphabet_is_counting_down = 1;
                    input_state->alphabet_click_timestamp = global_state->timestamp;
                    input_state->alphabet_current_key = key_event->key_code;
                    input_state->alphabet_index = (input_state->alphabet_index + 1) % wcslen(ime_alphabet[(int)(key_event->key_code)]);
                }

                // 在屏幕上循环显示当前选中的字母
                wchar_t letter[2];
                uint32_t x_pos = 1;
                for (int i = 0; i < wcslen(ime_alphabet[(int)(key_event->key_code)]); i++) {
                    letter[0] = ime_alphabet[(int)(key_event->key_code)][i]; letter[1] = 0;
                    fb_draw_textline(letter, x_pos, 50, (i != input_state->alphabet_index));
                    x_pos += 8;
                }

                input_state->state = 0;
            }
        }

        // 长+短按A键：删除一个字符，或返回上一个状态，取决于缓冲区状态和Ctrl状态
        else if ((key_event->key_edge == -1 || key_event->key_edge == -2) && key_event->key_code == 10) {
            input_state->state = 0;
            // 如果缓冲区非空且非Ctrl状态，则删除一个字符
            if (global_state->is_ctrl_enabled == 0 && input_state->textarea.length >= 1) {
                // input_state->text[--(input_state->length)] = 0;
                // input_state->cursor_pos--;
                delete_char(input_state);
                render_input_buffer(key_event, global_state, input_state);
            }
            // 如果缓冲区空，或者是Ctrl状态，则清空缓冲区，回到上一个状态
            else {
                // 重置Ctrl状态
                if (global_state->is_ctrl_enabled == 1) {
                    global_state->is_ctrl_enabled = 0;
                }
                init_input(key_event, global_state, input_state);
                return prev_focus_state;
            }
        }

        // 长+短按B键：依次切换汉-英-数输入模式
        else if ((key_event->key_edge == -1 || key_event->key_edge == -2) && key_event->key_code == 11) {
            input_state->ime_mode_flag = (input_state->ime_mode_flag + 1) % 3;
            render_input_buffer(key_event, global_state, input_state);
            input_state->state = 0;
        }

        // 短按C键：切换全局Ctrl键状态
        else if (key_event->key_edge == -1 && key_event->key_code == KEYCODE_NUM_C) {
            global_state->is_ctrl_enabled = 1 - global_state->is_ctrl_enabled;
            render_input_buffer(key_event, global_state, input_state);
            input_state->state = 0;
        }

        // 短按D键：进入下一个状态
        else if (key_event->key_edge == -1 && key_event->key_code == KEYCODE_NUM_D) {
            input_state->state = 0;
            return next_focus_state;
        }

        // 长+短按*键：光标向左移动
        else if ((key_event->key_edge == -1 || key_event->key_edge == -2) && key_event->key_code == 14) {
            if (input_state->cursor_pos > -1) {
                input_state->cursor_pos--;
            }
            else {
                input_state->cursor_pos = -1;
            }
            render_input_buffer(key_event, global_state, input_state);
        }

        // 长+短按#键：光标向右移动
        else if ((key_event->key_edge == -1 || key_event->key_edge == -2) && key_event->key_code == 15) {
            if (input_state->cursor_pos < input_state->textarea.length - 1) {
                input_state->cursor_pos++;
            }
            else {
                input_state->cursor_pos = input_state->textarea.length - 1;
            }
            render_input_buffer(key_event, global_state, input_state);
        }

        // 无按键：光标闪烁
        else {
            if (global_state->timer % 120 == 0) {
                render_cursor(key_event, global_state, input_state);
                gfx_refresh();
            }
        }
    }

    else if (state == 1) {
        // 短按D键：开始选字
        if (key_event->key_edge == -1 && key_event->key_code == 13) {
            if (input_state->candidate_num > 0) {
                render_pinyin_input(input_state, 1);
                input_state->state = 2;
            }
        }

        // 短按A键：取消输入拼音，清除已输入的所有按键，回到初始状态
        else if (key_event->key_edge == -1 && key_event->key_code == 10) {
            render_input_buffer(key_event, global_state, input_state);
            input_state->current_page = 0;
            input_state->pinyin_keys = 0;
            input_state->state = 0;
        }

        // 短按2-9键：继续输入拼音
        else if (key_event->key_edge == -1 && (key_event->key_code >= 2 && key_event->key_code <= 9)) {
            input_state->pinyin_keys *= 10;
            input_state->pinyin_keys += (uint32_t)(key_event->key_code);

            memset(input_state->candidates, 0, sizeof(input_state->candidates));
            memset(input_state->candidate_pages, 0, sizeof(input_state->candidate_pages));

            get_candidate_hanzi_list(input_state);

            if (input_state->candidate_num > 0) { // 如果当前键码有对应的候选字
                // 候选字列表分页
                candidate_paging(input_state);
                render_pinyin_input(input_state, 0);
            }
            else {
                render_pinyin_input(input_state, 0);
            }

            input_state->state = 1;
        }
    }

    else if (state == 2) {
        // 短按0-9键：从候选字列表中选定一个字，选定后转到初始状态
        if (key_event->key_edge == -1 && (key_event->key_code >= 0 && key_event->key_code <= 9)) {
            uint32_t index = (key_event->key_code == 0) ? 9 : (key_event->key_code - 1); // 按键0对应9
            // 将选中的字加入输入缓冲区
            uint32_t ch = input_state->candidate_pages[input_state->current_page][index];
            if (ch) {
                // input_state->text[(input_state->length)++] = ch;
                // input_state->cursor_pos++;
                insert_char(input_state, ch);
            }
            else {
                printf("选定了列表之外的字，忽略。\n");
            }

            render_input_buffer(key_event, global_state, input_state);

            memset(input_state->candidates, 0, sizeof(input_state->candidates));
            memset(input_state->candidate_pages, 0, sizeof(input_state->candidate_pages));
            input_state->current_page = 0;

            input_state->pinyin_keys = 0;
            input_state->state = 0;
        }

        // 长+短按*键：候选字翻页到上一页
        else if ((key_event->key_edge == -1 || key_event->key_edge == -2) && key_event->key_code == 14) {
            if(input_state->current_page > 0) {
                input_state->current_page--;
                render_pinyin_input(input_state, 1);
            }
            input_state->state = 2;
        }

        // 长+短按#键：候选字翻页到下一页
        else if ((key_event->key_edge == -1 || key_event->key_edge == -2) && key_event->key_code == 15) {
            if(input_state->current_page < input_state->candidate_page_num - 1) {
                input_state->current_page++;
                render_pinyin_input(input_state, 1);
            }
            input_state->state = 2;
        }

        // 短按A键：取消选择，回到初始状态
        else if (key_event->key_edge == -1 && key_event->key_code == 10) {
            render_input_buffer(key_event, global_state, input_state);
            input_state->current_page = 0;
            input_state->pinyin_keys = 0;
            input_state->state = 0;
        }
    }

    else if (state == 3) {
        // 短按0-9键：从符号列表中选定一个符号，选定后转到初始状态
        if (key_event->key_edge == -1 && (key_event->key_code >= 0 && key_event->key_code <= 9)) {
            uint32_t index = (key_event->key_code == 0) ? 9 : (key_event->key_code - 1); // 按键0对应9
            // 将选中的符号加入输入缓冲区
            uint32_t ch = input_state->candidate_pages[input_state->current_page][index];
            if (ch) {
                // input_state->text[(input_state->length)++] = ch;
                // input_state->cursor_pos++;
                insert_char(input_state, ch);
            }
            else {
                printf("选定了列表之外的符号，忽略。\n");
            }
            render_input_buffer(key_event, global_state, input_state);

            memset(input_state->candidates, 0, sizeof(input_state->candidates));
            memset(input_state->candidate_pages, 0, sizeof(input_state->candidate_pages));
            input_state->current_page = 0;

            input_state->pinyin_keys = 0;
            input_state->state = 0;
        }

        // 长+短按*键：候选字翻页到上一页
        else if ((key_event->key_edge == -1 || key_event->key_edge == -2) && key_event->key_code == 14) {
            if(input_state->current_page > 0) {
                input_state->current_page--;
                render_symbol_input(input_state);
            }
            input_state->state = 3;
        }

        // 长+短按#键：候选字翻页到下一页
        else if ((key_event->key_edge == -1 || key_event->key_edge == -2) && key_event->key_code == 15) {
            if(input_state->current_page < input_state->candidate_page_num - 1) {
                input_state->current_page++;
                render_symbol_input(input_state);
            }
            input_state->state = 3;
        }

        // 短按A键：取消选择，回到初始状态
        else if (key_event->key_edge == -1 && key_event->key_code == 10) {
            render_input_buffer(key_event, global_state, input_state);
            input_state->current_page = 0;
            input_state->pinyin_keys = 0;
            input_state->state = 0;
        }
    }

    return current_focus_state;
}




void init_menu(Key_Event *key_event, Global_State *global_state, Widget_Menu_State *menu_state) {
    menu_state->current_item_intex = 0;
    menu_state->first_item_intex = 0;
    menu_state->items_per_page = (menu_state->item_num > 4) ? 4 : menu_state->item_num;

    draw_menu(key_event, global_state, menu_state);
}

void refresh_menu(Key_Event *key_event, Global_State *global_state, Widget_Menu_State *menu_state) {
    draw_menu(key_event, global_state, menu_state);
}

void draw_menu(Key_Event *key_event, Global_State *global_state, Widget_Menu_State *menu_state) {

    uint32_t x_indent = 6;

    fb_soft_clear();

    fb_draw_textline(menu_state->title, x_indent, 0, 1);
    wchar_t item_counter[13];
    swprintf(item_counter, 13, L"%d/%d", menu_state->current_item_intex + 1, menu_state->item_num);
    int32_t iclen = wcslen(item_counter);
    fb_draw_textline(item_counter, 126 - iclen * 6, 0, 1);

    uint32_t y_pos = 13;
    uint8_t is_highlight = 0;
    for (uint32_t i = menu_state->first_item_intex; i < menu_state->item_num; i++) {
        if (i == menu_state->first_item_intex + menu_state->items_per_page) {
            break;
        }
        if (i != menu_state->current_item_intex) {
            is_highlight = 0;
        }
        else {
            is_highlight = 1;
        }
        fb_draw_textline(menu_state->items[i], x_indent, y_pos, (1 - is_highlight));
        y_pos += (FONT_HEIGHT + 1);
    }

    // NOTE 因fb_draw_textline会额外给文字上方增加一行，因此这个横线在菜单文字绘制之后再绘制
    fb_draw_line(0, 12, 128, 12, 1);

    gfx_refresh();
}


// 通用的菜单事件处理+回调注册
int32_t menu_event_handler(
    Key_Event *ke, Global_State *gs, Widget_Menu_State *ms,
    int32_t (*menu_item_action_callback)(int32_t), int32_t prev_focus_state, int32_t current_focus_state
) {
    // 短按1-9数字键：直接选中屏幕上显示的那页的相对第几项
    // NOTE 从1开始
    if (ke->key_edge == -1 && (ke->key_code >= KEYCODE_NUM_1 && ke->key_code <= KEYCODE_NUM_9)) {
        if (ke->key_code <= ms->items_per_page) {
            ms->current_item_intex = ms->first_item_intex + (uint32_t)(ke->key_code) - 1;
            return menu_item_action_callback(ms->current_item_intex);
        }
    }
    // 短按A键：返回上一个焦点状态
    else if (ke->key_edge == -1 && ke->key_code == KEYCODE_NUM_A) {
        return prev_focus_state;
    }
    // 短按D键：执行菜单项对应的功能
    else if (ke->key_edge == -1 && ke->key_code == KEYCODE_NUM_D) {
        return menu_item_action_callback(ms->current_item_intex);
    }
    // 长+短按*键：光标向上移动
    else if ((ke->key_edge == -1 || ke->key_edge == -2) && ke->key_code == KEYCODE_NUM_STAR) {
        if (ms->first_item_intex == 0 && ms->current_item_intex == 0) {
            ms->first_item_intex = ms->item_num - ms->items_per_page;
            ms->current_item_intex = ms->item_num - 1;
        }
        else if (ms->current_item_intex == ms->first_item_intex) {
            ms->first_item_intex--;
            ms->current_item_intex--;
        }
        else {
            ms->current_item_intex--;
        }

        draw_menu(ke, gs, ms);

        return current_focus_state;
    }
    // 长+短按#键：光标向下移动
    else if ((ke->key_edge == -1 || ke->key_edge == -2) && ke->key_code == KEYCODE_NUM_HASH) {
        if (ms->first_item_intex == ms->item_num - ms->items_per_page && ms->current_item_intex == ms->item_num - 1) {
            ms->first_item_intex = 0;
            ms->current_item_intex = 0;
        }
        else if (ms->current_item_intex == ms->first_item_intex + ms->items_per_page - 1) {
            ms->first_item_intex++;
            ms->current_item_intex++;
        }
        else {
            ms->current_item_intex++;
        }

        draw_menu(ke, gs, ms);

        return current_focus_state;
    }

    return current_focus_state;
}













void render_input_buffer(Key_Event *key_event, Global_State *global_state, Widget_Input_State *input_state) {

    Widget_Textarea_State *ta = &(input_state->textarea);

    fb_soft_clear();

    wchar_t prompt[32] = L"请输入         ";
    // 显示Ctrl激活状态
    if (global_state->is_ctrl_enabled == 1) {
        wcscat(prompt, L"◆");
    }
    else {
        wcscat(prompt, L"  ");
    }
    // 显示输入状态
    if (input_state->ime_mode_flag == IME_MODE_HANZI) {
        wcscat(prompt, L"[汉]\n");
    }
    else if (input_state->ime_mode_flag == IME_MODE_ALPHABET) {
        wcscat(prompt, L"[En]\n");
    }
    else if (input_state->ime_mode_flag == IME_MODE_NUMBER) {
        wcscat(prompt, L"[数]\n");
    }
    fb_draw_textline(prompt, 0, 0, 0);

    // 绘制右侧未填满的两列像素
    fb_draw_line(126, 0, 126, 12, 1);
    fb_draw_line(127, 0, 127, 12, 1);

    // 第一次排版：用于判断光标是否在视图内部
    // ta->current_line = 0;
    typeset_line_breaks(ta);
    typeset_view_range(ta);

    // 如果光标不在当前视图范围内
    if (input_state->cursor_pos < ta->view_start_pos || input_state->cursor_pos > ta->view_end_pos) {
        uint32_t cursor_line = 0;
        // 寻找当前光标所在的行
        for (int32_t i = 0; i < ta->line_num; i++) {
            int32_t a = ta->break_pos[i];
            int32_t b = (i == ta->line_num - 1) ? ta->length : ta->break_pos[i+1];
            if (input_state->cursor_pos >= a && input_state->cursor_pos < b) {
                cursor_line = i;
            }
        }

        // 如果光标在当前视图上方，则将current_line设为当前光标所在的行
        if (input_state->cursor_pos < ta->view_start_pos) {
            ta->current_line = cursor_line;
        }
        // 如果光标在当前视图下方，则将current_line设为当前光标所在行上方view_lines行（即，使得光标所在行位于视图的末行）
        //   逻辑上，如果出现这种情况，一定有 line_num > view_lines
        else {
            ta->current_line = cursor_line - ta->view_lines + 1;
        }
        // 重新排版
        typeset_line_breaks(ta);
        typeset_view_range(ta);
    }

    // 绘制文本
    render_text(ta);

    // 绘制滚动条
    if (ta->is_show_scroll_bar) {
        render_scroll_bar(
            ta->current_line, ta->line_num, ta->view_lines,
            ta->x, ta->y, ta->width, ta->height);
    }

    // 绘制光标
    render_cursor(key_event, global_state, input_state);

    gfx_refresh();
}


void render_cursor(Key_Event *key_event, Global_State *global_state, Widget_Input_State *input_state) {
    Widget_Textarea_State *ta = &(input_state->textarea);
    // 绘制光标：光标位置在cursor_pos所指字符的右外边缘
    int32_t char_index = 0;
    int32_t break_count = 0;
    int32_t line_x_pos = ta->x;
    if (input_state->cursor_pos >= 0) {
        for (char_index = ta->view_start_pos; char_index <= ta->view_end_pos; char_index++) {
            wchar_t ch = ta->text[char_index];
            int32_t char_width = (ch < 127) ? ((ch == '\n') ? 0 : 6) : 12;
            if (line_x_pos + char_width >= ta->x + ta->width || ch == '\n') {
                break_count++;
                line_x_pos = ta->x;
            }
            line_x_pos += char_width;
            if (input_state->cursor_pos == char_index) break;
        }
    }

    uint8_t x = line_x_pos;
    uint8_t y = (uint8_t)(ta->y + 13 * break_count); // 12x12字模底部本来就有1px的空白，加上行间距1px，所以每行的起始位置是13的倍数
    fb_draw_line(x, y-1, x, y+12, 2);
    fb_draw_line(x+1, y-1, x+1, y+12, 2);
}

void render_pinyin_input(Widget_Input_State *input_state, uint32_t is_picking) {
    // fb_soft_clear();
    // 计算候选列表长度
    uint32_t count = 0;
    wchar_t cc[MAX_CANDIDATE_NUM_PER_PAGE + 1];
    wchar_t cindex[21] = L"1 2 3 4 5 6 7 8 9 0 ";

    for(int j = 0; j < MAX_CANDIDATE_NUM_PER_PAGE; j++) {
        wchar_t ch = input_state->candidate_pages[input_state->current_page][j];
        if (!ch) break;
        cc[j] = ch;
        count++;
    }
    cc[count] = 0;
    cindex[count << 1] = 0;


    uint32_t y_offset = input_state->textarea.y + 13;

    // 清空输入法显示区域
    for (int i = y_offset-1; i <= input_state->textarea.y + input_state->textarea.height; i++) {
        fb_draw_line(input_state->textarea.x, i, input_state->textarea.x + input_state->textarea.width, i, 0);
    }

    wchar_t buf[30];
    if (is_picking) {
        swprintf(buf, 30, L"PY[%-6d]   (%2d/%2d)", input_state->pinyin_keys, (input_state->current_page+1), input_state->candidate_page_num);
        fb_draw_textline(buf, 0, y_offset + 0, 1);
        fb_draw_textline(cindex, 0, y_offset + 13, 1);
    }
    else {
        swprintf(buf, 30, L"PY[%-6d]", input_state->pinyin_keys);
        fb_draw_textline(buf, 0, y_offset + 0, 1);
    }
    if (input_state->candidate_num > 0) {
        fb_draw_textline(cc, 0, y_offset + 26, 1);
    }
    else {
        fb_draw_textline(L"(无候选字)", 0, y_offset + 26, 1);
    }

    fb_draw_line(input_state->textarea.x, y_offset-2, input_state->textarea.x + input_state->textarea.width, y_offset-2, 1);

    gfx_refresh();
}

void render_symbol_input(Widget_Input_State *input_state) {
    // fb_soft_clear();
    // 计算候选列表长度
    uint32_t count = 0;
    uint32_t list_char_width = 0;
    wchar_t cc[21];
    wchar_t cindex[21] = L"1 2 3 4 5 6 7 8 9 0 ";

    for(int j = 0; j < 10; j++) {
        wchar_t ch = input_state->candidate_pages[input_state->current_page][j];
        if (!ch) {
            break;
        }
        else if (ch < 127) {
            cc[list_char_width++] = ch;
            cc[list_char_width++] = L' ';
        }
        else {
            cc[list_char_width++] = ch;
        }
        count++;
    }
    cc[list_char_width] = 0;
    cindex[count << 1] = 0;


    uint32_t y_offset = input_state->textarea.y + 13;

    // 清空输入法显示区域
    for (int i = y_offset-1; i <= input_state->textarea.y + input_state->textarea.height; i++) {
        fb_draw_line(input_state->textarea.x, i, input_state->textarea.x + input_state->textarea.width, i, 0);
    }

    wchar_t text[30];

    swprintf(text, 30, L"Symbols      (%2d/%2d)", (input_state->current_page+1), input_state->candidate_page_num);
    fb_draw_textline(text, 0, y_offset + 0, 1);
    fb_draw_textline(cindex, 0, y_offset + 13, 1);

    if (input_state->candidate_num > 0) {
        fb_draw_textline(cc, 0, y_offset + 26, 1);
    }
    else {
        fb_draw_textline(L"(无候选符号)", 0, y_offset + 26, 1);
    }

    fb_draw_line(input_state->textarea.x, y_offset-2, input_state->textarea.x + input_state->textarea.width, y_offset-2, 1);

    gfx_refresh();
}
