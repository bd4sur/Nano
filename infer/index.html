<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>NanoLM - BD4SUR</title>
    <link rel="stylesheet" type="text/css" href="style.css" charset="utf-8"/>
</head>
<body>


<div class="ModalMask" id="modal_mask">
    <div class="Modal" id="modal">
        <div class="ModalThrobberContainer">
            <svg version="1" xmlns="http://www.w3.org/2000/svg" width="16" height="16" style="transform: scale(2.5);"><style>@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(360deg)}}@keyframes fillunfill{0%{stroke-dashoffset:32.3}50%{stroke-dashoffset:0}to{stroke-dashoffset:-31.9}}@keyframes rot{0%{transform:rotate(0deg)}to{transform:rotate(-360deg)}}@keyframes colors{0%,to{stroke:#15e}}</style><g style="animation-duration:1568.63ms;animation-iteration-count:infinite;animation-name:rotate;animation-timing-function:linear;transform-origin:50% 50%;width:16px;height:16px"><path fill="none" d="M8 1.125A6.875 6.875 0 1 1 1.125 8" stroke-width="2.25" stroke-linecap="butt" style="animation-duration:1333ms,5332ms,5332ms;animation-fill-mode:forwards;animation-iteration-count:infinite,infinite,infinite;animation-name:fillunfill,rot,colors;animation-play-state:running,running,running;animation-timing-function:cubic-bezier(.4,0,.2,1),steps(4),linear;transform-origin:50% 50%" stroke-dasharray="32.4" stroke-dashoffset="32.4"/></g></svg>
        </div>
        <div class="ModalBanner">
            <div class="ModalBannerTitle">NanoLM 推理设置</div>
        </div>

        <div class="ModalTitle">采样参数</div>
        <div class="ModalContent">
            <div id="top_k"></div>
            <div id="top_p"></div>
            <div id="temperature"></div>
            <div id="repetition_penalty"></div>
            <div id="max_seq_len"></div>
        </div>

        <div class="ModalTitle">系统提示语</div>
        <div class="ModalContent">
            <textarea class="SystemPromptInput" id="system_prompt" placeholder="此处输入的“系统提示语”将被附加到输入序列的前面。"></textarea>
        </div>

        <div class="ModalTitle">语音合成</div>
        <div class="ModalContent">
            <div id="tts_switch">点击启用/关闭TTS引擎</div>
        </div>

        <div class="ModalContent" style="display: flex; justify-content: flex-end; padding-right: 20px;">
            <button class="ModalCancel" id="modal_cancel">取消</button>
            <button class="ModalConfirm" id="modal_confirm">确认</button>
        </div>
    </div>
</div>





<div class="Main">
    <div class="Top">
        <div><span class="Nano">NanoLM</span><span style="margin-left: 10px; border-left: 1px solid #9fa1a8; padding-left: 10px; color: #000; font-weight: 100; font-size: smaller;"id="model_name">Inference</span></div>
        <div class="TopRight backend_select" style="display: flex; align-items: center; justify-content: space-between;">
            <!-- <div id="tts_init">启用 Piper TTS 引擎</div> -->
            <div id="backend_switch"><b>WASM</b>推理引擎</div>
        </div>
        <div class="TopRight ButtonClearall" id="clearall" style="display: none;">
            <div style="width: 24px; height: 24px;">
                <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="24px" height="24px"><path d="M910.6 512c-24.3 0-44.8 18.1-47.6 42.1C842.1 728.7 693.6 864 513.4 864c-194.2 0-352-157.8-352-352 0-194.4 157.6-352 352-352 81.8 0 157 27.9 216.8 74.6L662.8 302c-30.2 30.2-8.8 81.9 33.9 81.9h198.2c26.5 0 48-21.5 48-48V137.8c0-42.8-51.7-64.2-81.9-33.9l-62.5 62.5C721.4 102.7 622.6 64.3 514.9 64 266.7 63.2 65.8 263 65.4 511.3 65 759 265.8 960 513.4 960c229.2 0 418.3-172.2 444.8-394.2 3.4-28.6-18.8-53.8-47.6-53.8z" fill="#383a40"></path></svg>
            </div>
        </div>
    </div>

    <div class="Middle">

        <div class="Chat">

            <div class="ChatRecord" id="ChatRecord">
                <div class="Guide">
                    <div class="GuideIntroContainer">
                        <div class="GuideIntro">
                            <div class="GuideIntroTitle">Web Browser Is All You Need!</div>
                            <div class="GuideIntroContent">
                                <div>完全<span style="font-weight: bold;">在浏览器内</span>推理的大语言模型！</div>
                                <div style="color: #babbbf; margin: 5px 0 0 0; font-size: smaller;">Illustration by <a href="https://x.com/ookiiayu/status/1633071773217607683" target="_blank">ookiiayu@X</a></div>
                            </div>
                        </div>
                    </div>
                    <div style="color: #babbbf; line-height: 1.8; font-size: 11px; margin-bottom: 15px;">
                        <details>
                            <summary>使用前必读 Readme before use</summary>
                            <div>语音识别基于 <a href="https://github.com/xenova/whisper-web" target="_blank">Whisper</a>，语音合成基于 <a href="https://github.com/rhasspy/piper" target="_blank">Piper</a>，均在浏览器内推理</div>
                            <div>首次触发语音识别/合成时，自动访问HuggingFace下载模型</div>
                            <div>本页面不发送任何用户输入到任何远端服务器，欢迎审查代码</div>
                            <div style="font-weight: bold;">作者不对本系统所生成的任何内容负责，请读者慎思明辨</div>
                            <div style="font-weight: bold;">The author is not responsible for anything generated by this system. Check important info.</div>
                            <div>现在仅支持单轮对话或文本续写</div>
                        </details>
                    </div>
                    <div class="GuideQuestionContainer" id="test_prompts" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="ChatInput">
        <div class="LoadModel">
            <div class="LoadModelPrompt" style="display: flex; align-items: center; flex-direction: column; margin: 0px 0 0px 0; font-size: 14px;">
                <div class="LoadModelButton LoadLocalModelButton" id="enable_api">
                    <div style="font-weight: bold;">调用API</div>
                </div>
            </div>
            <div class="LoadModelPrompt" style="display: flex; align-items: center; flex-direction: column; margin: 0px 0 0px 0; font-size: 14px;">
                <div style="color: #626675;">请下载并加载语言模型</div>
                <div style="color: #62667533; font-size: 11px; margin: 5px 0 0 0;">（基座模型加载后，可按需挂载LoRA插件）</div>
            </div>
            <div style="display: flex; align-items: center; flex-direction: row;">
                <div class="LoadModelButton LoadLocalModelButton" id="download_model_button">
                    <div style="font-weight: bold;"><a href="https://huggingface.co/bd4sur" target="_blank">下载模型和LoRA插件</a></div>
                </div>
                <div class="LoadModelButton" style="border-left: 2px solid #b2b6c0; height: 20px;" id="model_button_vert_bar"></div>
                <div class="LoadModelButton LoadLocalModelButton" id="select_file">
                    <input type="file" id="model_file_selector" name="files[]" multiple style="position: absolute; top: 0; right: 0; width: 100%; height: 100%; opacity: 0;">
                    <div id="load_model_button_prompt" style="font-weight: bold;">加载本地模型</div>
                </div>
            </div>
            <div class="LoadModelPrompt" style="display: flex; align-items: center; flex-direction: column; margin: 16px 0; font-size: 14px;">
                <div style="color: #626675;">或者 体验下列单轮问答模型</div>
                <div style="color: #62667533; font-size: 11px; margin: 5px 0 0 0;">（请确保HuggingFace可访问，模型最大约700MiB）</div>
            </div>
            <div style="display: flex;">
                <div class="LoadModelButton LoadRemoteModelButton" data-model-name="56M-QA-V1" data-model-url="https://huggingface.co/bd4sur/Nano-56M/resolve/main/nano_56m_99000_sft_229000.bin">
                    <div class="LoadRemoteModelButtonPrompt" style="font-weight: bold;">56M-QA<br><span style="font-weight: normal; font-size: 11px;">通用问答</span></div>
                </div>
                <div class="LoadModelButton LoadRemoteModelButton" data-model-name="168M-QA-V2" data-model-url="https://huggingface.co/bd4sur/Nano-168M/resolve/main/nano_168m_625000_sft_947000.bin">
                    <div class="LoadRemoteModelButtonPrompt" style="font-weight: bold;">168M-QA<br><span style="font-weight: normal; font-size: 11px;">通用问答</span></div>
                </div>
                <div class="LoadModelButton LoadRemoteModelButton" data-model-name="168M-QA-AR" data-model-url="https://huggingface.co/bd4sur/Nano-168M/resolve/main/nano_168m_625000_sft_875000_amateur_radio_890000.bin">
                    <div class="LoadRemoteModelButtonPrompt" style="font-weight: bold;">168M-QA-AR<br><span style="font-weight: normal; font-size: 11px;">业余无线电考试</span></div>
                </div>
            </div>
        </div>
        <div class="ChatInputContainer" style="display: none;">
            <div class="InputBoxContainer">

                <!-- <div class="ButtonClear" id="clear_input_box" style="display: none;">
                    <div class="ButtonClearContainer">
                        <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16px" height="16px"><path d="M512 981.333333c259.2 0 469.333333-210.133333 469.333333-469.333333S771.2 42.666667 512 42.666667 42.666667 252.8 42.666667 512s210.133333 469.333333 469.333333 469.333333z m214.826667-261.845333a64 64 0 0 1-90.453334 1.578667l-122.794666-118.570667-118.570667 122.752A64 64 0 0 1 302.933333 636.330667l118.570667-122.752L298.666667 395.008A64 64 0 1 1 387.626667 302.933333l122.794666 118.570667 118.528-122.752A64 64 0 0 1 721.066667 387.669333l-118.613334 122.752 122.794667 118.570667a64 64 0 0 1 1.578667 90.453333z" fill="#383a40"></path></svg>
                    </div>
                </div> -->

                <textarea class="InputBox" id="input" placeholder="Ent换行 Shift+Ent提交" style="height: 30px;"></textarea>

                <div style="display: flex; flex-direction: row; justify-content: space-between; align-items: flex-end; margin-top: 10px;">

                    <div style="display: flex; flex-direction: row;">
                        <div class="ButtonSetting" id="setting">
                            <div class="ButtonSettingContainer">
                                <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16px" height="20px"><path d="M237.888 79.488l109.056 85.696a381.312 381.312 0 0 1 68.576-24.96L443.936 4.48a516.768 516.768 0 0 1 136.064 0l28.48 135.744c23.808 6.176 46.72 14.56 68.544 24.96l109.056-85.696a514.56 514.56 0 0 1 104.192 87.52L824.864 289.28c14.08 19.744 26.304 40.864 36.48 63.136l138.72 4.48c13.504 42.496 21.632 87.456 23.52 133.984l-128.768 51.616c-1.92 24.672-6.208 48.672-12.608 71.84L985.6 706.88a511.424 511.424 0 0 1-68.128 117.76l-131.84-43.2a385.824 385.824 0 0 1-55.808 46.848l19.712 137.408a508.352 508.352 0 0 1-127.872 46.528l-73.216-117.92a388.576 388.576 0 0 1-72.896 0l-73.216 117.92a508.352 508.352 0 0 1-127.84-46.528l19.68-137.408a385.888 385.888 0 0 1-55.808-46.88l-131.84 43.264A511.488 511.488 0 0 1 38.4 706.88l103.36-92.576c-6.368-23.168-10.624-47.168-12.576-71.84L0.416 490.88c1.92-46.528 9.984-91.488 23.52-134.016l138.688-4.48c10.208-22.24 22.432-43.36 36.512-63.104L133.696 167.04a514.56 514.56 0 0 1 104.192-87.52zM512 704a192 192 0 1 0 0-384 192 192 0 0 0 0 384z" fill="#383a40"></path></svg>
                            </div>
                            <div style="font-size: 12px; line-height: 28px; margin: 0 3px 0 3px;">设置</div>
                        </div>
        
                        <div class="ButtonLoRA" id="lora_button">
                            <div class="ButtonLoRAContainer">
                                <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="14px" height="18px"><path id="lora_button_icon" d="M352.549303 54.857143h-264.630857a88.137143 88.137143 0 0 0-87.990857 87.990857v264.630857a88.137143 88.137143 0 0 0 87.990857 87.990857h264.630857a88.137143 88.137143 0 0 0 87.990857-87.990857v-264.630857a88.064 88.064 0 0 0-87.990857-87.990857m645.705143 157.988571l-187.172572-187.026285a88.064 88.064 0 0 0-124.416 0l-25.892571 25.892571-161.206857 161.133714a87.04 87.04 0 0 0-25.673143 62.025143c-0.146286 23.405714 9.142857 45.860571 25.673143 62.390857l25.892571 25.892572 135.314286 135.387428 25.892571 25.892572c34.377143 34.377143 90.038857 34.377143 124.416 0l161.206857-161.206857 25.892572-25.892572c34.377143-34.377143 34.377143-90.112 0.073143-124.489143m-645.705143 370.688h-264.630857a88.137143 88.137143 0 0 0-87.990857 87.917715v264.630857A88.064 88.064 0 0 0 87.918446 1024h264.630857a88.064 88.064 0 0 0 87.990857-87.917714v-264.630857a88.137143 88.137143 0 0 0-87.990857-87.917715m528.676571 0h-264.557714a88.137143 88.137143 0 0 0-87.990857 87.917715v264.630857A88.064 88.064 0 0 0 616.66816 1024h264.557714a88.064 88.064 0 0 0 87.990857-87.917714v-264.630857a88.137143 88.137143 0 0 0-87.990857-87.917715" fill="#383a40"></path></svg>
                            </div>
                            <input type="file" id="lora_file_selector" class="LoRAFileInput">
                            <div style="font-size: 12px; line-height: 28px; margin: 0 3px 0 3px;">LoRA</div>
                        </div>
        
                        <div class="ButtonInstruct ButtonHover" id="instruct_switch">
                            <div class="ButtonInstructContainer">
                                <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="20px" height="26px"><path d="M336 741q-14 0-22.5-10t-8.5-26V604h-16q-78 0-119-41t-41-118V178q0-77 41-118t119-41h448q77 0 118 41t41 118v267q0 76-41 117.5T737 604H502L376 719q-13 12-21.5 17t-18.5 5z m57-415q0-21-15.5-36.5T341 274q-21 0-36.5 15.5t-15.5 36q0 20.5 15.5 36T341 377q21 0 36.5-15.5T393 326z m174 0q0-21-15.5-36.5T515 274q-21 0-36 15.5t-15 36q0 20.5 15.5 36t36 15.5q20.5 0 36-15.5T567 326z m174 0q0-21-15.5-36.5t-36-15.5q-20.5 0-36 15.5t-15.5 36q0 20.5 15.5 36T690 377q21 0 36-15.5t15-35.5z" fill="#383a40"></path></svg>
                            </div>
                            <div style="font-size: 12px; line-height: 28px; margin: 0 3px 0 0;">问答模式</div>
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: row;">
                        <button class="ButtonSubmit" id="submit" disabled>
                            <svg style="margin: 1px 1px 0 0;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px"><path d="M1008.00076 6.285714q18.857143 13.714286 15.428571 36.571429l-146.285714 877.714286q-2.857143 16.571429-18.285714 25.714285-8 4.571429-17.714286 4.571429-6.285714 0-13.714286-2.857143l-258.857142-105.714286-138.285715 168.571429q-10.285714 13.142857-28 13.142857-7.428571 0-12.571428-2.285714-10.857143-4-17.428572-13.428572T365.715046 987.428571v-199.428571l493.714285-605.142857-610.857142 528.571428-225.714286-92.571428q-21.142857-8-22.857143-31.428572-1.142857-22.857143 18.285714-33.714285L969.143617 5.142857q8.571429-5.142857 18.285714-5.142857 11.428571 0 20.571429 6.285714z" fill="#fff"></path></svg>
                        </button>
                        <button class="ButtonPTT" id="ptt">
                            <svg style="vertical-align: middle;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="20px" height="20px"><path d="M512 704c106.04 0 192-85.96 192-192V192c0-106.04-85.96-192-192-192S320 85.96 320 192v320c0 106.04 85.96 192 192 192z m320-320h-32c-17.68 0-32 14.32-32 32v96c0 149.6-128.98 269.64-281.58 254.76C353.42 753.78 256 634.22 256 500.6V416c0-17.68-14.32-32-32-32H192c-17.68 0-32 14.32-32 32v80.32c0 179.28 127.94 339.1 304 363.38V928H352c-17.68 0-32 14.32-32 32v32c0 17.68 14.32 32 32 32h320c17.68 0 32-14.32 32-32v-32c0-17.68-14.32-32-32-32h-112v-67.54C731.42 836.94 864 689.8 864 512v-96c0-17.68-14.32-32-32-32z" fill="#ffffff"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

        </div>
        <div style="height: 20px; display: flex; margin: 0px 30px; padding: 6px 0px; font-size: 10px; color: #9a9ea8; flex-direction: row; justify-content: center; align-items: center;">
            <div style="margin: 0 10px 0 5px;">版权所有 © 2023～2025 <a href="https://bd4sur.com" target="_blank">BD4SUR</a></div>
            <a style="border-bottom: none; display: flex;" href="https://github.com/bd4sur/Nano"><img alt="GitHub stars" height="16px" style="margin-left: 6px; filter: opacity(0.5);" src="https://img.shields.io/github/stars/bd4sur/Nano?style=social"></a>
        </div>
    </div>
</div>

</body>

<object id="submit_icon" style="display: none;">
    <svg style="margin: 1px 1px 0 0;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px"><path d="M1008.00076 6.285714q18.857143 13.714286 15.428571 36.571429l-146.285714 877.714286q-2.857143 16.571429-18.285714 25.714285-8 4.571429-17.714286 4.571429-6.285714 0-13.714286-2.857143l-258.857142-105.714286-138.285715 168.571429q-10.285714 13.142857-28 13.142857-7.428571 0-12.571428-2.285714-10.857143-4-17.428572-13.428572T365.715046 987.428571v-199.428571l493.714285-605.142857-610.857142 528.571428-225.714286-92.571428q-21.142857-8-22.857143-31.428572-1.142857-22.857143 18.285714-33.714285L969.143617 5.142857q8.571429-5.142857 18.285714-5.142857 11.428571 0 20.571429 6.285714z" fill="#fff"></path></svg>
</object>

<script src="./jquery.js"></script>
<script src="./socket.io.js"></script>
<script src="./marked.min.js"></script>
<script src="./components.js"></script>
<script src="./infer.js"></script>
<script src="./prompt.js"></script>
<script src="./tts.js"></script>
<script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/t2cn.js"></script>
<script src="./asr.js"></script>
<script>


const ASR_IP_PORT = "wss://ai.bd4sur.intra:10096";
const LLM_IP_PORT = "https://ai.bd4sur.intra:5000"
const TTS_IP_PORT = "https://ai.bd4sur.intra:5000"

let llm_socket = io.connect(`${LLM_IP_PORT}/chat`, {secure: true});
let tts_socket = io.connect(`${TTS_IP_PORT}/tts`, {secure: true});


// 全局状态：使用哪种推理后端
let NANO_INFER_BACKEND = "wasm"; // "api", "js" or "wasm"

let nano_worker = new Worker('nano_worker.js', {type: 'module'});

let round_counter = 0;
let is_instruct_enabled = true;
let is_lora_enabled = false;

let SYSTEM_PROMPT_CONTENT = "";

let SESSION_ID = new Date().getTime();
let CHAT_HISTORY = [{"role": "system", "content": SYSTEM_PROMPT_CONTENT}];
let CURRENT_MODEL = "qwen15-72b-16k";







let modal = new Modal("modal", "modal_mask");

let top_k = new RangeInput("top_k", "Top K", 0, 100, 1, 0);
let top_p = new RangeInput("top_p", "Top P", 0, 1, 0.1, 0.5);
let temperature = new RangeInput("temperature", "温度", 0, 2, 0.1, 1.0);
let repetition_penalty = new RangeInput("repetition_penalty", "复读惩罚", 0.5, 1.5, 0.1, 1.1);
let max_seq_len= new RangeInput("max_seq_len", "最大序列长度", 1, 1024, 1, 511);




// 终端类型判断："Desktop" or "Mobile"
function GetMediaType() {
    return ($(window).width() >= 650) ? "Desktop" : "Mobile";
}

function layout_init() {
    $("#submit").html($("#submit_icon").html());
    refresh_prompts(5);
}

function layout_refresh(left_width) {
    let media_type = GetMediaType();

    let clientHeight = window.innerHeight;
    let clientWidth = window.innerWidth;

    if(media_type == "Desktop") {
        $(".Main").height(clientHeight - (32*2+10+2));
    }
    else {
        $(".Main").height(clientHeight);
    }

    let main_width = $(".Main").width();
    let main_height = $(".Main").height();
    let chat_input_height = $(".ChatInput").outerHeight();
    let top_height = $(".Top").outerHeight();
    $(".Middle").height(main_height - top_height - chat_input_height);

    $(".Left").width(left_width);
    $(".Right").width(main_width - left_width);

}



function scroll_to_bottom() {
    let scrollHeight = $(".Chat").prop("scrollHeight");
    $(".Chat").animate({scrollTop:scrollHeight}, 0);
}

function switch_submit_button_state(state) {
    if(state === "submit") {
        $("#submit").removeClass("ButtonInterrupt");
        $("#submit").html($("#submit_icon").html());
        $("#input").removeAttr("disabled");
    }
    else if(state === "interrupt") {
        $("#submit").addClass("ButtonInterrupt");
        $("#submit").text("中断");
        $("#input").attr("disabled", "disabled");
    }
}

function show_input_box() {
    document.querySelector('#submit').removeAttribute("disabled");
    $('.LoadModel').fadeOut(300, () => {
        $(".backend_select").fadeOut(300, () => {
            $(".ChatInputContainer").fadeIn(300);
            $(".GuideQuestionContainer").fadeIn(300);
            $(".ButtonClearall").fadeIn(300);
        });
    });
}


function append_user_bubble(markdown, round_counter, date_str) {
    $("#ChatRecord").append(`
        <div class="ChatRound UserRound">
            <!--div class="ChatAvatarContainer UserAvatarContainer"><img class="UserAvatarImage" src="https://bd4sur.com/favicon.ico"></div-->
            <div class="ChatBubble UserBubble">
                <div class="ChatContent" id="user_${round_counter}">${markdown}</div>
                <div class="UserBubbleFooter">
                    <div class="UserFooterInfo"><b>Homo</b> ${date_str}</div>
                    <div class="UserCopyBubble" onclick="navigator.clipboard.writeText($('#user_${round_counter}').text())">
                        <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="12px" height="12px"><path d="M725.333333 469.333333h-85.333333v85.333334h-85.333333v-85.333334h-85.333334V384h85.333334V298.666667h85.333333v85.333333h85.333333v85.333333z m85.333334-256v426.666667H384V213.333333h426.666667m10.666666-85.333333H373.333333A74.666667 74.666667 0 0 0 298.666667 202.666667v448c0 41.216 33.450667 74.666667 74.666666 74.666666h448A74.666667 74.666667 0 0 0 896 650.666667V202.666667A74.666667 74.666667 0 0 0 821.333333 128M213.333333 298.666667H128v512a85.333333 85.333333 0 0 0 85.333333 85.333333h512v-85.333333H213.333333V298.666667z" fill="#aaaeba"></path></svg>
                        <span>复制</span>
                    </div>
                </div>
                <div class="UserBubbleProgressBar" id="prefill_progress_${round_counter}"></div>
            </div>
        </div>`);
}

function append_bot_bubble(round_counter, date_str, tps) {
    $("#ChatRecord").append(`
        <div class="ChatRound BotRound">
            <!--div class="ChatAvatarContainer BotAvatarContainer"><img class="BotAvatarImage" src="avatar_bot.jpg"></div-->
            <div class="ChatBubble BotBubble">
                <div class="ChatContent" id="bot_response_${round_counter}"><span style="color: #c9ced6;">正在思考...</span></div>
                <div class="BotBubbleFooter">
                    <div class="BotFooterInfo" id="bot_footer_${round_counter}"><b>Nano</b> ${date_str}</div>
                    <div style="display: flex;">
                        <div class="BotTTSBubble" onclick="start_tts($('#bot_response_${round_counter}').text())">
                            <span>朗读</span>
                        </div>
                        <div class="BotCopyBubble" onclick="navigator.clipboard.writeText($('#bot_response_${round_counter}').text())">
                            <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="12px" height="12px"><path d="M725.333333 469.333333h-85.333333v85.333334h-85.333333v-85.333334h-85.333334V384h85.333334V298.666667h85.333333v85.333333h85.333333v85.333333z m85.333334-256v426.666667H384V213.333333h426.666667m10.666666-85.333333H373.333333A74.666667 74.666667 0 0 0 298.666667 202.666667v448c0 41.216 33.450667 74.666667 74.666666 74.666666h448A74.666667 74.666667 0 0 0 896 650.666667V202.666667A74.666667 74.666667 0 0 0 821.333333 128M213.333333 298.666667H128v512a85.333333 85.333333 0 0 0 85.333333 85.333333h512v-85.333333H213.333333V298.666667z" fill="#aaaeba"></path></svg>
                            <span>复制</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>`);
}

function update_bot_bubble(markdown, round_counter) {
    $(`#bot_response_${round_counter}`).html(markdown);
}

function update_bot_footer(text, round_counter) {
    $(`#bot_footer_${round_counter}`).html(text);
}

function clear_chat_record() {
    $("#ChatRecord").html("");
}

function append_chat_info(info) {
    $("#ChatRecord").append(`<div class="ChatInfo">${info}</div>`);
}

function set_input_box(content) {
    $("#input").val(content);
    $("#input").trigger("change");
}

function get_current_time() {
    let date_obj = new Date();
    let hh = `00${date_obj.getHours()}`.slice(-2);
    let mm = `00${date_obj.getMinutes()}`.slice(-2);
    let ss = `00${date_obj.getSeconds()}`.slice(-2);
    return `${hh}:${mm}:${ss}`;
}






$(".Top").click(() => {
    $(".Chat").animate({ scrollTop: 0 }, "fast");
});

$("#submit").click(function(event) {
    if($('#submit').hasClass("ButtonInterrupt") === true) {
        interrupt();
        return false;
    }
    else {
        submit();
        return false;
    }
});

$("#input").on("keydown", function(e) {
    if(e.shiftKey && e.keyCode === 13) {
        if($('#submit').hasClass("ButtonInterrupt") === true) {
            interrupt();
            return false;
        }
        else {
            submit();
            return false;
        }
    }
});

$("#input").on("input propertychange change keydown", function(e) {
    $(this).innerHeight(30);
    $(this).innerHeight(this.scrollHeight);
});

$(".ChatInputContainer").on("click", function(e) {
    $("#input").focus();
});

$("#clear_input_box").on("click", function() {
    set_input_box("");
});

$("#setting").on("click", function() {
    modal.toggle();
});

$("#modal_confirm").on("click", function() {
    $(".ModalThrobberContainer").css("display", "flex");
    // do something
    modal.hide();
    $(".ModalThrobberContainer").css("display", "none");
});

$("#modal_cancel").on("click", function() {
    modal.hide();
});

$("#clearall").on("click", function() {
    clear_chat_record();
    append_chat_info("对话历史已清除");
});

$("#instruct_switch").on("click", function() {
    if(is_instruct_enabled === true) {
        is_instruct_enabled = false;
        $("#instruct_switch").removeClass("ButtonHover");
        append_chat_info("问答模式已关闭（启用文本续写）");
    }
    else {
        is_instruct_enabled = true;
        $("#instruct_switch").addClass("ButtonHover");
        append_chat_info("问答模式已开启");
    }
});

$("#backend_switch").click(function(event) {
    if(NANO_INFER_BACKEND === "js") {
        NANO_INFER_BACKEND = "wasm";
        $("#backend_switch").html(`<b>WASM</b>推理引擎`);
    }
    else if(NANO_INFER_BACKEND === "wasm") {
        NANO_INFER_BACKEND = "js";
        $("#backend_switch").html(`<b>JS</b>推理引擎`);
    }
});

$("#enable_api").click(function(e) {
    NANO_INFER_BACKEND = "api";
    get_current_llm_key();
    show_input_box();
});



// LLM推理引擎事件处理

function llm_on_running(round_counter, text, num_prompt_tokens, num_generated_tokens, status, tps) {
    // <|eos|> or <|padding|>
    if(text.indexOf("<|eos|>") >= 0 || text.indexOf("<|padding|>") >= 0) {
        return false;
    }
    if(status === "Decoding...") {
        $(`#prefill_progress_${round_counter}`).fadeOut(300);
        update_bot_bubble(marked.parse(text.replace(/~/gi, "～")), round_counter);
    }
    else if(status === "Pre-filling...") {
        let prefill_progress = (num_generated_tokens + 1) / num_prompt_tokens * 100;
        $(`#prefill_progress_${round_counter}`).css("width", `${Math.min(prefill_progress, 100)}%`);
    }
    update_bot_footer(`<b>Nano</b> ${get_current_time()} · ${tps.toFixed(2)} tokens/s · ${status}`, round_counter);
    switch_submit_button_state("interrupt");
    scroll_to_bottom();
    return true;
}

function llm_on_finished(round_counter, tps) {
    switch_submit_button_state("submit");
    update_bot_footer(`<b>Nano</b> ${get_current_time()} · ${tps.toFixed(2)} tokens/s on avg`, round_counter);
    return (round_counter + 1);
}














// 读取模型文件
let model_file_selector = document.getElementById('model_file_selector');
model_file_selector.onchange = async () => {
    $('.LoadRemoteModelButton').hide();
    $(".LoadModelPrompt").hide();
    $("#download_model_button").hide();
    $("#model_button_vert_bar").hide();
    let file = model_file_selector.files[0];
    let Reader = new FileReader();
    Reader.onloadend = () => {
        $('#load_model_button_prompt').html("正在解析...");
        let file_buffer = Reader.result;
        if(NANO_INFER_BACKEND === "wasm") {
            nano_worker.postMessage({
                eventType: "MODEL_FILE",
                eventData: file_buffer
            });
        }
        else if(NANO_INFER_BACKEND == "js") {
            load_model(file_buffer);
            show_input_box();
        }
    };
    Reader.readAsArrayBuffer(file);
    $('#load_model_button_prompt').html("正在读取...");
};




$(".LoadRemoteModelButton").on("click", async function () {

    async function fetch_cache_model(model_url) {
        let _cache = undefined;
        let is_cached = false;
        let response;

        if(window.caches !== undefined) {
        // if(false) {
            _cache = await window.caches.open("binaryFileCache");
            const cachedResponse = await _cache.match(model_url);
            if(cachedResponse) {
                console.log(`模型 ${model_url} 已缓存过，直接取缓存。`);
                is_cached = true;
                response = cachedResponse;
            }
            else {
                console.log(`模型 ${model_url} 尚未缓存过，从远程获取。`);
                const model_response = await fetch(model_url);
                response = model_response;
            }
        }
        else {
            console.log(`浏览器不支持 Cache API，从远程获取 ${model_url}。`);
            const model_response = await fetch(model_url);
            response = model_response;
        }

        let content_length = response.headers.get('Content-Length');
        let response_length = 0;
        let file_buffer = new Uint8Array(content_length);

        async function* streamAsyncIterable(stream) {
            const reader = stream.getReader();
            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) return;
                    yield value;
                }
            }
            finally {
                reader.releaseLock();
            }
        }

        for await (let chunk of streamAsyncIterable(response.body)) {
            file_buffer.set(chunk, response_length);
            response_length += chunk.length;
            $('.LoadRemoteModelButtonPrompt').html(`正在读取... ${(response_length / content_length * 100).toFixed(1)}%`);
        }

        if(window.caches !== undefined && is_cached === false) {
            let blob = new Blob([file_buffer]);
            const responseToCache = new Response(blob, {
                headers: { 'Content-Length': content_length }
            });
            await _cache.put(model_url, responseToCache);
        }

        return file_buffer;
    }

    $('.LoadRemoteModelButton').off("click");
    $('.LoadRemoteModelButtonPrompt').html("正在连接HuggingFace...");
    $('#select_file').hide();
    $('.LoadModelButton').hide();
    $(".LoadModelPrompt").hide();
    $(this).show();

    const model_name = $(this).attr("data-model-name");
    $("#model_name").html(model_name);

    const model_url = $(this).attr("data-model-url");
    let file_buffer = await fetch_cache_model(model_url);

    $('.LoadRemoteModelButtonPrompt').html("正在解析...");
    if(NANO_INFER_BACKEND === "wasm") {
        nano_worker.postMessage({
            eventType: "MODEL_FILE",
            eventData: file_buffer
        });
    }
    else if(NANO_INFER_BACKEND == "js") {
        load_model(file_buffer);
        document.querySelector('#submit').removeAttribute("disabled");
        $('.LoadModel').fadeOut(300, () => {
            $(".backend_select").fadeOut(300, () => {
                $(".ChatInputContainer").fadeIn(300);
                $(".GuideQuestionContainer").fadeIn(300);
                $(".ButtonClearall").fadeIn(300);
            });
        });
    }
});


// 读取外挂LoRA模块
$("#lora_file_selector").on("change", function(event) {
    console.log("File");
    let file = this.files[0];
    let Reader = new FileReader();
    Reader.onloadend = () => {
        let file_buffer = Reader.result;
        if(NANO_INFER_BACKEND === "wasm") {
            nano_worker.postMessage({
                eventType: "LOAD_LORA",
                eventData: {
                    file_buffer: file_buffer,
                    file_name: file.name
                }
            });
        }
        else {
            let res = load_lora(file_buffer);
            if(res === false) {
                append_chat_info(`LoRA模块加载失败：模块与基座不匹配QAQ`);
            }
            else {
                is_lora_enabled = true;
                $("#lora_button").addClass("ButtonLoRAHover");
                $("#lora_button_icon").attr("fill", "#5c8e1f");
                $("#lora_file_selector").hide();
                append_chat_info(`已加载LoRA模块：${file.name}`);
            }
        }
    };
    Reader.readAsArrayBuffer(file);
    event.stopPropagation();
});

$("#lora_button").on("click", function(e) {
    console.log("Button");
    if(is_lora_enabled === true) {
        if(NANO_INFER_BACKEND === "wasm") {
            nano_worker.postMessage({
                eventType: "UNLOAD_LORA",
                eventData: "Unload LoRA module."
            });
        }
        else if(NANO_INFER_BACKEND === "js") {
            is_lora_enabled = false;
            $("#lora_button").removeClass("ButtonLoRAHover");
            $("#lora_button_icon").attr("fill", "#383a40");
            $("#lora_file_selector").val("");
            $("#lora_file_selector").show();
            append_chat_info("已卸载LoRA模块");
        }
    }
});







nano_worker.addEventListener('message', function(event) {
    let eventData = event.data;

    if(eventData.eventType === 'INFO') {
        console.log(`Main received from worker: ${eventData.eventData.message}`);
    }

    if(eventData.eventType === 'ON_RUNNING') {
        let text = eventData.eventData.text;
        let num_prompt_tokens = eventData.eventData.num_prompt_tokens;
        let num_generated_tokens = eventData.eventData.num_generated_tokens;
        let status = eventData.eventData.status;
        let tps = eventData.eventData.tps;

        return llm_on_running(round_counter, text, num_prompt_tokens, num_generated_tokens, status, tps);
    }

    if(eventData.eventType === 'ON_FINISHED') {
        round_counter = llm_on_finished(round_counter, eventData.eventData.tps);
    }

    if(eventData.eventType === 'INIT_FINISHED') {
        show_input_box();
    }

    if(eventData.eventType === 'LORA_LOADED') {
        is_lora_enabled = true;
        $("#lora_button").addClass("ButtonLoRAHover");
        $("#lora_button_icon").attr("fill", "#5c8e1f");
        $("#lora_file_selector").hide();
        append_chat_info(`已加载LoRA模块：${eventData.eventData.lora_file_name}`);
    }

    if(eventData.eventType === 'LORA_UNLOADED') {
        is_lora_enabled = false;
        $("#lora_button").removeClass("ButtonLoRAHover");
        $("#lora_button_icon").attr("fill", "#383a40");
        $("#lora_file_selector").val("");
        $("#lora_file_selector").show();
        append_chat_info("已卸载LoRA模块");
    }

});





function get_current_llm_key() {
    llm_socket.emit("get_current_llm_key");
}
llm_socket.on("get_current_llm_key_callback", function(res) {
    append_chat_info(`当前LLM：${res.current_llm_key}`);
    $("#model_config").val(res.current_llm_key)
});






let start_generating_timestamp = 0;
let end_generating_timestamp = 0;
let char_count = 0;

llm_socket.on("chat_response", function(msg) {
    if(msg.status === "start") {
        start_generating_timestamp = new Date().getTime();
        append_bot_bubble(round_counter, get_current_time());
        scroll_to_bottom();
    }
    else if(msg.status === "generating") {
        switch_submit_button_state("interrupt");
        let llm_output = msg.llm_output;
        console.log(llm_output.content);
        let content = llm_output.content.replace(/\\\(/gi, "$")
                                        .replace(/\\\)/gi, "$")
                                        .replace(/\\\[/gi, "$$$")
                                        .replace(/\\\]/gi, "$$$")
                                        .replace(/\~/gi, "～")
                                        .replace("<think>", "<blockquote><p style=\"font-weight: bold;\">思考中...</p>")
                                        .replace("</think>", "</blockquote>");
        let md = marked.parse(content);
        char_count = content.length;
        update_bot_bubble(md, round_counter);
        update_bot_footer(`<b>Nano</b> ${get_current_time()}`, round_counter);
        // MathJax.startup.defaultPageReady();
        scroll_to_bottom();
    }
    else if(msg.status === "end") {
        end_generating_timestamp = new Date().getTime();
        CHAT_HISTORY.push(msg.llm_output)
        switch_submit_button_state("submit");
        let cps = char_count / (end_generating_timestamp - start_generating_timestamp) * 1000;
        update_bot_footer(`<b>Nano</b> ${get_current_time()} · ${cps.toFixed()} char/s on avg`, round_counter);

        // TTS
        /*
        if(is_tts_enabled === true) {
            let tts_input_texts = segment(msg.llm_output.content);
            tts_socket.emit("generate", {
                "session_id": round_counter,
                "speaker": "default",
                "refine_enabled": true,
                "refine_prompt": "",
                "generation_prompt": "[oral_2][break_6]",
                "texts": tts_input_texts
            });
        }
        */

        round_counter++; return;
    }
});




function submit() {

    let user_input = document.querySelector('#input').value;
    user_input = user_input.replace(/\\\(/gi, "$")
                           .replace(/\\\)/gi, "$")
                           .replace(/\\\[/gi, "$$$")
                           .replace(/\\\]/gi, "$$$");
    let prompt = is_instruct_enabled ? `<|instruct_mark|>${user_input}<|response_mark|>` : user_input;

    append_user_bubble(marked.parse(user_input), round_counter, get_current_time());

    let gen_args = {
        top_p:              Number(top_p.getValue()),
        top_k:              Number(top_k.getValue()),
        temperature:        Number(temperature.getValue()),
        repetition_penalty: Number(repetition_penalty.getValue()),
        max_seq_len:        Number(max_seq_len.getValue())
    }

    if(NANO_INFER_BACKEND === "api") {
        CHAT_HISTORY.push({"role": "user", "content": user_input});
        let llm_request = {
            "session_id": SESSION_ID,
            "timestamp": new Date().getTime(),
            "config": {
                "temperature": gen_args.temperature,
                "top_p": gen_args.top_p,
                "top_k": gen_args.top_k,
            },
            "chatml": CHAT_HISTORY
        };
        console.log(llm_request);
        llm_socket.emit("submit", llm_request);
    }
    else if(NANO_INFER_BACKEND === "wasm") {
        console.log(`Send: ${prompt}`);

        append_bot_bubble(round_counter, get_current_time());
        scroll_to_bottom();

        nano_worker.postMessage({
            eventType: "INFER",
            eventData: {
                prompt: prompt,
                args: gen_args
            }
        });
    }
    else if(NANO_INFER_BACKEND === "js") {
        generate(
            prompt,
            gen_args,
            () => {
                append_bot_bubble(round_counter, get_current_time());
                scroll_to_bottom();
            },
            (text, num_prompt_tokens, num_generated_tokens, status, tps) => {
                return llm_on_running(round_counter, text, num_prompt_tokens, num_generated_tokens, status, tps);
            },
            (tps) => {
                round_counter = llm_on_finished(round_counter, tps);
            }
        );
    }

    switch_submit_button_state("interrupt");
    set_input_box("");
    // MathJax.startup.defaultPageReady();
    scroll_to_bottom();
}

function interrupt() {
    append_chat_info("手动中断");
    if(NANO_INFER_BACKEND === "api") {
        llm_socket.emit("interrupt", {});
    }
    else if(NANO_INFER_BACKEND === "wasm") {
        nano_worker.postMessage({
            eventType: "INTERRUPT",
            eventData: ""
        });
    }
    else if(NANO_INFER_BACKEND === "js") {
        is_generating = false;
    }
    scroll_to_bottom();
}














let layoutObserver = new MutationObserver((mutations, observer) => {
    layout_refresh();
});
layoutObserver.observe(document.getElementsByTagName('html')[0], {attributes: true, characterData: true, childList: true, subtree: true});





(async () => {
    layout_init();
    create_whisper_worker();
})();



</script>
