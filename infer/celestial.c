#include <stdlib.h>
#include <stdint.h>
#include <stdio.h>
#include <math.h>

#include "utils.h"
#include "glyph.h"

#include "celestial.h"
#include "ephemeris.h"

#ifndef M_PI
    #define M_PI (3.14159265358979323846)
#endif

#ifndef M_PI_2
    # define M_PI_2 (1.57079632679489661923)
#endif

#define MIN(x,y) (((x) < (y)) ? (x) : (y))
#define MAX(x,y) (((x) > (y)) ? (x) : (y))

static int32_t USE_FISHEYE_PROJECTION = 1; // 是否使用鱼眼投影（否则使用XY投影）

// 是否启用赤道坐标圈
static int32_t enable_equatorial_coord = 1;
// 是否启用地平坐标圈
static int32_t enable_horizontal_coord = 1;
// 是否启用星芒效果
static int32_t enable_star_burst = 1;
// 是否启用大气散射效果
static int32_t enable_atmospheric_scattering = 1;

// 大气光学参数
static float MIE_G = 0.9f;
static float RAYLEIGH_BETA = 0.3f;
static float MIE_BETA_BASE = 0.001f;
static float MIE_BETA_MAX = 0.1f;
static float ATMOSPHERE_HEIGHT = 8.5f;

// 波长相关的瑞利散射系数 (近似)
static float RAYLEIGH_WAVELENGTH_FACTORS[3] = { 680, 550, 450 };

// 臭氧吸收系数
static float OZONE_ABSORPTION[3] = { 0.005,  0.040,  0.025 };

// 星表
#define STARS_NUM (12)
static float STARS[STARS_NUM][7] = {
//(RA)h   m   s    (Dec)d   m   s       Mag
    {2.0f,  32.0f, 9.3f,      89.0f, 16.0f, 10.8f,   2.09f}, // 勾陈一（北极星）
    {11.0f, 3.0f,  45.2f,     61.0f, 44.0f, 47.5f,   1.95f}, // 天枢
    {11.0f, 1.0f,  52.5f,     56.0f, 22.0f, 43.0f,   2.34f}, // 天璇
    {11.0f, 53.0f, 51.4f,     53.0f, 41.0f, 24.5f,   2.42f}, // 天玑
    {12.0f, 15.0f, 27.0f,     57.0f, 1.0f,  39.6f,   3.33f}, // 天权
    {12.0f, 54.0f, 2.8f,      55.0f, 57.0f, 16.2f,   1.75f}, // 玉衡
    {13.0f, 23.0f, 56.3f,     54.0f, 55.0f, 11.3f,   2.25f}, // 开阳
    {13.0f, 47.0f, 32.2f,     49.0f, 18.0f, 28.7f,   1.80f}, // 摇光

    {6.0f,  45.0f, 91.0f,    -16.0f, 43.0f, 35.0f,  -1.46f}, // 天狼
    {14.0f, 15.0f, 37.6f,     19.0f, 9.0f,  53.3f,  -0.05f}, // 大角
    {18.0f, 36.0f, 55.2f,     38.0f, 46.0f, 59.8f,   0.03f}, // 织女一
    {19.0f, 50.0f, 46.6f,      8.0f, 52.0f, 10.9f,   0.76f}  // 河鼓二
};

static wchar_t STAR_NAME[STARS_NUM][10] = {
    L"北极星", L"", L"", L"", L"", L"", L"", L"",
    L"天狼", L"大角", L"织女一", L"河鼓二"
};

// 月球表面纹理
static const uint32_t moon_texture_width = 64;
static const uint32_t moon_texture_height = 64;
static const uint8_t moon_texture_rgba[16384] = {1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,0,0,0,255,0,0,0,255,3,3,3,255,3,3,3,255,0,0,0,255,0,0,0,255,7,7,7,255,3,3,3,255,6,6,6,255,0,0,0,255,0,0,0,255,1,1,1,255,8,8,8,255,7,7,7,255,2,2,2,255,0,0,0,255,1,1,1,255,0,0,0,255,0,0,0,255,4,4,4,255,11,11,11,255,14,14,14,255,17,17,17,255,19,19,19,255,11,11,11,255,8,8,8,255,3,3,3,255,0,0,0,255,0,0,0,255,0,0,0,255,2,2,2,255,6,6,6,255,10,10,10,255,2,2,2,255,0,0,0,255,0,0,0,255,0,0,0,255,1,1,1,255,1,1,1,255,2,2,2,255,0,0,0,255,2,2,2,255,3,3,3,255,2,2,2,255,1,1,1,255,1,1,1,255,1,1,1,255,2,2,2,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,3,3,3,255,0,0,0,255,3,3,3,255,6,6,6,255,3,3,3,255,4,4,4,255,0,0,0,255,0,0,0,255,0,0,0,255,1,1,1,255,6,6,6,255,4,4,4,255,0,0,0,255,0,0,0,255,3,3,3,255,12,12,12,255,38,38,38,255,63,63,63,255,94,94,94,255,117,117,117,255,128,128,128,255,131,131,131,255,130,130,130,255,128,128,128,255,123,123,123,255,117,117,117,255,108,108,108,255,95,95,95,255,75,75,75,255,48,48,48,255,20,20,20,255,1,1,1,255,0,0,0,255,0,0,0,255,6,6,6,255,6,6,6,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,4,4,4,255,4,4,4,255,4,4,4,255,3,3,3,255,1,1,1,255,1,1,1,255,1,1,1,255,2,2,2,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,0,0,0,255,2,2,2,255,5,5,5,255,2,2,2,255,0,0,0,255,0,0,0,255,4,4,4,255,11,11,11,255,2,2,2,255,6,6,6,255,4,4,4,255,0,0,0,255,4,4,4,255,40,40,40,255,98,98,98,255,143,143,143,255,157,157,157,255,182,182,182,255,203,203,203,255,206,206,206,255,204,204,204,255,207,207,207,255,209,209,209,255,208,208,208,255,219,219,219,255,206,206,206,255,187,187,187,255,172,172,172,255,159,159,159,255,143,143,143,255,125,125,125,255,111,111,111,255,80,80,80,255,51,51,51,255,17,17,17,255,1,1,1,255,4,4,4,255,10,10,10,255,6,6,6,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,1,1,1,255,3,3,3,255,4,4,4,255,5,5,5,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,0,0,0,255,3,3,3,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,8,8,8,255,10,10,10,255,4,4,4,255,18,18,18,255,69,69,69,255,142,142,142,255,192,192,192,255,196,196,196,255,179,179,179,255,188,188,188,255,200,200,200,255,203,203,203,255,196,196,196,255,199,199,199,255,216,216,216,255,227,227,227,255,227,227,227,255,200,200,200,255,187,187,187,255,170,170,170,255,158,158,158,255,157,157,157,255,161,161,161,255,167,167,167,255,170,170,170,255,166,166,166,255,164,164,164,255,142,142,142,255,94,94,94,255,39,39,39,255,4,4,4,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,1,1,1,255,4,4,4,255,5,5,5,255,3,3,3,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,6,6,6,255,4,4,4,255,0,0,0,255,0,0,0,255,15,15,15,255,5,5,5,255,0,0,0,255,0,0,0,255,23,23,23,255,85,85,85,255,157,157,157,255,194,194,194,255,196,196,196,255,190,190,190,255,189,189,189,255,190,190,190,255,170,170,170,255,175,175,175,255,178,178,178,255,183,183,183,255,198,198,198,255,215,215,215,255,215,215,215,255,204,204,204,255,186,186,186,255,186,186,186,255,182,182,182,255,173,173,173,255,163,163,163,255,157,157,157,255,156,156,156,255,157,157,157,255,164,164,164,255,190,190,190,255,207,207,207,255,189,189,189,255,142,142,142,255,86,86,86,255,37,37,37,255,6,6,6,255,7,7,7,255,5,5,5,255,3,3,3,255,3,3,3,255,4,4,4,255,3,3,3,255,0,0,0,255,0,0,0,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,0,0,0,255,9,9,9,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,18,18,18,255,65,65,65,255,161,161,161,255,175,175,175,255,185,185,185,255,184,184,184,255,181,181,181,255,174,174,174,255,158,158,158,255,139,139,139,255,163,163,163,255,156,156,156,255,153,153,153,255,160,160,160,255,173,173,173,255,181,181,181,255,177,177,177,255,171,171,171,255,160,160,160,255,165,165,165,255,167,167,167,255,162,162,162,255,152,152,152,255,145,145,145,255,146,146,146,255,149,149,149,255,174,174,174,255,176,176,176,255,179,179,179,255,186,186,186,255,189,189,189,255,167,167,167,255,110,110,110,255,56,56,56,255,10,10,10,255,4,4,4,255,0,0,0,255,0,0,0,255,0,0,0,255,1,1,1,255,2,2,2,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,0,0,0,255,9,9,9,255,1,1,1,255,0,0,0,255,13,13,13,255,31,31,31,255,80,80,80,255,158,158,158,255,173,173,173,255,181,181,181,255,178,178,178,255,160,160,160,255,146,146,146,255,139,139,139,255,129,129,129,255,116,116,116,255,113,113,113,255,104,104,104,255,102,102,102,255,111,111,111,255,116,116,116,255,118,118,118,255,131,131,131,255,148,148,148,255,152,152,152,255,153,153,153,255,152,152,152,255,150,150,150,255,150,150,150,255,156,156,156,255,166,166,166,255,174,174,174,255,170,170,170,255,191,191,191,255,201,201,201,255,185,185,185,255,161,161,161,255,144,144,144,255,129,129,129,255,116,116,116,255,47,47,47,255,32,32,32,255,12,12,12,255,0,0,0,255,0,0,0,255,0,0,0,255,4,4,4,255,6,6,6,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,4,4,4,255,5,5,5,255,0,0,0,255,9,9,9,255,72,72,72,255,100,100,100,255,119,119,119,255,164,164,164,255,153,153,153,255,141,141,141,255,119,119,119,255,106,106,106,255,117,117,117,255,135,135,135,255,131,131,131,255,113,113,113,255,101,101,101,255,98,98,98,255,106,106,106,255,113,113,113,255,99,99,99,255,82,82,82,255,93,93,93,255,120,120,120,255,125,125,125,255,123,123,123,255,120,120,120,255,119,119,119,255,118,118,118,255,117,117,117,255,116,116,116,255,115,115,115,255,111,111,111,255,152,152,152,255,191,191,191,255,201,201,201,255,193,193,193,255,178,178,178,255,156,156,156,255,136,136,136,255,111,111,111,255,85,85,85,255,48,48,48,255,18,18,18,255,2,2,2,255,0,0,0,255,0,0,0,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,7,7,7,255,0,0,0,255,0,0,0,255,2,2,2,255,1,1,1,255,0,0,0,255,1,1,1,255,12,12,12,255,8,8,8,255,0,0,0,255,27,27,27,255,84,84,84,255,109,109,109,255,108,108,108,255,108,108,108,255,109,109,109,255,99,99,99,255,118,118,118,255,127,127,127,255,128,128,128,255,144,144,144,255,163,163,163,255,148,148,148,255,115,115,115,255,144,144,144,255,138,138,138,255,134,134,134,255,138,138,138,255,144,144,144,255,140,140,140,255,121,121,121,255,102,102,102,255,111,111,111,255,122,122,122,255,121,121,121,255,105,105,105,255,96,96,96,255,97,97,97,255,90,90,90,255,76,76,76,255,92,92,92,255,106,106,106,255,128,128,128,255,164,164,164,255,185,185,185,255,163,163,163,255,149,149,149,255,172,172,172,255,155,155,155,255,122,122,122,255,105,105,105,255,74,74,74,255,18,18,18,255,0,0,0,255,9,9,9,255,0,0,0,255,0,0,0,255,1,1,1,255,0,0,0,255,0,0,0,255,0,0,0,255,5,5,5,255,2,2,2,255,0,0,0,255,3,3,3,255,1,1,1,255,0,0,0,255,0,0,0,255,2,2,2,255,3,3,3,255,0,0,0,255,0,0,0,255,1,1,1,255,25,25,25,255,69,69,69,255,98,98,98,255,101,101,101,255,98,98,98,255,84,84,84,255,59,59,59,255,111,111,111,255,157,157,157,255,186,186,186,255,170,170,170,255,149,149,149,255,147,147,147,255,144,144,144,255,132,132,132,255,136,136,136,255,142,142,142,255,135,135,135,255,125,125,125,255,138,138,138,255,160,160,160,255,155,155,155,255,131,131,131,255,122,122,122,255,109,109,109,255,111,111,111,255,126,126,126,255,125,125,125,255,106,106,106,255,95,95,95,255,100,100,100,255,93,93,93,255,100,100,100,255,139,139,139,255,172,172,172,255,170,170,170,255,167,167,167,255,165,165,165,255,150,150,150,255,148,148,148,255,144,144,144,255,137,137,137,255,125,125,125,255,88,88,88,255,30,30,30,255,0,0,0,255,1,1,1,255,1,1,1,255,3,3,3,255,2,2,2,255,0,0,0,255,0,0,0,255,2,2,2,255,1,1,1,255,0,0,0,255,0,0,0,255,1,1,1,255,0,0,0,255,0,0,0,255,2,2,2,255,6,6,6,255,1,1,1,255,0,0,0,255,21,21,21,255,46,46,46,255,79,79,79,255,91,91,91,255,89,89,89,255,106,106,106,255,125,125,125,255,124,124,124,255,150,150,150,255,166,166,166,255,170,170,170,255,154,154,154,255,140,140,140,255,133,133,133,255,120,120,120,255,103,103,103,255,96,96,96,255,119,119,119,255,118,118,118,255,102,102,102,255,124,124,124,255,171,171,171,255,182,182,182,255,158,158,158,255,143,143,143,255,121,121,121,255,119,119,119,255,141,141,141,255,150,150,150,255,135,135,135,255,125,125,125,255,130,130,130,255,121,121,121,255,117,117,117,255,156,156,156,255,174,174,174,255,151,151,151,255,164,164,164,255,174,174,174,255,132,132,132,255,123,123,123,255,150,150,150,255,144,144,144,255,136,136,136,255,135,135,135,255,82,82,82,255,14,14,14,255,0,0,0,255,1,1,1,255,2,2,2,255,3,3,3,255,3,3,3,255,1,1,1,255,0,0,0,255,0,0,0,255,2,2,2,255,0,0,0,255,0,0,0,255,1,1,1,255,2,2,2,255,0,0,0,255,0,0,0,255,7,7,7,255,18,18,18,255,90,90,90,255,77,77,77,255,79,79,79,255,82,82,82,255,74,74,74,255,91,91,91,255,138,138,138,255,176,176,176,255,176,176,176,255,135,135,135,255,99,99,99,255,95,95,95,255,105,105,105,255,100,100,100,255,83,83,83,255,70,70,70,255,69,69,69,255,95,95,95,255,102,102,102,255,90,90,90,255,106,106,106,255,150,150,150,255,170,170,170,255,160,160,160,255,146,146,146,255,137,137,137,255,127,127,127,255,128,128,128,255,140,140,140,255,148,148,148,255,139,139,139,255,124,124,124,255,120,120,120,255,116,116,116,255,141,141,141,255,152,152,152,255,142,142,142,255,165,165,165,255,184,184,184,255,163,163,163,255,114,114,114,255,145,145,145,255,134,134,134,255,113,113,113,255,135,135,135,255,140,140,140,255,83,83,83,255,21,21,21,255,0,0,0,255,0,0,0,255,0,0,0,255,4,4,4,255,3,3,3,255,0,0,0,255,0,0,0,255,5,5,5,255,1,1,1,255,0,0,0,255,2,2,2,255,6,6,6,255,0,0,0,255,0,0,0,255,22,22,22,255,62,62,62,255,90,90,90,255,76,76,76,255,75,75,75,255,77,77,77,255,74,74,74,255,94,94,94,255,131,131,131,255,154,154,154,255,156,156,156,255,102,102,102,255,65,65,65,255,69,69,69,255,70,70,70,255,55,55,55,255,58,58,58,255,81,81,81,255,81,81,81,255,93,93,93,255,96,96,96,255,89,89,89,255,92,92,92,255,114,114,114,255,140,140,140,255,154,154,154,255,162,162,162,255,159,159,159,255,150,150,150,255,146,146,146,255,154,154,154,255,160,160,160,255,143,143,143,255,119,119,119,255,128,128,128,255,134,134,134,255,134,134,134,255,133,133,133,255,140,140,140,255,144,144,144,255,151,151,151,255,164,164,164,255,138,138,138,255,142,142,142,255,142,142,142,255,126,126,126,255,129,129,129,255,162,162,162,255,146,146,146,255,81,81,81,255,14,14,14,255,0,0,0,255,0,0,0,255,3,3,3,255,5,5,5,255,0,0,0,255,0,0,0,255,5,5,5,255,1,1,1,255,0,0,0,255,2,2,2,255,4,4,4,255,0,0,0,255,5,5,5,255,44,44,44,255,89,89,89,255,56,56,56,255,68,68,68,255,75,75,75,255,70,70,70,255,84,84,84,255,129,129,129,255,151,151,151,255,132,132,132,255,120,120,120,255,79,79,79,255,55,55,55,255,64,64,64,255,63,63,63,255,47,47,47,255,57,57,57,255,85,85,85,255,88,88,88,255,82,82,82,255,81,81,81,255,84,84,84,255,86,86,86,255,97,97,97,255,127,127,127,255,158,158,158,255,171,171,171,255,165,165,165,255,167,167,167,255,177,177,177,255,178,178,178,255,160,160,160,255,135,135,135,255,117,117,117,255,129,129,129,255,147,147,147,255,141,141,141,255,132,132,132,255,139,139,139,255,132,132,132,255,130,130,130,255,153,153,153,255,156,156,156,255,138,138,138,255,155,155,155,255,161,161,161,255,135,135,135,255,136,136,136,255,146,146,146,255,124,124,124,255,53,53,53,255,19,19,19,255,0,0,0,255,1,1,1,255,6,6,6,255,0,0,0,255,0,0,0,255,4,4,4,255,0,0,0,255,2,2,2,255,1,1,1,255,0,0,0,255,6,6,6,255,36,36,36,255,68,68,68,255,85,85,85,255,77,77,77,255,86,86,86,255,88,88,88,255,78,78,78,255,91,91,91,255,131,131,131,255,137,137,137,255,103,103,103,255,89,89,89,255,70,70,70,255,54,54,54,255,54,54,54,255,61,61,61,255,64,64,64,255,66,66,66,255,70,70,70,255,81,81,81,255,72,72,72,255,73,73,73,255,85,85,85,255,97,97,97,255,107,107,107,255,126,126,126,255,146,146,146,255,146,146,146,255,156,156,156,255,163,163,163,255,161,161,161,255,156,156,156,255,145,145,145,255,123,123,123,255,101,101,101,255,92,92,92,255,113,113,113,255,128,128,128,255,121,121,121,255,119,119,119,255,141,141,141,255,165,165,165,255,172,172,172,255,155,155,155,255,147,147,147,255,160,160,160,255,174,174,174,255,157,157,157,255,131,131,131,255,124,124,124,255,129,129,129,255,107,107,107,255,50,50,50,255,3,3,3,255,0,0,0,255,5,5,5,255,0,0,0,255,0,0,0,255,3,3,3,255,0,0,0,255,6,6,6,255,0,0,0,255,0,0,0,255,12,12,12,255,63,63,63,255,83,83,83,255,69,69,69,255,77,77,77,255,70,70,70,255,76,76,76,255,90,90,90,255,103,103,103,255,118,118,118,255,113,113,113,255,89,89,89,255,63,63,63,255,75,75,75,255,71,71,71,255,51,51,51,255,48,48,48,255,65,65,64,255,74,74,74,255,69,69,69,255,85,85,85,255,81,81,80,255,85,85,85,255,100,100,100,255,116,116,116,255,122,122,122,255,120,120,120,255,118,118,118,255,139,139,139,255,176,176,175,255,180,180,180,255,146,146,146,255,138,138,138,255,159,159,159,255,147,147,147,255,108,108,108,255,96,96,96,255,105,105,105,255,128,128,127,255,107,107,107,255,75,75,75,255,119,119,119,255,166,166,166,255,146,146,146,255,155,155,155,255,172,172,172,255,165,165,165,255,168,168,168,255,186,186,186,255,163,163,163,255,126,126,126,255,125,125,125,255,147,147,147,255,75,75,75,255,10,10,10,255,0,0,0,255,4,4,4,255,0,0,0,255,0,0,0,255,3,3,3,255,2,1,0,255,1,0,0,255,1,0,0,255,1,0,0,255,51,50,49,255,94,93,92,255,73,72,71,255,66,65,64,255,74,73,72,255,76,75,74,255,82,81,80,255,85,84,83,255,81,80,79,255,104,103,102,255,65,64,63,255,82,81,80,255,85,84,83,255,78,77,76,255,68,67,66,255,61,60,59,255,60,59,58,255,65,64,63,255,72,71,70,255,77,76,75,255,93,92,91,255,73,72,71,255,79,78,77,255,103,102,101,255,112,111,110,255,113,112,111,255,111,110,109,255,104,103,102,255,128,127,126,255,183,182,181,255,131,130,129,255,93,92,91,255,61,60,59,255,85,84,83,255,114,113,112,255,133,132,131,255,104,103,102,255,87,86,85,255,91,90,89,255,117,116,115,255,79,78,77,255,108,107,106,255,139,138,137,255,155,154,153,255,175,175,174,255,178,178,177,255,161,161,160,255,167,167,166,255,189,189,188,255,162,162,161,255,132,132,131,255,147,147,146,255,149,149,148,255,128,128,127,255,69,69,68,255,9,9,8,255,0,0,0,255,0,0,0,255,2,2,1,255,2,2,1,255,6,5,3,255,3,2,0,255,8,7,5,255,8,7,5,255,92,91,89,255,83,82,80,255,70,69,67,255,67,66,64,255,90,89,87,255,97,96,94,255,102,101,99,255,83,82,80,255,88,87,85,255,88,87,85,255,77,76,74,255,83,82,80,255,79,78,76,255,72,71,69,255,64,63,61,255,61,60,58,255,63,62,60,255,68,67,65,255,70,69,67,255,71,70,68,255,71,70,68,255,64,63,61,255,72,71,69,255,89,88,86,255,104,103,101,255,121,120,118,255,123,122,120,255,107,106,104,255,129,128,126,255,155,154,152,255,97,96,94,255,74,73,71,255,63,62,60,255,83,82,80,255,92,91,89,255,91,90,88,255,82,81,79,255,76,75,73,255,103,102,100,255,145,144,142,255,107,106,104,255,117,116,114,255,146,145,143,255,174,173,171,255,181,181,179,255,179,179,177,255,164,164,162,255,168,168,166,255,184,184,182,255,167,167,165,255,142,142,140,255,145,145,143,255,150,150,148,255,146,146,144,255,107,107,105,255,40,40,38,255,0,0,0,255,0,0,0,255,6,6,4,255,0,0,0,255,1,0,0,255,2,1,0,255,3,2,0,255,45,44,42,255,115,114,112,255,85,84,82,255,66,65,63,255,79,78,76,255,80,79,77,255,101,100,98,255,107,106,104,255,80,79,77,255,98,97,95,255,80,79,77,255,99,98,96,255,90,89,87,255,78,77,75,255,73,72,70,255,68,67,65,255,66,65,63,255,68,67,65,255,71,70,68,255,70,69,67,255,69,68,66,255,83,82,80,255,78,77,75,255,80,79,77,255,86,85,83,255,103,102,100,255,128,127,125,255,125,124,122,255,95,94,92,255,119,118,116,255,121,120,118,255,73,72,70,255,64,63,61,255,64,63,61,255,73,72,70,255,70,69,67,255,65,64,62,255,81,80,78,255,73,72,70,255,107,106,104,255,162,161,159,255,150,149,147,255,154,153,151,255,171,170,168,255,191,190,188,255,184,184,182,255,185,185,183,255,183,183,181,255,180,180,178,255,175,175,173,255,167,167,165,255,158,158,156,255,155,155,153,255,149,149,147,255,158,158,156,255,148,148,146,255,83,83,81,255,9,9,7,255,0,0,0,255,9,9,7,255,0,0,0,255,1,0,0,255,4,3,1,255,4,3,1,255,106,105,103,255,97,96,94,255,85,84,82,255,57,56,54,255,81,80,78,255,83,82,80,255,117,116,114,255,107,106,104,255,93,92,90,255,103,102,100,255,85,84,82,255,105,104,102,255,86,85,83,255,79,78,76,255,79,78,76,255,78,77,75,255,74,73,71,255,71,70,68,255,72,71,69,255,75,74,72,255,79,78,76,255,79,78,76,255,74,73,71,255,83,82,80,255,99,98,96,255,119,118,116,255,144,143,141,255,148,147,145,255,127,126,124,255,108,107,105,255,98,97,95,255,75,74,72,255,70,69,67,255,65,64,62,255,62,61,59,255,66,65,63,255,76,75,73,255,76,75,73,255,52,51,49,255,64,63,61,255,113,112,110,255,145,144,142,255,173,172,170,255,181,180,178,255,173,172,170,255,181,181,179,255,188,188,186,255,198,198,196,255,189,189,187,255,167,167,165,255,162,162,160,255,167,167,165,255,163,163,161,255,149,149,147,255,151,151,149,255,164,164,162,255,121,121,119,255,32,32,30,255,0,0,0,255,6,6,4,255,0,0,0,255,7,6,4,255,5,4,2,255,44,43,41,255,140,139,137,255,76,75,73,255,69,68,66,255,62,61,59,255,74,73,71,255,129,128,126,255,157,156,154,255,116,115,113,255,110,109,107,255,92,91,89,255,86,85,83,255,86,85,83,255,73,72,70,255,74,73,71,255,80,79,77,255,83,82,80,255,78,77,75,255,71,70,68,255,72,71,69,255,84,83,81,255,96,95,93,255,89,88,86,255,94,93,91,255,118,117,115,255,131,130,128,255,118,117,115,255,114,113,111,255,130,129,127,255,142,141,139,255,114,113,111,255,86,85,83,255,78,77,75,255,73,72,70,255,69,68,66,255,62,61,59,255,71,70,68,255,87,86,84,255,75,74,72,255,52,51,49,255,44,43,41,255,64,63,61,255,124,123,121,255,182,181,179,255,199,198,196,255,177,176,174,255,179,179,177,255,177,177,175,255,179,179,177,255,173,173,171,255,162,162,160,255,160,160,158,255,155,155,153,255,139,139,137,255,149,149,147,255,134,134,132,255,156,156,154,255,149,149,147,255,66,66,64,255,2,2,0,255,0,0,0,255,2,2,0,255,11,10,8,255,1,0,0,255,95,94,92,255,121,120,118,255,77,76,74,255,60,59,57,255,84,83,81,255,85,84,82,255,153,152,150,255,160,159,157,255,112,111,109,255,102,101,99,255,74,73,71,255,80,79,77,255,71,70,68,255,80,79,77,255,69,68,66,255,77,76,74,255,83,82,80,255,80,79,77,255,74,73,71,255,76,75,73,255,90,89,87,255,103,102,100,255,100,99,97,255,118,117,115,255,152,151,149,255,153,152,150,255,108,107,105,255,79,78,76,255,101,100,98,255,132,131,129,255,129,128,126,255,74,73,71,255,69,68,66,255,62,61,59,255,73,72,70,255,71,70,68,255,74,73,71,255,77,76,74,255,72,71,69,255,69,68,66,255,61,60,58,255,54,53,51,255,115,114,112,255,176,175,173,255,208,207,205,255,191,190,188,255,179,179,177,255,161,161,159,255,144,144,142,255,147,147,145,255,161,161,159,255,154,154,152,255,124,124,122,255,97,97,95,255,134,134,132,255,113,113,111,255,139,139,137,255,160,160,158,255,99,99,97,255,18,18,16,255,0,0,0,255,3,3,1,255,5,4,2,255,19,18,16,255,122,121,119,255,84,83,81,255,72,71,69,255,70,69,67,255,78,77,75,255,99,98,96,255,126,125,123,255,118,117,115,255,104,103,101,255,86,85,83,255,77,76,74,255,79,78,76,255,77,76,74,255,106,105,103,255,81,80,78,255,84,83,81,255,86,85,83,255,85,84,82,255,82,81,79,255,83,82,80,255,88,87,85,255,93,92,90,255,72,71,69,255,89,88,86,255,123,122,120,255,138,137,135,255,126,125,123,255,125,124,122,255,143,142,140,255,153,152,150,255,123,122,120,255,59,58,56,255,63,62,60,255,51,50,48,255,68,67,65,255,73,72,70,255,74,73,71,255,70,69,67,255,55,54,52,255,60,59,57,255,63,62,60,255,51,50,48,255,106,105,103,255,141,140,138,255,165,164,162,255,153,152,150,255,173,173,171,255,163,163,161,255,141,141,139,255,144,144,142,255,160,160,158,255,134,134,132,255,92,92,90,255,80,80,78,255,91,91,89,255,86,86,84,255,118,118,116,255,154,154,152,255,121,121,119,255,39,39,37,255,0,0,0,255,4,4,2,255,10,9,7,255,58,57,55,255,128,127,125,255,67,66,64,255,53,52,50,255,83,82,80,255,43,42,40,255,94,93,91,255,98,97,95,255,84,83,81,255,110,109,107,255,84,83,81,255,97,96,94,255,84,83,81,255,87,86,84,255,125,124,122,255,98,97,95,255,96,95,93,255,94,93,91,255,93,92,90,255,92,91,89,255,89,88,86,255,83,82,80,255,78,77,75,255,73,72,70,255,74,73,71,255,92,91,89,255,119,118,116,255,151,150,148,255,182,181,179,255,180,179,177,255,150,149,147,255,104,103,101,255,47,46,44,255,66,65,63,255,49,48,46,255,60,59,57,255,66,65,63,255,75,74,72,255,76,75,73,255,61,60,58,255,59,58,56,255,66,65,63,255,63,62,60,255,119,118,116,255,129,128,126,255,132,131,129,255,113,112,110,255,164,164,162,255,176,176,174,255,163,163,161,255,158,158,156,255,158,158,156,255,112,112,110,255,74,74,72,255,89,89,87,255,48,48,46,255,63,63,61,255,102,102,100,255,143,143,141,255,129,129,127,255,55,55,53,255,2,2,0,255,4,4,2,255,4,3,1,255,102,101,99,255,104,103,101,255,67,66,64,255,48,47,45,255,73,72,70,255,68,67,65,255,80,79,77,255,80,79,77,255,84,83,81,255,100,99,97,255,95,94,92,255,72,71,69,255,83,82,80,255,101,100,98,255,89,88,86,255,86,85,83,255,103,102,100,255,92,91,89,255,104,103,101,255,89,88,86,255,93,92,90,255,76,75,73,255,93,92,90,255,95,94,92,255,58,57,55,255,66,65,63,255,113,112,110,255,148,147,145,255,166,165,163,255,157,156,154,255,126,125,123,255,90,89,87,255,79,78,76,255,58,57,55,255,62,61,59,255,68,67,65,255,68,67,65,255,77,76,74,255,73,72,70,255,61,60,58,255,66,65,63,255,64,63,61,255,70,69,67,255,103,102,100,255,137,136,134,255,129,128,126,255,96,95,93,255,129,129,127,255,157,157,155,255,188,188,186,255,198,198,196,255,172,172,170,255,119,119,117,255,78,78,76,255,69,69,67,255,60,60,58,255,34,34,32,255,83,83,81,255,146,146,144,255,136,136,134,255,55,55,53,255,0,0,0,255,14,14,12,255,9,8,6,255,120,119,117,255,105,104,102,255,71,70,68,255,57,56,54,255,67,66,64,255,64,63,61,255,75,74,72,255,79,78,76,255,90,89,87,255,116,115,113,255,110,109,107,255,75,74,72,255,76,75,73,255,101,100,98,255,105,104,102,255,131,130,128,255,116,115,113,255,79,78,76,255,89,88,86,255,95,94,92,255,115,114,112,255,97,96,94,255,98,97,95,255,111,110,108,255,99,98,96,255,112,111,109,255,141,140,138,255,152,151,149,255,143,142,140,255,126,125,123,255,109,108,106,255,97,96,94,255,86,85,83,255,86,85,83,255,84,83,81,255,72,71,69,255,57,56,54,255,55,54,52,255,69,68,66,255,60,59,57,255,63,62,60,255,58,57,55,255,58,57,55,255,78,77,75,255,103,102,100,255,101,100,98,255,83,82,80,255,74,74,72,255,128,128,126,255,167,167,165,255,199,199,197,255,211,211,209,255,146,146,144,255,71,71,69,255,63,63,61,255,82,82,80,255,48,48,46,255,84,84,82,255,140,140,138,255,136,136,134,255,62,62,60,255,0,0,0,255,0,0,0,255,32,31,29,255,152,151,149,255,103,102,100,255,69,68,66,255,64,63,61,255,59,58,56,255,63,62,60,255,74,73,71,255,72,71,69,255,78,77,75,255,108,107,105,255,113,112,110,255,85,84,82,255,91,90,88,255,131,130,128,255,151,150,148,255,140,139,137,255,136,135,133,255,121,120,118,255,127,126,124,255,123,122,120,255,133,132,130,255,120,119,117,255,118,117,115,255,111,110,108,255,124,123,121,255,138,137,135,255,148,147,145,255,143,142,140,255,114,113,111,255,92,91,89,255,93,92,90,255,94,93,91,255,81,80,78,255,92,91,89,255,82,81,79,255,101,100,98,255,131,130,128,255,103,102,100,255,91,90,88,255,74,73,71,255,72,71,69,255,67,66,64,255,63,62,60,255,68,67,65,255,78,77,75,255,82,81,79,255,80,79,77,255,48,48,46,255,123,123,121,255,157,157,155,255,184,184,182,255,214,214,212,255,152,152,150,255,73,73,71,255,76,76,74,255,67,67,65,255,57,57,55,255,102,102,100,255,149,149,147,255,147,147,145,255,87,87,85,255,15,15,13,255,2,2,0,255,72,71,69,255,187,186,184,255,100,99,97,255,63,62,60,255,70,69,67,255,58,57,55,255,66,65,63,255,75,74,72,255,90,89,87,255,83,82,80,255,103,102,100,255,110,109,107,255,87,86,84,255,93,92,90,255,135,134,132,255,159,158,156,255,137,136,134,255,150,149,147,255,163,162,160,255,164,163,161,255,144,143,141,255,138,137,135,255,134,133,131,255,130,129,127,255,94,93,91,255,110,109,107,255,109,108,106,255,110,109,107,255,115,114,112,255,92,91,89,255,71,70,68,255,81,80,78,255,72,71,69,255,114,113,111,255,159,158,156,255,95,94,92,255,83,82,80,255,139,138,136,255,118,117,115,255,104,103,101,255,64,63,61,255,59,58,56,255,56,55,53,255,56,55,53,255,55,54,52,255,52,51,49,255,53,52,50,255,58,57,55,255,51,51,49,255,102,102,100,255,126,126,124,255,150,150,148,255,192,192,190,255,173,173,171,255,109,109,107,255,79,79,77,255,48,48,46,255,78,78,76,255,136,136,134,255,157,157,155,255,152,152,150,255,118,118,116,255,46,46,44,255,5,5,3,255,110,109,107,255,207,206,204,255,106,105,103,255,68,67,65,255,80,79,77,255,67,66,64,255,67,66,64,255,68,67,65,255,75,74,72,255,82,81,79,255,116,115,113,255,125,124,122,255,92,91,89,255,92,91,89,255,135,134,132,255,164,163,161,255,161,160,158,255,162,161,159,255,175,174,172,255,166,165,163,255,146,145,143,255,138,137,135,255,141,140,138,255,125,124,122,255,91,90,88,255,87,86,84,255,66,65,63,255,64,63,61,255,87,86,84,255,83,82,80,255,64,63,61,255,67,66,64,255,53,52,50,255,94,93,91,255,142,141,139,255,90,89,87,255,87,86,84,255,138,137,135,255,99,98,96,255,67,66,64,255,54,53,51,255,49,48,46,255,52,51,49,255,59,58,56,255,59,58,56,255,50,49,47,255,45,44,42,255,46,45,43,255,41,41,39,255,53,53,51,255,81,81,79,255,119,119,117,255,169,169,167,255,204,204,202,255,167,167,165,255,90,90,88,255,88,88,86,255,122,122,120,255,151,151,149,255,131,131,129,255,133,133,131,255,140,140,138,255,70,70,68,255,0,0,0,255,137,136,134,255,212,211,209,255,121,120,118,255,80,79,77,255,85,84,82,255,78,77,75,255,64,63,61,255,60,59,57,255,64,63,61,255,101,100,98,255,159,158,156,255,163,162,160,255,108,107,105,255,92,91,89,255,130,129,127,255,159,158,156,255,166,165,163,255,175,174,172,255,207,206,204,255,189,188,186,255,154,153,151,255,133,132,130,255,144,143,141,255,124,123,121,255,99,98,96,255,81,80,78,255,57,56,54,255,60,59,57,255,87,86,84,255,95,94,92,255,77,76,74,255,63,62,60,255,52,51,49,255,39,38,36,255,67,66,64,255,89,88,86,255,136,135,133,255,159,158,156,255,89,88,86,255,37,36,34,255,53,52,50,255,53,52,50,255,58,57,55,255,66,65,63,255,68,67,65,255,61,60,58,255,53,52,50,255,50,49,47,255,38,38,36,255,45,45,43,255,85,85,83,255,111,111,109,255,124,124,122,255,172,172,170,255,193,193,191,255,153,153,151,255,149,149,147,255,152,152,150,255,134,134,132,255,89,89,87,255,113,113,111,255,155,155,153,255,90,90,88,255,0,0,0,255,161,160,158,255,211,210,208,255,136,135,133,255,82,81,79,255,71,70,68,255,78,77,75,255,63,62,60,255,66,65,63,255,92,91,89,255,132,131,129,255,185,184,182,255,177,176,174,255,114,113,111,255,89,88,86,255,110,109,107,255,120,119,117,255,149,148,146,255,160,159,157,255,204,203,201,255,182,181,179,255,144,143,141,255,120,119,117,255,139,138,136,255,115,114,112,255,89,88,86,255,77,76,74,255,81,80,78,255,101,100,98,255,118,117,115,255,128,127,125,255,114,113,111,255,88,87,85,255,74,73,71,255,71,70,68,255,97,96,94,255,136,135,133,255,153,152,150,255,127,126,124,255,77,76,74,255,48,47,45,255,44,43,41,255,50,49,47,255,53,52,50,255,53,52,50,255,51,50,48,255,50,49,47,255,48,47,45,255,45,44,42,255,51,51,49,255,65,65,63,255,98,98,96,255,113,113,111,255,101,101,99,255,115,115,113,255,159,159,157,255,189,189,187,255,173,173,171,255,158,158,156,255,130,130,128,255,92,92,90,255,119,119,117,255,156,156,154,255,91,91,89,255,5,5,3,255,180,178,178,255,211,209,209,255,143,142,141,255,75,74,73,255,51,49,49,255,71,70,69,255,65,64,63,255,80,79,78,255,72,71,70,255,102,101,100,255,147,145,145,255,149,147,147,255,114,112,112,255,113,112,111,255,131,129,129,255,126,125,124,255,149,148,146,255,123,122,120,255,138,137,135,255,116,115,113,255,108,107,105,255,109,108,106,255,131,130,128,255,92,91,89,255,64,63,61,255,69,68,66,255,106,105,103,255,141,140,138,255,150,149,147,255,159,158,156,255,152,151,149,255,121,120,118,255,111,110,109,255,111,110,109,255,114,113,112,255,148,147,146,255,168,167,166,255,145,144,143,255,102,101,100,255,55,54,53,255,55,54,53,255,64,63,62,255,65,64,63,255,55,54,53,255,49,48,47,255,53,52,51,255,58,57,56,255,58,57,56,255,56,56,54,255,59,59,57,255,74,74,72,255,110,110,108,255,127,127,125,255,105,105,103,255,110,110,108,255,156,156,154,255,170,170,168,255,161,161,159,255,152,152,150,255,128,128,126,255,138,138,136,255,144,144,142,255,72,72,70,255,1,1,0,255,182,180,181,255,204,202,203,255,140,138,139,255,66,64,64,255,60,58,59,255,72,70,71,255,79,77,78,255,61,59,60,255,66,64,64,255,93,91,92,255,116,114,115,255,134,132,133,255,96,94,95,255,120,118,119,255,127,125,126,255,124,122,122,255,142,141,140,255,155,154,152,255,122,121,119,255,111,110,108,255,97,96,94,255,74,73,71,255,89,88,86,255,88,87,85,255,41,40,38,255,63,62,60,255,105,104,102,255,140,139,137,255,147,146,144,255,140,139,137,255,149,148,146,255,170,169,168,255,138,137,136,255,142,142,142,255,167,167,167,255,175,175,175,255,156,156,156,255,144,144,143,255,114,114,114,255,63,63,63,255,72,72,72,255,67,67,67,255,40,40,40,255,54,54,54,255,49,49,48,255,63,63,63,255,56,56,56,255,78,78,77,255,80,80,79,255,77,77,75,255,72,72,70,255,114,114,112,255,104,104,102,255,82,82,80,255,57,57,55,255,88,88,86,255,136,136,134,255,140,140,138,255,129,129,127,255,110,110,108,255,138,138,136,255,120,120,118,255,45,45,43,255,15,15,13,255,146,144,145,255,213,211,212,255,136,134,135,255,61,59,60,255,66,64,65,255,70,68,69,255,58,56,57,255,78,76,77,255,66,64,65,255,88,86,87,255,99,97,98,255,110,108,109,255,83,81,82,255,99,97,98,255,103,101,102,255,108,106,107,255,136,135,134,255,146,145,143,255,126,125,123,255,121,120,118,255,103,102,100,255,81,80,78,255,95,94,92,255,91,90,88,255,64,63,61,255,62,61,59,255,81,80,78,255,114,113,111,255,130,129,127,255,132,131,129,255,149,148,146,255,176,175,174,255,160,160,159,255,179,179,179,255,209,209,209,255,204,204,204,255,165,165,165,255,140,140,140,255,119,119,119,255,84,84,84,255,50,50,50,255,69,69,69,255,69,69,69,255,63,63,63,255,54,54,54,255,75,75,75,255,74,74,74,255,63,63,63,255,49,49,48,255,69,69,67,255,87,87,85,255,112,112,110,255,98,98,96,255,66,66,64,255,44,44,42,255,64,64,62,255,60,60,58,255,95,95,93,255,112,112,110,255,98,98,96,255,128,128,126,255,137,137,135,255,61,61,59,255,0,0,0,255,136,134,135,255,202,200,201,255,136,134,135,255,82,80,81,255,56,54,55,255,71,69,70,255,56,54,55,255,66,64,65,255,57,55,56,255,75,73,74,255,75,73,74,255,85,83,84,255,83,81,82,255,96,94,95,255,98,96,97,255,117,115,116,255,120,119,118,255,139,138,136,255,149,148,146,255,148,147,145,255,107,106,104,255,74,73,71,255,88,87,85,255,92,91,89,255,87,86,84,255,90,89,87,255,91,90,88,255,89,88,86,255,93,92,90,255,113,112,110,255,146,145,143,255,171,170,169,255,173,173,173,255,192,192,192,255,217,217,217,255,210,210,210,255,176,176,176,255,153,153,153,255,136,136,136,255,113,113,113,255,63,63,63,255,43,43,43,255,56,56,56,255,60,60,60,255,60,60,60,255,73,73,73,255,118,118,118,255,135,135,135,255,85,85,84,255,96,96,94,255,99,99,97,255,82,82,80,255,78,78,76,255,55,55,53,255,52,52,50,255,59,59,57,255,51,51,49,255,87,87,85,255,119,119,117,255,120,120,118,255,137,137,135,255,151,151,149,255,72,72,70,255,0,0,0,255,136,134,135,255,165,163,164,255,140,138,139,255,122,120,121,255,39,37,38,255,79,77,78,255,87,85,86,255,48,46,47,255,53,51,52,255,68,66,67,255,63,61,62,255,69,67,68,255,89,87,88,255,97,95,96,255,98,96,97,255,122,120,121,255,103,102,101,255,109,108,106,255,132,131,129,255,146,145,143,255,119,118,116,255,90,89,87,255,90,89,87,255,87,86,84,255,96,95,93,255,130,129,127,255,133,132,130,255,94,93,91,255,75,74,72,255,107,106,104,255,151,150,148,255,171,170,169,255,183,183,183,255,186,186,186,255,191,191,191,255,190,190,190,255,184,184,184,255,176,176,176,255,158,158,158,255,135,135,135,255,119,119,119,255,72,72,72,255,74,74,74,255,59,59,59,255,64,64,64,255,89,89,89,255,166,166,166,255,186,186,186,255,152,152,151,255,138,138,136,255,111,111,109,255,59,59,57,255,72,72,70,255,66,66,64,255,71,71,69,255,59,59,57,255,88,88,86,255,97,97,95,255,124,124,122,255,144,144,142,255,140,140,138,255,142,142,140,255,65,65,63,255,3,3,1,255,94,92,93,255,147,145,146,255,156,154,155,255,147,145,146,255,45,43,44,255,77,75,76,255,96,94,95,255,63,61,62,255,62,60,61,255,72,70,71,255,65,63,64,255,61,59,60,255,86,84,85,255,87,85,86,255,86,84,85,255,100,98,99,255,95,94,93,255,77,76,74,255,90,89,87,255,119,118,116,255,133,132,130,255,127,126,124,255,112,111,109,255,109,108,106,255,125,124,122,255,149,148,146,255,157,156,154,255,134,133,131,255,113,112,110,255,124,123,121,255,157,156,154,255,182,181,180,255,191,191,191,255,188,188,188,255,179,179,179,255,177,177,177,255,185,185,185,255,186,186,186,255,175,175,175,255,166,166,166,255,177,177,177,255,161,161,161,255,147,147,147,255,77,77,77,255,72,72,72,255,126,126,126,255,184,184,184,255,145,145,145,255,158,158,157,255,148,148,146,255,122,122,120,255,69,69,67,255,82,82,80,255,75,75,73,255,75,75,73,255,56,56,54,255,85,85,83,255,97,97,95,255,116,116,114,255,136,136,134,255,125,125,123,255,138,138,136,255,61,61,59,255,4,4,2,255,36,34,35,255,164,162,163,255,190,188,189,255,158,156,157,255,76,74,75,255,62,60,61,255,63,61,62,255,82,80,81,255,66,64,65,255,73,71,72,255,74,72,73,255,62,60,61,255,85,83,84,255,91,89,90,255,99,97,98,255,96,94,95,255,89,88,87,255,87,86,84,255,105,104,102,255,122,121,119,255,135,134,132,255,124,123,121,255,115,114,112,255,153,152,150,255,178,177,175,255,160,159,157,255,161,160,158,255,175,174,172,255,167,166,164,255,143,142,140,255,149,148,146,255,177,176,175,255,175,175,175,255,185,185,185,255,181,181,181,255,174,174,174,255,180,180,180,255,182,182,182,255,190,190,190,255,209,209,209,255,209,209,209,255,186,186,186,255,152,152,152,255,94,94,94,255,88,88,88,255,135,135,135,255,172,172,172,255,144,144,143,255,144,144,143,255,143,143,141,255,120,120,118,255,79,79,77,255,72,72,70,255,63,63,61,255,71,71,69,255,78,78,76,255,85,85,83,255,131,131,129,255,141,141,139,255,140,140,138,255,128,128,126,255,162,162,160,255,73,73,71,255,2,2,0,255,4,2,3,255,155,153,154,255,212,210,211,255,178,176,177,255,108,106,107,255,65,63,64,255,61,59,60,255,77,75,76,255,65,63,64,255,68,66,67,255,82,80,81,255,65,63,64,255,86,84,85,255,106,104,105,255,131,129,130,255,113,111,112,255,74,73,72,255,98,97,95,255,125,124,122,255,131,130,128,255,140,139,137,255,109,108,106,255,85,84,82,255,151,150,148,255,185,184,182,255,166,165,163,255,164,163,161,255,181,180,178,255,179,178,176,255,156,155,153,255,152,151,149,255,169,168,167,255,170,170,170,255,190,190,190,255,187,187,187,255,178,178,178,255,182,182,182,255,182,182,182,255,196,196,196,255,229,229,229,255,202,202,202,255,161,161,161,255,112,112,112,255,101,101,101,255,101,101,101,255,131,131,131,255,158,158,158,255,182,182,182,255,169,169,168,255,157,157,155,255,118,118,116,255,92,92,90,255,68,68,66,255,63,63,61,255,69,69,67,255,100,100,98,255,119,119,117,255,175,175,173,255,170,170,168,255,160,160,158,255,145,145,143,255,171,171,169,255,66,66,64,255,2,2,0,255,1,0,0,255,113,111,112,255,210,208,209,255,201,199,200,255,126,124,125,255,90,88,89,255,101,99,100,255,69,67,68,255,66,64,65,255,67,65,66,255,87,85,86,255,64,62,63,255,81,79,80,255,110,108,109,255,146,144,145,255,117,115,116,255,58,57,56,255,74,73,71,255,93,92,90,255,115,114,112,255,158,157,155,255,122,121,119,255,57,56,54,255,102,101,99,255,143,142,140,255,160,159,157,255,170,169,167,255,163,162,160,255,158,157,155,255,167,166,164,255,175,174,172,255,175,174,173,255,197,197,197,255,210,210,210,255,198,198,198,255,186,186,186,255,193,193,193,255,188,188,188,255,192,192,192,255,220,220,220,255,177,177,177,255,167,167,167,255,117,117,117,255,107,107,107,255,105,105,105,255,145,145,145,255,153,153,153,255,173,173,173,255,206,206,205,255,179,179,177,255,125,125,123,255,118,118,116,255,92,92,90,255,83,83,81,255,67,67,65,255,94,94,92,255,141,141,139,255,182,182,180,255,162,162,160,255,162,162,160,255,146,146,144,255,150,150,148,255,37,37,35,255,1,1,0,255,1,0,0,255,85,83,84,255,191,189,190,255,196,194,195,255,197,195,196,255,118,116,117,255,123,121,122,255,93,91,92,255,90,88,89,255,78,76,77,255,110,108,109,255,72,70,71,255,61,59,60,255,89,87,88,255,121,119,120,255,81,79,80,255,74,73,72,255,61,60,58,255,82,81,79,255,83,82,80,255,145,144,142,255,125,124,122,255,70,69,67,255,69,68,66,255,90,89,87,255,159,158,156,255,170,169,167,255,139,138,136,255,143,142,140,255,158,157,155,255,160,159,157,255,170,169,168,255,183,183,183,255,191,191,191,255,192,192,192,255,181,181,181,255,177,177,177,255,188,188,188,255,202,202,202,255,209,209,209,255,216,216,216,255,169,169,169,255,160,160,160,255,145,145,145,255,135,135,135,255,129,129,129,255,119,119,119,255,155,155,155,255,175,175,174,255,177,177,175,255,186,186,184,255,128,128,126,255,98,98,96,255,72,72,70,255,86,86,84,255,103,103,101,255,126,126,124,255,150,150,148,255,153,153,151,255,153,153,151,255,150,150,148,255,123,123,121,255,12,12,10,255,1,1,0,255,10,8,9,255,11,9,10,255,181,179,180,255,186,184,185,255,189,187,188,255,156,154,155,255,123,121,122,255,113,111,112,255,134,132,133,255,134,132,133,255,136,134,135,255,82,80,81,255,64,62,63,255,58,56,57,255,81,79,80,255,85,83,84,255,62,61,60,255,78,77,75,255,75,74,72,255,76,75,73,255,118,117,115,255,149,148,146,255,105,104,102,255,74,73,71,255,129,128,126,255,149,148,146,255,167,166,164,255,161,160,158,255,147,146,144,255,150,149,147,255,155,154,152,255,146,145,144,255,177,177,177,255,174,174,174,255,171,171,171,255,175,175,175,255,191,191,191,255,207,207,207,255,207,207,207,255,198,198,198,255,200,200,200,255,203,203,203,255,206,206,206,255,165,165,165,255,148,148,148,255,152,152,152,255,112,112,112,255,84,84,84,255,123,123,122,255,173,173,171,255,189,189,187,255,131,131,129,255,138,138,136,255,129,129,127,255,131,131,129,255,97,97,95,255,130,130,128,255,148,148,146,255,144,144,142,255,142,142,140,255,169,169,167,255,104,104,102,255,9,9,7,255,5,5,3,255,19,17,18,255,1,0,0,255,135,133,134,255,210,208,209,255,184,182,183,255,182,180,181,255,136,134,135,255,137,135,136,255,128,126,127,255,151,149,150,255,151,149,150,255,115,113,114,255,102,100,101,255,67,65,66,255,72,70,71,255,99,97,98,255,97,96,95,255,122,121,119,255,94,93,91,255,98,97,95,255,90,89,87,255,122,121,119,255,104,103,101,255,74,73,71,255,114,113,111,255,100,99,97,255,134,133,131,255,166,165,163,255,155,154,152,255,158,157,155,255,171,170,168,255,158,157,156,255,165,165,165,255,163,163,163,255,163,163,163,255,171,171,171,255,188,188,188,255,199,199,199,255,194,194,194,255,183,183,183,255,207,207,207,255,213,213,213,255,220,220,220,255,186,186,186,255,151,151,151,255,128,128,128,255,93,93,93,255,81,81,80,255,105,105,104,255,191,191,189,255,172,172,170,255,155,155,153,255,157,157,155,255,161,161,159,255,137,137,135,255,95,95,93,255,131,131,129,255,137,137,135,255,128,128,126,255,135,135,133,255,169,169,167,255,64,64,62,255,1,1,0,255,1,1,0,255,4,2,3,255,5,3,4,255,58,56,57,255,230,228,229,255,197,195,196,255,182,180,181,255,157,155,156,255,147,145,146,255,161,159,160,255,171,169,170,255,157,155,156,255,134,132,133,255,111,109,110,255,77,75,76,255,76,74,75,255,76,74,75,255,150,149,148,255,131,130,128,255,87,86,84,255,108,107,105,255,93,92,90,255,83,82,80,255,86,85,83,255,69,68,66,255,98,97,95,255,98,97,95,255,133,132,130,255,167,166,164,255,162,161,159,255,157,156,154,255,164,163,161,255,162,161,160,255,162,162,162,255,171,171,171,255,179,179,179,255,177,177,177,255,171,171,171,255,169,169,169,255,174,174,174,255,180,180,180,255,202,202,202,255,211,211,211,255,221,221,221,255,196,196,196,255,141,141,141,255,92,92,92,255,79,79,79,255,98,98,98,255,118,118,117,255,198,198,196,255,134,134,132,255,171,171,169,255,139,139,137,255,137,137,135,255,110,110,108,255,128,128,126,255,136,136,134,255,127,127,125,255,127,127,125,255,156,156,154,255,136,136,134,255,26,26,24,255,1,1,0,255,0,0,0,255,1,0,0,255,14,12,13,255,5,3,4,255,175,173,174,255,227,225,226,255,197,195,196,255,177,175,176,255,156,154,155,255,199,197,198,255,164,162,163,255,117,115,116,255,100,98,99,255,72,70,71,255,88,86,87,255,120,118,119,255,89,87,88,255,154,153,152,255,105,104,102,255,67,66,64,255,87,86,84,255,107,106,104,255,75,74,72,255,91,90,88,255,72,71,69,255,79,78,76,255,125,124,122,255,156,155,153,255,169,168,166,255,177,176,174,255,167,166,164,255,164,163,161,255,185,184,183,255,167,167,167,255,177,177,177,255,184,184,184,255,178,178,178,255,165,165,165,255,159,159,159,255,170,170,170,255,184,184,184,255,176,176,176,255,212,212,212,255,225,225,225,255,198,198,198,255,146,146,146,255,104,104,104,255,87,87,87,255,76,76,76,255,107,107,106,255,168,168,166,255,120,120,118,255,148,148,146,255,128,128,126,255,100,100,98,255,120,120,118,255,176,176,174,255,150,150,148,255,131,131,129,255,142,142,140,255,181,181,179,255,83,83,81,255,5,5,3,255,10,10,8,255,0,0,0,255,6,4,5,255,1,0,0,255,3,1,2,255,76,74,75,255,235,233,234,255,240,238,239,255,195,193,194,255,181,179,180,255,182,180,181,255,131,129,130,255,66,64,65,255,69,67,68,255,52,50,51,255,102,100,101,255,159,157,158,255,123,121,122,255,121,120,119,255,118,117,115,255,113,112,110,255,87,86,84,255,92,91,89,255,63,62,60,255,85,84,82,255,81,80,78,255,67,66,64,255,138,137,135,255,171,170,168,255,172,171,169,255,181,180,178,255,171,170,168,255,167,166,164,255,196,195,194,255,164,164,164,255,161,161,161,255,161,161,161,255,166,166,166,255,169,169,169,255,169,169,169,255,170,170,170,255,174,174,174,255,178,178,178,255,190,190,190,255,191,191,191,255,197,197,197,255,172,172,172,255,128,128,128,255,115,115,115,255,106,106,106,255,99,99,98,255,142,142,140,255,150,150,148,255,122,122,120,255,146,146,144,255,98,98,96,255,157,157,155,255,192,192,190,255,160,160,158,255,137,137,135,255,150,150,148,255,160,160,158,255,31,31,29,255,0,0,0,255,11,11,9,255,0,0,0,255,10,8,9,255,1,0,0,255,8,6,7,255,17,15,16,255,171,169,170,255,251,249,250,255,199,197,198,255,205,203,204,255,189,187,188,255,152,150,151,255,71,69,70,255,78,76,77,255,59,57,58,255,78,76,77,255,121,119,120,255,111,109,110,255,96,95,94,255,135,134,132,255,146,145,143,255,97,96,94,255,75,74,72,255,65,64,62,255,61,60,58,255,80,79,77,255,92,91,89,255,139,138,136,255,177,176,174,255,182,181,179,255,168,167,165,255,154,153,151,255,153,152,150,255,164,163,162,255,156,156,156,255,151,151,151,255,154,154,154,255,169,169,169,255,179,179,179,255,176,176,176,255,166,166,166,255,161,161,161,255,178,178,178,255,178,178,178,255,171,171,171,255,195,195,195,255,181,181,181,255,140,140,140,255,151,151,151,255,162,162,162,255,129,129,128,255,148,148,146,255,174,174,172,255,146,146,144,255,170,170,168,255,142,142,140,255,173,173,171,255,187,187,185,255,166,166,164,255,149,149,147,255,148,148,146,255,93,93,91,255,4,4,2,255,0,0,0,255,4,4,2,255,0,0,0,255,1,0,0,255,15,13,14,255,1,0,0,255,9,7,8,255,84,82,83,255,225,223,224,255,190,188,189,255,211,209,210,255,203,201,202,255,183,181,182,255,83,81,82,255,85,83,84,255,65,63,64,255,53,51,52,255,86,84,85,255,119,117,118,255,85,84,83,255,110,109,108,255,104,103,102,255,85,84,83,255,83,82,81,255,101,100,99,255,49,48,47,255,71,70,69,255,88,87,86,255,103,102,101,255,158,157,156,255,188,187,186,255,166,165,164,255,162,161,160,255,177,176,175,255,171,170,169,255,157,157,157,255,160,160,160,255,174,174,174,255,190,190,190,255,191,191,191,255,177,177,177,255,163,163,163,255,159,159,159,255,145,145,145,255,202,202,202,255,207,207,207,255,192,192,192,255,164,164,164,255,153,153,153,255,177,177,177,255,162,162,162,255,167,167,166,255,163,163,162,255,167,167,166,255,194,194,193,255,183,183,182,255,191,191,190,255,170,170,169,255,192,192,191,255,175,175,174,255,164,164,163,255,148,148,147,255,39,39,38,255,5,5,4,255,4,4,3,255,3,3,2,255,3,3,2,255,2,2,2,255,2,2,2,255,0,0,0,255,3,3,3,255,12,12,12,255,142,142,142,255,211,211,211,255,191,191,191,255,196,196,196,255,218,218,218,255,121,121,121,255,92,92,92,255,79,79,79,255,71,71,71,255,81,81,81,255,119,119,119,255,134,134,134,255,88,88,88,255,97,97,96,255,102,102,102,255,59,59,59,255,54,54,54,255,74,74,74,255,54,54,54,255,68,68,68,255,85,85,85,255,152,152,152,255,182,182,182,255,161,161,161,255,188,188,188,255,206,206,206,255,153,153,153,255,169,169,169,255,196,196,196,255,193,193,193,255,181,181,181,255,188,188,188,255,177,177,177,255,152,152,152,255,145,145,145,255,199,199,199,255,205,205,205,255,201,201,201,255,188,188,188,255,183,183,183,255,182,182,182,255,169,169,169,255,150,150,150,255,175,175,175,255,173,173,173,255,196,196,196,255,218,218,218,255,208,208,207,255,193,193,193,255,194,194,194,255,198,198,198,255,171,171,171,255,168,168,168,255,79,79,79,255,0,0,0,255,2,2,2,255,3,3,3,255,0,0,0,255,11,11,11,255,0,0,0,255,0,0,0,255,9,9,9,255,0,0,0,255,4,4,4,255,58,58,58,255,171,171,171,255,214,214,214,255,219,219,219,255,178,178,178,255,217,217,217,255,151,151,151,255,90,90,90,255,98,98,98,255,139,139,139,255,143,143,143,255,102,102,102,255,118,118,118,255,138,138,138,255,135,135,135,255,100,100,100,255,68,68,68,255,72,72,72,255,93,93,93,255,101,101,101,255,117,117,117,255,172,172,172,255,199,199,199,255,185,185,185,255,207,207,207,255,224,224,224,255,191,191,191,255,187,187,187,255,216,216,216,255,217,217,217,255,185,185,185,255,158,158,158,255,155,155,155,255,175,175,175,255,200,200,200,255,167,167,167,255,179,179,179,255,186,186,186,255,183,183,183,255,183,183,183,255,185,185,185,255,174,174,174,255,158,158,158,255,173,173,173,255,185,185,185,255,204,204,204,255,214,214,214,255,221,221,221,255,231,231,231,255,214,214,214,255,175,175,175,255,188,188,188,255,104,104,104,255,24,24,24,255,3,3,3,255,4,4,4,255,0,0,0,255,0,0,0,255,6,6,6,255,5,5,5,255,0,0,0,255,9,9,9,255,3,3,3,255,2,2,2,255,0,0,0,255,100,100,100,255,198,198,198,255,185,185,185,255,190,190,190,255,225,225,225,255,170,170,170,255,156,156,156,255,136,136,136,255,133,133,133,255,166,166,166,255,85,85,85,255,125,125,125,255,134,134,134,255,149,149,149,255,176,176,176,255,148,148,148,255,115,115,115,255,138,138,138,255,172,172,172,255,185,185,185,255,212,212,212,255,221,221,221,255,207,207,207,255,206,206,206,255,210,210,210,255,199,199,199,255,190,190,190,255,188,188,188,255,181,181,181,255,162,162,162,255,148,148,148,255,165,165,165,255,192,192,192,255,199,199,199,255,178,178,178,255,182,182,182,255,178,178,178,255,167,167,167,255,166,166,166,255,177,177,177,255,184,184,184,255,183,183,183,255,181,181,181,255,182,182,182,255,207,207,207,255,233,233,233,255,233,233,233,255,219,219,219,255,202,202,202,255,181,181,181,255,150,150,150,255,34,34,34,255,0,0,0,255,10,10,10,255,0,0,0,255,0,0,0,255,5,5,5,255,0,0,0,255,6,6,6,255,4,4,4,255,0,0,0,255,19,19,19,255,0,0,0,255,0,0,0,255,27,27,27,255,116,116,116,255,188,188,188,255,186,186,186,255,168,168,168,255,197,197,197,255,142,142,142,255,139,139,139,255,163,163,163,255,138,138,138,255,106,106,106,255,124,124,124,255,122,122,122,255,155,155,155,255,219,219,219,255,215,215,215,255,176,176,176,255,178,178,178,255,198,198,198,255,211,211,211,255,224,224,224,255,229,229,229,255,225,225,225,255,213,213,213,255,210,210,210,255,220,220,220,255,203,203,203,255,178,178,178,255,173,173,173,255,179,179,179,255,184,184,184,255,203,203,203,255,203,203,203,255,173,173,173,255,187,187,187,255,186,186,186,255,176,176,176,255,162,162,162,255,159,159,159,255,172,172,172,255,187,187,187,255,195,195,195,255,176,176,176,255,190,190,190,255,220,220,220,255,232,232,232,255,208,208,208,255,184,184,184,255,173,173,173,255,165,165,165,255,56,56,56,255,2,2,2,255,0,0,0,255,12,12,12,255,0,0,0,255,0,0,0,255,13,13,13,255,0,0,0,255,0,0,0,255,10,10,10,255,0,0,0,255,5,5,5,255,1,1,1,255,3,3,3,255,0,0,0,255,28,28,28,255,154,154,154,255,205,205,205,255,177,177,177,255,171,171,171,255,134,134,134,255,147,147,147,255,168,168,168,255,157,157,157,255,147,147,147,255,148,148,148,255,156,156,156,255,176,176,176,255,197,197,197,255,206,206,206,255,207,207,207,255,207,207,207,255,217,217,217,255,230,230,230,255,232,232,232,255,234,234,234,255,234,234,234,255,216,216,216,255,205,205,205,255,219,219,219,255,204,204,204,255,193,193,193,255,201,201,201,255,204,204,204,255,189,189,189,255,188,188,188,255,185,185,185,255,161,161,161,255,162,162,162,255,168,168,168,255,173,173,173,255,172,172,172,255,171,171,171,255,175,175,175,255,179,179,179,255,181,181,181,255,169,169,169,255,206,206,206,255,222,222,222,255,193,193,193,255,174,174,174,255,181,181,181,255,147,147,147,255,79,79,79,255,0,0,0,255,2,2,2,255,7,7,7,255,4,4,4,255,0,0,0,255,0,0,0,255,3,3,3,255,3,3,3,255,0,0,0,255,7,7,7,255,12,12,12,255,0,0,0,255,8,8,8,255,0,0,0,255,0,0,0,255,0,0,0,255,38,38,38,255,161,161,161,255,218,218,218,255,141,141,141,255,176,176,176,255,176,176,176,255,152,152,152,255,198,198,198,255,186,186,186,255,170,170,170,255,179,179,179,255,185,185,185,255,174,174,174,255,192,192,192,255,219,219,219,255,216,216,216,255,236,236,236,255,243,243,243,255,241,241,241,255,238,238,238,255,235,235,235,255,218,218,218,255,203,203,203,255,206,206,206,255,199,199,199,255,193,193,193,255,192,192,192,255,185,185,185,255,171,171,171,255,168,168,168,255,171,171,171,255,166,166,166,255,169,169,169,255,171,171,171,255,173,173,173,255,174,174,174,255,174,174,174,255,176,176,176,255,178,178,178,255,180,180,180,255,193,193,193,255,185,185,185,255,178,178,178,255,171,171,171,255,169,169,169,255,155,155,155,255,88,88,88,255,3,3,3,255,0,0,0,255,7,7,7,255,0,0,0,255,0,0,0,255,11,11,11,255,0,0,0,255,0,0,0,255,8,8,8,255,0,0,0,255,3,3,3,255,11,11,11,255,0,0,0,255,8,8,8,255,0,0,0,255,4,4,4,255,6,6,6,255,0,0,0,255,25,25,25,255,157,157,157,255,176,176,176,255,170,170,170,255,175,175,175,255,186,186,186,255,177,177,177,255,199,199,199,255,181,181,181,255,177,177,177,255,180,180,180,255,182,182,182,255,203,203,203,255,221,221,221,255,216,216,216,255,215,215,215,255,218,218,218,255,223,223,223,255,227,227,227,255,231,231,231,255,233,233,233,255,228,228,228,255,220,220,220,255,212,212,212,255,201,201,201,255,182,182,182,255,178,178,178,255,190,190,190,255,192,192,192,255,186,186,186,255,186,186,186,255,185,185,185,255,180,180,180,255,175,175,175,255,175,175,175,255,179,179,179,255,185,185,185,255,191,191,191,255,196,196,196,255,199,199,199,255,156,156,156,255,150,150,150,255,169,169,169,255,142,142,142,255,74,74,74,255,20,20,20,255,0,0,0,255,9,9,9,255,4,4,4,255,0,0,0,255,0,0,0,255,7,7,7,255,0,0,0,255,0,0,0,255,3,3,3,255,6,6,6,255,0,0,0,255,0,0,0,255,9,9,9,255,0,0,0,255,3,3,3,255,0,0,0,255,8,8,8,255,11,11,11,255,3,3,3,255,22,22,22,255,157,157,157,255,181,181,181,255,156,156,156,255,159,159,159,255,175,175,175,255,189,189,189,255,193,193,193,255,186,186,186,255,182,182,182,255,192,192,192,255,202,202,202,255,210,210,210,255,220,220,220,255,218,218,218,255,215,215,215,255,218,218,218,255,218,218,218,255,217,217,217,255,225,225,225,255,222,222,222,255,203,203,203,255,207,207,207,255,209,209,209,255,192,192,192,255,187,187,187,255,202,202,202,255,195,195,195,255,179,179,179,255,186,186,186,255,162,162,162,255,163,163,163,255,172,172,172,255,187,187,187,255,200,200,200,255,204,204,204,255,204,204,204,255,203,203,203,255,164,164,164,255,159,159,159,255,171,171,171,255,156,156,156,255,80,80,80,255,6,6,6,255,0,0,0,255,10,10,10,255,0,0,0,255,0,0,0,255,5,5,5,255,0,0,0,255,0,0,0,255,2,2,2,255,6,6,6,255,0,0,0,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,7,7,7,255,0,0,0,255,0,0,0,255,29,29,29,255,120,120,120,255,197,197,197,255,185,185,185,255,128,128,128,255,171,171,171,255,174,174,174,255,183,183,183,255,191,191,191,255,192,192,192,255,193,193,193,255,206,206,206,255,221,221,221,255,223,223,223,255,216,216,216,255,207,207,207,255,216,216,216,255,228,228,228,255,219,219,219,255,212,212,212,255,224,224,224,255,216,216,216,255,195,195,195,255,176,176,176,255,172,172,172,255,172,172,172,255,169,169,169,255,169,169,169,255,173,173,173,255,180,180,180,255,200,200,200,255,205,205,205,255,198,198,198,255,204,204,204,255,215,215,215,255,193,193,193,255,156,156,156,255,169,169,169,255,187,187,187,255,147,147,147,255,53,53,53,255,0,0,0,255,0,0,0,255,8,8,8,255,0,0,0,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,0,0,0,255,4,4,4,255,7,7,7,255,3,3,3,255,20,20,20,255,74,74,74,255,144,144,144,255,192,192,192,255,123,123,123,255,166,166,166,255,194,194,194,255,181,181,181,255,164,164,164,255,173,173,173,255,195,195,195,255,207,207,207,255,211,211,211,255,221,221,221,255,220,220,220,255,219,219,219,255,229,229,229,255,225,225,225,255,214,214,214,255,213,213,213,255,203,203,203,255,189,189,189,255,179,179,179,255,180,180,180,255,181,181,181,255,175,175,175,255,169,169,169,255,167,167,167,255,179,179,179,255,180,180,180,255,189,189,189,255,195,195,195,255,185,185,185,255,170,170,170,255,173,173,173,255,188,188,188,255,162,162,162,255,104,104,104,255,37,37,37,255,3,3,3,255,0,0,0,255,4,4,4,255,4,4,4,255,3,3,3,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,3,3,3,255,6,6,6,255,0,0,0,255,0,0,0,255,0,0,0,255,61,61,61,255,128,128,128,255,199,199,199,255,165,165,165,255,151,151,151,255,171,171,171,255,186,186,186,255,185,185,185,255,196,196,196,255,219,219,219,255,225,225,225,255,240,240,240,255,230,230,230,255,210,210,210,255,213,213,213,255,221,221,221,255,220,220,220,255,220,220,220,255,226,226,226,255,209,209,209,255,191,191,191,255,184,184,184,255,183,183,183,255,184,184,184,255,186,186,186,255,189,189,189,255,180,180,180,255,198,198,198,255,205,205,205,255,194,194,194,255,184,184,184,255,181,181,181,255,171,171,171,255,157,157,157,255,76,76,76,255,23,23,23,255,0,0,0,255,0,0,0,255,7,7,7,255,0,0,0,255,0,0,0,255,5,5,5,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,14,14,14,255,0,0,0,255,0,0,0,255,9,9,9,255,11,11,11,255,0,0,0,255,0,0,0,255,9,9,9,255,78,78,78,255,158,158,158,255,214,214,214,255,198,198,198,255,168,168,168,255,173,173,173,255,193,193,193,255,200,200,200,255,178,178,178,255,204,204,204,255,215,215,215,255,215,215,215,255,220,220,220,255,217,217,217,255,207,207,207,255,205,205,205,255,182,182,182,255,181,181,181,255,183,183,183,255,191,191,191,255,198,198,198,255,198,198,198,255,192,192,192,255,187,187,187,255,205,205,205,255,194,194,194,255,172,172,172,255,167,167,167,255,190,190,190,255,193,193,193,255,131,131,131,255,53,53,53,255,0,0,0,255,0,0,0,255,6,6,6,255,8,8,8,255,4,4,4,255,0,0,0,255,0,0,0,255,0,0,0,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,2,2,2,255,0,0,0,255,0,0,0,255,6,6,6,255,7,7,7,255,2,2,2,255,0,0,0,255,0,0,0,255,0,0,0,255,5,5,5,255,68,68,68,255,167,167,167,255,226,226,226,255,218,218,218,255,195,195,195,255,190,190,190,255,208,208,208,255,218,218,218,255,221,221,221,255,223,223,223,255,220,220,220,255,201,201,201,255,190,190,190,255,202,202,202,255,207,207,207,255,203,203,203,255,196,196,196,255,190,190,190,255,189,189,189,255,188,188,188,255,183,183,183,255,178,178,178,255,188,188,188,255,204,204,204,255,220,220,220,255,201,201,201,255,130,130,130,255,46,46,46,255,4,4,4,255,2,2,2,255,0,0,0,255,5,5,5,255,2,2,2,255,0,0,0,255,0,0,0,255,7,7,7,255,7,7,7,255,0,0,0,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,0,0,0,255,1,1,1,255,4,4,4,255,0,0,0,255,0,0,0,255,0,0,0,255,5,5,5,255,7,7,7,255,8,8,8,255,12,12,12,255,0,0,0,255,0,0,0,255,33,33,33,255,124,124,124,255,196,196,196,255,221,221,221,255,213,213,213,255,217,217,217,255,221,221,221,255,231,231,231,255,231,231,231,255,210,210,210,255,201,201,201,255,218,218,218,255,200,200,200,255,201,201,201,255,200,200,200,255,199,199,199,255,203,203,203,255,209,209,209,255,209,209,209,255,206,206,206,255,223,223,223,255,166,166,166,255,91,91,91,255,37,37,37,255,11,11,11,255,3,3,3,255,0,0,0,255,0,0,0,255,6,6,6,255,0,0,0,255,0,0,0,255,1,1,1,255,3,3,3,255,0,0,0,255,0,0,0,255,6,6,6,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,0,0,0,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,0,0,0,255,0,0,0,255,1,1,1,255,1,1,1,255,9,9,9,255,16,16,16,255,5,5,5,255,0,0,0,255,18,18,18,255,53,53,53,255,115,115,115,255,146,146,146,255,182,182,182,255,215,215,215,255,238,238,238,255,233,233,233,255,220,220,220,255,221,221,221,255,224,224,224,255,233,233,233,255,237,237,237,255,227,227,227,255,205,205,205,255,173,173,173,255,134,134,134,255,104,104,104,255,27,27,27,255,25,25,25,255,6,6,6,255,0,0,0,255,0,0,0,255,19,19,19,255,13,13,13,255,0,0,0,255,0,0,0,255,0,0,0,255,4,4,4,255,13,13,13,255,6,6,6,255,0,0,0,255,0,0,0,255,6,6,6,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,2,2,2,255,0,0,0,255,1,1,1,255,6,6,6,255,2,2,2,255,0,0,0,255,0,0,0,255,4,4,4,255,0,0,0,255,2,2,2,255,1,1,1,255,0,0,0,255,2,2,2,255,8,8,8,255,6,6,6,255,0,0,0,255,0,0,0,255,13,13,13,255,10,10,10,255,6,6,6,255,27,27,27,255,54,54,54,255,71,71,71,255,83,83,83,255,82,82,82,255,75,75,75,255,54,54,54,255,28,28,28,255,12,12,12,255,9,9,9,255,6,6,6,255,0,0,0,255,1,1,1,255,0,0,0,255,4,4,4,255,13,13,13,255,5,5,5,255,0,0,0,255,0,0,0,255,13,13,13,255,4,4,4,255,4,4,4,255,0,0,0,255,0,0,0,255,0,0,0,255,5,5,5,255,4,4,4,255,0,0,0,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255,1,1,1,255};



// ===============================================================================
// 幅度转换
// ===============================================================================

// 从星等转换为相对亮度（归一化到 [0,1]，mag=0 → 1.0，mag=6 → ~0.01）
// 增加一个衰减系数（平均蓝天亮度），以便白天能够掩盖亮星
float magnitude_to_relative_luminance(float mag) {
    return 0.7f * powf(10.0f, -0.4f * mag);
}

float get_luminance(float r, float g, float b) {
    return 0.299f * r + 0.587f * g + 0.114f * b;
}

// 抖动：用于缓解低位深屏幕的色带现象
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

/**
 * Floyd-Steinberg误差扩散抖动
 * 在RGBA8888缓冲区上模拟RGB565量化过程，通过误差扩散缓解色带
 * 
 * @param frame_buffer RGBA8888格式帧缓冲（4字节/像素，顺序R,G,B,A）
 * @param fb_width     帧缓冲宽度（像素）
 * @param fb_height    帧缓冲高度（像素）
 * 
 * 算法原理：
 * 1. 对每个像素，先叠加累积误差得到"增强值"
 * 2. 模拟RGB565量化：R8→R5(>>3), G8→G6(>>2), B8→B5(>>3)
 * 3. 量化后还原为8bit：R5→R8(<<3|>>2), G6→G8(<<2|>>4), B5→B8(<<3|>>2)
 * 4. 计算误差 = 增强值 - 量化还原值
 * 5. 按Floyd-Steinberg权重扩散误差到邻域：
 *        [ 0      0      0    ]
 *        [ 0      X    7/16   ]
 *        [ 3/16  5/16  1/16   ]
 */
void dithering_fs(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height) {
    if (!frame_buffer || fb_width <= 0 || fb_height <= 0) return;

    const int32_t stride = fb_width * 4;  // RGBA8888每行字节数

    // 为避免跨行误差污染，使用双行误差缓冲（当前行+下一行）
    // 误差范围：[-255, 255] → 用int16_t安全存储
    int16_t *err_r = (int16_t *)calloc(fb_width * 2, sizeof(int16_t));
    int16_t *err_g = (int16_t *)calloc(fb_width * 2, sizeof(int16_t));
    int16_t *err_b = (int16_t *)calloc(fb_width * 2, sizeof(int16_t));

    if (!err_r || !err_g || !err_b) {
        if (err_r) free(err_r);
        if (err_g) free(err_g);
        if (err_b) free(err_b);
        return; // 内存分配失败，静默退出
    }

    #define CLAMP(v, min, max) ((v) < (min) ? (min) : ((v) > (max) ? (max) : (v)))

    for (int32_t y = 0; y < fb_height; y++) {
        int16_t *curr_err_r = err_r + (y & 1) * fb_width;      // 双缓冲切换
        int16_t *curr_err_g = err_g + (y & 1) * fb_width;
        int16_t *curr_err_b = err_b + (y & 1) * fb_width;
        int16_t *next_err_r = err_r + ((y + 1) & 1) * fb_width;
        int16_t *next_err_g = err_g + ((y + 1) & 1) * fb_width;
        int16_t *next_err_b = err_b + ((y + 1) & 1) * fb_width;

        // 清空下一行误差缓冲（避免残留）
        if (y + 1 < fb_height) {
            memset(next_err_r, 0, fb_width * sizeof(int16_t));
            memset(next_err_g, 0, fb_width * sizeof(int16_t));
            memset(next_err_b, 0, fb_width * sizeof(int16_t));
        }

        uint8_t *row = frame_buffer + y * stride;

        for (int32_t x = 0; x < fb_width; x++) {
            // 1. 叠加累积误差（限制在合理范围防止溢出）
            int32_t r = CLAMP(row[x * 4 + 0] + curr_err_r[x], 0, 255);
            int32_t g = CLAMP(row[x * 4 + 1] + curr_err_g[x], 0, 255);
            int32_t b = CLAMP(row[x * 4 + 2] + curr_err_b[x], 0, 255);
            uint8_t a = row[x * 4 + 3]; // Alpha通道保持不变

            // 2. 模拟RGB565量化并还原到8bit（保留低位以维持亮度）
            uint8_t r5 = r >> 3;          // 8bit → 5bit
            uint8_t g6 = g >> 2;          // 8bit → 6bit
            uint8_t b5 = b >> 3;          // 8bit → 5bit

            uint8_t r_out = (r5 << 3) | (r5 >> 2);  // 5bit → 8bit (复制高位到低位)
            uint8_t g_out = (g6 << 2) | (g6 >> 4);  // 6bit → 8bit
            uint8_t b_out = (b5 << 3) | (b5 >> 2);  // 5bit → 8bit

            // 3. 写回量化+抖动后的像素值
            row[x * 4 + 0] = r_out;
            row[x * 4 + 1] = g_out;
            row[x * 4 + 2] = b_out;
            // Alpha保持原值

            // 4. 计算误差（原始增强值 - 量化还原值）
            int32_t err_r_val = r - r_out;
            int32_t err_g_val = g - g_out;
            int32_t err_b_val = b - b_out;

            // 5. Floyd-Steinberg误差扩散（仅传播到未处理像素）
            if (x + 1 < fb_width) {
                // 右侧像素 (7/16)
                curr_err_r[x + 1] += (err_r_val * 7) >> 4;
                curr_err_g[x + 1] += (err_g_val * 7) >> 4;
                curr_err_b[x + 1] += (err_b_val * 7) >> 4;
            }

            if (y + 1 < fb_height) {
                if (x > 0) {
                    // 左下 (3/16)
                    next_err_r[x - 1] += (err_r_val * 3) >> 4;
                    next_err_g[x - 1] += (err_g_val * 3) >> 4;
                    next_err_b[x - 1] += (err_b_val * 3) >> 4;
                }
                // 正下 (5/16)
                next_err_r[x] += (err_r_val * 5) >> 4;
                next_err_g[x] += (err_g_val * 5) >> 4;
                next_err_b[x] += (err_b_val * 5) >> 4;

                if (x + 1 < fb_width) {
                    // 右下 (1/16)
                    next_err_r[x + 1] += err_r_val >> 4;
                    next_err_g[x + 1] += err_g_val >> 4;
                    next_err_b[x + 1] += err_b_val >> 4;
                }
            }
        }
    }

    free(err_r);
    free(err_g);
    free(err_b);
}





// 8x8 Bayer矩阵（预缩放至0~255范围，避免运行时乘法）
static const uint8_t bayer8x8[64] = {
    0,  192, 48,  240, 12,  204, 60,  252,
    128,64,  176,112,140,76,  224,160,
    32, 224, 16,  208, 44, 236, 28,  220,
    160,96,  144,80,  172,108,252,188,
    8,  200, 56,  248, 4,  196, 52,  244,
    136,72,  184,120,132,68,  216,152,
    40, 232, 24,  216, 36, 228, 20,  212,
    168,104,152,88,  180,116,244,180
};

// 量化误差补偿表（RGB565量化后还原的亮度偏移补偿）
static const int8_t quant_bias[8] = {0, 1, 1, 2, 2, 3, 3, 4}; // 经验值

void dithering_fast(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height) {
    if (!frame_buffer || fb_width <= 0 || fb_height <= 0) return;

    const int32_t stride = fb_width * 4;

    for (int32_t y = 0; y < fb_height; y++) {
        uint8_t *row = frame_buffer + y * stride;
        for (int32_t x = 0; x < fb_width; x++) {
            uint8_t *px = row + x * 4;
            uint8_t r = px[0], g = px[1], b = px[2];
            uint8_t a = px[3]; // 保留Alpha

            // 1. 获取Bayer阈值（归一化到0~7范围，匹配5/6bit量化步长）
            uint8_t threshold = bayer8x8[(y & 7) * 8 + (x & 7)] >> 5; // 0~7

            // 2. 应用阈值偏移（模拟误差扩散的视觉效果）
            int32_t r_adj = r + quant_bias[threshold];
            int32_t g_adj = g + quant_bias[threshold];
            int32_t b_adj = b + quant_bias[threshold];

            // 3. 模拟RGB565量化并还原
            uint8_t r5 = (r_adj > 255) ? 31 : (r_adj >> 3);
            uint8_t g6 = (g_adj > 255) ? 63 : (g_adj >> 2);
            uint8_t b5 = (b_adj > 255) ? 31 : (b_adj >> 3);

            px[0] = (r5 << 3) | (r5 >> 2);
            px[1] = (g6 << 2) | (g6 >> 4);
            px[2] = (b5 << 3) | (b5 >> 2);
            px[3] = a; // Alpha不变
        }
    }
}


// ===============================================================================
// 帧缓冲操作
// ===============================================================================

// 设置像素
static inline void set_pixel(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height, int32_t x, int32_t y, uint8_t r, uint8_t g, uint8_t b) {
    int32_t i = (y * fb_width + x) * 4;
    frame_buffer[ i ] = MIN(255, r);
    frame_buffer[i+1] = MIN(255, g);
    frame_buffer[i+2] = MIN(255, b);
    frame_buffer[i+3] = 255;
}

// 叠加像素
static inline void add_pixel(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height, int32_t x, int32_t y, uint8_t r, uint8_t g, uint8_t b) {
    int32_t i = (y * fb_width + x) * 4;
    frame_buffer[ i ] = MIN(255, frame_buffer[ i ] + r);
    frame_buffer[i+1] = MIN(255, frame_buffer[i+1] + g);
    frame_buffer[i+2] = MIN(255, frame_buffer[i+2] + b);
    frame_buffer[i+3] = 255;
}

static inline uint8_t get_pixel_channel(const uint8_t *tex, int32_t width, int32_t x, int32_t y, int32_t c) {
    return tex[((y * width + x) * 4) + c];
}

// ===============================================================================
// 坐标转换
// ===============================================================================

static inline float to_deg_float(float rad) {
    return rad * (180.0f / M_PI);
}

static inline float to_rad_float(float deg) {
    return deg * (M_PI / 180.0f);
}

static inline float normalize_angle_float(float angle) {
    angle = fmodf(angle, 360.0f);
    if (angle < 0) angle += 360.0f;
    return angle;
}

// 将hms格式的赤经转为度数
static inline float ra_hms_to_deg(float h, float m, float s) {
    float totalHours = h + m / 60.0f + s / 3600.0f;
    return normalize_angle_float(totalHours * 15.0f);
}

// 将度分秒格式的赤纬转为度数
static inline float dec_dms_to_decimal(float d, float m, float s) {
    float sign = (d < 0.0f) ? (-1.0f) : (1.0f);
    float absD = fabsf(d);
    float decimal = sign * (absD + m / 60.0f + s / 3600.0f);
    return decimal;
}

// 地平天球的球坐标系→地平天球的笛卡尔坐标系
void horizontal_to_xyz(float azimuth_deg, float altitude_deg, float R, float *x, float *y, float *z) {
    float altRad = to_rad_float(altitude_deg);
    float azRad = to_rad_float(180.0f + azimuth_deg);
    *x = R * cosf(altRad) * sinf(azRad);
    *y = R * cosf(altRad) * cosf(azRad);
    *z = R * sinf(altRad);
}

// 地平天球的球坐标系→地平天球的笛卡尔坐标系→投影到地面投影坐标系
void horizontal_to_screen_xy(
    float azimuth_deg, float altitude_deg, float radius,
    float center_x, float center_y, float *scr_x, float *scr_y
) {
    // 鱼眼投影
    if (USE_FISHEYE_PROJECTION) {
        // 因为是躺在地上看天，所以方位角是从正北逆时针旋转
        float az_rad = (-azimuth_deg * M_PI) / 180.0f;
        float alt_rad = (altitude_deg * M_PI) / 180.0f;
        // 天顶距 θ = π/2 - altitude
        float theta = M_PI_2 - alt_rad;
        // 等距鱼眼投影：r = (2R / π) * θ
        float r = (2.0f * radius / M_PI) * theta;
        // 投影到平面：X指向东（注意因为是躺在地上看天，所以东是屏幕坐标系的左侧/负半轴），Y指向北
        float X = r * sinf(az_rad);
        float Y = -r * cosf(az_rad);

        *scr_x = X + center_x;
        *scr_y = Y + center_y;
    }
    // 正交XY投影：笛卡尔坐标系的XY直接垂直投射到地平面上
    else {
        float x = 0.0f;
        float y = 0.0f;
        float z = 0.0f;
        horizontal_to_xyz(azimuth_deg, altitude_deg, radius, &x, &y, &z);
        (void)z;

        if (altitude_deg >= 0.0f) {
            // 转到canvas的屏幕坐标系
            *scr_x = x + center_x;
            *scr_y = y + center_y;
        }
        else {
            // 地平面以下的，移出canvas显示范围
            *scr_x = x - center_x;
            *scr_y = y - center_y;
        }
    }
}


// 屏幕坐标系→地面投影坐标系→反演回地平天球的直角坐标系
// 返回值为正：能够反演回球面；返回值为负：无法反演回球面
int32_t screen_xy_to_xyz(
    float scr_x, float scr_y,
    float radius, float center_x, float center_y,
    float *x, float *y, float *z
) {
    float dx = scr_x - center_x;
    float dy = scr_y - center_y;
    float r = sqrtf(dx*dx + dy*dy) / radius; // 归一化半径
    // 鱼眼投影
    if (USE_FISHEYE_PROJECTION) {
        if (r <= 1) {
            float theta = r * M_PI_2; // 天顶角
            float phi = atan2f(dy, dx); // 方位角
            *x = radius * sinf(theta) * cosf(phi);
            *y = radius * sinf(theta) * sinf(phi);
            *z = radius * cosf(theta);
            return 1;
        }
        else {
            *x = 0.0f;
            *y = 0.0f;
            *z = 0.0f;
            return -1;
        }
    }
    // XY投影
    else {
        if (r <= 1) {
            *x = dx;
            *y = dy;
            *z = sqrtf(radius*radius - (dx*dx + dy*dy));
            return 1;
        }
        else {
            *x = 0.0f;
            *y = 0.0f;
            *z = 0.0f;
            return -1;
        }
    }
}


// ===============================================================================
// 滤波器
// ===============================================================================

void star_burst_filter(uint8_t *frame_buffer, int32_t width, int32_t height, float sun_screen_x, float sun_screen_y) {
    // 亮度阈值
    float threshold = 0.9;

    float cx = sun_screen_x;
    float cy = sun_screen_y;
    int32_t ix = (int32_t)(floorf(cx));
    int32_t iy = (int32_t)(floorf(cy));
    if (ix < 0 || ix >= width || iy < 0 || iy >= height) return;

    // 1. 读取原图中该像素的亮度
    int32_t idx = (iy * width + ix) * 4;
    float r = frame_buffer[idx] / 255.f;
    float g = frame_buffer[idx + 1] / 255.f;
    float b = frame_buffer[idx + 2] / 255.f;
    float lum = get_luminance(r, g, b);

    if (lum <= threshold) return; // 不够亮，不绘制星芒

    // 2. 计算星芒颜色和强度
    float factor = MIN(1.0f, (lum - threshold) * 5.0f);
    float sr = r * factor * 255.0f;
    float sg = g * factor * 255.0f;
    float sb = b * factor * 255.0f;

    // 3. 绘制星芒（沿4个方向双向延伸）
    int32_t blurLength = 100;
    float decay = 0.97f;

    for (int32_t k = 0; k < 4; k++) {
        float dx = 0.0f;
        float dy = 0.0f;

        switch (k) {
            case 0: dx = 1.0f; dy = 0.0f; break;
            case 1: dx = 0.0f; dy = 1.0f; break;
            case 2: dx = 1.0f; dy = 1.0f; break;
            case 3: dx = 1.0f; dy = -1.0f; break;
            default: break;
        }

        float len = sqrtf(dx*dx + dy*dy);
        float ndx = dx / len;
        float ndy = dy / len;

        for (int32_t d = 1; d <= blurLength; d++) {
            float alpha = powf(decay, (float)d);
            if (alpha < 0.01f) break;

            // 正向
            int32_t px = (int32_t)floorf(cx + ndx * d);
            int32_t py = (int32_t)floorf(cy + ndy * d);
            if (px >= 0 && px < width && py >= 0 && py < height) {
                add_pixel(frame_buffer, width, height, px, py, (uint8_t)(sr * alpha), (uint8_t)(sg * alpha), (uint8_t)(sb * alpha));
            }

            // 反向
            px = (int32_t)floorf(cx - ndx * d);
            py = (int32_t)floorf(cy - ndy * d);
            if (px >= 0 && px < width && py >= 0 && py < height) {
                add_pixel(frame_buffer, width, height, px, py, (uint8_t)(sr * alpha), (uint8_t)(sg * alpha), (uint8_t)(sb * alpha));
            }
        }
    }
}





// ===============================================================================
// 绘制文字（临时实现）
// ===============================================================================

uint8_t *get_glyph(uint32_t utf32, uint8_t *font_width, uint8_t *font_height) {
    if(utf32 < 127) {
        *font_width = 6;
        *font_height = 12;
        return ASCII_6_12[utf32 - 32];
    }
    else {
        int32_t index = binary_search(UTF32_LUT_SORTED, UTF32_LUT_INDEXS, GLYPH_CHAR_NUM, utf32);
        if (index >= 0 && index < 7445) {
            *font_width = 12;
            *font_height = 12;
            return GB2312_12_12[index];
        }
        else {
            return NULL;
        }
    }
}

// 显示汉字
void fb_draw_char(
    uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    int32_t x, int32_t y, uint8_t *glyph, uint8_t font_width, uint8_t font_height,
    uint8_t red, uint8_t green, uint8_t blue
) {
    int32_t row_bytes = (font_height + 8 - 1) / 8;
    int32_t col_bytes = font_width;
    for (int32_t j = 0; j < row_bytes; j++) {
        int32_t bits = (j == (row_bytes-1)) ? (8 - ((8 * row_bytes) % font_height)) : 8;
        for (int32_t i = 0; i < col_bytes; i++) {
            uint8_t g = glyph[j * col_bytes + i];
            for (int32_t b = 0; b < bits; b++) {
                int32_t px = x + i;
                int32_t py = y + j*8 + b;
                if (px < 0 || px >= fb_width || py < 0 || py >= fb_height) continue;
                if ((g >> b) & 0x1) {
                    set_pixel(frame_buffer, fb_width, fb_height, px, py, red, green, blue);
                }
                else {
                    add_pixel(frame_buffer, fb_width, fb_height, px, py, 0, 0, 0);
                }
            }
        }
    }
}


// 绘制一行文本，mode为1则为正显，为0则为反白
void fb_draw_textline(
    uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    wchar_t *line, int32_t x, int32_t y, uint8_t red, uint8_t green, uint8_t blue) {
    uint32_t x_pos = x;
    uint32_t y_pos = y;
    for (uint32_t i = 0; i < wcslen(line); i++) {
        uint32_t current_char = line[i];
        uint8_t font_width = 12;
        uint8_t font_height = 12;
        uint8_t *glyph = get_glyph(current_char, &font_width, &font_height);
        if (!glyph) {
            // printf("出现了字库之外的字符！\n");
            glyph = get_glyph(12307, &font_width, &font_height); // 用字脚符号“〓”代替，参考https://ja.wikipedia.org/wiki/下駄記号
        }
        if (x_pos + font_width >= fb_width) {
            break;
        }
        fb_draw_char(frame_buffer, fb_width, fb_height,
            x_pos, y_pos, glyph, font_width, font_height, red, green, blue);
        x_pos += font_width;
    }
}









// ===============================================================================
// 绘制基本形状
// ===============================================================================

void draw_line(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float x1, float y1, float x2, float y2, float line_width, uint8_t r, uint8_t g, uint8_t b
) {
    if (line_width <= 0.0f) return;

    // 确保颜色在 [0, 255] 范围内
    uint8_t cr = MAX(0, MIN(255, r));
    uint8_t cg = MAX(0, MIN(255, g));
    uint8_t cb = MAX(0, MIN(255, b));

    float dx = x2 - x1;
    float dy = y2 - y1;
    float len_sq = dx * dx + dy * dy;

    // 退化为点：绘制圆形
    if (len_sq == 0.0f) { // TODO 与0比较
        float radius = line_width / 2.0f;
        float r_sq = radius * radius;
        int32_t xMin = MAX(0, (int32_t)floorf(x1 - radius));
        int32_t xMax = MIN(fb_width - 1, (int32_t)ceilf(x1 + radius));
        int32_t yMin = MAX(0, (int32_t)floorf(y1 - radius));
        int32_t yMax = MIN(fb_height - 1, (int32_t)ceilf(y1 + radius));

        for (int32_t y = yMin; y <= yMax; y++) {
            for (int32_t x = xMin; x <= xMax; x++) {
                float dist_sq = (float)((x - x1) * (x - x1) + (y - y1) * (y - y1));
                if (dist_sq <= r_sq) {
                    add_pixel(frame_buffer, fb_width, fb_height, x, y, cr, cg, cb);
                }
            }
        }
        return;
    }

    float len = sqrtf(len_sq);
    float inv_len = 1.0f / len;
    float nx = -dy * inv_len; // 法向量（垂直于线段）
    float ny = dx * inv_len;

    float half_w = line_width / 2.0f;

    // 包围盒（含线宽）
    int32_t xMin = MAX(0, (int32_t)floorf(MIN(x1, x2) - half_w));
    int32_t xMax = MIN(fb_width - 1, (int32_t)ceilf(MAX(x1, x2) + half_w));
    int32_t yMin = MAX(0, (int32_t)floorf(MIN(y1, y2) - half_w));
    int32_t yMax = MIN(fb_height - 1, (int32_t)ceilf(MAX(y1, y2) + half_w));

    for (int32_t y = yMin; y <= yMax; y++) {
        for (int32_t x = xMin; x <= xMax; x++) {
            // 计算点 (x, y) 到线段的有符号距离
            int32_t px = x - x1;
            int32_t py = y - y1;

            // 投影长度（参数 t）
            float t = (float)(px * dx + py * dy) / len_sq;
            int32_t closest_x = x1;
            int32_t closest_y = y1;

            if (t < 0.0f) {
                closest_x = x1;
                closest_y = y1;
            }
            else if (t > 1.0f) {
                closest_x = x2;
                closest_y = y2;
            }
            else {
                closest_x = x1 + (int32_t)(t * dx);
                closest_y = y1 + (int32_t)(t * dy);
            }

            float dist = sqrtf((float)((x - closest_x) * (x - closest_x) + (y - closest_y) * (y - closest_y)));

            if (dist > half_w) continue;

            // 抗锯齿：边缘平滑过渡
            float alpha = 1.0f;
            float edge_fade = 1.0; // 像素，可调
            if (dist > half_w - edge_fade) {
                alpha = (half_w - dist) / edge_fade;
                alpha = MAX(0.0f, MIN(1.0f, alpha));
            }
            add_pixel(frame_buffer, fb_width, fb_height, x, y, cr * alpha, cg * alpha, cb * alpha);
        }
    }
}


void draw_circle_outline(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float cx, float cy, float radius, float line_weight, uint8_t red, uint8_t green, uint8_t blue
) {
    if (radius <= 0.0f || line_weight <= 0.0f) return;

    uint8_t r = MAX(0, MIN(255, red));
    uint8_t g = MAX(0, MIN(255, green));
    uint8_t b = MAX(0, MIN(255, blue));

    // 计算内外半径（考虑线宽居中）
    float halfWeight = line_weight / 2.0f;
    float outerR = radius + halfWeight;
    float innerR = MAX(0, radius - halfWeight);

    float outerRSq = outerR * outerR;
    float innerRSq = innerR * innerR;

    // 包围盒（含线宽）
    int32_t xMin = MAX(0, (int32_t)floorf(cx - outerR));
    int32_t xMax = MIN(fb_width - 1, (int32_t)ceilf(cx + outerR));
    int32_t yMin = MAX(0, (int32_t)floorf(cy - outerR));
    int32_t yMax = MIN(fb_height - 1, (int32_t)ceilf(cy + outerR));

    for (int32_t y = yMin; y <= yMax; y++) {
        for (int32_t x = xMin; x <= xMax; x++) {
            float dx = x - cx;
            float dy = y - cy;
            float distSq = dx * dx + dy * dy;

            // 判断是否在环形区域内（包含外边界，排除内边界）
            if (distSq < outerRSq && distSq >= innerRSq) {
                add_pixel(frame_buffer, fb_width, fb_height, x, y, r, g, b);
            }
        }
    }
}

// 地面填充纯黑色
void draw_horizon(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height, float sky_radius, float center_x, float center_y) {
    float R_sq = sky_radius * sky_radius;
    for (int32_t y = 0; y < fb_height; y++) {
        for (int32_t x = 0; x < fb_width; x++) {
            float dx = (float)x - center_x;
            float dy = (float)y - center_y;
            if (dx * dx + dy * dy > R_sq) {
                set_pixel(frame_buffer, fb_width, fb_height, x, y, 0, 0, 0);
            }
        }
    }
}

// ===============================================================================
// 绘制坐标系
// ===============================================================================

/**
 * 绘制赤道坐标系下的子午圈或纬度圈（投影到地平屏幕）
 * @param frame_buffer - 帧缓冲区
 * @param fb_width - 缓冲区宽度
 * @param fb_height - 缓冲区高度
 * @param is_meridian - 1: 子午圈（固定RA）；0: 纬度圈（固定Dec）
 * @param ra_hours - 子午圈的赤经（小时），仅当 is_meridian=1 时有效
 * @param dec_deg - 纬度圈的赤纬（度），仅当 is_meridian=0 时有效
 * @param line_weight - 线宽（像素），建议 ≥1
 * @param colorR, colorG, colorB - RGB 颜色分量 [0-255]
 * @param year, month, day, hour, minute, second, timezone, longitude, latitude - 观测参数
 */
void draw_celestial_circle(
    uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float sky_radius, float center_x, float center_y,
    int32_t is_meridian, float ra_hours, float dec_deg,
    int32_t line_weight, uint8_t colorR, uint8_t colorG, uint8_t colorB,
    int32_t year, int32_t month, int32_t day, int32_t hour, int32_t minute, int32_t second,
    double timezone, double longitude, double latitude
) {
    int32_t POINTS = 360; // 提高采样密度以获得更平滑曲线

    float x_prev = 0.0f;
    float y_prev = 0.0f;
    double alt_prev = 0.0f;
    float x_0 = 0.0f;
    float y_0 = 0.0f;
    double alt_0 = 0.0f;

    // 子午圈：固定 RA，遍历 Dec ∈ [-90°, +90°]
    if (is_meridian) {
        if (ra_hours < 0.0f || ra_hours > 24.0f) return;
        float ra_deg = fmodf(ra_hours, 24.0f) * 15.0f;
        double alt = 0.0;
        double azi = 0.0;
        for (int32_t i = 0; i <= POINTS; i++) {
            float dec = -90.0f + (180.0f * (float)i / (float)POINTS);
            equatorial_to_horizontal((double)ra_deg, (double)dec, year, month, day, hour, minute, second, timezone, longitude, latitude, &azi, &alt);

            if (alt > 0.0) {
                float x = 0.0f;
                float y = 0.0f;
                horizontal_to_screen_xy(azi, alt, sky_radius, center_x, center_y, &x, &y);

                if (i == 0) {
                    x_0 = x;
                    y_0 = y;
                    alt_0 = alt;
                }
                
                if (alt_prev > 0.0 && alt > 0.0) {
                    draw_line(frame_buffer, fb_width, fb_height, x_prev, y_prev, x, y, line_weight, colorR, colorG, colorB);
                }

                x_prev = x;
                y_prev = y;
                alt_prev = alt;
            }
        }
        if (alt_0 > 0.0 && alt > 0.0) {
            draw_line(frame_buffer, fb_width, fb_height, x_prev, y_prev, x_0, y_0, line_weight, colorR, colorG, colorB);
        }
    }
    // 纬度圈：固定 Dec，遍历 RA ∈ [0h, 24h)
    else {
        if (dec_deg < -90.0f || dec_deg > 90.0f) return;
        double alt = 0.0;
        double azi = 0.0;
        for (int32_t i = 0; i <= POINTS; i++) {
            float ra_h = 24.0f * (float)i / (float)POINTS;
            float ra_deg = fmodf(ra_h, 24.0f) * 15.0f;

            equatorial_to_horizontal((double)ra_deg, (double)dec_deg, year, month, day, hour, minute, second, timezone, longitude, latitude, &azi, &alt);

            if (alt > 0.0) {
                float x = 0.0f;
                float y = 0.0f;
                horizontal_to_screen_xy(azi, alt, sky_radius, center_x, center_y, &x, &y);

                if (i == 0) {
                    x_0 = x;
                    y_0 = y;
                    alt_0 = alt;
                }

                if (alt_prev > 0.0 && alt > 0.0) {
                    draw_line(frame_buffer, fb_width, fb_height, x_prev, y_prev, x, y, line_weight, colorR, colorG, colorB);
                }

                x_prev = x;
                y_prev = y;
                alt_prev = alt;
            }
        }
        if (alt_0 > 0.0 && alt > 0.0) {
            draw_line(frame_buffer, fb_width, fb_height, x_prev, y_prev, x_0, y_0, line_weight, colorR, colorG, colorB);
        }
    }
}


// ===============================================================================
// 绘制天体
// ===============================================================================

void render_sun(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float sky_radius, float center_x, float center_y,
    float sun_proj_x, float sun_proj_y, float sun_altitude_deg
) {

    float sun_radius = sky_radius * 0.02;

    // 太阳半径（随高度变化）：地平线附近略大
    float radius = MAX(6.0f, sun_radius) * (1.0f + 0.2f * MAX(0.0f, 1.0f - sun_altitude_deg / 10.0f));

    // 光晕半径
    int32_t glow_radius = 20;

    // 太阳颜色：随高度从红→黄→白
    uint8_t r = 0;
    uint8_t g = 0;
    uint8_t b = 0;
    // 接近地平线：深红到橙
    if (sun_altitude_deg < 5.0f) {
        float t = MIN(1.0f, MAX(0.0f, sun_altitude_deg) / 5.0f);
        r = 255;
        g = (uint8_t)roundf(160.0f * t);
        b = (uint8_t)roundf(40.0f * t);
    }
    // 低空：橙黄
    else if (sun_altitude_deg < 15.0f) {
        float t = (sun_altitude_deg - 5.0f) / 10.0f;
        r = 255;
        g = (uint8_t)roundf(160.0f + 95 * t);
        b = (uint8_t)roundf(40.0f + 60 * t);
    }
    // 中天：白色
    else {
        r = 255;
        g = 255;
        b = 255;
    }

    // 抗锯齿边缘宽度
    float edgeSmoothWidth = 1.0f;

    // 绘制太阳本体（带软边缘）
    for (int32_t dy = -glow_radius; dy <= glow_radius; dy++) {
        for (int32_t dx = -glow_radius; dx <= glow_radius; dx++) {
            float dist = sqrtf(dx * dx + dy * dy);
            int32_t px = (int32_t)floorf(sun_proj_x + (float)dx);
            int32_t py = (int32_t)floorf(sun_proj_y + (float)dy);
            if (px < 0 || px >= fb_width || py < 0 || py >= fb_height) continue;

            // 太阳光晕（指数衰减）
            float glow = 0.0f;
            if (dist > radius && dist <= (float)glow_radius) {
                // 光晕强度随距离衰减
                glow = expf(-(dist / (float)glow_radius) * 3.0f);
            }

            // 太阳本体（带抗锯齿）
            float diskWeight = 0.0f;
            if (dist <= radius + edgeSmoothWidth) {
                if (dist <= radius - edgeSmoothWidth) {
                    diskWeight = 1.0f;
                }
                else if (dist < radius + edgeSmoothWidth) {
                    float t = (radius + edgeSmoothWidth - dist) / (2.0f * edgeSmoothWidth);
                    diskWeight = MAX(0.0f, MIN(1.0f, t * t * (3.0f - 2.0f * t)));
                }
            }

            // 合并：中心最亮（diskWeight=1），向外过渡到光晕
            float totalR = diskWeight * r + glow * r;
            float totalG = diskWeight * g + glow * g;
            float totalB = diskWeight * b + glow * b;

            add_pixel(frame_buffer, fb_width, fb_height, px, py, totalR, totalG, totalB);
        }
    }
}


// 基于球面几何晨昏线的月相绘制（带物理合理的软边缘）
void render_moon(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float sky_radius, float center_x, float center_y,
    int32_t year, int32_t month, int32_t day, int32_t hour, int32_t minute, int32_t second,
    double timezone, double longitude, double latitude
) {
    float lum = 0.8f;

    // 计算月球位置、月相、月球方向角
    double moon_azi = 0.0;
    double moon_alt = 0.0;
    where_is_the_moon(year, month, day, hour, minute, second, timezone, longitude, latitude, &moon_azi, &moon_alt);

    // 计算月球的屏幕投影坐标
    float moon_scr_x = 0.0f;
    float moon_scr_y = 0.0f;
    horizontal_to_screen_xy(moon_azi, moon_alt, sky_radius, center_x, center_y, &moon_scr_x, &moon_scr_y);

    // 从天北极位置粗略计算月球倾斜角
    float northpole_scr_x = 0.0f;
    float northpole_scr_y = 0.0f;
    horizontal_to_screen_xy(0.0f, latitude, sky_radius, center_x, center_y, &northpole_scr_x, &northpole_scr_y); // 计算北天极投影位置

    float xa = moon_scr_x;
    float ya = moon_scr_y;
    float xb = northpole_scr_x;
    float yb = northpole_scr_y;
    float tilt_rad = acosf((-xa * (xb - xa) - ya * (yb - ya)) / (sqrtf(xa*xa+ya*ya) * sqrtf((xb-xa)*(xb-xa) + (yb-ya)*(yb-ya))));
    float tilt_deg = to_deg_float(tilt_rad) + 180.0f;

    // 月相角
    float mphase = (float)moon_phase(year, month, day, hour, minute, second, timezone);
    float phase_deg = 180.0f * (mphase + 1.0f) + 90.0f;
    float cosPhase = cosf(to_rad_float(phase_deg));
    float sinPhase = sinf(to_rad_float(phase_deg));
    float sunDirX = cosPhase * cosf(to_rad_float(tilt_deg));
    float sunDirY = cosPhase * sinf(to_rad_float(tilt_deg));
    float sunDirZ = sinPhase;

    float sunLen = sqrtf(sunDirX * sunDirX + sunDirY * sunDirY + sunDirZ * sunDirZ);
    float sunUnitX = (sunLen > 0.0f) ? (sunDirX / sunLen) : 1.0f;
    float sunUnitY = (sunLen > 0.0f) ? (sunDirY / sunLen) : 0.0f;
    float sunUnitZ = (sunLen > 0.0f) ? (sunDirZ / sunLen) : 0.0f;

    // 颜色与环境光
    // const litColor = [220, 220, 200];
    // const darkColor = [10, 10, 20];
    float ambient = 0.01f;

    // 半影角宽度（弧度）
    float PENUMBRA_HALF_ANGLE = 0.2f;

    // 抗锯齿过渡带宽度（像素）
    float edgeSmoothWidth = 1.0f;

    // 显示直径
    float moonRadius = sky_radius * 0.08;

    float r2 = moonRadius * moonRadius;
    for (int32_t dy = -(int32_t)moonRadius; dy <= (int32_t)moonRadius; dy++) {
        for (int32_t dx = -(int32_t)moonRadius; dx <= (int32_t)moonRadius; dx++) {
            float distance = sqrtf((float)(dx * dx + dy * dy));
            if (distance > moonRadius + edgeSmoothWidth) continue;

            int32_t px = (int32_t)floorf(moon_scr_x + (float)dx);
            int32_t py = (int32_t)floorf(moon_scr_y + (float)dy);
            if (px < 0 || px >= fb_width || py < 0 || py >= fb_height) continue;

            // 计算抗锯齿权重（基于圆盘覆盖比例）
            float moonWeight = 1.0f;
            if (distance <= moonRadius - edgeSmoothWidth) {
                moonWeight = 1.0; // 完全在内部
            }
            else if (distance >= moonRadius + edgeSmoothWidth) {
                moonWeight = 0.0; // 完全在外部（应跳过，但保留以防边界误差）
                continue;
            }
            else {
                // 平滑过渡 [moonRadius - w, moonRadius + w]
                float t = (moonRadius + edgeSmoothWidth - distance) / (2.0f * edgeSmoothWidth);
                moonWeight = MAX(0.0f, MIN(1.0f, t)); // 线性插值，也可用更平滑：moonWeight = t * t * (3 - 2 * t);
            }

            if (moonWeight <= 0) continue;

            // 获取当前背景颜色
            int32_t idx = (py * fb_width + px) * 4;
            float bgR = frame_buffer[idx] / 255;
            float bgG = frame_buffer[idx + 1] / 255;
            float bgB = frame_buffer[idx + 2] / 255;

            // 构造单位球面上的表面点（归一化位置向量 = 法向量）
            float len = sqrtf(dx * dx + dy * dy + r2 - dx * dx - dy * dy); // = moonRadius
            // 实际上，(dx, dy, dz) 在半径为 moonRadius 的球面上，所以单位向量为：
            float nx = (float)dx / moonRadius;
            float ny = (float)dy / moonRadius;
            float nz = sqrtf(MAX(0.0f, r2 - dx * dx - dy * dy)) / moonRadius;

            // 关键：计算该点与晨昏线（太阳方向与月球中心构成的大圆）的球面角距离
            // 点积 dot = cos(θ)，其中 θ 是表面点与太阳方向的夹角
            float dot = nx * sunUnitX + ny * sunUnitY + nz * sunUnitZ;
            float angle_from_terminator = acosf(MAX(-1.0f, MIN(1.0f, dot))) - M_PI_2; // ∈ [-π/2, π/2]

            // 软边缘判断
            float intensity = 1.0f;
            if (angle_from_terminator >= PENUMBRA_HALF_ANGLE) {
                intensity = 1.0; // 完全照亮
            }
            else if (angle_from_terminator <= -PENUMBRA_HALF_ANGLE) {
                intensity = ambient; // 完全背光
            }
            else {
                // 映射到 [0,1]
                float t = (angle_from_terminator + PENUMBRA_HALF_ANGLE) / (2.0f * PENUMBRA_HALF_ANGLE);
                float smoothT = t * t * (3.0f - 2.0f * t); // smoothstep
                intensity = ambient + (1.0f - ambient) * smoothT;
            }

            // 调整全局亮度
            intensity *= lum;

            // 纹理映射：先绕 Z 轴旋转 -alpha，再映射到经纬度
            float u_norm = (float)dx / moonRadius;   // ∈ [-1, 1]
            float v_norm = (float)dy / moonRadius;   // ∈ [-1, 1]

            // 绕原点旋转 -alpha（使贴图随光照方向对齐）
            float cosA = cosf(-to_rad_float(tilt_deg));
            float sinA = sinf(-to_rad_float(tilt_deg));
            float u_rot = u_norm * cosA - v_norm * sinA;
            float v_rot = u_norm * sinA + v_norm * cosA;

            // 映射到 [0,1] 贴图空间
            float u = (u_rot + 1.0f) * 0.5f; // [-1,1] → [0,1]
            float v = (v_rot + 1.0f) * 0.5f;

            // 可选：限制在 [0,1] 内（避免边缘采样异常）
            if (u < 0.0f || u > 1.0f || v < 0.0f || v > 1.0f) {
                // 可选择 clamp 或 skip；这里 clamp 更安全
                u = MAX(0.0f, MIN(1.0f, u));
                v = MAX(0.0f, MIN(1.0f, v));
            }

            // 双线性采样
            float tx = u * (float)moon_texture_width - 0.5f;
            float ty = v * (float)moon_texture_height - 0.5f;

            int32_t x0 = (int32_t)floorf(tx);
            int32_t y0 = (int32_t)floorf(ty);
            int32_t x1 = (x0 + 1) % moon_texture_width;
            int32_t y1 = MIN(y0 + 1, moon_texture_height - 1);

            float wx = tx - (float)x0;
            float wy = ty - (float)y0;

            uint8_t c00_r = get_pixel_channel(moon_texture_rgba, moon_texture_width, x0, y0, 0);
            uint8_t c00_g = get_pixel_channel(moon_texture_rgba, moon_texture_width, x0, y0, 1);
            uint8_t c00_b = get_pixel_channel(moon_texture_rgba, moon_texture_width, x0, y0, 2);

            uint8_t c10_r = get_pixel_channel(moon_texture_rgba, moon_texture_width, x1, y0, 0);
            uint8_t c10_g = get_pixel_channel(moon_texture_rgba, moon_texture_width, x1, y0, 1);
            uint8_t c10_b = get_pixel_channel(moon_texture_rgba, moon_texture_width, x1, y0, 2);

            uint8_t c01_r = get_pixel_channel(moon_texture_rgba, moon_texture_width, x0, y1, 0);
            uint8_t c01_g = get_pixel_channel(moon_texture_rgba, moon_texture_width, x0, y1, 1);
            uint8_t c01_b = get_pixel_channel(moon_texture_rgba, moon_texture_width, x0, y1, 2);

            uint8_t c11_r = get_pixel_channel(moon_texture_rgba, moon_texture_width, x1, y1, 0);
            uint8_t c11_g = get_pixel_channel(moon_texture_rgba, moon_texture_width, x1, y1, 1);
            uint8_t c11_b = get_pixel_channel(moon_texture_rgba, moon_texture_width, x1, y1, 2);

            // bilinear interpolation
            float r0 = (float)c00_r + wx * (float)(c10_r - c00_r);
            float g0 = (float)c00_g + wx * (float)(c10_g - c00_g);
            float b0 = (float)c00_b + wx * (float)(c10_b - c00_b);

            float r1 = (float)c01_r + wx * (float)(c11_r - c01_r);
            float g1 = (float)c01_g + wx * (float)(c11_g - c01_g);
            float b1 = (float)c01_b + wx * (float)(c11_b - c01_b);

            float texR = r0 + wy * (r1 - r0);
            float texG = g0 + wy * (g1 - g0);
            float texB = b0 + wy * (b1 - b0);

            // 应用光照强度
            float r = roundf(texR * intensity);
            float g = roundf(texG * intensity);
            float b = roundf(texB * intensity);

            float finalR = moonWeight * r + (1.0f - moonWeight) * bgR;
            float finalG = moonWeight * g + (1.0f - moonWeight) * bgG;
            float finalB = moonWeight * b + (1.0f - moonWeight) * bgB;

            frame_buffer[idx]     = MIN(255, finalR);
            frame_buffer[idx + 1] = MIN(255, finalG);
            frame_buffer[idx + 2] = MIN(255, finalB);
        }
    }
}


void draw_star(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float sky_radius, float center_x, float center_y,
    float sx, float sy, float magnitude
) {

    int32_t maxGlowRadius = 3; // 光晕最大半径（像素）

    float starLumBase = magnitude_to_relative_luminance(magnitude);

    // 遍历光晕区域（正方形包围圆）
    for (int32_t dy = -maxGlowRadius; dy <= maxGlowRadius; dy++) {
        for (int32_t dx = -maxGlowRadius; dx <= maxGlowRadius; dx++) {
            float dist = sqrtf(dx * dx + dy * dy);
            if (dist > (float)maxGlowRadius) continue;

            int32_t px = (int32_t)roundf(sx + (float)dx);
            int32_t py = (int32_t)roundf(sy + (float)dy);
            if (px < 0 || px >= fb_width || py < 0 || py >= fb_height) continue;

            // 获取背景亮度用于对比度抑制
            int32_t bgIdx = (py * fb_width + px) * 4;
            float bgR = frame_buffer[bgIdx] / 255.0f;
            float bgG = frame_buffer[bgIdx + 1] / 255.0f;
            float bgB = frame_buffer[bgIdx + 2] / 255.0f;
            float bgLum = get_luminance(bgR, bgG, bgB);

            // 计算恒星在该点的原始发光强度（带光晕衰减）
            float glowFactor = expf(-dist * 1.0f);
            float starLum = starLumBase * glowFactor;

            // 对比度抑制：白天背景亮时，星星和光晕都应被压制
            float contrast = starLum / (bgLum + 0.001f);
            float visibility = 1.0f;
            if (contrast < 1.0f) {
                // visibility = Math.pow(contrast, 3);
                visibility = contrast * contrast * contrast;
            }
            starLum *= visibility;

            // 转为 0–255 范围
            uint8_t add = MIN(255, (uint8_t)floorf(starLum * 255.0f));

            // 叠加到 RGB（保持白色光晕，可改为彩色）
            frame_buffer[bgIdx]     = (uint8_t)MIN(255, frame_buffer[bgIdx]     + add);
            frame_buffer[bgIdx + 1] = (uint8_t)MIN(255, frame_buffer[bgIdx + 1] + add);
            frame_buffer[bgIdx + 2] = (uint8_t)MIN(255, frame_buffer[bgIdx + 2] + add);
        }
    }
}



// ===============================================================================
// 散射
// ===============================================================================

// 计算大气散射强度
void calculate_scattered_pixel(
    float ray_x, float ray_y, float ray_z, float sun_x, float sun_y, float sun_z,
    float *red, float *green, float *blue
) {

    // 视线向量归一化
    float ray_length = sqrtf(ray_x * ray_x + ray_y * ray_y + ray_z * ray_z);
    if (ray_length == 0.0f) {
        *red = 0;
        *green = 0;
        *blue = 0;
        return;
    }
    float ray_norm_x = ray_x / ray_length;
    float ray_norm_y = ray_y / ray_length;
    float ray_norm_z = ray_z / ray_length;


    // 太阳方向归一化
    float sun_vec_radius = sqrtf(sun_x * sun_x + sun_y * sun_y + sun_z * sun_z);
    if (sun_vec_radius == 0.0f) {
        *red = 0;
        *green = 255.0;
        *blue = 0;
        return;
    }
    float sun_norm_x = sun_x / sun_vec_radius;
    float sun_norm_y = sun_y / sun_vec_radius;
    float sun_norm_z = sun_z / sun_vec_radius;


    // 太阳光入射路径：计算仰角、天顶角、大气光学质量
    float sun_altitude = asinf(MAX(-1.0f, MIN(1.0f, sun_norm_z))); // [-π/2, π/2]
    float sun_altitude_deg = sun_altitude * 180.0f / M_PI;
    float sun_zenith = M_PI_2 - sun_altitude; // [0, π]
    float sun_zenith_deg = 90.0f - sun_altitude_deg;
    float sun_air_mass = 0.0f;
    // Kasten-Young, Ref. https://kexue.fm/archives/396
    if (sun_altitude_deg >= 0.0f) {
        sun_air_mass = 1.0f / (cosf(sun_zenith) + 0.50572f * powf(96.07995f - sun_zenith_deg, -1.6364f));
    }
    else {
        sun_air_mass = 40.0f;
    }


    // 观察者视线的仰角、天顶角、大气光学质量
    float view_zenith = acosf(MAX(0.0f, MIN(1.0f, ray_norm_z)));
    float view_zenith_deg = view_zenith * 180.0f / M_PI;
    float view_altitude_deg = 90.0f - view_zenith_deg;
    float view_air_mass = 0.0f;
    // Kasten-Young
    if (view_altitude_deg >= 0.0f) {
        view_air_mass = 1.0f / (cosf(view_zenith) + 0.50572f * powf(96.07995f - view_zenith_deg, -1.6364f));
    }
    else {
        view_air_mass = 40.0f;
    }


    // 观察方向与太阳方向夹角余弦
    float cos_theta = ray_norm_x * sun_norm_x + ray_norm_y * sun_norm_y + ray_norm_z * sun_norm_z;


    // 米氏散射相函数
    float mie_phase = powf(1.0f + MIE_G * MIE_G - 2.0f * MIE_G * cos_theta, -1.5f);


    // 瑞利散射相函数
    float rayleigh_phase = (1.0f + cos_theta * cos_theta) * 0.75f;


    // 计算视线方向的大气密度系数：直觉上来看，密度越大，对散射的贡献越大
    float rz = MAX(0.01, ray_norm_z); // 避免除零
    float density_factor = expf(-rz / ATMOSPHERE_HEIGHT);


    // 瑞利散射系数：分波长（RGB通道）计算
    // rayleigh_beta_at_wavelength[i] = RAYLEIGH_BETA * Math.pow(rayleigh_ref_wavelength / RAYLEIGH_WAVELENGTH_FACTORS[i], 4);
    float rayleigh_ref_wavelength = RAYLEIGH_WAVELENGTH_FACTORS[1]; // G分量作为参考波长
    float wl_0 = rayleigh_ref_wavelength / RAYLEIGH_WAVELENGTH_FACTORS[0]; // R
    float wl_1 = rayleigh_ref_wavelength / RAYLEIGH_WAVELENGTH_FACTORS[1]; // G
    float wl_2 = rayleigh_ref_wavelength / RAYLEIGH_WAVELENGTH_FACTORS[2]; // B

    float rayleigh_beta_0 = RAYLEIGH_BETA * wl_0 * wl_0 * wl_0 * wl_0; // R
    float rayleigh_beta_1 = RAYLEIGH_BETA * wl_1 * wl_1 * wl_1 * wl_1; // G
    float rayleigh_beta_2 = RAYLEIGH_BETA * wl_2 * wl_2 * wl_2 * wl_2; // B


    // 米氏散射系数：地平线附近，气溶胶浓度剧增（用viewAirMass模拟），米氏散射贡献显著上升
    float mie_beta = MIN(MIE_BETA_MAX, MIE_BETA_BASE * view_air_mass);


    // 计算每个通道的散射强度
    
    float mie_contrib = mie_beta * mie_phase;

    float rayleigh_contrib_0 = rayleigh_beta_0 * rayleigh_phase;
    float rayleigh_contrib_1 = rayleigh_beta_1 * rayleigh_phase;
    float rayleigh_contrib_2 = rayleigh_beta_2 * rayleigh_phase;

    float attn_scale = (sun_altitude_deg >= 0) ? (expf(-powf((sun_altitude_deg / 20.0f), 4.0f)) + 0.01f) : (1.0f);

    float attn_0 = expf(-(rayleigh_beta_0 + mie_beta) * view_air_mass * attn_scale);
    float attn_1 = expf(-(rayleigh_beta_1 + mie_beta) * view_air_mass * attn_scale);
    float attn_2 = expf(-(rayleigh_beta_2 + mie_beta) * view_air_mass * attn_scale);

    float ozone_transmittance_0 = expf(-OZONE_ABSORPTION[0] * sun_air_mass * 0.8);
    float ozone_transmittance_1 = expf(-OZONE_ABSORPTION[1] * sun_air_mass * 0.8);
    float ozone_transmittance_2 = expf(-OZONE_ABSORPTION[2] * sun_air_mass * 0.8);

    float scattered_0 = (rayleigh_contrib_0 + mie_contrib) * attn_0 * ozone_transmittance_0 * density_factor;
    float scattered_1 = (rayleigh_contrib_1 + mie_contrib) * attn_1 * ozone_transmittance_1 * density_factor;
    float scattered_2 = (rayleigh_contrib_2 + mie_contrib) * attn_2 * ozone_transmittance_2 * density_factor;

    // 太阳落到地平线以下时，进一步衰减散射光
    float night_attn = (sun_altitude_deg >= 0) ? (1.0f) : MAX(0.0f, expf(0.016f * sun_altitude_deg));
    scattered_0 *= night_attn;
    scattered_1 *= night_attn;
    scattered_2 *= night_attn;

    // 全局增益、限幅、输出
    const float global_gain = 2.0;
    *red   = MIN(1.0f, scattered_0 * global_gain);
    *green = MIN(1.0f, scattered_1 * global_gain);
    *blue  = MIN(1.0f, scattered_2 * global_gain);
}

// ===============================================================================
// 渲染整个天空
// ===============================================================================

void render_sky(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float sky_radius, float center_x, float center_y,
    int32_t year, int32_t month, int32_t day, int32_t hour, int32_t minute, int32_t second,
    double timezone, double longitude, double latitude
) {

    if (fb_width < (int32_t)sky_radius * 2 || fb_height < (int32_t)sky_radius * 2 ||
        center_x < (int32_t)sky_radius || (fb_width - center_x) < (int32_t)sky_radius ||
        center_y < (int32_t)sky_radius || (fb_height - center_y) < (int32_t)sky_radius
    ) {
        return;
    }

    float diameter = sky_radius * 2;

    // 计算太阳位置
    double sun_azi = 0.0;
    double sun_alt = 0.0;
    where_is_the_sun(year, month, day, hour, minute, second, timezone, longitude, latitude, &sun_azi, &sun_alt);

    float sun_x = 0.0f;
    float sun_y = 0.0f;
    float sun_z = 0.0f;
    horizontal_to_xyz(sun_azi, sun_alt, sky_radius, &sun_x, &sun_y, &sun_z);

    float sun_proj_x = 0.0f;
    float sun_proj_y = 0.0f;
    horizontal_to_screen_xy(sun_azi, sun_alt, sky_radius, center_x, center_y, &sun_proj_x, &sun_proj_y);

    // 绘制太阳
    render_sun(
        frame_buffer, fb_width, fb_height,
        sky_radius, center_x, center_y,
        sun_proj_x, sun_proj_y, sun_alt);


    // 计算月球位置并绘制
    render_moon(
        frame_buffer, fb_width, fb_height,
        sky_radius, center_x, center_y,
        year, month, day, hour, minute, second, timezone, longitude, latitude);


    // 天空绘制范围的屏幕坐标
    int32_t y1 = (int32_t)floorf(center_y - sky_radius);
    int32_t y2 = (int32_t)floorf(center_y + sky_radius);
    int32_t x1 = (int32_t)floorf(center_x - sky_radius);
    int32_t x2 = (int32_t)floorf(center_x + sky_radius);

    // 大气散射
    if (enable_atmospheric_scattering) {
        for (int32_t y = y1; y < y2; y+=2) { // NOTE 两倍降采样
            for (int32_t x = x1; x < x2; x+=2) { // NOTE 两倍降采样
                // 观察者到该像素的方向向量（从屏幕坐标系转回地平天球的笛卡尔坐标系）
                float ray_x = 0.0f;
                float ray_y = 0.0f;
                float ray_z = 0.0f;
                int32_t on_sphere = screen_xy_to_xyz((float)x, (float)y, sky_radius, center_x, center_y, &ray_x, &ray_y, &ray_z);

                float red = 0.0f;
                float green = 0.0f;
                float blue = 0.0f;
                if (on_sphere > 0) {
                    calculate_scattered_pixel(ray_x, ray_y, ray_z, sun_x, sun_y, sun_z, &red, &green, &blue);
                }

                add_pixel(frame_buffer, fb_width, fb_height, (x+0), (y+0), (uint8_t)(red * 255.0f), (uint8_t)(green * 255.0f), (uint8_t)(blue  * 255.0f));
                add_pixel(frame_buffer, fb_width, fb_height, (x+0), (y+1), (uint8_t)(red * 255.0f), (uint8_t)(green * 255.0f), (uint8_t)(blue  * 255.0f));
                add_pixel(frame_buffer, fb_width, fb_height, (x+1), (y+0), (uint8_t)(red * 255.0f), (uint8_t)(green * 255.0f), (uint8_t)(blue  * 255.0f));
                add_pixel(frame_buffer, fb_width, fb_height, (x+1), (y+1), (uint8_t)(red * 255.0f), (uint8_t)(green * 255.0f), (uint8_t)(blue  * 255.0f));
            }
        }
    }

    // 绘制恒星等其他天体
    float mag_offset = -2.0f;
    for (int32_t i = 0; i < STARS_NUM; i++) {
        float *star_item = STARS[i];
        double alt = 0.0;
        double azi = 0.0;
        equatorial_to_horizontal(
            ra_hms_to_deg(star_item[0], star_item[1], star_item[2]),
            dec_dms_to_decimal(star_item[3], star_item[4], star_item[5]),
            year, month, day, hour, minute, second, timezone, longitude, latitude, &azi, &alt);
        float mag = 0.5f + mag_offset + star_item[6];

        float sx = 0.0f;
        float sy = 0.0f;
        horizontal_to_screen_xy(azi, alt, sky_radius, center_x, center_y, &sx, &sy);

        draw_star(frame_buffer, fb_width, fb_height, sky_radius, center_x, center_y, sx, sy, mag);

        fb_draw_textline(frame_buffer, fb_width, fb_height, STAR_NAME[i], sx+3, sy+3, 255, 255, 255);

    }

    // 绘制星芒
    if (enable_star_burst && sun_alt > 0) {
        star_burst_filter(frame_buffer, fb_width, fb_height, sun_proj_x, sun_proj_y);
    }

    // 绘制地景（天空投影圆盘之外的部分）
    draw_horizon(frame_buffer, fb_width, fb_height, sky_radius, center_x, center_y);

    // 绘制地平坐标网格
    if (enable_horizontal_coord) {
        draw_circle_outline(frame_buffer, fb_width, fb_height, center_x, center_y, (sky_radius-1.0f), 2.0f, 128, 128, 128);
        draw_circle_outline(frame_buffer, fb_width, fb_height, center_x, center_y, (sky_radius/3.0f), 1.0f, 16, 16, 16);
        draw_circle_outline(frame_buffer, fb_width, fb_height, center_x, center_y, (sky_radius/3.0f*2.0f), 1.0f, 16, 16, 16);
        draw_line(frame_buffer, fb_width, fb_height, center_x, y1, center_x, y2, 1, 16, 16, 16);
        draw_line(frame_buffer, fb_width, fb_height, x1, center_y, x2, center_y, 1, 16, 16, 16);
    }

    // 绘制赤道坐标网格
    if (enable_equatorial_coord) {
        // 绘制赤道天球子午圈
        for (int32_t i = 0; i < 24; i += 2) {
            int32_t line_width = (i == 0 || i == 12) ? 3 : 2;
            draw_celestial_circle(
                frame_buffer, fb_width, fb_height,
                sky_radius, center_x, center_y,
                1, (float)i, 0.0f,
                line_width, 8, 16, 32,
                year, month, day, hour, minute, second, timezone, longitude, latitude
            );
        }
        // 绘制赤道天球等纬度圈
        for (int32_t i = -90; i < 90; i += 10) {
            int32_t line_width = (i == 0) ? 3 : 2;
            draw_celestial_circle(
                frame_buffer, fb_width, fb_height,
                sky_radius, center_x, center_y,
                0, 0.0f, (float)i,
                line_width, 8, 16, 32,
                year, month, day, hour, minute, second, timezone, longitude, latitude
            );
        }
    }

    // 绘制当前时间
    wchar_t current_time_str[30];
    swprintf(current_time_str, 20, L"%d-%02d-%02d %02d:%02d:%02d", year, month, day, hour, minute, second);
    fb_draw_textline(frame_buffer, fb_width, fb_height, current_time_str, 1, 1, 255, 255, 255);

}
