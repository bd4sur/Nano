#include <stdlib.h>
#include <stdint.h>
#include <stdio.h>
#include <math.h>

#include "utils.h"
#include "glyph.h"

#include "celestial.h"
#include "ephemeris.h"

#ifndef M_PI
    #define M_PI (3.14159265358979323846)
#endif

#ifndef M_PI_2
    # define M_PI_2 (1.57079632679489661923)
#endif

#define MIN(x,y) (((x) < (y)) ? (x) : (y))
#define MAX(x,y) (((x) > (y)) ? (x) : (y))

static int32_t USE_FISHEYE_PROJECTION = 1; // 是否使用鱼眼投影（否则使用XY投影）

// 大气光学参数
static float MIE_G = 0.9f;
static float RAYLEIGH_BETA = 0.3f;
static float MIE_BETA_BASE = 0.001f;
static float MIE_BETA_MAX = 0.1f;
static float ATMOSPHERE_HEIGHT = 8.5f;

// 波长相关的瑞利散射系数 (近似)
static float RAYLEIGH_WAVELENGTH_FACTORS[3] = { 680, 550, 450 };

// 臭氧吸收系数
static float OZONE_ABSORPTION[3] = { 0.005,  0.040,  0.025 };

// 大气光学质量查找表：index(deg)=[0,90]
// AIR_MASS_LUT[i] = 1.0 / (Math.cos(i/180*Math.PI) + 0.50572 * Math.pow(96.07995 - i, -1.6364));
static const float AIR_MASS_LUT[91] = {0.9997119918558381f, 0.9998592586926793f, 1.0003110890402365f, 1.0010681642273038f, 1.0021316319418698f, 1.0035031104733083f, 1.0051846947247018f, 1.0071789640369042f, 1.0094889918788565f, 1.0121183574721748f, 1.0150711594323112f, 1.0183520315238068f, 1.021966160643514f, 1.02591930716334f, 1.03021782778332f, 1.034868701066905f, 1.039879555853524f, 1.045258702769114f, 1.0510151690837524f, 1.0571587371972049f, 1.0636999870686308f, 1.0706503429463945f, 1.0780221247986177f, 1.085828604895485f, 1.0940840700512897f, 1.1028038900988062f, 1.1120045932419853f, 1.121703949016588f, 1.1319210596838862f, 1.1426764609918518f, 1.1539922333636758f, 1.1658921247176817f, 1.1784016862889535f, 1.1915484230151434f, 1.2053619602715009f, 1.2198742289986713f, 1.235119671567844f, 1.2511354710792817f, 1.2679618072017325f, 1.2856421421433408f, 1.304223540913535f, 1.3237570307072422f, 1.3442980050388187f, 1.3659066791992502f, 1.3886486047386126f, 1.4125952520262743f, 1.4378246715634218f, 1.4644222466782195f, 1.4924815526010962f, 1.5221053397946254f, 1.5534066629239196f, 1.5865101811584308f, 1.6215536607984282f, 1.6586897177821054f, 1.698087845793255f, 1.7399367858997083f, 1.7844473064938864f, 1.8318554785517882f, 1.8824265519054382f, 1.936459564717931f, 1.9942928525292494f, 2.0563106676544924f, 2.122951177872814f, 2.194716190118216f, 2.2721830471079465f, 2.3560192822092514f, 2.4470008042366937f, 2.54603463942889f, 2.6541876121514743f, 2.7727228429386073f, 2.9031466488030997f, 3.04726944828179f, 3.2072857614398935f, 3.385880605461222f, 3.5863729280725876f, 3.812911869220776f, 4.07074973811966f, 4.366628617623185f, 4.709338986746881f, 5.110545154023385f, 5.5860358798512f, 6.157673414942184f, 6.856529464259364f, 7.728117030932225f, 8.841485995032256f, 10.30579132793028f, 12.30208325139153f, 15.14773544253034f, 19.433245107572002f, 26.31055506838526f, 37.91960837783621f};

// 散射光随太阳高度变化的衰减因子：sun_altitude_deg=[-90,90]
// ATTN_SCALE_LUT[sun_altitude_deg+90] = (sun_altitude_deg >= 0) ? (expf(-powf((sun_altitude_deg / 20.0f), 4.0f)) + 0.01f) : (1.0f);
static const float ATTN_SCALE_LUT[181] = {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1.01,1.009993750019531,1.0099000049998332,1.0094938781229095,1.0084012793176063,1.0061013694701175,1.0019327166055711,0.9951057826726806,0.9847249016017939,0.9698231310344834,0.9494130628134758,0.9225556126616087,0.8884467393499313,0.8465188286183754,0.796549202213455,0.7387633299194912,0.6739157633354735,0.6033289868052961,0.5288709904654524,0.45285793449343037,0.37787944117144234,0.3065598428646592,0.24128605528432856,0.18394671713945743,0.1357323295944279,0.0970383676562235,0.06749254452616452,0.04609841754220801,0.031459239080080414,0.02202814149649049,0.016329715427485746,0.013113504775028439,0.011424976438192463,0.010603957787932912,0.010235900606629577,0.010084487560285047,0.010027602616196642,0.0100081825538457,0.010002188925004884,0.010000525452390085,0.010000112535174719,0.010000021375803119,0.01000000357929494,0.01000000052506122,0.010000000067048827,0.0100000000074047,0.010000000000702522,0.01000000000005687,0.010000000000003902,0.010000000000000226,0.01000000000000001,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01};

// 夜间散射光的衰减因子：sun_altitude_deg=[-90,90]
// NIGHT_ATTN_LUT[sun_altitude_deg+90] = (sun_altitude_deg >= 0) ? (1.0f) : MAX(0.0f, expf(0.016f * sun_altitude_deg));
static const float NIGHT_ATTN_LUT[181] = {0.23692775868212176,0.24074909196587688,0.2446320583319975,0.24857765184107966,0.2525868825866102,0.2566607769535559,0.26080037788112365,0.2650067451297589,0.26928095555244996,0.27362410337040804,0.27803730045319414,0.2825216766033636,0.28707837984570167,0.2917085767211244,0.2964134525853191,0.3011942119122021,0.3060520786022707,0.3109882962959281,0.31600412869186245,0.32110085987056064,0.32627979462303947,0.3315422587848797,0.33688959957564707,0.34232318594378797,0.34784440891708746,0.35345468195878016,0.3591554413294046,0.3649481464544937,0.37083428029819565,0.37681534974292086,0.38289288597511206,0.38906844487723635,0.3953436074260998,0.401719980097586,0.4081991952779227,0.4147829116815814,0.4214728147759176,0.4282706172126597,0.43517805926635666,0.44219690927989863,0.44932896411722156,0.4565760496233147,0.46394002109164667,0.4714227637391309,0.47902619318875106,0.4867522559599717,0.494602929967057,0.5025802250254283,0.5106861833661879,0.5189228801589404,0.5272924240430485,0.535796957667456,0.5444386582392171,0.5532197380808739,0.5621424451968224,0.5712090638488149,0.5804219151407424,0.5897833576128504,0.5992957878455384,0.6089616410728969,0.6187833918061408,0.6287635544670984,0.6389046840319161,0.6492093766851474,0.659680270484389,0.6703200460356393,0.6811314271795471,0.6921171816887304,0.7032801219763409,0.7146231058160573,0.7261490370736909,0.7378608664505912,0.7497615922390413,0.7618542610898376,0.7741419687922484,0.7866278610665534,0.7993151343693651,0.812207036711939,0.8253068684916824,0.838617983337074,0.8521437889662113,0.865887748059205,0.8798533791446438,0.8940442575003572,0.9084640160687062,0.9231163463866358,0.9380049995307295,0.9531337870775047,0.9685065820791976,0.9841273200552851,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1};


// 行星相关常量（用于渲染）
//                                        -     1Mer  2Ven  3Ear  4Mars 5Jup  6Sat  7Ura  8Nep
static const float   PLANET_RADIUS[9]   = {0.0f, 1.0f, 2.0f, 0.0f, 1.0f, 3.0f, 2.0f, 1.0f, 1.0f};
static const uint8_t PLANET_COLOR_R[9]  = {0,    192,  255,  0,    255,  255,  192,  0,    192 };
static const uint8_t PLANET_COLOR_G[9]  = {0,    192,  255,  0,    64,   192,  255,  255,  128 };
static const uint8_t PLANET_COLOR_B[9]  = {0,    192,  64,   0,    0,    128,  128,  255,  255 };
static const wchar_t PLANET_NAME[9][10] = {L"", L"水星", L"金星", L"地球", L"火星", L"木星", L"土星", L"天王星", L"海王星"};

// 星表
#define STARS_NUM (21)
static const float STARS[STARS_NUM][7] = {
//(RA)h     m      s    (Dec)d       m      s        Mag
    {2.0f,  32.0f, 9.3f,      89.0f, 16.0f, 10.8f,   2.09f}, // 勾陈一（北极星）
    {11.0f, 3.0f,  45.2f,     61.0f, 44.0f, 47.5f,   1.95f}, // 天枢
    {11.0f, 1.0f,  52.5f,     56.0f, 22.0f, 43.0f,   2.34f}, // 天璇
    {11.0f, 53.0f, 51.4f,     53.0f, 41.0f, 24.5f,   2.42f}, // 天玑
    {12.0f, 15.0f, 27.0f,     57.0f, 1.0f,  39.6f,   3.33f}, // 天权
    {12.0f, 54.0f, 2.8f,      55.0f, 57.0f, 16.2f,   1.75f}, // 玉衡
    {13.0f, 23.0f, 56.3f,     54.0f, 55.0f, 11.3f,   2.25f}, // 开阳
    {13.0f, 47.0f, 32.2f,     49.0f, 18.0f, 28.7f,   1.80f}, // 摇光

    { 6.0f, 45.0f, 91.0f,    -16.0f, 43.0f, 35.0f,  -1.46f}, // 天狼
    {14.0f, 15.0f, 37.6f,     19.0f, 9.0f,  53.3f,  -0.05f}, // 大角
    {18.0f, 36.0f, 55.2f,     38.0f, 46.0f, 59.8f,   0.03f}, // 织女一
    {19.0f, 50.0f, 46.6f,      8.0f, 52.0f, 10.9f,   0.76f}, // 河鼓二
    { 0.0f, 42.0f, 43.6f,     41.0f, 16.0f, 15.7f,   3.40f}, // M31
    { 5.0f, 55.0f, 11.4f,      7.0f, 24.0f, 22.2f,   0.42f}, // 参宿四
    { 5.0f, 25.0f,  8.8f,      6.0f, 20.0f, 55.1f,   1.64f}, // 参宿五
    { 5.0f, 40.0f, 46.6f,     -1.0f, 56.0f, 38.7f,   1.77f}, // 参宿一
    { 5.0f, 36.0f, 13.8f,     -1.0f, 12.0f, 12.3f,   1.69f}, // 参宿二
    { 5.0f, 32.0f,  1.4f,      0.0f,-18.0f,  1.9f,   2.41f}, // 参宿三
    { 5.0f, 47.0f, 46.5f,     -9.0f, 40.0f, 17.7f,   2.06f}, // 参宿六
    { 5.0f, 14.0f, 33.2f,     -8.0f, 12.0f, 13.0f,   0.13f}, // 参宿七
    { 5.0f, 35.0f, 27.0f,     -5.0f, 54.0f, 42.2f,   2.77f}  // 伐三
};

static const wchar_t STAR_NAME[STARS_NUM][10] = {
    L"北极星", L"天枢", L"", L"", L"", L"", L"开阳", L"",
    L"天狼", L"大角", L"织女一", L"河鼓二", L"M31",
    L"参宿四", L"", L"", L"", L"", L"", L"参宿七", L""
};

// 月球表面纹理
static const uint32_t moon_texture_width = 64;
static const uint32_t moon_texture_height = 64;
static const uint8_t moon_texture_rgba[12288] = {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,3,3,3,3,3,3,0,0,0,0,0,0,7,7,7,3,3,3,6,6,6,0,0,0,0,0,0,1,1,1,8,8,8,7,7,7,2,2,2,0,0,0,1,1,1,0,0,0,0,0,0,4,4,4,11,11,11,14,14,14,17,17,17,19,19,19,11,11,11,8,8,8,3,3,3,0,0,0,0,0,0,0,0,0,2,2,2,6,6,6,10,10,10,2,2,2,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,2,2,2,0,0,0,2,2,2,3,3,3,2,2,2,1,1,1,1,1,1,1,1,1,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,0,0,0,3,3,3,6,6,6,3,3,3,4,4,4,0,0,0,0,0,0,0,0,0,1,1,1,6,6,6,4,4,4,0,0,0,0,0,0,3,3,3,12,12,12,38,38,38,63,63,63,94,94,94,117,117,117,128,128,128,131,131,131,130,130,130,128,128,128,123,123,123,117,117,117,108,108,108,95,95,95,75,75,75,48,48,48,20,20,20,1,1,1,0,0,0,0,0,0,6,6,6,6,6,6,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,4,4,4,4,4,4,3,3,3,1,1,1,1,1,1,1,1,1,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,2,2,2,5,5,5,2,2,2,0,0,0,0,0,0,4,4,4,11,11,11,2,2,2,6,6,6,4,4,4,0,0,0,4,4,4,40,40,40,98,98,98,143,143,143,157,157,157,182,182,182,203,203,203,206,206,206,204,204,204,207,207,207,209,209,209,208,208,208,219,219,219,206,206,206,187,187,187,172,172,172,159,159,159,143,143,143,125,125,125,111,111,111,80,80,80,51,51,51,17,17,17,1,1,1,4,4,4,10,10,10,6,6,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,3,3,3,4,4,4,5,5,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,8,8,10,10,10,4,4,4,18,18,18,69,69,69,142,142,142,192,192,192,196,196,196,179,179,179,188,188,188,200,200,200,203,203,203,196,196,196,199,199,199,216,216,216,227,227,227,227,227,227,200,200,200,187,187,187,170,170,170,158,158,158,157,157,157,161,161,161,167,167,167,170,170,170,166,166,166,164,164,164,142,142,142,94,94,94,39,39,39,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,4,4,4,5,5,5,3,3,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,6,4,4,4,0,0,0,0,0,0,15,15,15,5,5,5,0,0,0,0,0,0,23,23,23,85,85,85,157,157,157,194,194,194,196,196,196,190,190,190,189,189,189,190,190,190,170,170,170,175,175,175,178,178,178,183,183,183,198,198,198,215,215,215,215,215,215,204,204,204,186,186,186,186,186,186,182,182,182,173,173,173,163,163,163,157,157,157,156,156,156,157,157,157,164,164,164,190,190,190,207,207,207,189,189,189,142,142,142,86,86,86,37,37,37,6,6,6,7,7,7,5,5,5,3,3,3,3,3,3,4,4,4,3,3,3,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,9,9,9,0,0,0,0,0,0,0,0,0,0,0,0,18,18,18,65,65,65,161,161,161,175,175,175,185,185,185,184,184,184,181,181,181,174,174,174,158,158,158,139,139,139,163,163,163,156,156,156,153,153,153,160,160,160,173,173,173,181,181,181,177,177,177,171,171,171,160,160,160,165,165,165,167,167,167,162,162,162,152,152,152,145,145,145,146,146,146,149,149,149,174,174,174,176,176,176,179,179,179,186,186,186,189,189,189,167,167,167,110,110,110,56,56,56,10,10,10,4,4,4,0,0,0,0,0,0,0,0,0,1,1,1,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,9,9,9,1,1,1,0,0,0,13,13,13,31,31,31,80,80,80,158,158,158,173,173,173,181,181,181,178,178,178,160,160,160,146,146,146,139,139,139,129,129,129,116,116,116,113,113,113,104,104,104,102,102,102,111,111,111,116,116,116,118,118,118,131,131,131,148,148,148,152,152,152,153,153,153,152,152,152,150,150,150,150,150,150,156,156,156,166,166,166,174,174,174,170,170,170,191,191,191,201,201,201,185,185,185,161,161,161,144,144,144,129,129,129,116,116,116,47,47,47,32,32,32,12,12,12,0,0,0,0,0,0,0,0,0,4,4,4,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,4,5,5,5,0,0,0,9,9,9,72,72,72,100,100,100,119,119,119,164,164,164,153,153,153,141,141,141,119,119,119,106,106,106,117,117,117,135,135,135,131,131,131,113,113,113,101,101,101,98,98,98,106,106,106,113,113,113,99,99,99,82,82,82,93,93,93,120,120,120,125,125,125,123,123,123,120,120,120,119,119,119,118,118,118,117,117,117,116,116,116,115,115,115,111,111,111,152,152,152,191,191,191,201,201,201,193,193,193,178,178,178,156,156,156,136,136,136,111,111,111,85,85,85,48,48,48,18,18,18,2,2,2,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,7,7,7,0,0,0,0,0,0,2,2,2,1,1,1,0,0,0,1,1,1,12,12,12,8,8,8,0,0,0,27,27,27,84,84,84,109,109,109,108,108,108,108,108,108,109,109,109,99,99,99,118,118,118,127,127,127,128,128,128,144,144,144,163,163,163,148,148,148,115,115,115,144,144,144,138,138,138,134,134,134,138,138,138,144,144,144,140,140,140,121,121,121,102,102,102,111,111,111,122,122,122,121,121,121,105,105,105,96,96,96,97,97,97,90,90,90,76,76,76,92,92,92,106,106,106,128,128,128,164,164,164,185,185,185,163,163,163,149,149,149,172,172,172,155,155,155,122,122,122,105,105,105,74,74,74,18,18,18,0,0,0,9,9,9,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,5,5,5,2,2,2,0,0,0,3,3,3,1,1,1,0,0,0,0,0,0,2,2,2,3,3,3,0,0,0,0,0,0,1,1,1,25,25,25,69,69,69,98,98,98,101,101,101,98,98,98,84,84,84,59,59,59,111,111,111,157,157,157,186,186,186,170,170,170,149,149,149,147,147,147,144,144,144,132,132,132,136,136,136,142,142,142,135,135,135,125,125,125,138,138,138,160,160,160,155,155,155,131,131,131,122,122,122,109,109,109,111,111,111,126,126,126,125,125,125,106,106,106,95,95,95,100,100,100,93,93,93,100,100,100,139,139,139,172,172,172,170,170,170,167,167,167,165,165,165,150,150,150,148,148,148,144,144,144,137,137,137,125,125,125,88,88,88,30,30,30,0,0,0,1,1,1,1,1,1,3,3,3,2,2,2,0,0,0,0,0,0,2,2,2,1,1,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,2,2,2,6,6,6,1,1,1,0,0,0,21,21,21,46,46,46,79,79,79,91,91,91,89,89,89,106,106,106,125,125,125,124,124,124,150,150,150,166,166,166,170,170,170,154,154,154,140,140,140,133,133,133,120,120,120,103,103,103,96,96,96,119,119,119,118,118,118,102,102,102,124,124,124,171,171,171,182,182,182,158,158,158,143,143,143,121,121,121,119,119,119,141,141,141,150,150,150,135,135,135,125,125,125,130,130,130,121,121,121,117,117,117,156,156,156,174,174,174,151,151,151,164,164,164,174,174,174,132,132,132,123,123,123,150,150,150,144,144,144,136,136,136,135,135,135,82,82,82,14,14,14,0,0,0,1,1,1,2,2,2,3,3,3,3,3,3,1,1,1,0,0,0,0,0,0,2,2,2,0,0,0,0,0,0,1,1,1,2,2,2,0,0,0,0,0,0,7,7,7,18,18,18,90,90,90,77,77,77,79,79,79,82,82,82,74,74,74,91,91,91,138,138,138,176,176,176,176,176,176,135,135,135,99,99,99,95,95,95,105,105,105,100,100,100,83,83,83,70,70,70,69,69,69,95,95,95,102,102,102,90,90,90,106,106,106,150,150,150,170,170,170,160,160,160,146,146,146,137,137,137,127,127,127,128,128,128,140,140,140,148,148,148,139,139,139,124,124,124,120,120,120,116,116,116,141,141,141,152,152,152,142,142,142,165,165,165,184,184,184,163,163,163,114,114,114,145,145,145,134,134,134,113,113,113,135,135,135,140,140,140,83,83,83,21,21,21,0,0,0,0,0,0,0,0,0,4,4,4,3,3,3,0,0,0,0,0,0,5,5,5,1,1,1,0,0,0,2,2,2,6,6,6,0,0,0,0,0,0,22,22,22,62,62,62,90,90,90,76,76,76,75,75,75,77,77,77,74,74,74,94,94,94,131,131,131,154,154,154,156,156,156,102,102,102,65,65,65,69,69,69,70,70,70,55,55,55,58,58,58,81,81,81,81,81,81,93,93,93,96,96,96,89,89,89,92,92,92,114,114,114,140,140,140,154,154,154,162,162,162,159,159,159,150,150,150,146,146,146,154,154,154,160,160,160,143,143,143,119,119,119,128,128,128,134,134,134,134,134,134,133,133,133,140,140,140,144,144,144,151,151,151,164,164,164,138,138,138,142,142,142,142,142,142,126,126,126,129,129,129,162,162,162,146,146,146,81,81,81,14,14,14,0,0,0,0,0,0,3,3,3,5,5,5,0,0,0,0,0,0,5,5,5,1,1,1,0,0,0,2,2,2,4,4,4,0,0,0,5,5,5,44,44,44,89,89,89,56,56,56,68,68,68,75,75,75,70,70,70,84,84,84,129,129,129,151,151,151,132,132,132,120,120,120,79,79,79,55,55,55,64,64,64,63,63,63,47,47,47,57,57,57,85,85,85,88,88,88,82,82,82,81,81,81,84,84,84,86,86,86,97,97,97,127,127,127,158,158,158,171,171,171,165,165,165,167,167,167,177,177,177,178,178,178,160,160,160,135,135,135,117,117,117,129,129,129,147,147,147,141,141,141,132,132,132,139,139,139,132,132,132,130,130,130,153,153,153,156,156,156,138,138,138,155,155,155,161,161,161,135,135,135,136,136,136,146,146,146,124,124,124,53,53,53,19,19,19,0,0,0,1,1,1,6,6,6,0,0,0,0,0,0,4,4,4,0,0,0,2,2,2,1,1,1,0,0,0,6,6,6,36,36,36,68,68,68,85,85,85,77,77,77,86,86,86,88,88,88,78,78,78,91,91,91,131,131,131,137,137,137,103,103,103,89,89,89,70,70,70,54,54,54,54,54,54,61,61,61,64,64,64,66,66,66,70,70,70,81,81,81,72,72,72,73,73,73,85,85,85,97,97,97,107,107,107,126,126,126,146,146,146,146,146,146,156,156,156,163,163,163,161,161,161,156,156,156,145,145,145,123,123,123,101,101,101,92,92,92,113,113,113,128,128,128,121,121,121,119,119,119,141,141,141,165,165,165,172,172,172,155,155,155,147,147,147,160,160,160,174,174,174,157,157,157,131,131,131,124,124,124,129,129,129,107,107,107,50,50,50,3,3,3,0,0,0,5,5,5,0,0,0,0,0,0,3,3,3,0,0,0,6,6,6,0,0,0,0,0,0,12,12,12,63,63,63,83,83,83,69,69,69,77,77,77,70,70,70,76,76,76,90,90,90,103,103,103,118,118,118,113,113,113,89,89,89,63,63,63,75,75,75,71,71,71,51,51,51,48,48,48,65,65,64,74,74,74,69,69,69,85,85,85,81,81,80,85,85,85,100,100,100,116,116,116,122,122,122,120,120,120,118,118,118,139,139,139,176,176,175,180,180,180,146,146,146,138,138,138,159,159,159,147,147,147,108,108,108,96,96,96,105,105,105,128,128,127,107,107,107,75,75,75,119,119,119,166,166,166,146,146,146,155,155,155,172,172,172,165,165,165,168,168,168,186,186,186,163,163,163,126,126,126,125,125,125,147,147,147,75,75,75,10,10,10,0,0,0,4,4,4,0,0,0,0,0,0,3,3,3,2,1,0,1,0,0,1,0,0,1,0,0,51,50,49,94,93,92,73,72,71,66,65,64,74,73,72,76,75,74,82,81,80,85,84,83,81,80,79,104,103,102,65,64,63,82,81,80,85,84,83,78,77,76,68,67,66,61,60,59,60,59,58,65,64,63,72,71,70,77,76,75,93,92,91,73,72,71,79,78,77,103,102,101,112,111,110,113,112,111,111,110,109,104,103,102,128,127,126,183,182,181,131,130,129,93,92,91,61,60,59,85,84,83,114,113,112,133,132,131,104,103,102,87,86,85,91,90,89,117,116,115,79,78,77,108,107,106,139,138,137,155,154,153,175,175,174,178,178,177,161,161,160,167,167,166,189,189,188,162,162,161,132,132,131,147,147,146,149,149,148,128,128,127,69,69,68,9,9,8,0,0,0,0,0,0,2,2,1,2,2,1,6,5,3,3,2,0,8,7,5,8,7,5,92,91,89,83,82,80,70,69,67,67,66,64,90,89,87,97,96,94,102,101,99,83,82,80,88,87,85,88,87,85,77,76,74,83,82,80,79,78,76,72,71,69,64,63,61,61,60,58,63,62,60,68,67,65,70,69,67,71,70,68,71,70,68,64,63,61,72,71,69,89,88,86,104,103,101,121,120,118,123,122,120,107,106,104,129,128,126,155,154,152,97,96,94,74,73,71,63,62,60,83,82,80,92,91,89,91,90,88,82,81,79,76,75,73,103,102,100,145,144,142,107,106,104,117,116,114,146,145,143,174,173,171,181,181,179,179,179,177,164,164,162,168,168,166,184,184,182,167,167,165,142,142,140,145,145,143,150,150,148,146,146,144,107,107,105,40,40,38,0,0,0,0,0,0,6,6,4,0,0,0,1,0,0,2,1,0,3,2,0,45,44,42,115,114,112,85,84,82,66,65,63,79,78,76,80,79,77,101,100,98,107,106,104,80,79,77,98,97,95,80,79,77,99,98,96,90,89,87,78,77,75,73,72,70,68,67,65,66,65,63,68,67,65,71,70,68,70,69,67,69,68,66,83,82,80,78,77,75,80,79,77,86,85,83,103,102,100,128,127,125,125,124,122,95,94,92,119,118,116,121,120,118,73,72,70,64,63,61,64,63,61,73,72,70,70,69,67,65,64,62,81,80,78,73,72,70,107,106,104,162,161,159,150,149,147,154,153,151,171,170,168,191,190,188,184,184,182,185,185,183,183,183,181,180,180,178,175,175,173,167,167,165,158,158,156,155,155,153,149,149,147,158,158,156,148,148,146,83,83,81,9,9,7,0,0,0,9,9,7,0,0,0,1,0,0,4,3,1,4,3,1,106,105,103,97,96,94,85,84,82,57,56,54,81,80,78,83,82,80,117,116,114,107,106,104,93,92,90,103,102,100,85,84,82,105,104,102,86,85,83,79,78,76,79,78,76,78,77,75,74,73,71,71,70,68,72,71,69,75,74,72,79,78,76,79,78,76,74,73,71,83,82,80,99,98,96,119,118,116,144,143,141,148,147,145,127,126,124,108,107,105,98,97,95,75,74,72,70,69,67,65,64,62,62,61,59,66,65,63,76,75,73,76,75,73,52,51,49,64,63,61,113,112,110,145,144,142,173,172,170,181,180,178,173,172,170,181,181,179,188,188,186,198,198,196,189,189,187,167,167,165,162,162,160,167,167,165,163,163,161,149,149,147,151,151,149,164,164,162,121,121,119,32,32,30,0,0,0,6,6,4,0,0,0,7,6,4,5,4,2,44,43,41,140,139,137,76,75,73,69,68,66,62,61,59,74,73,71,129,128,126,157,156,154,116,115,113,110,109,107,92,91,89,86,85,83,86,85,83,73,72,70,74,73,71,80,79,77,83,82,80,78,77,75,71,70,68,72,71,69,84,83,81,96,95,93,89,88,86,94,93,91,118,117,115,131,130,128,118,117,115,114,113,111,130,129,127,142,141,139,114,113,111,86,85,83,78,77,75,73,72,70,69,68,66,62,61,59,71,70,68,87,86,84,75,74,72,52,51,49,44,43,41,64,63,61,124,123,121,182,181,179,199,198,196,177,176,174,179,179,177,177,177,175,179,179,177,173,173,171,162,162,160,160,160,158,155,155,153,139,139,137,149,149,147,134,134,132,156,156,154,149,149,147,66,66,64,2,2,0,0,0,0,2,2,0,11,10,8,1,0,0,95,94,92,121,120,118,77,76,74,60,59,57,84,83,81,85,84,82,153,152,150,160,159,157,112,111,109,102,101,99,74,73,71,80,79,77,71,70,68,80,79,77,69,68,66,77,76,74,83,82,80,80,79,77,74,73,71,76,75,73,90,89,87,103,102,100,100,99,97,118,117,115,152,151,149,153,152,150,108,107,105,79,78,76,101,100,98,132,131,129,129,128,126,74,73,71,69,68,66,62,61,59,73,72,70,71,70,68,74,73,71,77,76,74,72,71,69,69,68,66,61,60,58,54,53,51,115,114,112,176,175,173,208,207,205,191,190,188,179,179,177,161,161,159,144,144,142,147,147,145,161,161,159,154,154,152,124,124,122,97,97,95,134,134,132,113,113,111,139,139,137,160,160,158,99,99,97,18,18,16,0,0,0,3,3,1,5,4,2,19,18,16,122,121,119,84,83,81,72,71,69,70,69,67,78,77,75,99,98,96,126,125,123,118,117,115,104,103,101,86,85,83,77,76,74,79,78,76,77,76,74,106,105,103,81,80,78,84,83,81,86,85,83,85,84,82,82,81,79,83,82,80,88,87,85,93,92,90,72,71,69,89,88,86,123,122,120,138,137,135,126,125,123,125,124,122,143,142,140,153,152,150,123,122,120,59,58,56,63,62,60,51,50,48,68,67,65,73,72,70,74,73,71,70,69,67,55,54,52,60,59,57,63,62,60,51,50,48,106,105,103,141,140,138,165,164,162,153,152,150,173,173,171,163,163,161,141,141,139,144,144,142,160,160,158,134,134,132,92,92,90,80,80,78,91,91,89,86,86,84,118,118,116,154,154,152,121,121,119,39,39,37,0,0,0,4,4,2,10,9,7,58,57,55,128,127,125,67,66,64,53,52,50,83,82,80,43,42,40,94,93,91,98,97,95,84,83,81,110,109,107,84,83,81,97,96,94,84,83,81,87,86,84,125,124,122,98,97,95,96,95,93,94,93,91,93,92,90,92,91,89,89,88,86,83,82,80,78,77,75,73,72,70,74,73,71,92,91,89,119,118,116,151,150,148,182,181,179,180,179,177,150,149,147,104,103,101,47,46,44,66,65,63,49,48,46,60,59,57,66,65,63,75,74,72,76,75,73,61,60,58,59,58,56,66,65,63,63,62,60,119,118,116,129,128,126,132,131,129,113,112,110,164,164,162,176,176,174,163,163,161,158,158,156,158,158,156,112,112,110,74,74,72,89,89,87,48,48,46,63,63,61,102,102,100,143,143,141,129,129,127,55,55,53,2,2,0,4,4,2,4,3,1,102,101,99,104,103,101,67,66,64,48,47,45,73,72,70,68,67,65,80,79,77,80,79,77,84,83,81,100,99,97,95,94,92,72,71,69,83,82,80,101,100,98,89,88,86,86,85,83,103,102,100,92,91,89,104,103,101,89,88,86,93,92,90,76,75,73,93,92,90,95,94,92,58,57,55,66,65,63,113,112,110,148,147,145,166,165,163,157,156,154,126,125,123,90,89,87,79,78,76,58,57,55,62,61,59,68,67,65,68,67,65,77,76,74,73,72,70,61,60,58,66,65,63,64,63,61,70,69,67,103,102,100,137,136,134,129,128,126,96,95,93,129,129,127,157,157,155,188,188,186,198,198,196,172,172,170,119,119,117,78,78,76,69,69,67,60,60,58,34,34,32,83,83,81,146,146,144,136,136,134,55,55,53,0,0,0,14,14,12,9,8,6,120,119,117,105,104,102,71,70,68,57,56,54,67,66,64,64,63,61,75,74,72,79,78,76,90,89,87,116,115,113,110,109,107,75,74,72,76,75,73,101,100,98,105,104,102,131,130,128,116,115,113,79,78,76,89,88,86,95,94,92,115,114,112,97,96,94,98,97,95,111,110,108,99,98,96,112,111,109,141,140,138,152,151,149,143,142,140,126,125,123,109,108,106,97,96,94,86,85,83,86,85,83,84,83,81,72,71,69,57,56,54,55,54,52,69,68,66,60,59,57,63,62,60,58,57,55,58,57,55,78,77,75,103,102,100,101,100,98,83,82,80,74,74,72,128,128,126,167,167,165,199,199,197,211,211,209,146,146,144,71,71,69,63,63,61,82,82,80,48,48,46,84,84,82,140,140,138,136,136,134,62,62,60,0,0,0,0,0,0,32,31,29,152,151,149,103,102,100,69,68,66,64,63,61,59,58,56,63,62,60,74,73,71,72,71,69,78,77,75,108,107,105,113,112,110,85,84,82,91,90,88,131,130,128,151,150,148,140,139,137,136,135,133,121,120,118,127,126,124,123,122,120,133,132,130,120,119,117,118,117,115,111,110,108,124,123,121,138,137,135,148,147,145,143,142,140,114,113,111,92,91,89,93,92,90,94,93,91,81,80,78,92,91,89,82,81,79,101,100,98,131,130,128,103,102,100,91,90,88,74,73,71,72,71,69,67,66,64,63,62,60,68,67,65,78,77,75,82,81,79,80,79,77,48,48,46,123,123,121,157,157,155,184,184,182,214,214,212,152,152,150,73,73,71,76,76,74,67,67,65,57,57,55,102,102,100,149,149,147,147,147,145,87,87,85,15,15,13,2,2,0,72,71,69,187,186,184,100,99,97,63,62,60,70,69,67,58,57,55,66,65,63,75,74,72,90,89,87,83,82,80,103,102,100,110,109,107,87,86,84,93,92,90,135,134,132,159,158,156,137,136,134,150,149,147,163,162,160,164,163,161,144,143,141,138,137,135,134,133,131,130,129,127,94,93,91,110,109,107,109,108,106,110,109,107,115,114,112,92,91,89,71,70,68,81,80,78,72,71,69,114,113,111,159,158,156,95,94,92,83,82,80,139,138,136,118,117,115,104,103,101,64,63,61,59,58,56,56,55,53,56,55,53,55,54,52,52,51,49,53,52,50,58,57,55,51,51,49,102,102,100,126,126,124,150,150,148,192,192,190,173,173,171,109,109,107,79,79,77,48,48,46,78,78,76,136,136,134,157,157,155,152,152,150,118,118,116,46,46,44,5,5,3,110,109,107,207,206,204,106,105,103,68,67,65,80,79,77,67,66,64,67,66,64,68,67,65,75,74,72,82,81,79,116,115,113,125,124,122,92,91,89,92,91,89,135,134,132,164,163,161,161,160,158,162,161,159,175,174,172,166,165,163,146,145,143,138,137,135,141,140,138,125,124,122,91,90,88,87,86,84,66,65,63,64,63,61,87,86,84,83,82,80,64,63,61,67,66,64,53,52,50,94,93,91,142,141,139,90,89,87,87,86,84,138,137,135,99,98,96,67,66,64,54,53,51,49,48,46,52,51,49,59,58,56,59,58,56,50,49,47,45,44,42,46,45,43,41,41,39,53,53,51,81,81,79,119,119,117,169,169,167,204,204,202,167,167,165,90,90,88,88,88,86,122,122,120,151,151,149,131,131,129,133,133,131,140,140,138,70,70,68,0,0,0,137,136,134,212,211,209,121,120,118,80,79,77,85,84,82,78,77,75,64,63,61,60,59,57,64,63,61,101,100,98,159,158,156,163,162,160,108,107,105,92,91,89,130,129,127,159,158,156,166,165,163,175,174,172,207,206,204,189,188,186,154,153,151,133,132,130,144,143,141,124,123,121,99,98,96,81,80,78,57,56,54,60,59,57,87,86,84,95,94,92,77,76,74,63,62,60,52,51,49,39,38,36,67,66,64,89,88,86,136,135,133,159,158,156,89,88,86,37,36,34,53,52,50,53,52,50,58,57,55,66,65,63,68,67,65,61,60,58,53,52,50,50,49,47,38,38,36,45,45,43,85,85,83,111,111,109,124,124,122,172,172,170,193,193,191,153,153,151,149,149,147,152,152,150,134,134,132,89,89,87,113,113,111,155,155,153,90,90,88,0,0,0,161,160,158,211,210,208,136,135,133,82,81,79,71,70,68,78,77,75,63,62,60,66,65,63,92,91,89,132,131,129,185,184,182,177,176,174,114,113,111,89,88,86,110,109,107,120,119,117,149,148,146,160,159,157,204,203,201,182,181,179,144,143,141,120,119,117,139,138,136,115,114,112,89,88,86,77,76,74,81,80,78,101,100,98,118,117,115,128,127,125,114,113,111,88,87,85,74,73,71,71,70,68,97,96,94,136,135,133,153,152,150,127,126,124,77,76,74,48,47,45,44,43,41,50,49,47,53,52,50,53,52,50,51,50,48,50,49,47,48,47,45,45,44,42,51,51,49,65,65,63,98,98,96,113,113,111,101,101,99,115,115,113,159,159,157,189,189,187,173,173,171,158,158,156,130,130,128,92,92,90,119,119,117,156,156,154,91,91,89,5,5,3,180,178,178,211,209,209,143,142,141,75,74,73,51,49,49,71,70,69,65,64,63,80,79,78,72,71,70,102,101,100,147,145,145,149,147,147,114,112,112,113,112,111,131,129,129,126,125,124,149,148,146,123,122,120,138,137,135,116,115,113,108,107,105,109,108,106,131,130,128,92,91,89,64,63,61,69,68,66,106,105,103,141,140,138,150,149,147,159,158,156,152,151,149,121,120,118,111,110,109,111,110,109,114,113,112,148,147,146,168,167,166,145,144,143,102,101,100,55,54,53,55,54,53,64,63,62,65,64,63,55,54,53,49,48,47,53,52,51,58,57,56,58,57,56,56,56,54,59,59,57,74,74,72,110,110,108,127,127,125,105,105,103,110,110,108,156,156,154,170,170,168,161,161,159,152,152,150,128,128,126,138,138,136,144,144,142,72,72,70,1,1,0,182,180,181,204,202,203,140,138,139,66,64,64,60,58,59,72,70,71,79,77,78,61,59,60,66,64,64,93,91,92,116,114,115,134,132,133,96,94,95,120,118,119,127,125,126,124,122,122,142,141,140,155,154,152,122,121,119,111,110,108,97,96,94,74,73,71,89,88,86,88,87,85,41,40,38,63,62,60,105,104,102,140,139,137,147,146,144,140,139,137,149,148,146,170,169,168,138,137,136,142,142,142,167,167,167,175,175,175,156,156,156,144,144,143,114,114,114,63,63,63,72,72,72,67,67,67,40,40,40,54,54,54,49,49,48,63,63,63,56,56,56,78,78,77,80,80,79,77,77,75,72,72,70,114,114,112,104,104,102,82,82,80,57,57,55,88,88,86,136,136,134,140,140,138,129,129,127,110,110,108,138,138,136,120,120,118,45,45,43,15,15,13,146,144,145,213,211,212,136,134,135,61,59,60,66,64,65,70,68,69,58,56,57,78,76,77,66,64,65,88,86,87,99,97,98,110,108,109,83,81,82,99,97,98,103,101,102,108,106,107,136,135,134,146,145,143,126,125,123,121,120,118,103,102,100,81,80,78,95,94,92,91,90,88,64,63,61,62,61,59,81,80,78,114,113,111,130,129,127,132,131,129,149,148,146,176,175,174,160,160,159,179,179,179,209,209,209,204,204,204,165,165,165,140,140,140,119,119,119,84,84,84,50,50,50,69,69,69,69,69,69,63,63,63,54,54,54,75,75,75,74,74,74,63,63,63,49,49,48,69,69,67,87,87,85,112,112,110,98,98,96,66,66,64,44,44,42,64,64,62,60,60,58,95,95,93,112,112,110,98,98,96,128,128,126,137,137,135,61,61,59,0,0,0,136,134,135,202,200,201,136,134,135,82,80,81,56,54,55,71,69,70,56,54,55,66,64,65,57,55,56,75,73,74,75,73,74,85,83,84,83,81,82,96,94,95,98,96,97,117,115,116,120,119,118,139,138,136,149,148,146,148,147,145,107,106,104,74,73,71,88,87,85,92,91,89,87,86,84,90,89,87,91,90,88,89,88,86,93,92,90,113,112,110,146,145,143,171,170,169,173,173,173,192,192,192,217,217,217,210,210,210,176,176,176,153,153,153,136,136,136,113,113,113,63,63,63,43,43,43,56,56,56,60,60,60,60,60,60,73,73,73,118,118,118,135,135,135,85,85,84,96,96,94,99,99,97,82,82,80,78,78,76,55,55,53,52,52,50,59,59,57,51,51,49,87,87,85,119,119,117,120,120,118,137,137,135,151,151,149,72,72,70,0,0,0,136,134,135,165,163,164,140,138,139,122,120,121,39,37,38,79,77,78,87,85,86,48,46,47,53,51,52,68,66,67,63,61,62,69,67,68,89,87,88,97,95,96,98,96,97,122,120,121,103,102,101,109,108,106,132,131,129,146,145,143,119,118,116,90,89,87,90,89,87,87,86,84,96,95,93,130,129,127,133,132,130,94,93,91,75,74,72,107,106,104,151,150,148,171,170,169,183,183,183,186,186,186,191,191,191,190,190,190,184,184,184,176,176,176,158,158,158,135,135,135,119,119,119,72,72,72,74,74,74,59,59,59,64,64,64,89,89,89,166,166,166,186,186,186,152,152,151,138,138,136,111,111,109,59,59,57,72,72,70,66,66,64,71,71,69,59,59,57,88,88,86,97,97,95,124,124,122,144,144,142,140,140,138,142,142,140,65,65,63,3,3,1,94,92,93,147,145,146,156,154,155,147,145,146,45,43,44,77,75,76,96,94,95,63,61,62,62,60,61,72,70,71,65,63,64,61,59,60,86,84,85,87,85,86,86,84,85,100,98,99,95,94,93,77,76,74,90,89,87,119,118,116,133,132,130,127,126,124,112,111,109,109,108,106,125,124,122,149,148,146,157,156,154,134,133,131,113,112,110,124,123,121,157,156,154,182,181,180,191,191,191,188,188,188,179,179,179,177,177,177,185,185,185,186,186,186,175,175,175,166,166,166,177,177,177,161,161,161,147,147,147,77,77,77,72,72,72,126,126,126,184,184,184,145,145,145,158,158,157,148,148,146,122,122,120,69,69,67,82,82,80,75,75,73,75,75,73,56,56,54,85,85,83,97,97,95,116,116,114,136,136,134,125,125,123,138,138,136,61,61,59,4,4,2,36,34,35,164,162,163,190,188,189,158,156,157,76,74,75,62,60,61,63,61,62,82,80,81,66,64,65,73,71,72,74,72,73,62,60,61,85,83,84,91,89,90,99,97,98,96,94,95,89,88,87,87,86,84,105,104,102,122,121,119,135,134,132,124,123,121,115,114,112,153,152,150,178,177,175,160,159,157,161,160,158,175,174,172,167,166,164,143,142,140,149,148,146,177,176,175,175,175,175,185,185,185,181,181,181,174,174,174,180,180,180,182,182,182,190,190,190,209,209,209,209,209,209,186,186,186,152,152,152,94,94,94,88,88,88,135,135,135,172,172,172,144,144,143,144,144,143,143,143,141,120,120,118,79,79,77,72,72,70,63,63,61,71,71,69,78,78,76,85,85,83,131,131,129,141,141,139,140,140,138,128,128,126,162,162,160,73,73,71,2,2,0,4,2,3,155,153,154,212,210,211,178,176,177,108,106,107,65,63,64,61,59,60,77,75,76,65,63,64,68,66,67,82,80,81,65,63,64,86,84,85,106,104,105,131,129,130,113,111,112,74,73,72,98,97,95,125,124,122,131,130,128,140,139,137,109,108,106,85,84,82,151,150,148,185,184,182,166,165,163,164,163,161,181,180,178,179,178,176,156,155,153,152,151,149,169,168,167,170,170,170,190,190,190,187,187,187,178,178,178,182,182,182,182,182,182,196,196,196,229,229,229,202,202,202,161,161,161,112,112,112,101,101,101,101,101,101,131,131,131,158,158,158,182,182,182,169,169,168,157,157,155,118,118,116,92,92,90,68,68,66,63,63,61,69,69,67,100,100,98,119,119,117,175,175,173,170,170,168,160,160,158,145,145,143,171,171,169,66,66,64,2,2,0,1,0,0,113,111,112,210,208,209,201,199,200,126,124,125,90,88,89,101,99,100,69,67,68,66,64,65,67,65,66,87,85,86,64,62,63,81,79,80,110,108,109,146,144,145,117,115,116,58,57,56,74,73,71,93,92,90,115,114,112,158,157,155,122,121,119,57,56,54,102,101,99,143,142,140,160,159,157,170,169,167,163,162,160,158,157,155,167,166,164,175,174,172,175,174,173,197,197,197,210,210,210,198,198,198,186,186,186,193,193,193,188,188,188,192,192,192,220,220,220,177,177,177,167,167,167,117,117,117,107,107,107,105,105,105,145,145,145,153,153,153,173,173,173,206,206,205,179,179,177,125,125,123,118,118,116,92,92,90,83,83,81,67,67,65,94,94,92,141,141,139,182,182,180,162,162,160,162,162,160,146,146,144,150,150,148,37,37,35,1,1,0,1,0,0,85,83,84,191,189,190,196,194,195,197,195,196,118,116,117,123,121,122,93,91,92,90,88,89,78,76,77,110,108,109,72,70,71,61,59,60,89,87,88,121,119,120,81,79,80,74,73,72,61,60,58,82,81,79,83,82,80,145,144,142,125,124,122,70,69,67,69,68,66,90,89,87,159,158,156,170,169,167,139,138,136,143,142,140,158,157,155,160,159,157,170,169,168,183,183,183,191,191,191,192,192,192,181,181,181,177,177,177,188,188,188,202,202,202,209,209,209,216,216,216,169,169,169,160,160,160,145,145,145,135,135,135,129,129,129,119,119,119,155,155,155,175,175,174,177,177,175,186,186,184,128,128,126,98,98,96,72,72,70,86,86,84,103,103,101,126,126,124,150,150,148,153,153,151,153,153,151,150,150,148,123,123,121,12,12,10,1,1,0,10,8,9,11,9,10,181,179,180,186,184,185,189,187,188,156,154,155,123,121,122,113,111,112,134,132,133,134,132,133,136,134,135,82,80,81,64,62,63,58,56,57,81,79,80,85,83,84,62,61,60,78,77,75,75,74,72,76,75,73,118,117,115,149,148,146,105,104,102,74,73,71,129,128,126,149,148,146,167,166,164,161,160,158,147,146,144,150,149,147,155,154,152,146,145,144,177,177,177,174,174,174,171,171,171,175,175,175,191,191,191,207,207,207,207,207,207,198,198,198,200,200,200,203,203,203,206,206,206,165,165,165,148,148,148,152,152,152,112,112,112,84,84,84,123,123,122,173,173,171,189,189,187,131,131,129,138,138,136,129,129,127,131,131,129,97,97,95,130,130,128,148,148,146,144,144,142,142,142,140,169,169,167,104,104,102,9,9,7,5,5,3,19,17,18,1,0,0,135,133,134,210,208,209,184,182,183,182,180,181,136,134,135,137,135,136,128,126,127,151,149,150,151,149,150,115,113,114,102,100,101,67,65,66,72,70,71,99,97,98,97,96,95,122,121,119,94,93,91,98,97,95,90,89,87,122,121,119,104,103,101,74,73,71,114,113,111,100,99,97,134,133,131,166,165,163,155,154,152,158,157,155,171,170,168,158,157,156,165,165,165,163,163,163,163,163,163,171,171,171,188,188,188,199,199,199,194,194,194,183,183,183,207,207,207,213,213,213,220,220,220,186,186,186,151,151,151,128,128,128,93,93,93,81,81,80,105,105,104,191,191,189,172,172,170,155,155,153,157,157,155,161,161,159,137,137,135,95,95,93,131,131,129,137,137,135,128,128,126,135,135,133,169,169,167,64,64,62,1,1,0,1,1,0,4,2,3,5,3,4,58,56,57,230,228,229,197,195,196,182,180,181,157,155,156,147,145,146,161,159,160,171,169,170,157,155,156,134,132,133,111,109,110,77,75,76,76,74,75,76,74,75,150,149,148,131,130,128,87,86,84,108,107,105,93,92,90,83,82,80,86,85,83,69,68,66,98,97,95,98,97,95,133,132,130,167,166,164,162,161,159,157,156,154,164,163,161,162,161,160,162,162,162,171,171,171,179,179,179,177,177,177,171,171,171,169,169,169,174,174,174,180,180,180,202,202,202,211,211,211,221,221,221,196,196,196,141,141,141,92,92,92,79,79,79,98,98,98,118,118,117,198,198,196,134,134,132,171,171,169,139,139,137,137,137,135,110,110,108,128,128,126,136,136,134,127,127,125,127,127,125,156,156,154,136,136,134,26,26,24,1,1,0,0,0,0,1,0,0,14,12,13,5,3,4,175,173,174,227,225,226,197,195,196,177,175,176,156,154,155,199,197,198,164,162,163,117,115,116,100,98,99,72,70,71,88,86,87,120,118,119,89,87,88,154,153,152,105,104,102,67,66,64,87,86,84,107,106,104,75,74,72,91,90,88,72,71,69,79,78,76,125,124,122,156,155,153,169,168,166,177,176,174,167,166,164,164,163,161,185,184,183,167,167,167,177,177,177,184,184,184,178,178,178,165,165,165,159,159,159,170,170,170,184,184,184,176,176,176,212,212,212,225,225,225,198,198,198,146,146,146,104,104,104,87,87,87,76,76,76,107,107,106,168,168,166,120,120,118,148,148,146,128,128,126,100,100,98,120,120,118,176,176,174,150,150,148,131,131,129,142,142,140,181,181,179,83,83,81,5,5,3,10,10,8,0,0,0,6,4,5,1,0,0,3,1,2,76,74,75,235,233,234,240,238,239,195,193,194,181,179,180,182,180,181,131,129,130,66,64,65,69,67,68,52,50,51,102,100,101,159,157,158,123,121,122,121,120,119,118,117,115,113,112,110,87,86,84,92,91,89,63,62,60,85,84,82,81,80,78,67,66,64,138,137,135,171,170,168,172,171,169,181,180,178,171,170,168,167,166,164,196,195,194,164,164,164,161,161,161,161,161,161,166,166,166,169,169,169,169,169,169,170,170,170,174,174,174,178,178,178,190,190,190,191,191,191,197,197,197,172,172,172,128,128,128,115,115,115,106,106,106,99,99,98,142,142,140,150,150,148,122,122,120,146,146,144,98,98,96,157,157,155,192,192,190,160,160,158,137,137,135,150,150,148,160,160,158,31,31,29,0,0,0,11,11,9,0,0,0,10,8,9,1,0,0,8,6,7,17,15,16,171,169,170,251,249,250,199,197,198,205,203,204,189,187,188,152,150,151,71,69,70,78,76,77,59,57,58,78,76,77,121,119,120,111,109,110,96,95,94,135,134,132,146,145,143,97,96,94,75,74,72,65,64,62,61,60,58,80,79,77,92,91,89,139,138,136,177,176,174,182,181,179,168,167,165,154,153,151,153,152,150,164,163,162,156,156,156,151,151,151,154,154,154,169,169,169,179,179,179,176,176,176,166,166,166,161,161,161,178,178,178,178,178,178,171,171,171,195,195,195,181,181,181,140,140,140,151,151,151,162,162,162,129,129,128,148,148,146,174,174,172,146,146,144,170,170,168,142,142,140,173,173,171,187,187,185,166,166,164,149,149,147,148,148,146,93,93,91,4,4,2,0,0,0,4,4,2,0,0,0,1,0,0,15,13,14,1,0,0,9,7,8,84,82,83,225,223,224,190,188,189,211,209,210,203,201,202,183,181,182,83,81,82,85,83,84,65,63,64,53,51,52,86,84,85,119,117,118,85,84,83,110,109,108,104,103,102,85,84,83,83,82,81,101,100,99,49,48,47,71,70,69,88,87,86,103,102,101,158,157,156,188,187,186,166,165,164,162,161,160,177,176,175,171,170,169,157,157,157,160,160,160,174,174,174,190,190,190,191,191,191,177,177,177,163,163,163,159,159,159,145,145,145,202,202,202,207,207,207,192,192,192,164,164,164,153,153,153,177,177,177,162,162,162,167,167,166,163,163,162,167,167,166,194,194,193,183,183,182,191,191,190,170,170,169,192,192,191,175,175,174,164,164,163,148,148,147,39,39,38,5,5,4,4,4,3,3,3,2,3,3,2,2,2,2,2,2,2,0,0,0,3,3,3,12,12,12,142,142,142,211,211,211,191,191,191,196,196,196,218,218,218,121,121,121,92,92,92,79,79,79,71,71,71,81,81,81,119,119,119,134,134,134,88,88,88,97,97,96,102,102,102,59,59,59,54,54,54,74,74,74,54,54,54,68,68,68,85,85,85,152,152,152,182,182,182,161,161,161,188,188,188,206,206,206,153,153,153,169,169,169,196,196,196,193,193,193,181,181,181,188,188,188,177,177,177,152,152,152,145,145,145,199,199,199,205,205,205,201,201,201,188,188,188,183,183,183,182,182,182,169,169,169,150,150,150,175,175,175,173,173,173,196,196,196,218,218,218,208,208,207,193,193,193,194,194,194,198,198,198,171,171,171,168,168,168,79,79,79,0,0,0,2,2,2,3,3,3,0,0,0,11,11,11,0,0,0,0,0,0,9,9,9,0,0,0,4,4,4,58,58,58,171,171,171,214,214,214,219,219,219,178,178,178,217,217,217,151,151,151,90,90,90,98,98,98,139,139,139,143,143,143,102,102,102,118,118,118,138,138,138,135,135,135,100,100,100,68,68,68,72,72,72,93,93,93,101,101,101,117,117,117,172,172,172,199,199,199,185,185,185,207,207,207,224,224,224,191,191,191,187,187,187,216,216,216,217,217,217,185,185,185,158,158,158,155,155,155,175,175,175,200,200,200,167,167,167,179,179,179,186,186,186,183,183,183,183,183,183,185,185,185,174,174,174,158,158,158,173,173,173,185,185,185,204,204,204,214,214,214,221,221,221,231,231,231,214,214,214,175,175,175,188,188,188,104,104,104,24,24,24,3,3,3,4,4,4,0,0,0,0,0,0,6,6,6,5,5,5,0,0,0,9,9,9,3,3,3,2,2,2,0,0,0,100,100,100,198,198,198,185,185,185,190,190,190,225,225,225,170,170,170,156,156,156,136,136,136,133,133,133,166,166,166,85,85,85,125,125,125,134,134,134,149,149,149,176,176,176,148,148,148,115,115,115,138,138,138,172,172,172,185,185,185,212,212,212,221,221,221,207,207,207,206,206,206,210,210,210,199,199,199,190,190,190,188,188,188,181,181,181,162,162,162,148,148,148,165,165,165,192,192,192,199,199,199,178,178,178,182,182,182,178,178,178,167,167,167,166,166,166,177,177,177,184,184,184,183,183,183,181,181,181,182,182,182,207,207,207,233,233,233,233,233,233,219,219,219,202,202,202,181,181,181,150,150,150,34,34,34,0,0,0,10,10,10,0,0,0,0,0,0,5,5,5,0,0,0,6,6,6,4,4,4,0,0,0,19,19,19,0,0,0,0,0,0,27,27,27,116,116,116,188,188,188,186,186,186,168,168,168,197,197,197,142,142,142,139,139,139,163,163,163,138,138,138,106,106,106,124,124,124,122,122,122,155,155,155,219,219,219,215,215,215,176,176,176,178,178,178,198,198,198,211,211,211,224,224,224,229,229,229,225,225,225,213,213,213,210,210,210,220,220,220,203,203,203,178,178,178,173,173,173,179,179,179,184,184,184,203,203,203,203,203,203,173,173,173,187,187,187,186,186,186,176,176,176,162,162,162,159,159,159,172,172,172,187,187,187,195,195,195,176,176,176,190,190,190,220,220,220,232,232,232,208,208,208,184,184,184,173,173,173,165,165,165,56,56,56,2,2,2,0,0,0,12,12,12,0,0,0,0,0,0,13,13,13,0,0,0,0,0,0,10,10,10,0,0,0,5,5,5,1,1,1,3,3,3,0,0,0,28,28,28,154,154,154,205,205,205,177,177,177,171,171,171,134,134,134,147,147,147,168,168,168,157,157,157,147,147,147,148,148,148,156,156,156,176,176,176,197,197,197,206,206,206,207,207,207,207,207,207,217,217,217,230,230,230,232,232,232,234,234,234,234,234,234,216,216,216,205,205,205,219,219,219,204,204,204,193,193,193,201,201,201,204,204,204,189,189,189,188,188,188,185,185,185,161,161,161,162,162,162,168,168,168,173,173,173,172,172,172,171,171,171,175,175,175,179,179,179,181,181,181,169,169,169,206,206,206,222,222,222,193,193,193,174,174,174,181,181,181,147,147,147,79,79,79,0,0,0,2,2,2,7,7,7,4,4,4,0,0,0,0,0,0,3,3,3,3,3,3,0,0,0,7,7,7,12,12,12,0,0,0,8,8,8,0,0,0,0,0,0,0,0,0,38,38,38,161,161,161,218,218,218,141,141,141,176,176,176,176,176,176,152,152,152,198,198,198,186,186,186,170,170,170,179,179,179,185,185,185,174,174,174,192,192,192,219,219,219,216,216,216,236,236,236,243,243,243,241,241,241,238,238,238,235,235,235,218,218,218,203,203,203,206,206,206,199,199,199,193,193,193,192,192,192,185,185,185,171,171,171,168,168,168,171,171,171,166,166,166,169,169,169,171,171,171,173,173,173,174,174,174,174,174,174,176,176,176,178,178,178,180,180,180,193,193,193,185,185,185,178,178,178,171,171,171,169,169,169,155,155,155,88,88,88,3,3,3,0,0,0,7,7,7,0,0,0,0,0,0,11,11,11,0,0,0,0,0,0,8,8,8,0,0,0,3,3,3,11,11,11,0,0,0,8,8,8,0,0,0,4,4,4,6,6,6,0,0,0,25,25,25,157,157,157,176,176,176,170,170,170,175,175,175,186,186,186,177,177,177,199,199,199,181,181,181,177,177,177,180,180,180,182,182,182,203,203,203,221,221,221,216,216,216,215,215,215,218,218,218,223,223,223,227,227,227,231,231,231,233,233,233,228,228,228,220,220,220,212,212,212,201,201,201,182,182,182,178,178,178,190,190,190,192,192,192,186,186,186,186,186,186,185,185,185,180,180,180,175,175,175,175,175,175,179,179,179,185,185,185,191,191,191,196,196,196,199,199,199,156,156,156,150,150,150,169,169,169,142,142,142,74,74,74,20,20,20,0,0,0,9,9,9,4,4,4,0,0,0,0,0,0,7,7,7,0,0,0,0,0,0,3,3,3,6,6,6,0,0,0,0,0,0,9,9,9,0,0,0,3,3,3,0,0,0,8,8,8,11,11,11,3,3,3,22,22,22,157,157,157,181,181,181,156,156,156,159,159,159,175,175,175,189,189,189,193,193,193,186,186,186,182,182,182,192,192,192,202,202,202,210,210,210,220,220,220,218,218,218,215,215,215,218,218,218,218,218,218,217,217,217,225,225,225,222,222,222,203,203,203,207,207,207,209,209,209,192,192,192,187,187,187,202,202,202,195,195,195,179,179,179,186,186,186,162,162,162,163,163,163,172,172,172,187,187,187,200,200,200,204,204,204,204,204,204,203,203,203,164,164,164,159,159,159,171,171,171,156,156,156,80,80,80,6,6,6,0,0,0,10,10,10,0,0,0,0,0,0,5,5,5,0,0,0,0,0,0,2,2,2,6,6,6,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,7,7,7,0,0,0,0,0,0,29,29,29,120,120,120,197,197,197,185,185,185,128,128,128,171,171,171,174,174,174,183,183,183,191,191,191,192,192,192,193,193,193,206,206,206,221,221,221,223,223,223,216,216,216,207,207,207,216,216,216,228,228,228,219,219,219,212,212,212,224,224,224,216,216,216,195,195,195,176,176,176,172,172,172,172,172,172,169,169,169,169,169,169,173,173,173,180,180,180,200,200,200,205,205,205,198,198,198,204,204,204,215,215,215,193,193,193,156,156,156,169,169,169,187,187,187,147,147,147,53,53,53,0,0,0,0,0,0,8,8,8,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,4,4,4,7,7,7,3,3,3,20,20,20,74,74,74,144,144,144,192,192,192,123,123,123,166,166,166,194,194,194,181,181,181,164,164,164,173,173,173,195,195,195,207,207,207,211,211,211,221,221,221,220,220,220,219,219,219,229,229,229,225,225,225,214,214,214,213,213,213,203,203,203,189,189,189,179,179,179,180,180,180,181,181,181,175,175,175,169,169,169,167,167,167,179,179,179,180,180,180,189,189,189,195,195,195,185,185,185,170,170,170,173,173,173,188,188,188,162,162,162,104,104,104,37,37,37,3,3,3,0,0,0,4,4,4,4,4,4,3,3,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,6,6,6,0,0,0,0,0,0,0,0,0,61,61,61,128,128,128,199,199,199,165,165,165,151,151,151,171,171,171,186,186,186,185,185,185,196,196,196,219,219,219,225,225,225,240,240,240,230,230,230,210,210,210,213,213,213,221,221,221,220,220,220,220,220,220,226,226,226,209,209,209,191,191,191,184,184,184,183,183,183,184,184,184,186,186,186,189,189,189,180,180,180,198,198,198,205,205,205,194,194,194,184,184,184,181,181,181,171,171,171,157,157,157,76,76,76,23,23,23,0,0,0,0,0,0,7,7,7,0,0,0,0,0,0,5,5,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,14,14,14,0,0,0,0,0,0,9,9,9,11,11,11,0,0,0,0,0,0,9,9,9,78,78,78,158,158,158,214,214,214,198,198,198,168,168,168,173,173,173,193,193,193,200,200,200,178,178,178,204,204,204,215,215,215,215,215,215,220,220,220,217,217,217,207,207,207,205,205,205,182,182,182,181,181,181,183,183,183,191,191,191,198,198,198,198,198,198,192,192,192,187,187,187,205,205,205,194,194,194,172,172,172,167,167,167,190,190,190,193,193,193,131,131,131,53,53,53,0,0,0,0,0,0,6,6,6,8,8,8,4,4,4,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,0,0,0,0,0,0,6,6,6,7,7,7,2,2,2,0,0,0,0,0,0,0,0,0,5,5,5,68,68,68,167,167,167,226,226,226,218,218,218,195,195,195,190,190,190,208,208,208,218,218,218,221,221,221,223,223,223,220,220,220,201,201,201,190,190,190,202,202,202,207,207,207,203,203,203,196,196,196,190,190,190,189,189,189,188,188,188,183,183,183,178,178,178,188,188,188,204,204,204,220,220,220,201,201,201,130,130,130,46,46,46,4,4,4,2,2,2,0,0,0,5,5,5,2,2,2,0,0,0,0,0,0,7,7,7,7,7,7,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,4,4,4,0,0,0,0,0,0,0,0,0,5,5,5,7,7,7,8,8,8,12,12,12,0,0,0,0,0,0,33,33,33,124,124,124,196,196,196,221,221,221,213,213,213,217,217,217,221,221,221,231,231,231,231,231,231,210,210,210,201,201,201,218,218,218,200,200,200,201,201,201,200,200,200,199,199,199,203,203,203,209,209,209,209,209,209,206,206,206,223,223,223,166,166,166,91,91,91,37,37,37,11,11,11,3,3,3,0,0,0,0,0,0,6,6,6,0,0,0,0,0,0,1,1,1,3,3,3,0,0,0,0,0,0,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,9,9,9,16,16,16,5,5,5,0,0,0,18,18,18,53,53,53,115,115,115,146,146,146,182,182,182,215,215,215,238,238,238,233,233,233,220,220,220,221,221,221,224,224,224,233,233,233,237,237,237,227,227,227,205,205,205,173,173,173,134,134,134,104,104,104,27,27,27,25,25,25,6,6,6,0,0,0,0,0,0,19,19,19,13,13,13,0,0,0,0,0,0,0,0,0,4,4,4,13,13,13,6,6,6,0,0,0,0,0,0,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,0,0,0,1,1,1,6,6,6,2,2,2,0,0,0,0,0,0,4,4,4,0,0,0,2,2,2,1,1,1,0,0,0,2,2,2,8,8,8,6,6,6,0,0,0,0,0,0,13,13,13,10,10,10,6,6,6,27,27,27,54,54,54,71,71,71,83,83,83,82,82,82,75,75,75,54,54,54,28,28,28,12,12,12,9,9,9,6,6,6,0,0,0,1,1,1,0,0,0,4,4,4,13,13,13,5,5,5,0,0,0,0,0,0,13,13,13,4,4,4,4,4,4,0,0,0,0,0,0,0,0,0,5,5,5,4,4,4,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1};


// ===============================================================================
// 幅度转换
// ===============================================================================

// 从星等转换为相对亮度（归一化到 [0,1]，mag=0 → 1.0，mag=6 → ~0.01）
// 增加一个衰减系数（平均蓝天亮度），以便白天能够掩盖亮星
float magnitude_to_relative_luminance(float mag) {
    return 0.7f * powf(10.0f, -0.4f * mag);
}

float get_luminance(float r, float g, float b) {
    return 0.299f * r + 0.587f * g + 0.114f * b;
}

// ===============================================================================
// 帧缓冲操作
// ===============================================================================

// 设置像素
static inline void set_pixel(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height, int32_t x, int32_t y, uint8_t r, uint8_t g, uint8_t b) {
    int32_t i = (y * fb_width + x) * 3;
    frame_buffer[ i ] = MIN(255, r);
    frame_buffer[i+1] = MIN(255, g);
    frame_buffer[i+2] = MIN(255, b);
}

// 叠加像素
static inline void add_pixel(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height, int32_t x, int32_t y, uint8_t r, uint8_t g, uint8_t b) {
    int32_t i = (y * fb_width + x) * 3;
    frame_buffer[ i ] = MIN(255, frame_buffer[ i ] + r);
    frame_buffer[i+1] = MIN(255, frame_buffer[i+1] + g);
    frame_buffer[i+2] = MIN(255, frame_buffer[i+2] + b);
}

// 数乘像素
static inline void scale_pixel(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height, int32_t x, int32_t y, float k) {
    int32_t i = (y * fb_width + x) * 3;
    frame_buffer[ i ] = MIN(255, (uint8_t)(k * (float)frame_buffer[ i ]));
    frame_buffer[i+1] = MIN(255, (uint8_t)(k * (float)frame_buffer[i+1]));
    frame_buffer[i+2] = MIN(255, (uint8_t)(k * (float)frame_buffer[i+2]));
}

static inline uint8_t get_pixel_channel(const uint8_t *tex, int32_t width, int32_t x, int32_t y, int32_t c) {
    return tex[((y * width + x) * 3) + c];
}

// ===============================================================================
// 坐标转换
// ===============================================================================

static inline float to_deg_float(float rad) {
    return rad * (180.0f / M_PI);
}

static inline float to_rad_float(float deg) {
    return deg * (M_PI / 180.0f);
}

static inline float normalize_angle_float(float angle) {
    angle = fmodf(angle, 360.0f);
    if (angle < 0) angle += 360.0f;
    return angle;
}

// 将hms格式的赤经转为度数
static inline float ra_hms_to_deg(float h, float m, float s) {
    float totalHours = h + m / 60.0f + s / 3600.0f;
    return normalize_angle_float(totalHours * 15.0f);
}

// 将度分秒格式的赤纬转为度数
static inline float dec_dms_to_decimal(float d, float m, float s) {
    float sign = (d < 0.0f) ? (-1.0f) : (1.0f);
    float absD = fabsf(d);
    float decimal = sign * (absD + m / 60.0f + s / 3600.0f);
    return decimal;
}

// 地平天球的球坐标系→地平天球的笛卡尔坐标系
void horizontal_to_xyz(float azimuth_deg, float altitude_deg, float R, float *x, float *y, float *z) {
    float altRad = to_rad_float(altitude_deg);
    float azRad = to_rad_float(180.0f + azimuth_deg);
    *x = R * cosf(altRad) * sinf(azRad);
    *y = R * cosf(altRad) * cosf(azRad);
    *z = R * sinf(altRad);
}

// 地平天球的球坐标系→地平天球的笛卡尔坐标系→投影到地面投影坐标系
void horizontal_to_screen_xy(
    float azimuth_deg, float altitude_deg, float radius,
    float center_x, float center_y, float *scr_x, float *scr_y
) {
    // 鱼眼投影
    if (USE_FISHEYE_PROJECTION) {
        // 因为是躺在地上看天，所以方位角是从正北逆时针旋转
        float az_rad = (-azimuth_deg * M_PI) / 180.0f;
        float alt_rad = (altitude_deg * M_PI) / 180.0f;
        // 天顶距 θ = π/2 - altitude
        float theta = M_PI_2 - alt_rad;
        // 等距鱼眼投影：r = (2R / π) * θ
        float r = (2.0f * radius / M_PI) * theta;
        // 投影到平面：X指向东（注意因为是躺在地上看天，所以东是屏幕坐标系的左侧/负半轴），Y指向北
        float X = r * sinf(az_rad);
        float Y = -r * cosf(az_rad);

        *scr_x = X + center_x;
        *scr_y = Y + center_y;
    }
    // 正交XY投影：笛卡尔坐标系的XY直接垂直投射到地平面上
    else {
        float x = 0.0f;
        float y = 0.0f;
        float z = 0.0f;
        horizontal_to_xyz(azimuth_deg, altitude_deg, radius, &x, &y, &z);
        (void)z;

        if (altitude_deg >= 0.0f) {
            // 转到canvas的屏幕坐标系
            *scr_x = x + center_x;
            *scr_y = y + center_y;
        }
        else {
            // 地平面以下的，移出canvas显示范围
            *scr_x = x - center_x;
            *scr_y = y - center_y;
        }
    }
}


// 屏幕坐标系→地面投影坐标系→反演回地平天球的直角坐标系
// 返回值为正：能够反演回球面；返回值为负：无法反演回球面
int32_t screen_xy_to_xyz(
    float scr_x, float scr_y,
    float radius, float center_x, float center_y,
    float *x, float *y, float *z
) {
    float dx = scr_x - center_x;
    float dy = scr_y - center_y;
    float r = sqrtf(dx*dx + dy*dy) / radius; // 归一化半径
    // 鱼眼投影
    if (USE_FISHEYE_PROJECTION) {
        if (r <= 1) {
            float theta = r * M_PI_2; // 天顶角
            float phi = atan2f(dy, dx); // 方位角
            *x = radius * sinf(theta) * cosf(phi);
            *y = radius * sinf(theta) * sinf(phi);
            *z = radius * cosf(theta);
            return 1;
        }
        else {
            *x = 0.0f;
            *y = 0.0f;
            *z = 0.0f;
            return -1;
        }
    }
    // XY投影
    else {
        if (r <= 1) {
            *x = dx;
            *y = dy;
            *z = sqrtf(radius*radius - (dx*dx + dy*dy));
            return 1;
        }
        else {
            *x = 0.0f;
            *y = 0.0f;
            *z = 0.0f;
            return -1;
        }
    }
}


// ===============================================================================
// 滤波器
// ===============================================================================

void star_burst_filter(uint8_t *frame_buffer, int32_t width, int32_t height, float sun_screen_x, float sun_screen_y) {
    // 亮度阈值
    float threshold = 0.9;

    float cx = sun_screen_x;
    float cy = sun_screen_y;
    int32_t ix = (int32_t)(floorf(cx));
    int32_t iy = (int32_t)(floorf(cy));
    if (ix < 0 || ix >= width || iy < 0 || iy >= height) return;

    // 1. 读取原图中该像素的亮度
    int32_t idx = (iy * width + ix) * 3;
    float r = frame_buffer[idx] / 255.f;
    float g = frame_buffer[idx + 1] / 255.f;
    float b = frame_buffer[idx + 2] / 255.f;
    float lum = get_luminance(r, g, b);

    if (lum <= threshold) return; // 不够亮，不绘制星芒

    // 2. 计算星芒颜色和强度
    float factor = MIN(1.0f, (lum - threshold) * 5.0f);
    float sr = r * factor * 255.0f;
    float sg = g * factor * 255.0f;
    float sb = b * factor * 255.0f;

    // 3. 绘制星芒（沿4个方向双向延伸）
    int32_t blurLength = 100;
    float decay = 0.97f;

    for (int32_t k = 0; k < 4; k++) {
        float dx = 0.0f;
        float dy = 0.0f;

        switch (k) {
            case 0: dx = 1.0f; dy = 0.0f; break;
            case 1: dx = 0.0f; dy = 1.0f; break;
            case 2: dx = 1.0f; dy = 1.0f; break;
            case 3: dx = 1.0f; dy = -1.0f; break;
            default: break;
        }

        float len = sqrtf(dx*dx + dy*dy);
        float ndx = dx / len;
        float ndy = dy / len;

        for (int32_t d = 1; d <= blurLength; d++) {
            float alpha = powf(decay, (float)d);
            if (alpha < 0.01f) break;

            // 正向
            int32_t px = (int32_t)floorf(cx + ndx * d);
            int32_t py = (int32_t)floorf(cy + ndy * d);
            if (px >= 0 && px < width && py >= 0 && py < height) {
                add_pixel(frame_buffer, width, height, px, py, (uint8_t)(sr * alpha), (uint8_t)(sg * alpha), (uint8_t)(sb * alpha));
            }

            // 反向
            px = (int32_t)floorf(cx - ndx * d);
            py = (int32_t)floorf(cy - ndy * d);
            if (px >= 0 && px < width && py >= 0 && py < height) {
                add_pixel(frame_buffer, width, height, px, py, (uint8_t)(sr * alpha), (uint8_t)(sg * alpha), (uint8_t)(sb * alpha));
            }
        }
    }
}

// 抖动：用于缓解低位深屏幕的色带现象
/**
 * Floyd-Steinberg误差扩散抖动
 * 在RGB888缓冲区上模拟RGB565量化过程，通过误差扩散缓解色带
 * 
 * @param frame_buffer RGB8888格式帧缓冲（3字节/像素，顺序R,G,B）
 * @param fb_width     帧缓冲宽度（像素）
 * @param fb_height    帧缓冲高度（像素）
 * 
 * 算法原理：
 * 1. 对每个像素，先叠加累积误差得到"增强值"
 * 2. 模拟RGB565量化：R8→R5(>>3), G8→G6(>>2), B8→B5(>>3)
 * 3. 量化后还原为8bit：R5→R8(<<3|>>2), G6→G8(<<2|>>4), B5→B8(<<3|>>2)
 * 4. 计算误差 = 增强值 - 量化还原值
 * 5. 按Floyd-Steinberg权重扩散误差到邻域：
 *        [ 0      0      0    ]
 *        [ 0      X    7/16   ]
 *        [ 3/16  5/16  1/16   ]
 */
void dithering_fs(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height) {
    if (!frame_buffer || fb_width <= 0 || fb_height <= 0) return;

    const int32_t stride = fb_width * 3;  // RGB888每行字节数

    // 为避免跨行误差污染，使用双行误差缓冲（当前行+下一行）
    // 误差范围：[-255, 255] → 用int16_t安全存储
    int16_t *err_r = (int16_t *)calloc(fb_width * 2, sizeof(int16_t));
    int16_t *err_g = (int16_t *)calloc(fb_width * 2, sizeof(int16_t));
    int16_t *err_b = (int16_t *)calloc(fb_width * 2, sizeof(int16_t));

    if (!err_r || !err_g || !err_b) {
        if (err_r) free(err_r);
        if (err_g) free(err_g);
        if (err_b) free(err_b);
        return; // 内存分配失败，静默退出
    }

    #define CLAMP(v, min, max) ((v) < (min) ? (min) : ((v) > (max) ? (max) : (v)))

    for (int32_t y = 0; y < fb_height; y++) {
        int16_t *curr_err_r = err_r + (y & 1) * fb_width;      // 双缓冲切换
        int16_t *curr_err_g = err_g + (y & 1) * fb_width;
        int16_t *curr_err_b = err_b + (y & 1) * fb_width;
        int16_t *next_err_r = err_r + ((y + 1) & 1) * fb_width;
        int16_t *next_err_g = err_g + ((y + 1) & 1) * fb_width;
        int16_t *next_err_b = err_b + ((y + 1) & 1) * fb_width;

        // 清空下一行误差缓冲（避免残留）
        if (y + 1 < fb_height) {
            memset(next_err_r, 0, fb_width * sizeof(int16_t));
            memset(next_err_g, 0, fb_width * sizeof(int16_t));
            memset(next_err_b, 0, fb_width * sizeof(int16_t));
        }

        uint8_t *row = frame_buffer + y * stride;

        for (int32_t x = 0; x < fb_width; x++) {
            // 1. 叠加累积误差（限制在合理范围防止溢出）
            int32_t r = CLAMP(row[x * 3 + 0] + curr_err_r[x], 0, 255);
            int32_t g = CLAMP(row[x * 3 + 1] + curr_err_g[x], 0, 255);
            int32_t b = CLAMP(row[x * 3 + 2] + curr_err_b[x], 0, 255);

            // 2. 模拟RGB565量化并还原到8bit（保留低位以维持亮度）
            uint8_t r5 = r >> 3;          // 8bit → 5bit
            uint8_t g6 = g >> 2;          // 8bit → 6bit
            uint8_t b5 = b >> 3;          // 8bit → 5bit

            uint8_t r_out = (r5 << 3) | (r5 >> 2);  // 5bit → 8bit (复制高位到低位)
            uint8_t g_out = (g6 << 2) | (g6 >> 4);  // 6bit → 8bit
            uint8_t b_out = (b5 << 3) | (b5 >> 2);  // 5bit → 8bit

            // 3. 写回量化+抖动后的像素值
            row[x * 3 + 0] = r_out;
            row[x * 3 + 1] = g_out;
            row[x * 3 + 2] = b_out;
            // Alpha保持原值

            // 4. 计算误差（原始增强值 - 量化还原值）
            int32_t err_r_val = r - r_out;
            int32_t err_g_val = g - g_out;
            int32_t err_b_val = b - b_out;

            // 5. Floyd-Steinberg误差扩散（仅传播到未处理像素）
            if (x + 1 < fb_width) {
                // 右侧像素 (7/16)
                curr_err_r[x + 1] += (err_r_val * 7) >> 4;
                curr_err_g[x + 1] += (err_g_val * 7) >> 4;
                curr_err_b[x + 1] += (err_b_val * 7) >> 4;
            }

            if (y + 1 < fb_height) {
                if (x > 0) {
                    // 左下 (3/16)
                    next_err_r[x - 1] += (err_r_val * 3) >> 4;
                    next_err_g[x - 1] += (err_g_val * 3) >> 4;
                    next_err_b[x - 1] += (err_b_val * 3) >> 4;
                }
                // 正下 (5/16)
                next_err_r[x] += (err_r_val * 5) >> 4;
                next_err_g[x] += (err_g_val * 5) >> 4;
                next_err_b[x] += (err_b_val * 5) >> 4;

                if (x + 1 < fb_width) {
                    // 右下 (1/16)
                    next_err_r[x + 1] += err_r_val >> 4;
                    next_err_g[x + 1] += err_g_val >> 4;
                    next_err_b[x + 1] += err_b_val >> 4;
                }
            }
        }
    }

    free(err_r);
    free(err_g);
    free(err_b);
}



// 8x8 Bayer矩阵（预缩放至0~255范围，避免运行时乘法）
static const uint8_t bayer8x8[64] = {
    0,  192, 48,  240, 12,  204, 60,  252,
    128,64,  176,112,140,76,  224,160,
    32, 224, 16,  208, 44, 236, 28,  220,
    160,96,  144,80,  172,108,252,188,
    8,  200, 56,  248, 4,  196, 52,  244,
    136,72,  184,120,132,68,  216,152,
    40, 232, 24,  216, 36, 228, 20,  212,
    168,104,152,88,  180,116,244,180
};

// 量化误差补偿表（RGB565量化后还原的亮度偏移补偿）
static const int8_t quant_bias[8] = {0, 1, 1, 2, 2, 3, 3, 4}; // 经验值

void dithering_fast(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height) {
    if (!frame_buffer || fb_width <= 0 || fb_height <= 0) return;

    const int32_t stride = fb_width * 3;

    for (int32_t y = 0; y < fb_height; y++) {
        uint8_t *row = frame_buffer + y * stride;
        for (int32_t x = 0; x < fb_width; x++) {
            uint8_t *px = row + x * 3;
            uint8_t r = px[0], g = px[1], b = px[2];

            // 1. 获取Bayer阈值（归一化到0~7范围，匹配5/6bit量化步长）
            uint8_t threshold = bayer8x8[(y & 7) * 8 + (x & 7)] >> 5; // 0~7

            // 2. 应用阈值偏移（模拟误差扩散的视觉效果）
            int32_t r_adj = r + quant_bias[threshold];
            int32_t g_adj = g + quant_bias[threshold];
            int32_t b_adj = b + quant_bias[threshold];

            // 3. 模拟RGB565量化并还原
            uint8_t r5 = (r_adj > 255) ? 31 : (r_adj >> 3);
            uint8_t g6 = (g_adj > 255) ? 63 : (g_adj >> 2);
            uint8_t b5 = (b_adj > 255) ? 31 : (b_adj >> 3);

            px[0] = (r5 << 3) | (r5 >> 2);
            px[1] = (g6 << 2) | (g6 >> 4);
            px[2] = (b5 << 3) | (b5 >> 2);
        }
    }
}


// ===============================================================================
// 绘制文字（临时实现）
// ===============================================================================

uint8_t *get_glyph(uint32_t utf32, uint8_t *font_width, uint8_t *font_height) {
    if(utf32 < 127) {
        *font_width = 6;
        *font_height = 12;
        return ASCII_6_12[utf32 - 32];
    }
    else {
        int32_t index = binary_search(UTF32_LUT_SORTED, UTF32_LUT_INDEXS, GLYPH_CHAR_NUM, utf32);
        if (index >= 0 && index < 7445) {
            *font_width = 12;
            *font_height = 12;
            return GB2312_12_12[index];
        }
        else {
            return NULL;
        }
    }
}

// 显示汉字
void fb_draw_char(
    uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    int32_t x, int32_t y, uint8_t *glyph, uint8_t font_width, uint8_t font_height,
    uint8_t red, uint8_t green, uint8_t blue
) {
    int32_t row_bytes = (font_height + 8 - 1) / 8;
    int32_t col_bytes = font_width;
    for (int32_t j = 0; j < row_bytes; j++) {
        int32_t bits = (j == (row_bytes-1)) ? (8 - ((8 * row_bytes) % font_height)) : 8;
        for (int32_t i = 0; i < col_bytes; i++) {
            uint8_t g = glyph[j * col_bytes + i];
            for (int32_t b = 0; b < bits; b++) {
                int32_t px = x + i;
                int32_t py = y + j*8 + b;
                if (px < 0 || px >= fb_width || py < 0 || py >= fb_height) continue;
                if ((g >> b) & 0x1) {
                    set_pixel(frame_buffer, fb_width, fb_height, px, py, red, green, blue);
                }
                else {
                    add_pixel(frame_buffer, fb_width, fb_height, px, py, 0, 0, 0);
                }
            }
        }
    }
}



// 绘制一行文本
void fb_draw_textline(
    uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    wchar_t *line, int32_t x, int32_t y, uint8_t red, uint8_t green, uint8_t blue
) {
    uint32_t x_pos = x;
    uint32_t y_pos = y;
    for (uint32_t i = 0; i < wcslen(line); i++) {
        uint32_t current_char = line[i];
        uint8_t font_width = 12;
        uint8_t font_height = 12;
        uint8_t *glyph = get_glyph(current_char, &font_width, &font_height);
        if (!glyph) {
            glyph = get_glyph(12307, &font_width, &font_height); // 用字脚符号“〓”代替，参考https://ja.wikipedia.org/wiki/下駄記号
        }
        if (x_pos + font_width >= fb_width) {
            break;
        }
        fb_draw_char(frame_buffer, fb_width, fb_height,
            x_pos, y_pos, glyph, font_width, font_height, red, green, blue);
        x_pos += font_width;
    }
}


// 绘制一行文本（居中）
void fb_draw_textline_centered(
    uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    wchar_t *line, int32_t cx, int32_t cy, uint8_t red, uint8_t green, uint8_t blue
) {
    // 第一遍扫描：计算文本渲染长度
    int32_t total_width = 0;
    for (uint32_t i = 0; i < wcslen(line); i++) {
        uint32_t current_char = line[i];
        uint8_t font_width = 12;
        uint8_t font_height = 12;
        uint8_t *glyph = get_glyph(current_char, &font_width, &font_height);
        if (!glyph) {
            glyph = get_glyph(12307, &font_width, &font_height); // 用字脚符号“〓”代替，参考https://ja.wikipedia.org/wiki/下駄記号
        }
        total_width += font_width;
    }

    // 第二遍扫描：渲染
    int32_t x_pos = cx - (total_width/2);
    int32_t y_pos = cy - 6;
    if (y_pos < 0 || y_pos + 6 > fb_height) return;
    for (uint32_t i = 0; i < wcslen(line); i++) {
        uint32_t current_char = line[i];
        uint8_t font_width = 12;
        uint8_t font_height = 12;
        uint8_t *glyph = get_glyph(current_char, &font_width, &font_height);
        if (!glyph) {
            glyph = get_glyph(12307, &font_width, &font_height); // 用字脚符号“〓”代替，参考https://ja.wikipedia.org/wiki/下駄記号
        }
        if (x_pos < 0) {
            x_pos += font_width;
            continue;
        }
        else if (x_pos + font_width > fb_width) {
            break;
        }
        fb_draw_char(frame_buffer, fb_width, fb_height,
            x_pos, y_pos, glyph, font_width, font_height, red, green, blue);
        x_pos += font_width;
    }
}






// ===============================================================================
// 绘制基本形状
// ===============================================================================

void draw_line(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float x1, float y1, float x2, float y2, float line_width, uint8_t r, uint8_t g, uint8_t b
) {
    if (line_width <= 0.0f) return;

    // 确保颜色在 [0, 255] 范围内
    uint8_t cr = MAX(0, MIN(255, r));
    uint8_t cg = MAX(0, MIN(255, g));
    uint8_t cb = MAX(0, MIN(255, b));

    float dx = x2 - x1;
    float dy = y2 - y1;
    float len_sq = dx * dx + dy * dy;

    // 退化为点：绘制圆形
    if (len_sq == 0.0f) { // TODO 与0比较
        float radius = line_width / 2.0f;
        float r_sq = radius * radius;
        int32_t xMin = MAX(0, (int32_t)floorf(x1 - radius));
        int32_t xMax = MIN(fb_width - 1, (int32_t)ceilf(x1 + radius));
        int32_t yMin = MAX(0, (int32_t)floorf(y1 - radius));
        int32_t yMax = MIN(fb_height - 1, (int32_t)ceilf(y1 + radius));

        for (int32_t y = yMin; y <= yMax; y++) {
            for (int32_t x = xMin; x <= xMax; x++) {
                float dist_sq = (float)((x - x1) * (x - x1) + (y - y1) * (y - y1));
                if (dist_sq <= r_sq) {
                    add_pixel(frame_buffer, fb_width, fb_height, x, y, cr, cg, cb);
                }
            }
        }
        return;
    }

    float len = sqrtf(len_sq);
    float inv_len = 1.0f / len;
    float nx = -dy * inv_len; // 法向量（垂直于线段）
    float ny = dx * inv_len;

    float half_w = line_width / 2.0f;

    // 包围盒（含线宽）
    int32_t xMin = MAX(0, (int32_t)floorf(MIN(x1, x2) - half_w));
    int32_t xMax = MIN(fb_width - 1, (int32_t)ceilf(MAX(x1, x2) + half_w));
    int32_t yMin = MAX(0, (int32_t)floorf(MIN(y1, y2) - half_w));
    int32_t yMax = MIN(fb_height - 1, (int32_t)ceilf(MAX(y1, y2) + half_w));

    for (int32_t y = yMin; y <= yMax; y++) {
        for (int32_t x = xMin; x <= xMax; x++) {
            // 计算点 (x, y) 到线段的有符号距离
            int32_t px = x - x1;
            int32_t py = y - y1;

            // 投影长度（参数 t）
            float t = (float)(px * dx + py * dy) / len_sq;
            int32_t closest_x = x1;
            int32_t closest_y = y1;

            if (t < 0.0f) {
                closest_x = x1;
                closest_y = y1;
            }
            else if (t > 1.0f) {
                closest_x = x2;
                closest_y = y2;
            }
            else {
                closest_x = x1 + (int32_t)(t * dx);
                closest_y = y1 + (int32_t)(t * dy);
            }

            float dist = sqrtf((float)((x - closest_x) * (x - closest_x) + (y - closest_y) * (y - closest_y)));

            if (dist > half_w) continue;

            // 抗锯齿：边缘平滑过渡
            float alpha = 1.0f;
            float edge_fade = 1.0; // 像素，可调
            if (dist > half_w - edge_fade) {
                alpha = (half_w - dist) / edge_fade;
                alpha = MAX(0.0f, MIN(1.0f, alpha));
            }
            add_pixel(frame_buffer, fb_width, fb_height, x, y, cr * alpha, cg * alpha, cb * alpha);
        }
    }
}


void draw_circle_outline(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float cx, float cy, float radius, float line_weight, uint8_t red, uint8_t green, uint8_t blue
) {
    if (radius <= 0.0f || line_weight <= 0.0f) return;

    uint8_t r = MAX(0, MIN(255, red));
    uint8_t g = MAX(0, MIN(255, green));
    uint8_t b = MAX(0, MIN(255, blue));

    // 计算内外半径（考虑线宽居中）
    float halfWeight = line_weight / 2.0f;
    float outerR = radius + halfWeight;
    float innerR = MAX(0, radius - halfWeight);

    float outerRSq = outerR * outerR;
    float innerRSq = innerR * innerR;

    // 包围盒（含线宽）
    int32_t xMin = MAX(0, (int32_t)floorf(cx - outerR));
    int32_t xMax = MIN(fb_width - 1, (int32_t)ceilf(cx + outerR));
    int32_t yMin = MAX(0, (int32_t)floorf(cy - outerR));
    int32_t yMax = MIN(fb_height - 1, (int32_t)ceilf(cy + outerR));

    for (int32_t y = yMin; y <= yMax; y++) {
        for (int32_t x = xMin; x <= xMax; x++) {
            float dx = x - cx;
            float dy = y - cy;
            float distSq = dx * dx + dy * dy;

            // 判断是否在环形区域内（包含外边界，排除内边界）
            if (distSq < outerRSq && distSq >= innerRSq) {
                add_pixel(frame_buffer, fb_width, fb_height, x, y, r, g, b);
            }
        }
    }
}

// 画实心圆形
void draw_circle(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float cx, float cy, float radius, uint8_t red, uint8_t green, uint8_t blue
) {
    if (radius <= 0.0f) return;

    uint8_t r = MAX(0, MIN(255, red));
    uint8_t g = MAX(0, MIN(255, green));
    uint8_t b = MAX(0, MIN(255, blue));

    float outerRSq = radius * radius;

    // 包围盒（含线宽）
    int32_t xMin = MAX(0, (int32_t)floorf(cx - radius));
    int32_t xMax = MIN(fb_width - 1, (int32_t)ceilf(cx + radius));
    int32_t yMin = MAX(0, (int32_t)floorf(cy - radius));
    int32_t yMax = MIN(fb_height - 1, (int32_t)ceilf(cy + radius));

    for (int32_t y = yMin; y <= yMax; y++) {
        for (int32_t x = xMin; x <= xMax; x++) {
            float dx = x - cx;
            float dy = y - cy;
            float distSq = dx * dx + dy * dy;

            // 判断是否在区域内
            if (distSq < outerRSq) {
                add_pixel(frame_buffer, fb_width, fb_height, x, y, r, g, b);
            }
        }
    }
}

// 画实心矩形
void draw_rect(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float x0, float y0, float width, float height, uint8_t red, uint8_t green, uint8_t blue
) {
    uint8_t r = MAX(0, MIN(255, red));
    uint8_t g = MAX(0, MIN(255, green));
    uint8_t b = MAX(0, MIN(255, blue));
    for (int32_t y = y0; y < y0+height; y++) {
        for (int32_t x = x0; x < x0+width; x++) {
            set_pixel(frame_buffer, fb_width, fb_height, x, y, r, g, b);
        }
    }
}

// 地面填充纯黑色
void draw_horizon(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height, float sky_radius, float center_x, float center_y) {
    float margin = 6.0f;
    float R_sq = sky_radius * sky_radius;
    float R_margin_sq = (sky_radius - margin) * (sky_radius - margin);
    for (int32_t y = 0; y < fb_height; y++) {
        for (int32_t x = 0; x < fb_width; x++) {
            float dx = (float)x - center_x;
            float dy = (float)y - center_y;
            float r2 = dx * dx + dy * dy;
            if (r2 > R_sq) {
                set_pixel(frame_buffer, fb_width, fb_height, x, y, 0, 0, 0);
            }
            else if (r2 >= R_margin_sq && r2 < R_sq) {
                float k = 1.0f - (sqrtf(r2) - (sky_radius - margin)) / margin;
                scale_pixel(frame_buffer, fb_width, fb_height, x, y, k);
            }
        }
    }
}

// ===============================================================================
// 绘制坐标系
// ===============================================================================

/**
 * 绘制赤道坐标系下的子午圈或纬度圈（投影到地平屏幕）
 * @param frame_buffer - 帧缓冲区
 * @param fb_width - 缓冲区宽度
 * @param fb_height - 缓冲区高度
 * @param is_meridian - 1: 子午圈（固定RA）；0: 纬度圈（固定Dec）
 * @param ra_hours - 子午圈的赤经（小时），仅当 is_meridian=1 时有效
 * @param dec_deg - 纬度圈的赤纬（度），仅当 is_meridian=0 时有效
 * @param line_weight - 线宽（像素），建议 ≥1
 * @param colorR, colorG, colorB - RGB 颜色分量 [0-255]
 * @param year, month, day, hour, minute, second, timezone, longitude, latitude - 观测参数
 */
void draw_celestial_circle(
    uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float sky_radius, float center_x, float center_y,
    int32_t is_meridian, float ra_hours, float dec_deg,
    int32_t line_weight, uint8_t colorR, uint8_t colorG, uint8_t colorB,
    int32_t year, int32_t month, int32_t day, int32_t hour, int32_t minute, int32_t second,
    double timezone, double longitude, double latitude
) {
    int32_t POINTS = 360; // 提高采样密度以获得更平滑曲线

    float x_prev = 0.0f;
    float y_prev = 0.0f;
    double alt_prev = 0.0f;
    float x_0 = 0.0f;
    float y_0 = 0.0f;
    double alt_0 = 0.0f;

    // 子午圈：固定 RA，遍历 Dec ∈ [-90°, +90°]
    if (is_meridian) {
        if (ra_hours < 0.0f || ra_hours > 24.0f) return;
        float ra_deg = fmodf(ra_hours, 24.0f) * 15.0f;
        double alt = 0.0;
        double azi = 0.0;
        for (int32_t i = 0; i <= POINTS; i++) {
            float dec = -90.0f + (180.0f * (float)i / (float)POINTS);
            equatorial_to_horizontal((double)ra_deg, (double)dec, year, month, day, hour, minute, second, timezone, longitude, latitude, &azi, &alt);

            if (alt > 0.0) {
                float x = 0.0f;
                float y = 0.0f;
                horizontal_to_screen_xy(azi, alt, sky_radius, center_x, center_y, &x, &y);

                if (i == 0) {
                    x_0 = x;
                    y_0 = y;
                    alt_0 = alt;
                }
                
                if (alt_prev > 0.0 && alt > 0.0) {
                    draw_line(frame_buffer, fb_width, fb_height, x_prev, y_prev, x, y, line_weight, colorR, colorG, colorB);
                }

                x_prev = x;
                y_prev = y;
                alt_prev = alt;
            }
        }
        if (alt_0 > 0.0 && alt > 0.0) {
            draw_line(frame_buffer, fb_width, fb_height, x_prev, y_prev, x_0, y_0, line_weight, colorR, colorG, colorB);
        }
    }
    // 纬度圈：固定 Dec，遍历 RA ∈ [0h, 24h)
    else {
        if (dec_deg < -90.0f || dec_deg > 90.0f) return;
        double alt = 0.0;
        double azi = 0.0;
        for (int32_t i = 0; i <= POINTS; i++) {
            float ra_h = 24.0f * (float)i / (float)POINTS;
            float ra_deg = fmodf(ra_h, 24.0f) * 15.0f;

            equatorial_to_horizontal((double)ra_deg, (double)dec_deg, year, month, day, hour, minute, second, timezone, longitude, latitude, &azi, &alt);

            if (alt > 0.0) {
                float x = 0.0f;
                float y = 0.0f;
                horizontal_to_screen_xy(azi, alt, sky_radius, center_x, center_y, &x, &y);

                if (i == 0) {
                    x_0 = x;
                    y_0 = y;
                    alt_0 = alt;
                }

                if (alt_prev > 0.0 && alt > 0.0) {
                    draw_line(frame_buffer, fb_width, fb_height, x_prev, y_prev, x, y, line_weight, colorR, colorG, colorB);
                }

                x_prev = x;
                y_prev = y;
                alt_prev = alt;
            }
        }
        if (alt_0 > 0.0 && alt > 0.0) {
            draw_line(frame_buffer, fb_width, fb_height, x_prev, y_prev, x_0, y_0, line_weight, colorR, colorG, colorB);
        }
    }
}


// ===============================================================================
// 绘制天体
// ===============================================================================

void render_sun(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float sky_radius, float center_x, float center_y,
    float sun_proj_x, float sun_proj_y, float sun_altitude_deg
) {

    float sun_radius = sky_radius * 0.02;

    // 太阳半径（随高度变化）：地平线附近略大
    float radius = MAX(6.0f, sun_radius) * (1.0f + 0.2f * MAX(0.0f, 1.0f - sun_altitude_deg / 10.0f));

    // 光晕半径
    int32_t glow_radius = 20;

    // 太阳颜色：随高度从红→黄→白
    uint8_t r = 0;
    uint8_t g = 0;
    uint8_t b = 0;
    // 接近地平线：深红到橙
    if (sun_altitude_deg < 5.0f) {
        float t = MIN(1.0f, MAX(0.0f, sun_altitude_deg) / 5.0f);
        r = 255;
        g = (uint8_t)roundf(160.0f * t);
        b = (uint8_t)roundf(40.0f * t);
    }
    // 低空：橙黄
    else if (sun_altitude_deg < 15.0f) {
        float t = (sun_altitude_deg - 5.0f) / 10.0f;
        r = 255;
        g = (uint8_t)roundf(160.0f + 95 * t);
        b = (uint8_t)roundf(40.0f + 60 * t);
    }
    // 中天：白色
    else {
        r = 255;
        g = 255;
        b = 255;
    }

    // 抗锯齿边缘宽度
    float edgeSmoothWidth = 1.0f;

    // 绘制太阳本体（带软边缘）
    for (int32_t dy = -glow_radius; dy <= glow_radius; dy++) {
        for (int32_t dx = -glow_radius; dx <= glow_radius; dx++) {
            float dist = sqrtf(dx * dx + dy * dy);
            int32_t px = (int32_t)floorf(sun_proj_x + (float)dx);
            int32_t py = (int32_t)floorf(sun_proj_y + (float)dy);
            if (px < 0 || px >= fb_width || py < 0 || py >= fb_height) continue;

            // 太阳光晕（指数衰减）
            float glow = 0.0f;
            if (dist > radius && dist <= (float)glow_radius) {
                // 光晕强度随距离衰减
                glow = expf(-(dist / (float)glow_radius) * 3.0f);
            }

            // 太阳本体（带抗锯齿）
            float diskWeight = 0.0f;
            if (dist <= radius + edgeSmoothWidth) {
                if (dist <= radius - edgeSmoothWidth) {
                    diskWeight = 1.0f;
                }
                else if (dist < radius + edgeSmoothWidth) {
                    float t = (radius + edgeSmoothWidth - dist) / (2.0f * edgeSmoothWidth);
                    diskWeight = MAX(0.0f, MIN(1.0f, t * t * (3.0f - 2.0f * t)));
                }
            }

            // 合并：中心最亮（diskWeight=1），向外过渡到光晕
            float totalR = diskWeight * r + glow * r;
            float totalG = diskWeight * g + glow * g;
            float totalB = diskWeight * b + glow * b;

            add_pixel(frame_buffer, fb_width, fb_height, px, py, totalR, totalG, totalB);
        }
    }
}


// 基于球面几何晨昏线的月相绘制（带物理合理的软边缘）
void render_moon(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float sky_radius, float center_x, float center_y,
    int32_t year, int32_t month, int32_t day, int32_t hour, int32_t minute, int32_t second,
    double timezone, double longitude, double latitude
) {
    float lum = 0.8f;

    // 计算月球位置、月相、月球方向角
    double moon_azi = 0.0;
    double moon_alt = 0.0;
    double moon_RA = 0.0;
    double moon_Dec = 0.0;
    double jd = julian_day(year, month, day, hour, minute, second, timezone);
    calculate_lunar_equatorial_coordinates(jd, &moon_RA, &moon_Dec);

    equatorial_to_horizontal(
        moon_RA, moon_Dec, year, month, day, hour, minute, second, timezone,
        longitude, latitude,
        &moon_azi, &moon_alt
    );

    // 计算月球的屏幕投影坐标
    float moon_scr_x = 0.0f;
    float moon_scr_y = 0.0f;
    horizontal_to_screen_xy(moon_azi, moon_alt, sky_radius, center_x, center_y, &moon_scr_x, &moon_scr_y);

    // 以下是计算月面贴图的北极（月球地理北极）相对于屏幕y轴的旋转角
    // 这一步是旋转月球地理北极，使其指向其所在的天球子午圈北向切线方向，为后面计算月球亮区旋转角作准备
    // 天球赤道坐标系经圈（子午圈）上，月亮所在位置往北2度的位置，在屏幕上的投影坐标
    double northdelta_azi = 0.0;
    double northdelta_alt = 0.0;
    float northdelta_scr_x = 0.0f;
    float northdelta_scr_y = 0.0f;
    equatorial_to_horizontal(
        moon_RA, moon_Dec + 2, year, month, day, hour, minute, second, timezone,
        longitude, latitude,
        &northdelta_azi, &northdelta_alt
    );
    horizontal_to_screen_xy(northdelta_azi, northdelta_alt, sky_radius, center_x, center_y, &northdelta_scr_x, &northdelta_scr_y);

    float xa = moon_scr_x;
    float ya = moon_scr_y;
    float xb = northdelta_scr_x;
    float yb = northdelta_scr_y;
    // 计算月面贴图的北极（月球地理北极）相对于屏幕y轴的旋转角
    float tilt_rad = atan2f(xb-xa, -(yb-ya)); // 屏幕坐标系y向下为正
    float tilt_deg = normalize_angle_float(to_deg_float(tilt_rad));

    // 月面视圆盘的亮区拱点，在天球赤道坐标系背景上，相对于天北极方向向东的偏转角度
    float bright_pos_deg = (float)moon_bright_limb_pos_angle(year, month, day, hour, minute, second, timezone);
    bright_pos_deg = normalize_angle_float(bright_pos_deg);
    // 假定月面亮区两端永远是月球的地理南北极
    tilt_deg = normalize_angle_float(tilt_deg - (bright_pos_deg-90)); // NOTE 仰视东西颠倒；亮区拱点和亮区的尖尖相差90度

    // 月相
    float moon_i = (float)moon_phase(year, month, day, hour, minute, second, timezone);
    // float moon_k = (1 + cosf(moon_i)) / 2;
    float phase_deg = normalize_angle_float(moon_i - 90);
    float cosPhase = cosf(to_rad_float(phase_deg));
    float sinPhase = sinf(to_rad_float(phase_deg));
    float sunDirX = cosPhase * cosf(to_rad_float(tilt_deg));
    float sunDirY = cosPhase * sinf(to_rad_float(tilt_deg));
    float sunDirZ = sinPhase;

    float sunLen = sqrtf(sunDirX * sunDirX + sunDirY * sunDirY + sunDirZ * sunDirZ);
    float sunUnitX = (sunLen > 0.0f) ? (sunDirX / sunLen) : 1.0f;
    float sunUnitY = (sunLen > 0.0f) ? (sunDirY / sunLen) : 0.0f;
    float sunUnitZ = (sunLen > 0.0f) ? (sunDirZ / sunLen) : 0.0f;

    // 颜色与环境光
    // const litColor = [220, 220, 200];
    // const darkColor = [10, 10, 20];
    float ambient = 0.01f;

    // 半影角宽度（弧度）
    float PENUMBRA_HALF_ANGLE = 0.2f;

    // 抗锯齿过渡带宽度（像素）
    float edgeSmoothWidth = 1.0f;

    // 显示直径
    float moonRadius = sky_radius * 0.08;

    float r2 = moonRadius * moonRadius;
    for (int32_t dy = -(int32_t)moonRadius; dy <= (int32_t)moonRadius; dy++) {
        for (int32_t dx = -(int32_t)moonRadius; dx <= (int32_t)moonRadius; dx++) {
            float distance = sqrtf((float)(dx * dx + dy * dy));
            if (distance > moonRadius + edgeSmoothWidth) continue;

            int32_t px = (int32_t)floorf(moon_scr_x + (float)dx);
            int32_t py = (int32_t)floorf(moon_scr_y + (float)dy);
            if (px < 0 || px >= fb_width || py < 0 || py >= fb_height) continue;

            // 计算抗锯齿权重（基于圆盘覆盖比例）
            float moonWeight = 1.0f;
            if (distance <= moonRadius - edgeSmoothWidth) {
                moonWeight = 1.0; // 完全在内部
            }
            else if (distance >= moonRadius + edgeSmoothWidth) {
                moonWeight = 0.0; // 完全在外部（应跳过，但保留以防边界误差）
                continue;
            }
            else {
                // 平滑过渡 [moonRadius - w, moonRadius + w]
                float t = (moonRadius + edgeSmoothWidth - distance) / (2.0f * edgeSmoothWidth);
                moonWeight = MAX(0.0f, MIN(1.0f, t)); // 线性插值，也可用更平滑：moonWeight = t * t * (3 - 2 * t);
            }

            if (moonWeight <= 0) continue;


            int32_t idx = (py * fb_width + px) * 3;

            // 构造单位球面上的表面点（归一化位置向量 = 法向量）
            float len = sqrtf(dx * dx + dy * dy + r2 - dx * dx - dy * dy); // = moonRadius
            // 实际上，(dx, dy, dz) 在半径为 moonRadius 的球面上，所以单位向量为：
            float nx = (float)dx / moonRadius;
            float ny = (float)dy / moonRadius;
            float nz = sqrtf(MAX(0.0f, r2 - dx * dx - dy * dy)) / moonRadius;

            // 关键：计算该点与晨昏线（太阳方向与月球中心构成的大圆）的球面角距离
            // 点积 dot = cos(θ)，其中 θ 是表面点与太阳方向的夹角
            float dot = nx * sunUnitX + ny * sunUnitY + nz * sunUnitZ;
            float angle_from_terminator = acosf(MAX(-1.0f, MIN(1.0f, dot))) - M_PI_2; // ∈ [-π/2, π/2]

            // 软边缘判断
            float intensity = 1.0f;
            if (angle_from_terminator >= PENUMBRA_HALF_ANGLE) {
                intensity = 1.0; // 完全照亮
            }
            else if (angle_from_terminator <= -PENUMBRA_HALF_ANGLE) {
                intensity = ambient; // 完全背光
            }
            else {
                // 映射到 [0,1]
                float t = (angle_from_terminator + PENUMBRA_HALF_ANGLE) / (2.0f * PENUMBRA_HALF_ANGLE);
                float smoothT = t * t * (3.0f - 2.0f * t); // smoothstep
                intensity = ambient + (1.0f - ambient) * smoothT;
            }

            // 调整全局亮度
            intensity *= lum;

            // 纹理映射：先绕 Z 轴旋转 -alpha，再映射到经纬度
            float u_norm = (float)dx / moonRadius;   // ∈ [-1, 1]
            float v_norm = (float)dy / moonRadius;   // ∈ [-1, 1]

            // 绕原点旋转 -alpha（使贴图随光照方向对齐）
            float cosA = cosf(-to_rad_float(tilt_deg));
            float sinA = sinf(-to_rad_float(tilt_deg));
            float u_rot = u_norm * cosA - v_norm * sinA;
            float v_rot = u_norm * sinA + v_norm * cosA;

            // 映射到 [0,1] 贴图空间
            float u = (u_rot + 1.0f) * 0.5f; // [-1,1] → [0,1]
            float v = (v_rot + 1.0f) * 0.5f;

            // 可选：限制在 [0,1] 内（避免边缘采样异常）
            if (u < 0.0f || u > 1.0f || v < 0.0f || v > 1.0f) {
                // 可选择 clamp 或 skip；这里 clamp 更安全
                u = MAX(0.0f, MIN(1.0f, u));
                v = MAX(0.0f, MIN(1.0f, v));
            }

            // 双线性采样
            float tx = u * (float)moon_texture_width - 0.5f;
            float ty = v * (float)moon_texture_height - 0.5f;

            int32_t x0 = (int32_t)floorf(tx);
            int32_t y0 = (int32_t)floorf(ty);
            int32_t x1 = (x0 + 1) % moon_texture_width;
            int32_t y1 = MIN(y0 + 1, moon_texture_height - 1);

            float wx = tx - (float)x0;
            float wy = ty - (float)y0;

            uint8_t c00_r = get_pixel_channel(moon_texture_rgba, moon_texture_width, x0, y0, 0);
            uint8_t c00_g = get_pixel_channel(moon_texture_rgba, moon_texture_width, x0, y0, 1);
            uint8_t c00_b = get_pixel_channel(moon_texture_rgba, moon_texture_width, x0, y0, 2);

            uint8_t c10_r = get_pixel_channel(moon_texture_rgba, moon_texture_width, x1, y0, 0);
            uint8_t c10_g = get_pixel_channel(moon_texture_rgba, moon_texture_width, x1, y0, 1);
            uint8_t c10_b = get_pixel_channel(moon_texture_rgba, moon_texture_width, x1, y0, 2);

            uint8_t c01_r = get_pixel_channel(moon_texture_rgba, moon_texture_width, x0, y1, 0);
            uint8_t c01_g = get_pixel_channel(moon_texture_rgba, moon_texture_width, x0, y1, 1);
            uint8_t c01_b = get_pixel_channel(moon_texture_rgba, moon_texture_width, x0, y1, 2);

            uint8_t c11_r = get_pixel_channel(moon_texture_rgba, moon_texture_width, x1, y1, 0);
            uint8_t c11_g = get_pixel_channel(moon_texture_rgba, moon_texture_width, x1, y1, 1);
            uint8_t c11_b = get_pixel_channel(moon_texture_rgba, moon_texture_width, x1, y1, 2);

            // bilinear interpolation
            float r0 = (float)c00_r + wx * (float)(c10_r - c00_r);
            float g0 = (float)c00_g + wx * (float)(c10_g - c00_g);
            float b0 = (float)c00_b + wx * (float)(c10_b - c00_b);

            float r1 = (float)c01_r + wx * (float)(c11_r - c01_r);
            float g1 = (float)c01_g + wx * (float)(c11_g - c01_g);
            float b1 = (float)c01_b + wx * (float)(c11_b - c01_b);

            float texR = r0 + wy * (r1 - r0);
            float texG = g0 + wy * (g1 - g0);
            float texB = b0 + wy * (b1 - b0);

            // 应用光照强度
            float r = roundf(texR * intensity);
            float g = roundf(texG * intensity);
            float b = roundf(texB * intensity);

            add_pixel(frame_buffer, fb_width, fb_height, px, py, moonWeight * r, moonWeight * g, moonWeight * b);
        }
    }
}


void draw_star(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float sky_radius, float center_x, float center_y,
    float sx, float sy, float magnitude, float radius, uint8_t red, uint8_t green, uint8_t blue
) {

    int32_t maxGlowRadius = 1; // 光晕最大半径（像素）

    float starLumBase = magnitude_to_relative_luminance(magnitude);

    // 获取背景亮度用于对比度抑制
    int32_t bgIdx = ((int32_t)sy * fb_width + (int32_t)sx) * 3;
    float bgR = frame_buffer[bgIdx] / 255.0f;
    float bgG = frame_buffer[bgIdx + 1] / 255.0f;
    float bgB = frame_buffer[bgIdx + 2] / 255.0f;
    float bgLum = get_luminance(bgR, bgG, bgB);

    // 遍历光晕区域（正方形包围圆）
    int32_t R = (int32_t)radius + maxGlowRadius;
    for (int32_t dy = -R; dy <= R; dy++) {
        for (int32_t dx = -R; dx <= R; dx++) {
            float dist = sqrtf(dx * dx + dy * dy);
            if (dist > (float)R) continue;

            int32_t px = (int32_t)roundf(sx + (float)dx);
            int32_t py = (int32_t)roundf(sy + (float)dy);
            if (px < 0 || px >= fb_width || py < 0 || py >= fb_height) continue;

            int32_t idx = (py * fb_width + px) * 3;

            float starLum = 0.0f;
            if (dist <= radius) {
                starLum = starLumBase;
            }
            // 光晕衰减
            else if (dist > radius) {
                starLum = starLumBase * expf(-dist * 1.0f);
            }

            // 对比度抑制：白天背景亮时，星星和光晕都应被压制
            float contrast = starLum / (bgLum + 0.001f);
            float visibility = 1.0f;
            if (contrast < 1.0f) {
                // visibility = Math.pow(contrast, 3);
                visibility = contrast * contrast * contrast;
            }
            starLum *= visibility;

            // 转为 0–255 范围
            uint8_t r = MIN(255, (uint8_t)floorf(starLum * (float)red));
            uint8_t g = MIN(255, (uint8_t)floorf(starLum * (float)green));
            uint8_t b = MIN(255, (uint8_t)floorf(starLum * (float)blue));

            // 叠加到 RGB（保持白色光晕，可改为彩色）
            frame_buffer[idx + 0] = (uint8_t)MIN(255, frame_buffer[idx + 0] + r);
            frame_buffer[idx + 1] = (uint8_t)MIN(255, frame_buffer[idx + 1] + g);
            frame_buffer[idx + 2] = (uint8_t)MIN(255, frame_buffer[idx + 2] + b);
        }
    }
}



// ===============================================================================
// 散射
// ===============================================================================

// 计算大气散射强度
void calculate_scattered_pixel(
    float ray_x, float ray_y, float ray_z, float sun_x, float sun_y, float sun_z,
    float *red, float *green, float *blue,
    int32_t enable_opt_lut
) {

    // 视线向量归一化
    float ray_length = sqrtf(ray_x * ray_x + ray_y * ray_y + ray_z * ray_z);
    if (ray_length == 0.0f) {
        *red = 0;
        *green = 0;
        *blue = 0;
        return;
    }
    float ray_norm_x = ray_x / ray_length;
    float ray_norm_y = ray_y / ray_length;
    float ray_norm_z = ray_z / ray_length;


    // 太阳方向归一化
    float sun_vec_radius = sqrtf(sun_x * sun_x + sun_y * sun_y + sun_z * sun_z);
    if (sun_vec_radius == 0.0f) {
        *red = 0;
        *green = 255.0;
        *blue = 0;
        return;
    }
    float sun_norm_x = sun_x / sun_vec_radius;
    float sun_norm_y = sun_y / sun_vec_radius;
    float sun_norm_z = sun_z / sun_vec_radius;


    // 太阳光入射路径：计算仰角、天顶角、大气光学质量
    float sun_altitude = asinf(MAX(-1.0f, MIN(1.0f, sun_norm_z))); // [-π/2, π/2]
    float sun_altitude_deg = sun_altitude * 180.0f / M_PI;
    float sun_zenith = M_PI_2 - sun_altitude; // [0, π]
    float sun_zenith_deg = 90.0f - sun_altitude_deg;
    float sun_air_mass = 0.0f;
    // Kasten-Young, Ref. https://kexue.fm/archives/396
    if (sun_altitude_deg >= 0.0f) {
        sun_air_mass = (enable_opt_lut) ?
                        AIR_MASS_LUT[(int32_t)floorf(sun_zenith_deg)] :
                        (1.0f / (cosf(sun_zenith) + 0.50572f * powf(96.07995f - sun_zenith_deg, -1.6364f)));
    }
    else {
        sun_air_mass = 40.0f;
    }


    // 观察者视线的仰角、天顶角、大气光学质量
    float view_zenith = acosf(MAX(0.0f, MIN(1.0f, ray_norm_z)));
    float view_zenith_deg = view_zenith * 180.0f / M_PI;
    float view_altitude_deg = 90.0f - view_zenith_deg;
    float view_air_mass = 0.0f;
    // Kasten-Young
    if (view_altitude_deg >= 0.0f) {
        view_air_mass = (enable_opt_lut) ? AIR_MASS_LUT[(int32_t)floorf(view_zenith_deg)] :
                        (1.0f / (cosf(view_zenith) + 0.50572f * powf(96.07995f - view_zenith_deg, -1.6364f)));
    }
    else {
        view_air_mass = 40.0f;
    }


    // 观察方向与太阳方向夹角余弦
    float cos_theta = ray_norm_x * sun_norm_x + ray_norm_y * sun_norm_y + ray_norm_z * sun_norm_z;


    // 米氏散射相函数
    float mie_phase = powf(1.0f + MIE_G * MIE_G - 2.0f * MIE_G * cos_theta, -1.5f);


    // 瑞利散射相函数
    float rayleigh_phase = (1.0f + cos_theta * cos_theta) * 0.75f;


    // 计算视线方向的大气密度系数：直觉上来看，密度越大，对散射的贡献越大
    float rz = MAX(0.01, ray_norm_z); // 避免除零
    float density_factor = expf(-rz / ATMOSPHERE_HEIGHT);


    // 瑞利散射系数：分波长（RGB通道）计算
    // rayleigh_beta_at_wavelength[i] = RAYLEIGH_BETA * Math.pow(rayleigh_ref_wavelength / RAYLEIGH_WAVELENGTH_FACTORS[i], 4);
    float rayleigh_ref_wavelength = RAYLEIGH_WAVELENGTH_FACTORS[1]; // G分量作为参考波长
    float wl_0 = rayleigh_ref_wavelength / RAYLEIGH_WAVELENGTH_FACTORS[0]; // R
    float wl_1 = rayleigh_ref_wavelength / RAYLEIGH_WAVELENGTH_FACTORS[1]; // G
    float wl_2 = rayleigh_ref_wavelength / RAYLEIGH_WAVELENGTH_FACTORS[2]; // B

    float rayleigh_beta_0 = RAYLEIGH_BETA * wl_0 * wl_0 * wl_0 * wl_0; // R
    float rayleigh_beta_1 = RAYLEIGH_BETA * wl_1 * wl_1 * wl_1 * wl_1; // G
    float rayleigh_beta_2 = RAYLEIGH_BETA * wl_2 * wl_2 * wl_2 * wl_2; // B


    // 米氏散射系数：地平线附近，气溶胶浓度剧增（用viewAirMass模拟），米氏散射贡献显著上升
    float mie_beta = MIN(MIE_BETA_MAX, MIE_BETA_BASE * view_air_mass);


    // 计算每个通道的散射强度
    
    float mie_contrib = mie_beta * mie_phase;

    float rayleigh_contrib_0 = rayleigh_beta_0 * rayleigh_phase;
    float rayleigh_contrib_1 = rayleigh_beta_1 * rayleigh_phase;
    float rayleigh_contrib_2 = rayleigh_beta_2 * rayleigh_phase;

    float attn_scale = (enable_opt_lut) ?
                        ATTN_SCALE_LUT[(int32_t)floorf(sun_altitude_deg) + 90] :
                        ((sun_altitude_deg >= 0) ? (expf(-powf((sun_altitude_deg / 20.0f), 4.0f)) + 0.01f) : (1.0f));

    float attn_0 = expf(-(rayleigh_beta_0 + mie_beta) * view_air_mass * attn_scale);
    float attn_1 = expf(-(rayleigh_beta_1 + mie_beta) * view_air_mass * attn_scale);
    float attn_2 = expf(-(rayleigh_beta_2 + mie_beta) * view_air_mass * attn_scale);

    float ozone_transmittance_0 = expf(-OZONE_ABSORPTION[0] * sun_air_mass * 0.8);
    float ozone_transmittance_1 = expf(-OZONE_ABSORPTION[1] * sun_air_mass * 0.8);
    float ozone_transmittance_2 = expf(-OZONE_ABSORPTION[2] * sun_air_mass * 0.8);

    float scattered_0 = (rayleigh_contrib_0 + mie_contrib) * attn_0 * ozone_transmittance_0 * density_factor;
    float scattered_1 = (rayleigh_contrib_1 + mie_contrib) * attn_1 * ozone_transmittance_1 * density_factor;
    float scattered_2 = (rayleigh_contrib_2 + mie_contrib) * attn_2 * ozone_transmittance_2 * density_factor;

    // 太阳落到地平线以下时，进一步衰减散射光
    float night_attn = (enable_opt_lut) ?
                        NIGHT_ATTN_LUT[(int32_t)floorf(sun_altitude_deg) + 90] :
                        ((sun_altitude_deg >= 0) ? (1.0f) : MAX(0.0f, expf(0.016f * sun_altitude_deg)));
    scattered_0 *= night_attn;
    scattered_1 *= night_attn;
    scattered_2 *= night_attn;

    // 全局增益、限幅、输出
    const float global_gain = 2.0;
    *red   = MIN(1.0f, scattered_0 * global_gain);
    *green = MIN(1.0f, scattered_1 * global_gain);
    *blue  = MIN(1.0f, scattered_2 * global_gain);
}

// ===============================================================================
// 渲染整个天空
// ===============================================================================

void render_sky(uint8_t *frame_buffer, int32_t fb_width, int32_t fb_height,
    float sky_radius, float center_x, float center_y,
    int32_t year, int32_t month, int32_t day, int32_t hour, int32_t minute, int32_t second,
    double timezone, double longitude, double latitude,
    int32_t downsampling_factor,     // 降采样因子（设为0为自动，建议设为2）
    int32_t enable_opt_sym,          // 是否启用基于对称性的渲染优化（以画质为代价）
    int32_t enable_opt_lut,          // 是否启用基于对称性的渲染优化（以画质为代价）

    int32_t enable_equatorial_coord, // 是否启用赤道坐标圈
    int32_t enable_horizontal_coord, // 是否启用地平坐标圈
    int32_t enable_star_burst,       // 是否启用星芒效果
    int32_t enable_atmospheric_scattering, // 是否启用大气散射效果
    int32_t enable_star_name,        // 是否显示恒星名称
    int32_t enable_planet,           // 是否显示大行星
    int32_t enable_planet_name       // 是否显示大行星名称
) {

    if (fb_width < (int32_t)sky_radius * 2 || fb_height < (int32_t)sky_radius * 2 ||
        center_x < (int32_t)sky_radius || (fb_width - center_x) < (int32_t)sky_radius ||
        center_y < (int32_t)sky_radius || (fb_height - center_y) < (int32_t)sky_radius
    ) {
        return;
    }

    float diameter = sky_radius * 2;

    // 计算太阳位置
    double sun_azi = 0.0;
    double sun_alt = 0.0;
    where_is_the_sun(year, month, day, hour, minute, second, timezone, longitude, latitude, &sun_azi, &sun_alt);

    // 夜晚默认启用查找表
    if (sun_alt < -18.0f) enable_opt_lut = 1;

    float sun_x = 0.0f;
    float sun_y = 0.0f;
    float sun_z = 0.0f;
    horizontal_to_xyz(sun_azi, sun_alt, sky_radius, &sun_x, &sun_y, &sun_z);

    float sun_proj_x = 0.0f;
    float sun_proj_y = 0.0f;
    horizontal_to_screen_xy(sun_azi, sun_alt, sky_radius, center_x, center_y, &sun_proj_x, &sun_proj_y);

    // 天空绘制范围的屏幕坐标
    int32_t y1 = (int32_t)floorf(center_y - sky_radius);
    int32_t y2 = (int32_t)floorf(center_y + sky_radius);
    int32_t x1 = (int32_t)floorf(center_x - sky_radius);
    int32_t x2 = (int32_t)floorf(center_x + sky_radius);

    // 大气散射
    int32_t _downsampling_factor = (downsampling_factor == 0) ? ((sun_alt < -18.0) ? 8 : 2) : (downsampling_factor); // 降采样倍数
    if (enable_atmospheric_scattering) {
        if (enable_opt_sym) {
            for (int32_t y = y1; y < y2; y += 2) {
                for (int32_t x = x1; x < x2; x += 2) {
                    // 计算太阳与圆心的连线法向量，进而计算半圆范围和镜像点坐标
                    float dx = sun_proj_x - center_x;
                    float dy = sun_proj_y - center_y;
                    float t = (((float)x - center_x) * dx + ((float)y - center_y) * dy) / (dx * dx + dy * dy);
                    int32_t xx = (int32_t)floorf(center_x * 2 + 2 * t * dx - (float)x);
                    int32_t yy = (int32_t)floorf(center_y * 2 + 2 * t * dy - (float)y);

                    if ((xx - center_x) * (xx - center_x) + (yy - center_y) * (yy - center_y) > sky_radius * sky_radius ||
                        (x - center_x) * (x - center_x) + (y - center_y) * (y - center_y) > sky_radius * sky_radius
                    ) {
                        continue;
                    }

                    float c0 = (-center_x) * dy - (-center_y) * dx;
                    float nx = (c0 > 0) ? (dy) : (-dy);
                    float ny = (c0 > 0) ? (-dx) : (dx);

                    float dp = nx * (x - center_x) + ny * (y - center_y);

                    if (dp >= 0) {
                        // 观察者到该像素的方向向量（从屏幕坐标系转回地平天球的笛卡尔坐标系）
                        float ray_x = 0.0f;
                        float ray_y = 0.0f;
                        float ray_z = 0.0f;
                        int32_t on_sphere = screen_xy_to_xyz((float)x, (float)y, sky_radius, center_x, center_y, &ray_x, &ray_y, &ray_z);

                        float red = 0.0f;
                        float green = 0.0f;
                        float blue = 0.0f;
                        if (on_sphere > 0) {
                            calculate_scattered_pixel(ray_x, ray_y, ray_z, sun_x, sun_y, sun_z, &red, &green, &blue, enable_opt_lut);
                        }

                        uint8_t rr = (uint8_t)(red * 255.0f);
                        uint8_t gg = (uint8_t)(green * 255.0f);
                        uint8_t bb = (uint8_t)(blue  * 255.0f);

                        // 为了补偿上下错位而引入的启发式偏置。通过实验确定，原因不明，可能跟浮点数舍入有关。
                        float k = dy/dx;
                        int32_t offset_x = (k <  1.0f && k >= 0.0f) ? 1 : 0;
                        int32_t offset_y = (k >= 1.0f) ? 1 : 0;

                        for (int32_t i = 0; i < 3; i++) {
                            for (int32_t j = 0; j < 3; j++) {
                                set_pixel(frame_buffer, fb_width, fb_height, (x+i), (y+j), rr, gg, bb);
                                set_pixel(frame_buffer, fb_width, fb_height, (xx + i + offset_x), (yy + j + offset_y), rr, gg, bb);
                            }
                        }
                    }
                }
            }
        }
        else {
            for (int32_t y = y1; y < y2; y += _downsampling_factor) {
                for (int32_t x = x1; x < x2; x += _downsampling_factor) {
                    // 观察者到该像素的方向向量（从屏幕坐标系转回地平天球的笛卡尔坐标系）
                    float ray_x = 0.0f;
                    float ray_y = 0.0f;
                    float ray_z = 0.0f;
                    int32_t on_sphere = screen_xy_to_xyz((float)x, (float)y, sky_radius, center_x, center_y, &ray_x, &ray_y, &ray_z);

                    float red = 0.0f;
                    float green = 0.0f;
                    float blue = 0.0f;
                    if (on_sphere > 0) {
                        calculate_scattered_pixel(ray_x, ray_y, ray_z, sun_x, sun_y, sun_z, &red, &green, &blue, enable_opt_lut);
                    }

                    for (int32_t i = 0; i < _downsampling_factor; i++) {
                        for (int32_t j = 0; j < _downsampling_factor; j++) {
                            add_pixel(frame_buffer, fb_width, fb_height,
                                (x+i), (y+j), (uint8_t)(red * 255.0f), (uint8_t)(green * 255.0f), (uint8_t)(blue  * 255.0f));
                        }
                    }
                }
            }
        }
    }

    // 绘制太阳
    render_sun(
        frame_buffer, fb_width, fb_height,
        sky_radius, center_x, center_y,
        sun_proj_x, sun_proj_y, sun_alt);


    // 计算月球位置并绘制
    render_moon(
        frame_buffer, fb_width, fb_height,
        sky_radius, center_x, center_y,
        year, month, day, hour, minute, second, timezone, longitude, latitude);

    // 绘制星芒
    if (enable_star_burst && sun_alt > 0) {
        star_burst_filter(frame_buffer, fb_width, fb_height, sun_proj_x, sun_proj_y);
    }

    // 绘制恒星
    float mag_offset = -2.0f;
    for (int32_t i = 0; i < STARS_NUM; i++) {
        float *star_item = STARS[i];
        double alt = 0.0;
        double azi = 0.0;
        equatorial_to_horizontal(
            ra_hms_to_deg(star_item[0], star_item[1], star_item[2]),
            dec_dms_to_decimal(star_item[3], star_item[4], star_item[5]),
            year, month, day, hour, minute, second, timezone, longitude, latitude, &azi, &alt);
        float mag = 0.5f + mag_offset + star_item[6];

        float sx = 0.0f;
        float sy = 0.0f;
        horizontal_to_screen_xy(azi, alt, sky_radius, center_x, center_y, &sx, &sy);

        draw_star(frame_buffer, fb_width, fb_height, sky_radius, center_x, center_y, sx, sy, mag, 1, 255, 255, 255);

        if (enable_star_name) {
            fb_draw_textline(frame_buffer, fb_width, fb_height, STAR_NAME[i], sx+3, sy+3, 250, 250, 250);
        }
    }

    // 绘制大行星
    if (enable_planet) {
        for (int32_t i = 8; i >= 1; i--) { // 之所以倒数，是为了让靠近太阳的行星后绘制，使其覆盖在远离太阳的行星上面
            if (i == 3) continue; // 跳过地球
            double planet_azi = 0.0;
            double planet_alt = 0.0;
            where_is_the_planet(year, month, day, hour, minute, second, timezone, longitude, latitude, i, &planet_azi, &planet_alt);

            float planet_proj_x = 0.0f;
            float planet_proj_y = 0.0f;
            horizontal_to_screen_xy(planet_azi, planet_alt, sky_radius, center_x, center_y, &planet_proj_x, &planet_proj_y);

            draw_star(frame_buffer, fb_width, fb_height, sky_radius, center_x, center_y, planet_proj_x, planet_proj_y,
                0.0f, PLANET_RADIUS[i], PLANET_COLOR_R[i], PLANET_COLOR_G[i], PLANET_COLOR_B[i]);

            if (enable_planet_name) {
                fb_draw_textline(frame_buffer, fb_width, fb_height, PLANET_NAME[i], planet_proj_x+3, planet_proj_y+3, PLANET_COLOR_R[i], PLANET_COLOR_G[i], PLANET_COLOR_B[i]);
            }
        }
    }

    // 绘制赤道坐标网格
    if (enable_equatorial_coord) {
        // 绘制赤道天球子午圈
        for (int32_t i = 0; i < 24; i += 2) {
            int32_t line_width = (i == 0 || i == 12) ? 3 : 2;
            draw_celestial_circle(
                frame_buffer, fb_width, fb_height,
                sky_radius, center_x, center_y,
                1, (float)i, 0.0f,
                line_width, 8, 16, 32,
                year, month, day, hour, minute, second, timezone, longitude, latitude
            );
        }
        // 绘制赤道天球等纬度圈
        for (int32_t i = -90; i < 90; i += 10) {
            int32_t line_width = (i == 0) ? 3 : 2;
            draw_celestial_circle(
                frame_buffer, fb_width, fb_height,
                sky_radius, center_x, center_y,
                0, 0.0f, (float)i,
                line_width, 8, 16, 32,
                year, month, day, hour, minute, second, timezone, longitude, latitude
            );
        }
    }

    // 绘制地景（天空投影圆盘之外的部分）
    draw_horizon(frame_buffer, fb_width, fb_height, sky_radius, center_x, center_y);

    // 绘制地平坐标网格
    if (enable_horizontal_coord) {
        draw_circle_outline(frame_buffer, fb_width, fb_height, center_x, center_y, (sky_radius-1.0f), 2.0f, 128, 128, 128);
        draw_circle_outline(frame_buffer, fb_width, fb_height, center_x, center_y, (sky_radius/3.0f), 1.0f, 16, 16, 16);
        draw_circle_outline(frame_buffer, fb_width, fb_height, center_x, center_y, (sky_radius/3.0f*2.0f), 1.0f, 16, 16, 16);
        draw_line(frame_buffer, fb_width, fb_height, center_x, y1, center_x, y2, 1, 16, 16, 16);
        draw_line(frame_buffer, fb_width, fb_height, x1, center_y, x2, center_y, 1, 16, 16, 16);
    }

}
